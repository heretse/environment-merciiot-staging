[{"id":"4632a2e7.644ccc","type":"tab","label":"get AP flow","disabled":false,"info":""},{"id":"111006a3.51e0a9","type":"tab","label":"get sensor flow","disabled":false,"info":""},{"id":"b38da013.ce2ec","type":"tab","label":"tag mgm flow","disabled":false,"info":""},{"id":"c9fba67e.2e3dc8","type":"tab","label":"DL Flow","disabled":false,"info":""},{"id":"a87a28e1.8a8c38","type":"tab","label":"device mgm flow","disabled":false,"info":""},{"id":"17b8ee59.a67e72","type":"tab","label":"meta mgm Flow","disabled":false,"info":""},{"id":"d31ca3d0.f06ed","type":"tab","label":"Device state Flow","disabled":false,"info":""},{"id":"98bfa5b4.5b0408","type":"tab","label":"showField Flow","disabled":false,"info":""},{"id":"ef7281df.ce773","type":"tab","label":"Filter Flow","disabled":false,"info":""},{"id":"691153b7.0e855c","type":"subflow","name":"Redis get flow","info":"","in":[{"x":88,"y":131,"wires":[{"id":"a4885a91.4c3fe8"}]}],"out":[{"x":496,"y":121,"wires":[{"id":"76d8e50a.b981ac","port":0},{"id":"67c3c32d.8a73fc","port":0},{"id":"6ed4e0e3.5f4cb","port":0}]}]},{"id":"cdf3e7e3.4b3ec8","type":"subflow","name":"MySQL Subflow","info":"","in":[{"x":55,"y":71,"wires":[{"id":"13c242e7.72df5d"}]}],"out":[{"x":486,"y":71,"wires":[{"id":"dc9903d8.a72bf","port":0},{"id":"72fe6b5c.3339a4","port":0},{"id":"273b9fe0.6549d","port":0}]}]},{"id":"13cff304.82a29d","type":"subflow","name":"Get Delay Subflow","info":"","in":[{"x":88,"y":168,"wires":[{"id":"4b086086.bd12e"}]}],"out":[{"x":536,"y":165,"wires":[{"id":"4b086086.bd12e","port":0}]}]},{"id":"b2c69ed9.dcd28","type":"redis-config","z":"691153b7.0e855c","host":"redis-svr","port":"6379","dbase":"0","pass":"gemtek123"},{"id":"88a22566.58e328","type":"redis-config","z":"691153b7.0e855c","host":"redis-svr","port":"6379","dbase":"0","pass":"gemtek123"},{"id":"5203d0ff.41bad","type":"MySQLdatabase","z":"","host":"mysqldb","port":"3306","db":"cloudb_dev","tz":""},{"id":"aa1e18bc.734148","type":"MySQLdatabase","z":"","host":"mysqldb","port":"3306","db":"cloudb_dev","tz":""},{"id":"21e9f69a.3cd2ca","type":"mongodb","z":"","hostname":"mongodb","port":"27017","db":"argi_dev","name":""},{"id":"a72e7e06.4e35","type":"mqtt-broker","z":"","name":"","broker":"mqtt-svc","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"b55ac49f.330058","type":"redis-config","z":"","host":"redis-svr","port":"6379","dbase":"0","pass":"gemtek123"},{"id":"2d8d8dfe.7a8582","type":"mqtt-broker","z":"","name":"acer_dev","broker":"mqtt-svc","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"a4885a91.4c3fe8","type":"switch","z":"691153b7.0e855c","name":"lbs","property":"flow","propertyType":"msg","rules":[{"t":"gte","v":"5","vt":"str"},{"t":"lt","v":"5","vt":"str"}],"checkall":"true","outputs":2,"x":197.5,"y":131,"wires":[["76d8e50a.b981ac"],["67c3c32d.8a73fc"]]},{"id":"76d8e50a.b981ac","type":"redis-command","z":"691153b7.0e855c","server":"b2c69ed9.dcd28","command":"get","name":"redis_23","topic":"","x":354.5,"y":94,"wires":[[]]},{"id":"67c3c32d.8a73fc","type":"redis-command","z":"691153b7.0e855c","server":"88a22566.58e328","command":"get","name":"redis_22","topic":"","x":357,"y":164,"wires":[[]]},{"id":"4a0d5c77.eab8d4","type":"catch","z":"691153b7.0e855c","name":"","scope":["67c3c32d.8a73fc","76d8e50a.b981ac"],"x":121.5,"y":298,"wires":[["6ed4e0e3.5f4cb"]]},{"id":"6ed4e0e3.5f4cb","type":"function","z":"691153b7.0e855c","name":"set null to payload","func":"msg.payload = null\nreturn msg","outputs":1,"noerr":0,"x":346.5,"y":297,"wires":[[]]},{"id":"51636037.738fc","type":"function","z":"cdf3e7e3.4b3ec8","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":1465.5,"y":87,"wires":[[]]},{"id":"13c242e7.72df5d","type":"switch","z":"cdf3e7e3.4b3ec8","name":"lbs","property":"flow","propertyType":"msg","rules":[{"t":"lte","v":"5","vt":"str"},{"t":"gt","v":"5","vt":"str"}],"checkall":"true","outputs":2,"x":163,"y":71,"wires":[["dc9903d8.a72bf"],["72fe6b5c.3339a4"]]},{"id":"dc9903d8.a72bf","type":"mysql","z":"cdf3e7e3.4b3ec8","mydb":"5203d0ff.41bad","name":"cloudb_17","x":323,"y":41,"wires":[[]]},{"id":"72fe6b5c.3339a4","type":"mysql","z":"cdf3e7e3.4b3ec8","mydb":"aa1e18bc.734148","name":"cloudb_12","x":321,"y":98,"wires":[[]]},{"id":"859e2e6a.94391","type":"catch","z":"cdf3e7e3.4b3ec8","name":"","scope":["72fe6b5c.3339a4","dc9903d8.a72bf"],"x":94.5,"y":251,"wires":[["273b9fe0.6549d"]]},{"id":"273b9fe0.6549d","type":"function","z":"cdf3e7e3.4b3ec8","name":"set empty result","func":"let emptyArray = []\nmsg.payload = emptyArray\nreturn msg","outputs":1,"noerr":0,"x":289.5,"y":250,"wires":[[]]},{"id":"ee330287.343f3","type":"http in","z":"4632a2e7.644ccc","name":"","url":"/gw/:dstatus","method":"get","upload":false,"swaggerDoc":"","x":132,"y":479,"wires":[["f1dbef16.10e19"]]},{"id":"f1dbef16.10e19","type":"switch","z":"4632a2e7.644ccc","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":132.5,"y":430,"wires":[["70da2408.7b7e6c"],["af69a427.ae1448"]]},{"id":"af69a427.ae1448","type":"function","z":"4632a2e7.644ccc","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":450,"y":453,"wires":[["22d71abf.265f26"]]},{"id":"22d71abf.265f26","type":"http response","z":"4632a2e7.644ccc","name":"","statusCode":"","headers":{},"x":1293.5,"y":370,"wires":[]},{"id":"70da2408.7b7e6c","type":"function","z":"4632a2e7.644ccc","name":"set para to obj","func":"msg.payload['dstatus'] = msg.req.params.dstatus\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":128,"y":383,"wires":[["6a6d892.0941f78"]]},{"id":"e7f341e5.7609a","type":"switch","z":"4632a2e7.644ccc","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":116,"y":47,"wires":[["23c749d9.e8f216"],["b60fc1be.26fe4"]]},{"id":"b60fc1be.26fe4","type":"function","z":"4632a2e7.644ccc","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":418,"y":154,"wires":[["22d71abf.265f26"]]},{"id":"f27f217a.7983a","type":"function","z":"4632a2e7.644ccc","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":781.0000076293945,"y":158.00000190734863,"wires":[["22d71abf.265f26"]]},{"id":"9eb35cbd.33433","type":"function","z":"4632a2e7.644ccc","name":"set all device query","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type = \"LoRa\"'\nlet sqlStr = 'select device_type, deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type = \"159\"'\nif(actInfo.dstatus > 0)\n   sqlStr += ' and device_status = '+actInfo.dstatus\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg","outputs":1,"noerr":0,"x":750.5,"y":30,"wires":[["9b1eaeda.f9481"]]},{"id":"da61aa64.cb4058","type":"function","z":"4632a2e7.644ccc","name":"set CP device query","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type = \"LoRa\" and device_cp_id = '+actInfo.cpId+' and device_status = '+actInfo.dstatus\nlet sqlStr = 'select device_type, deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type = \"159\" and device_cp_id = '+actInfo.cpId\nif(actInfo.dstatus > 0)\n   sqlStr += ' and device_status = '+actInfo.dstatus\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":761,"y":68,"wires":[["9b1eaeda.f9481"]]},{"id":"be64389b.1aaea8","type":"function","z":"4632a2e7.644ccc","name":"set user device query","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type = \"LoRa\" and device_user_id = '+actInfo.userId\nlet sqlStr = 'select device_type, deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type = \"159\" and device_user_id = '+actInfo.userId\nif(actInfo.dstatus > 0)\n   sqlStr += ' and device_status = '+actInfo.dstatus\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":762,"y":107,"wires":[["9b1eaeda.f9481"]]},{"id":"58462d0d.5f44c4","type":"function","z":"4632a2e7.644ccc","name":"check result","func":"// let deviceList = flow.get('deviceInfo')\nlet deviceList = msg['deviceInfo']\nlet newPayload = {}\nlet gwArray = []\nlet statusObj = {}\nfor(let i = 0 ; i < deviceList.length ; i++){\n    let d = deviceList[i]\n    let m = msg.payload[i]\n    if(Array.isArray(m) && m.length > 0){\n      statusObj = m[0]\n      if(statusObj['information'] !== undefined){\n        d['mStatus'] = statusObj.information.status\n      }\n      else{\n        d['mStatus'] = 'NA'\n      }\n      d['mDate'] = statusObj.date\n    }else{\n      d['mDate'] = statusObj.date\n      d['mStatus'] = 'NA'\n    }\n    /*\n    if(msg.payload[i].rows && msg.payload[i].rows.length > 0){\n        d['uptime'] = msg.payload[i].rows[0].value.data.boot_time\n    }else{\n        \n    }\n    */\n    d['uptime'] = 'NA'\n    gwArray.push(d)\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = gwArray.length\nnewPayload['mList'] = gwArray\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2295.5,"y":148,"wires":[["5ee42e0b.74df6"]]},{"id":"5ee42e0b.74df6","type":"http response","z":"4632a2e7.644ccc","name":"","statusCode":"","headers":{},"x":2454.5,"y":146,"wires":[]},{"id":"9b1eaeda.f9481","type":"subflow:cdf3e7e3.4b3ec8","z":"4632a2e7.644ccc","x":1028.5,"y":56,"wires":[["30455a46.aecde6"]]},{"id":"23c749d9.e8f216","type":"switch","z":"4632a2e7.644ccc","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","outputs":4,"x":410.5,"y":51,"wires":[["9eb35cbd.33433"],["da61aa64.cb4058"],["be64389b.1aaea8"],["f27f217a.7983a"]]},{"id":"6db35c3e.f4f6d4","type":"split","z":"4632a2e7.644ccc","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1392.5,"y":217,"wires":[["65e5f5e9.2ec06c"]]},{"id":"30455a46.aecde6","type":"switch","z":"4632a2e7.644ccc","name":"check length","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":1205.5,"y":56,"wires":[["bac90e35.3fe56"],["c918c1ed.2da1b"]]},{"id":"c918c1ed.2da1b","type":"function","z":"4632a2e7.644ccc","name":"set no data result","func":"let newPayload = {}\nlet gwArray = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = gwArray.length\nnewPayload['mList'] = gwArray\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1150,"y":176,"wires":[["22d71abf.265f26"]]},{"id":"543f1180.b3018","type":"function","z":"4632a2e7.644ccc","name":"set cloudant query","func":"let queryInfo = flow.get('queryInfo')\nmsg['db'] = 'iotp_kqqhst_default_2018-03-14'\nmsg['searchName'] = 'by-deviceIdAndEventType'\nmsg['q'] = encodeURIComponent('[\"'+msg.payload.device_mac+'\", \"status\"]')\nmsg['l'] = 1\nmsg['s'] = 0\nmsg['descending'] = true\n\nreturn msg","outputs":1,"noerr":0,"x":1664.5,"y":364,"wires":[["bb14645d.705c08"]]},{"id":"bb14645d.705c08","type":"http request","z":"4632a2e7.644ccc","name":"","method":"GET","ret":"obj","url":"https://a9168397-afad-400f-b3c4-a896d9f4c249-bluemix.cloudant.com/{{db}}/_design/iotp/_view/{{searchName}}?key={{q}}&skip={{s}}&limit={{l}}& descending={{descending}}","tls":"","x":1854.5,"y":365,"wires":[[]]},{"id":"5953d505.c0b36c","type":"join","z":"4632a2e7.644ccc","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":2119.5,"y":223,"wires":[["58462d0d.5f44c4","84bfc291.ba14b"]]},{"id":"bac90e35.3fe56","type":"function","z":"4632a2e7.644ccc","name":"set result to flow","func":"// flow.set('deviceInfo', msg.payload)\nmsg['deviceInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":1412.5,"y":51,"wires":[["6db35c3e.f4f6d4"]]},{"id":"65e5f5e9.2ec06c","type":"switch","z":"4632a2e7.644ccc","name":"","property":"payload.device_status","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"},{"t":"else"}],"checkall":"true","outputs":2,"x":1518.5,"y":216,"wires":[["8888d275.bafef"],["5953d505.c0b36c"]]},{"id":"41b936bd.b2cd18","type":"function","z":"4632a2e7.644ccc","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":102,"y":97,"wires":[["e7f341e5.7609a"]]},{"id":"e6c387f5.7b6b98","type":"http in","z":"111006a3.51e0a9","name":"","url":"/sensor/:dstatus","method":"get","upload":false,"swaggerDoc":"","x":139,"y":459.9999694824219,"wires":[["25f41c94.12e284"]]},{"id":"25f41c94.12e284","type":"switch","z":"111006a3.51e0a9","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":136.5,"y":407,"wires":[["8e4fd5f5.b53838"],["2e2d6e20.8a5f02"]]},{"id":"2e2d6e20.8a5f02","type":"function","z":"111006a3.51e0a9","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":433,"y":356,"wires":[["c2961cd2.9bf7a"]]},{"id":"c2961cd2.9bf7a","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":1388.5,"y":414,"wires":[]},{"id":"8e4fd5f5.b53838","type":"function","z":"111006a3.51e0a9","name":"set para to obj","func":"msg.payload['dstatus'] = msg.req.params.dstatus\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":125,"y":360,"wires":[["91051b85.2fdfa8"]]},{"id":"7b22c401.6b1fdc","type":"switch","z":"111006a3.51e0a9","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":127,"y":59,"wires":[["69a3aefc.65688"],["23574429.365dcc"]]},{"id":"23574429.365dcc","type":"function","z":"111006a3.51e0a9","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":430,"y":152,"wires":[["c2961cd2.9bf7a"]]},{"id":"c57c83ee.e7898","type":"function","z":"111006a3.51e0a9","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":805,"y":155,"wires":[["c2961cd2.9bf7a"]]},{"id":"d9461df8.a864b","type":"function","z":"111006a3.51e0a9","name":"set all device query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type != \"LoRa\" '\nif(actInfo.fport !== undefined && actInfo.fport == 159){\n  sqlStr = 'select deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, device_IoT_org, device_IoT_type, remark, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where 1 = 1 '   \n}else{\n  sqlStr = 'select deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, device_IoT_org, device_IoT_type, remark, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type != \"159\" '  \n}\nif(actInfo.dstatus > 0)\n  sqlStr += ' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined && actInfo.fport != 158)\n  sqlStr += ' and device_type = \"'+actInfo.fport +'\"'  \n  \nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":817.5,"y":28,"wires":[["85bfafe1.5fa5a"]]},{"id":"243753e5.9a3f7c","type":"function","z":"111006a3.51e0a9","name":"set CP device query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type != \"LoRa\" and device_cp_id = '+actInfo.cpId+' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined && actInfo.fport == 159){\n  sqlStr = 'select deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where 1 = 1 and device_cp_id = '+actInfo.cpId    \n}else{\n  sqlStr = 'select deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type != \"159\" and device_cp_id = '+actInfo.cpId    \n}\n\nif(actInfo.dstatus > 0)\n  sqlStr += ' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined && actInfo.fport != 158)\n  sqlStr += ' and device_type = \"'+actInfo.fport +'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":827,"y":71,"wires":[["85bfafe1.5fa5a"]]},{"id":"c7f068f5.d53688","type":"function","z":"111006a3.51e0a9","name":"set user device query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type != \"LoRa\" and device_user_id = '+actInfo.userId\nif(actInfo.fport !== undefined && actInfo.fport == 159){\n  sqlStr = 'select deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where 1 = 1 and device_user_id = '+actInfo.userId\n}else{\n  sqlStr = 'select deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type != \"159\" and device_user_id = '+actInfo.userId\n}\nif(actInfo.dstatus > 0)\n  sqlStr += ' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined && actInfo.fport != 158)\n  sqlStr += ' and device_type = \"'+actInfo.fport +'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":829,"y":111,"wires":[["85bfafe1.5fa5a"]]},{"id":"73697b9e.9a1ae4","type":"function","z":"111006a3.51e0a9","name":"check result","func":"let deviceList = flow.get('deviceInfo')\nlet newPayload = {}\nlet gwArray = []\nfor(let i = 0 ; i < deviceList.length ; i++){\n    let d = deviceList[i]\n    if(msg.payload[i].rows && msg.payload[i].rows.length > 0){\n        d['LoRaAP'] = msg.payload[i].rows[0].value.deviceId\n    }else{\n        d['LoRaAP'] = 'NA'\n    }\n    gwArray.push(d)\n}\nif(gwArray.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = gwArray.length\n  newPayload['mList'] = gwArray\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2195.5,"y":133,"wires":[["c1588c48.79d5"]]},{"id":"c1588c48.79d5","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":2361.5,"y":98,"wires":[]},{"id":"69a3aefc.65688","type":"switch","z":"111006a3.51e0a9","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","outputs":4,"x":418.5,"y":55,"wires":[["d9461df8.a864b"],["243753e5.9a3f7c"],["c7f068f5.d53688"],["c57c83ee.e7898"]]},{"id":"d07ff1a0.4cef5","type":"split","z":"111006a3.51e0a9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1446.5,"y":131,"wires":[["66af7f6d.a2907"]]},{"id":"f2ac2a8d.008998","type":"switch","z":"111006a3.51e0a9","name":"check length","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":1261.5,"y":71,"wires":[["9412bb15.d37098"],["830933fa.d0974"]]},{"id":"830933fa.d0974","type":"function","z":"111006a3.51e0a9","name":"set no data result","func":"let newPayload = {}\nlet gwArray = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = gwArray.length\nnewPayload['mList'] = gwArray\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1194,"y":222,"wires":[["c2961cd2.9bf7a"]]},{"id":"fe98492d.b50928","type":"function","z":"111006a3.51e0a9","name":"set cloudant query","func":"let queryInfo = flow.get('queryInfo')\nmsg['db'] = 'iotp_kqqhst_default_2018-03-14'\nmsg['searchName'] = 'by-eventTypeAndMac'\nmsg['q'] = encodeURIComponent('[\"'+msg.payload.device_mac+'\", \"raw\"]')\nmsg['l'] = 1\nmsg['s'] = 0\nmsg['descending'] = true\n\nreturn msg","outputs":1,"noerr":0,"x":1726.5,"y":89,"wires":[["befcc57f.b34148"]]},{"id":"befcc57f.b34148","type":"http request","z":"111006a3.51e0a9","name":"","method":"GET","ret":"obj","url":"https://a9168397-afad-400f-b3c4-a896d9f4c249-bluemix.cloudant.com/{{db}}/_design/iotp/_view/{{searchName}}?key={{q}}&skip={{s}}&limit={{l}}& descending={{descending}}","tls":"","x":1913.5,"y":89,"wires":[["f6c6145b.b26698"]]},{"id":"f6c6145b.b26698","type":"join","z":"111006a3.51e0a9","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":2054.5,"y":133,"wires":[["73697b9e.9a1ae4"]]},{"id":"9412bb15.d37098","type":"function","z":"111006a3.51e0a9","name":"set result to flow","func":"msg['deviceInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":1454.5,"y":66,"wires":[["13a4fae1.444a55"]]},{"id":"66af7f6d.a2907","type":"switch","z":"111006a3.51e0a9","name":"","property":"payload.device_status","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"},{"t":"else"}],"checkall":"true","outputs":2,"x":1566.5,"y":130,"wires":[["fe98492d.b50928"],["f6c6145b.b26698"]]},{"id":"b10fada4.cb78","type":"debug","z":"111006a3.51e0a9","name":"","active":true,"tosidebar":true,"console":false,"complete":"true","x":2345.5,"y":39,"wires":[]},{"id":"89b3efb5.06ae9","type":"function","z":"111006a3.51e0a9","name":"set token len","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":126,"y":107,"wires":[["7b22c401.6b1fdc"]]},{"id":"85bfafe1.5fa5a","type":"subflow:cdf3e7e3.4b3ec8","z":"111006a3.51e0a9","x":1072,"y":66,"wires":[["f2ac2a8d.008998"]]},{"id":"9df557d1.1d0838","type":"http in","z":"b38da013.ce2ec","name":"","url":"/:type/tag","method":"get","upload":false,"swaggerDoc":"","x":128.71427154541016,"y":564.0000762939453,"wires":[["8c931e69.dfde9","89d46df0.4a5dd"]]},{"id":"8c931e69.dfde9","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":130.71427154541016,"y":527.0000267028809,"wires":[["1f18dde7.cd00b2"],["10135718.c64c29"]]},{"id":"4aeb597e.2a7468","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":168.5,"y":123,"wires":[["3edda623.e3c5ca"]]},{"id":"3edda623.e3c5ca","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":169.5,"y":75,"wires":[["2f579b6a.4e5874"],["cd5dc94a.4d3b58"]]},{"id":"cd5dc94a.4d3b58","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":472.5,"y":168,"wires":[["6d12deb.21b312"]]},{"id":"10135718.c64c29","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":493.2142791748047,"y":535.0000505447388,"wires":[["6d12deb.21b312"]]},{"id":"6d12deb.21b312","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1535,"y":269,"wires":[]},{"id":"2f579b6a.4e5874","type":"function","z":"b38da013.ce2ec","name":"set search tag info","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\n// let searchTxt = flow.get('search')\nlet searchTxt = msg['search']\nlet newPayload = {}\nlet paginate = false\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  newPayload['createDt'] = dateCond\n}\nif(searchTxt && searchTxt.length > 0){\n    node.warn('searchTxt:'+searchTxt)\n  let typeCond = {'information.type':Number(obj.tagType)}\n  let cond = {}\n  let conArray = []\n  conArray.push(typeCond)\n  if(searchTxt.indexOf(':') !== -1){\n    let arr = searchTxt.split(':')\n    if(arr.length === 3){\n      let searchCond = {}\n      searchCond['$'+arr[1]] = arr[2]\n      cond[arr[0]] = searchCond\n    }\n  }else{\n    cond['information.id'] = eval('/'+searchTxt+'/')\n  }\n  conArray.push(cond)\n//   let andCond = eval('$and')\n  let andCond = '$and'\n  newPayload[andCond] = conArray\n}else{\n  newPayload['information.type'] = Number(obj.tagType)\n}\n\nif(obj.paginate !== undefined && obj.paginate === 'true'){\n  paginate = true\n}\nlet page_limit = 10\nif(obj.limit !== undefined){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page !== undefined){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['createTs'] = -1\nif(obj.sort && obj.sort == 'asc'){\n  sort['createTs'] = 1\n}\nsort['id'] = 1\nmsg['sort'] = sort\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":463,"y":73,"wires":[["98c15df6.f931b","9faedd86.7ad7"]]},{"id":"98c15df6.f931b","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tags by type","collection":"tags","operation":"find","x":708,"y":74,"wires":[["9faedd86.7ad7","b9b9bef7.180a8"]]},{"id":"b9b9bef7.180a8","type":"function","z":"b38da013.ce2ec","name":"check result","func":"let newPayload = {}\nlet tagArray = []\nif(msg.payload.length == 1){\n  for(let i = 0 ; i < msg.payload.length ; i++){\n    let d = msg.payload[i]\n    tagArray.push(d)\n  }  \n}else{\n  tagArray = msg.payload\n}\n\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = tagArray.length\nnewPayload['tagList'] = tagArray\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1094,"y":69,"wires":[["6d12deb.21b312"]]},{"id":"9faedd86.7ad7","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":878,"y":30,"wires":[]},{"id":"9b51170f.885708","type":"http in","z":"b38da013.ce2ec","name":"","url":"/:type/tagCnt","method":"get","upload":false,"swaggerDoc":"","x":178.4047088623047,"y":1355.5714111328125,"wires":[["8aa5ae97.23869"]]},{"id":"8aa5ae97.23869","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":165.23804473876953,"y":1302.904803276062,"wires":[["afd281b1.7f87d"],["27759a8c.65e106"]]},{"id":"56df5ab5.6f4ee4","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":167.26185607910156,"y":867.3809413909912,"wires":[["bc0162d9.6419"]]},{"id":"bc0162d9.6419","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":168.26185607910156,"y":819.3809413909912,"wires":[["7690da07.32ef94"],["76bbb237.8b39dc"]]},{"id":"76bbb237.8b39dc","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":471.26185607910156,"y":912.3809413909912,"wires":[["a3604fe8.b86c5"]]},{"id":"27759a8c.65e106","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":662.2618408203125,"y":1294.5238037109375,"wires":[["a3604fe8.b86c5"]]},{"id":"a3604fe8.b86c5","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1533.7618560791016,"y":1013.3809413909912,"wires":[]},{"id":"7690da07.32ef94","type":"function","z":"b38da013.ce2ec","name":"set search tag info","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\n// let searchTxt = flow.get('search')\nlet searchTxt = msg['search']\nlet newPayload = {}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  newPayload['createDt'] = dateCond\n}\nif(searchTxt && searchTxt.length > 0){\n    node.warn('searchTxt:'+searchTxt)\n  let typeCond = {'information.type':Number(obj.tagType)}\n  let cond = {}\n  let conArray = []\n  conArray.push(typeCond)\n  if(searchTxt.indexOf(':') !== -1){\n    let arr = searchTxt.split(':')\n    if(arr.length === 3){\n      let searchCond = {}\n      searchCond['$'+arr[1]] = arr[2]\n      cond[arr[0]] = searchCond\n    }\n  }else{\n    cond['information.id'] = eval('/'+searchTxt+'/')\n  }\n  conArray.push(cond)\n//   let andCond = eval('$and')\n  let andCond = '$and'\n  newPayload[andCond] = conArray\n}else{\n  newPayload['information.type'] = Number(obj.tagType)\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":473.76185607910156,"y":818.3809413909912,"wires":[["a26bca85.705648"]]},{"id":"a26bca85.705648","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tags by type","collection":"tags","operation":"count","x":706.7618560791016,"y":818.3809413909912,"wires":[["569cce6b.2cd5c"]]},{"id":"569cce6b.2cd5c","type":"function","z":"b38da013.ce2ec","name":"check result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = msg.payload\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1046.761848449707,"y":851.3809261322021,"wires":[["a3604fe8.b86c5"]]},{"id":"13a4fae1.444a55","type":"function","z":"111006a3.51e0a9","name":"check result","func":"// let deviceList = flow.get('deviceInfo')\nlet deviceList = msg['deviceInfo']\nlet newPayload = {}\nlet gwArray = []\nfor(let i = 0 ; i < deviceList.length ; i++){\n    let d = deviceList[i]\n    /*\n    if(msg.payload[i].rows && msg.payload[i].rows.length > 0){\n        d['LoRaAP'] = msg.payload[i].rows[0].value.deviceId\n    }else{\n        \n    }\n    */\n    d['LoRaAP'] = 'NA'\n    gwArray.push(d)\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = gwArray.length\nnewPayload['mList'] = gwArray\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2105,"y":65,"wires":[["c1588c48.79d5","b10fada4.cb78"]]},{"id":"16a727a1.6f6c38","type":"http in","z":"b38da013.ce2ec","name":"","url":"/:type/tag","method":"post","upload":false,"swaggerDoc":"","x":212.50000953674316,"y":2565.00004196167,"wires":[["a3a3d2c8.db008","d050003e.120de"]]},{"id":"a7bd51c2.a2acc","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":209.5,"y":2456.000024795532,"wires":[["69c9463.7b5deb8"],["7e41e8d2.94aac8"]]},{"id":"48bc487d.0e1948","type":"function","z":"b38da013.ce2ec","name":"set para to obj","func":"msg.payload['type'] = msg.req.params.type\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nmsg['objId'] = msg.payload.objId\nreturn msg\n","outputs":1,"noerr":0,"x":204,"y":2365,"wires":[["c18ed2d.208a53"]]},{"id":"57ceabda.a102c4","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\n\nreturn msg","outputs":1,"noerr":0,"x":194.99998474121094,"y":2131.0000673532486,"wires":[["759a5801.e9d2a8"]]},{"id":"759a5801.e9d2a8","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":195.99998474121094,"y":2083.0000673532486,"wires":[["b0d3a904.a62c08"],["b0bf8b19.539528"]]},{"id":"b0bf8b19.539528","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":494,"y":2217,"wires":[["3ece233b.067e1c"]]},{"id":"7e41e8d2.94aac8","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":510,"y":2412,"wires":[["3ece233b.067e1c"]]},{"id":"346668bf.912d38","type":"function","z":"b38da013.ce2ec","name":"set info to insert","func":"let obj = msg['actInfo']\nlet newPayload = {}\nlet infoObj = {}\n\nobj['type'] = Number(obj.type)\ninfoObj['id'] = obj._id\ninfoObj['type'] = Number(obj.type)\nnewPayload['information'] = infoObj\ndelete obj['type']\ndelete obj['grp']\ndelete obj['ts']\ndelete obj['userId']\ndelete obj['cpId']\ndelete obj['roleId']\ndelete obj['dataset']\ndelete obj['token']\ndelete obj['objId']\n\nlet keys = Object.keys(obj);\nfor (let i = 0; i < keys.length; i++) {\n  newPayload[keys[i]] = obj[keys[i]]\n}\nlet nowTime = new Date()\nlet ts = nowTime.getTime()\nnewPayload['createTs'] = Date.now()\nnewPayload['createDt'] = nowTime\nmsg['recv'] = nowTime.toISOString()\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":741.1666259765625,"y":2000,"wires":[["aa9bb1ed.426a2"]]},{"id":"3ece233b.067e1c","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1137.499984741211,"y":2329.0000673532486,"wires":[]},{"id":"69c9463.7b5deb8","type":"switch","z":"b38da013.ce2ec","name":"check _id","property":"payload._id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":195.5,"y":2409,"wires":[["48bc487d.0e1948"],["7e41e8d2.94aac8"]]},{"id":"1170c527.76515b","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"insert tag info","collection":"tags","payonly":true,"upsert":true,"multi":true,"operation":"insert","x":1379.333251953125,"y":1874.6666259765625,"wires":[]},{"id":"d4a13c04.0541a","type":"function","z":"b38da013.ce2ec","name":"check result","func":"let newPayload = {}\nlet responseMsg = ''\nnewPayload['responseCode'] = '000'\nif(msg['objId'] == -1){\n  responseMsg = 'insert success'\n}else{\n  responseMsg = 'update success'\n}\nnewPayload['responseMsg'] = responseMsg\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1227.1666870117188,"y":2003.6666259765625,"wires":[["3ece233b.067e1c"]]},{"id":"a3a3d2c8.db008","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":419.50001335144043,"y":2566.00004196167,"wires":[]},{"id":"b0d3a904.a62c08","type":"switch","z":"b38da013.ce2ec","name":"","property":"objId","propertyType":"msg","rules":[{"t":"eq","v":"-1","vt":"str"},{"t":"neq","v":"-1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":193.50000762939453,"y":2024.6190719604492,"wires":[["76e0ffb0.ae0c4"],["a5e02242.43d0b"]]},{"id":"8c55a0e2.724d6","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"update tag info","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"store","x":989.1666870117188,"y":2120.33349609375,"wires":[]},{"id":"15252923.756947","type":"switch","z":"b38da013.ce2ec","name":"check search","property":"payload.search","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":161.90471649169922,"y":1219.8381662368774,"wires":[["3b1a6116.baca6e"],["a58773ea.4289e"]]},{"id":"afd281b1.7f87d","type":"function","z":"b38da013.ce2ec","name":"set flow obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":158.07139587402344,"y":1260.5714044570923,"wires":[["15252923.756947"]]},{"id":"a58773ea.4289e","type":"function","z":"b38da013.ce2ec","name":"set search text","func":"msg.payload = msg.payload.search\nreturn msg","outputs":1,"noerr":0,"x":397.40470123291016,"y":1178.2381048202515,"wires":[["141bfba5.266df4"]]},{"id":"141bfba5.266df4","type":"decrypt","z":"b38da013.ce2ec","name":"","algorithm":"TripleDES","key":"gemtek","x":595.4047012329102,"y":1175.6380987167358,"wires":[["e8949998.c667d8"]]},{"id":"e8949998.c667d8","type":"function","z":"b38da013.ce2ec","name":"set to flow","func":"// flow.set('search', msg.payload)\nmsg['search'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":751.4046821594238,"y":1171.3523664474487,"wires":[["ad70b0ed.27976"]]},{"id":"1f18dde7.cd00b2","type":"function","z":"b38da013.ce2ec","name":"set flow obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":131.7142791748047,"y":494.00003814697266,"wires":[["3b8afab9.111976"]]},{"id":"3b8afab9.111976","type":"switch","z":"b38da013.ce2ec","name":"check search","property":"payload.search","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":132.2142791748047,"y":459.60003757476807,"wires":[["792b55a6.ab4d4c"],["621cac6f.948544"]]},{"id":"621cac6f.948544","type":"function","z":"b38da013.ce2ec","name":"set search text","func":"msg.payload = msg.payload.search\nreturn msg","outputs":1,"noerr":0,"x":437.7142791748047,"y":436.0000247955322,"wires":[["ff533ca5.5d7c8"]]},{"id":"ff533ca5.5d7c8","type":"decrypt","z":"b38da013.ce2ec","name":"","algorithm":"TripleDES","key":"gemtek","x":626.7142868041992,"y":427.40002632141113,"wires":[["a1affde8.8871f"]]},{"id":"a1affde8.8871f","type":"function","z":"b38da013.ce2ec","name":"set to flow","func":"// flow.set('search', msg.payload)\nmsg['search'] = msg.payload\nmsg.payload = msg['actInfo']\nreturn msg","outputs":1,"noerr":0,"x":794.5714111328125,"y":391.9714412689209,"wires":[["59c9b38.d90544c"]]},{"id":"c0d7b784.a5b978","type":"inject","z":"b38da013.ce2ec","name":"","topic":"","payload":"000","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":191.9999942779541,"y":2822.000108361244,"wires":[["cba9f58f.ec77e8"]]},{"id":"cba9f58f.ec77e8","type":"encrypt","z":"b38da013.ce2ec","name":"","algorithm":"TripleDES","key":"gemtek","x":476.9999942779541,"y":2819.4000393152237,"wires":[["1de72166.e784bf"]]},{"id":"1de72166.e784bf","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":688.0000019073486,"y":2818.600039124489,"wires":[]},{"id":"89d46df0.4a5dd","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":292.2142753601074,"y":564.2000274658203,"wires":[]},{"id":"792b55a6.ab4d4c","type":"function","z":"b38da013.ce2ec","name":"clear empty search text","func":"msg['search'] = ''\nreturn msg","outputs":1,"noerr":0,"x":176.21427154541016,"y":418.60001277923584,"wires":[["59c9b38.d90544c"]]},{"id":"3b1a6116.baca6e","type":"function","z":"b38da013.ce2ec","name":"clear search text","func":"// flow.set('search', '')\nmsg['search'] = ''\nreturn msg","outputs":1,"noerr":0,"x":168.238037109375,"y":1173.5714845657349,"wires":[["ad70b0ed.27976"]]},{"id":"bb630f20.fbceb","type":"http in","z":"c9fba67e.2e3dc8","name":"","url":"/mqtt","method":"post","upload":false,"swaggerDoc":"","x":149.50000762939453,"y":454.6000566482544,"wires":[["3dd5d836.02f858"]]},{"id":"3dd5d836.02f858","type":"switch","z":"c9fba67e.2e3dc8","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":147,"y":410.0000057220459,"wires":[["2bd7df60.8d86a"],["dd7dca44.df15a8"]]},{"id":"555bc39a.26b1bc","type":"function","z":"c9fba67e.2e3dc8","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":146.5,"y":320,"wires":[["7adeca1e.72fe64"]]},{"id":"de477fb6.dfe6f","type":"function","z":"c9fba67e.2e3dc8","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":147.5,"y":128,"wires":[["608bc57b.5aca1c"]]},{"id":"608bc57b.5aca1c","type":"switch","z":"c9fba67e.2e3dc8","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":148.5,"y":80,"wires":[["f1bc654b.41e088"],["b4f1479c.bbe148"]]},{"id":"b4f1479c.bbe148","type":"function","z":"c9fba67e.2e3dc8","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":451.5,"y":173,"wires":[["f3e184c.f396f78"]]},{"id":"dd7dca44.df15a8","type":"function","z":"c9fba67e.2e3dc8","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":416.5,"y":393,"wires":[["f3e184c.f396f78"]]},{"id":"2bd7df60.8d86a","type":"switch","z":"c9fba67e.2e3dc8","name":"check message","property":"payload.message.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":168,"y":363,"wires":[["555bc39a.26b1bc"],["dd7dca44.df15a8"]]},{"id":"f3e184c.f396f78","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":847.5000114440918,"y":336.600004196167,"wires":[]},{"id":"2c4de79a.f26b28","type":"mqtt out","z":"c9fba67e.2e3dc8","name":"","topic":"GIOT-GW/DL/0001C497BC0C094","qos":"1","retain":"","broker":"a72e7e06.4e35","x":815.5,"y":115.80000305175781,"wires":[]},{"id":"f1bc654b.41e088","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to mqtt","func":"let actInfo = msg['actInfo']\nif(actInfo.topic != null)\n  msg['topic'] = actInfo.topic\nmsg.payload = actInfo.message\nreturn msg","outputs":1,"noerr":0,"x":499.5,"y":88.19999694824219,"wires":[["2c4de79a.f26b28","a04e4920.fff288"]]},{"id":"a04e4920.fff288","type":"function","z":"c9fba67e.2e3dc8","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'DL success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":703.000009059906,"y":181.0000023841858,"wires":[["f3e184c.f396f78"]]},{"id":"b9cc0874.055508","type":"http in","z":"a87a28e1.8a8c38","name":"","url":"/device","method":"post","upload":false,"swaggerDoc":"","x":128.5,"y":466.00000762939453,"wires":[["136f2537.00d9eb"]]},{"id":"136f2537.00d9eb","type":"switch","z":"a87a28e1.8a8c38","name":"check d","property":"payload.d","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":126,"y":417,"wires":[["f739a63e.817838"],["1a0830d9.02c37f"]]},{"id":"f739a63e.817838","type":"switch","z":"a87a28e1.8a8c38","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":134,"y":368,"wires":[["949bb26f.b98e3"],["1a0830d9.02c37f"]]},{"id":"949bb26f.b98e3","type":"function","z":"a87a28e1.8a8c38","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":131,"y":317,"wires":[["2cfe618b.f6a04e"]]},{"id":"38536753.2503a8","type":"switch","z":"a87a28e1.8a8c38","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":121,"y":67,"wires":[["4774175d.621958"],["7747a4d5.2e3fec"]]},{"id":"7747a4d5.2e3fec","type":"function","z":"a87a28e1.8a8c38","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":410,"y":156,"wires":[["91e1c2ff.5c8b5"]]},{"id":"1a0830d9.02c37f","type":"function","z":"a87a28e1.8a8c38","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":477.5,"y":433,"wires":[["91e1c2ff.5c8b5"]]},{"id":"8aed9f96.3208b","type":"function","z":"a87a28e1.8a8c38","name":"set device to payload","func":"let actInfo = msg['actInfo']\nif(actInfo.d.length > 0){\n  msg.payload = actInfo.d\n}\nreturn msg","outputs":1,"noerr":0,"x":640,"y":44,"wires":[["2b4437ec.883498"]]},{"id":"91e1c2ff.5c8b5","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":1557,"y":420,"wires":[]},{"id":"2b4437ec.883498","type":"switch","z":"a87a28e1.8a8c38","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":850.5,"y":43,"wires":[["7c4c5b08.2d6ab4"],["2ce13924.98ebb6"]]},{"id":"2ce13924.98ebb6","type":"function","z":"a87a28e1.8a8c38","name":"set no device result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'No device to add'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1044,"y":121,"wires":[["91e1c2ff.5c8b5"]]},{"id":"7c4c5b08.2d6ab4","type":"split","z":"a87a28e1.8a8c38","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1019.5,"y":36,"wires":[["29ab4640.40e86a"]]},{"id":"29ab4640.40e86a","type":"function","z":"a87a28e1.8a8c38","name":"set sql add device","func":"let actInfo = msg['actInfo']\nlet terminalObj = {}\nlet filterObj = {}\nlet sqlStr = 'INSERT INTO `api_device_info` ( `device_mac`, `device_name`, `device_status`, `device_type`, `device_share`, `device_IoT_org`, `device_IoT_type`, `createTime`, `createUser`) VALUES ( \"'+msg.payload.mac+'\", \"'+msg.payload.name+'\", 0, \"'+msg.payload.fport+'\", '+msg.payload.share+', \"'+msg.payload.org+'\", \"'+msg.payload.type+'\", current_time(), '+actInfo.userId+') '\nif(msg.payload.remark !== undefined)\n  sqlStr = 'INSERT INTO `api_device_info` ( `device_mac`, `device_name`, `device_status`, `device_type`, `device_share`, `device_IoT_org`, `device_IoT_type`, `createTime`, `createUser`, `remark`) VALUES ( \"'+msg.payload.mac+'\", \"'+msg.payload.name+'\", 0, \"'+msg.payload.fport+'\", '+msg.payload.share+', \"'+msg.payload.org+'\", \"'+msg.payload.type+'\", current_time(), '+actInfo.userId+', \"'+msg.payload.remark+'\") '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nfilterObj['mac'] = msg.payload.mac\nfilterObj['remark'] = msg.payload.name\nterminalObj['filter'] = filterObj\nterminalObj['userId'] = '1'\nmsg['terminalObj'] = terminalObj\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1202,"y":35,"wires":[["ccc76ba3.4f2748"]]},{"id":"7fd281f8.ed133","type":"join","z":"a87a28e1.8a8c38","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":1775.5,"y":141,"wires":[["538a9cf0.fbb5e4","ee230a26.6ecd28"]]},{"id":"538a9cf0.fbb5e4","type":"function","z":"a87a28e1.8a8c38","name":"check result","func":"let actInfo = msg['actInfo']\nlet totalLen = actInfo.d.length\nlet affectRow = 0\nlet title = 'Device'\nlet targetId = ''\nlet newPayload = {}\nlet errorDtl = {}\nlet errorMsg = []\n\nfor(let i = 0 ; i < msg.payload.length ; i++){\n  errorDtl = {}\n  if(msg.payload[i].affectedRows > 0){\n    affectRow++\n  }else{\n    targetId = actInfo.d[i].mac\n    errorDtl['msg'] = 'insert '+title+ ' : '+targetId+' fail'\n    errorMsg.push(errorDtl)\n  }\n}\nif(totalLen == affectRow){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'insert success'\n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = errorMsg\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1945.5,"y":141,"wires":[["f206d2a8.943ca"]]},{"id":"f206d2a8.943ca","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":2110.5,"y":138,"wires":[]},{"id":"4774175d.621958","type":"switch","z":"a87a28e1.8a8c38","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":383.5,"y":52,"wires":[["8aed9f96.3208b"],["2bcb19ae.8dddd6"]]},{"id":"2bcb19ae.8dddd6","type":"function","z":"a87a28e1.8a8c38","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":630.5,"y":92,"wires":[["91e1c2ff.5c8b5"]]},{"id":"cea3db15.9f6988","type":"function","z":"a87a28e1.8a8c38","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['roleId'] = actInfo.roleId\nreturn msg","outputs":1,"noerr":0,"x":111,"y":116,"wires":[["38536753.2503a8"]]},{"id":"ccc76ba3.4f2748","type":"subflow:cdf3e7e3.4b3ec8","z":"a87a28e1.8a8c38","x":1417.6999740600586,"y":32,"wires":[["9ec93abf.4f8798","ee230a26.6ecd28"]]},{"id":"6df5320f.544a5c","type":"http in","z":"a87a28e1.8a8c38","name":"","url":"/device/:id","method":"put","upload":false,"swaggerDoc":"","x":140,"y":1025.8000564575195,"wires":[["900b2c67.33b02"]]},{"id":"900b2c67.33b02","type":"switch","z":"a87a28e1.8a8c38","name":"check d","property":"payload.d","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":127.5,"y":976.800048828125,"wires":[["8a205ced.9370f"],["51024a41.83b244"]]},{"id":"8a205ced.9370f","type":"switch","z":"a87a28e1.8a8c38","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":135.5,"y":927.800048828125,"wires":[["8aab9329.16ada"],["51024a41.83b244"]]},{"id":"8aab9329.16ada","type":"function","z":"a87a28e1.8a8c38","name":"set para to obj","func":"msg.payload['id'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":132.5,"y":876.800048828125,"wires":[["ec004ba2.193a08"]]},{"id":"7614b5d.94d3f4c","type":"switch","z":"a87a28e1.8a8c38","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":127.5,"y":634.8000411987305,"wires":[["ecb35855.0e3c48"],["be00be01.c963e"]]},{"id":"be00be01.c963e","type":"function","z":"a87a28e1.8a8c38","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":416.5,"y":723.8000411987305,"wires":[["f7843887.b82d28"]]},{"id":"51024a41.83b244","type":"function","z":"a87a28e1.8a8c38","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":401,"y":942.7999877929688,"wires":[["f7843887.b82d28"]]},{"id":"f7843887.b82d28","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":1403.500072479248,"y":806.8000392913818,"wires":[]},{"id":"59143d6b.c12c34","type":"function","z":"a87a28e1.8a8c38","name":"set sql update device","func":"let actInfo = msg['actInfo']\nlet data = actInfo.d\nlet remark =  data.remark !== undefined ? data.remark : ''\nlet sqlStr = 'UPDATE `api_device_info` SET `device_name` = \"' + data.name + '\",`device_status` = ' + data.status + ',`device_type` = \"' + data.fport + '\", `device_share` = '+data.share+',`remark` = \"'+ remark + '\",`updateTime` = current_time(),`updateUser` = '+actInfo.userId + ' WHERE `deviceId` =' + actInfo.id\nif(data.status == 0)\n  sqlStr = 'UPDATE `api_device_info` SET `device_name` = \"' + data.name + '\",`device_status` = ' + data.status + ',`device_type` = \"' + data.fport + '\", `device_share` = '+data.share+', `device_active_time` = null, device_cp_id = null, device_bind_time = null, device_user_id = null, `remark` = \"'+ remark + '\",`updateTime` = current_time(),`updateUser` = '+actInfo.userId + ' WHERE `deviceId` =' + actInfo.id\nif (data.status == 1)\n  sqlStr = 'UPDATE `api_device_info` SET `device_name` = \"' + data.name + '\",`device_status` = ' + data.status + ',`device_type` = \"' + data.fport + '\", `device_share` = '+data.share+', `device_cp_id`='+data.bindCp+', `device_active_time` = current_time(), `remark` = \"'+ remark + '\",`updateTime` = current_time(),`updateUser` = '+actInfo.userId + ' WHERE `deviceId` =' + actInfo.id\nif (data.status == 2)\n  sqlStr = 'UPDATE `api_device_info` SET `device_name` = \"' + data.name + '\",`device_status` = ' + data.status + ',`device_type` = \"' + data.fport + '\", `device_share` = '+data.share+', `device_bind_time` = current_time(),`device_user_id` = '+data.bindUser+',`remark` = \"'+ remark + '\",`updateTime` = current_time(),`updateUser` = '+actInfo.userId + ' WHERE `deviceId` =' + actInfo.id\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":624.5000991821289,"y":589.8001308441162,"wires":[["ae2fb9ab.496168","2a19baab.10c8f6"]]},{"id":"5a016820.5e07e8","type":"function","z":"a87a28e1.8a8c38","name":"check result","func":"let newPayload = {}\nif(msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'update success'\n    \n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = 'upadte fail'\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1271.0001220703125,"y":656.8001098632812,"wires":[["f7843887.b82d28"]]},{"id":"ecb35855.0e3c48","type":"switch","z":"a87a28e1.8a8c38","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":390,"y":619.8000411987305,"wires":[["59143d6b.c12c34"],["ae152574.d25ac8"]]},{"id":"ae152574.d25ac8","type":"function","z":"a87a28e1.8a8c38","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":637,"y":659.8000411987305,"wires":[["f7843887.b82d28"]]},{"id":"2018832f.8b211c","type":"function","z":"a87a28e1.8a8c38","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['roleId'] = actInfo.roleId\nreturn msg","outputs":1,"noerr":0,"x":117.5,"y":683.8000411987305,"wires":[["7614b5d.94d3f4c"]]},{"id":"ae2fb9ab.496168","type":"subflow:cdf3e7e3.4b3ec8","z":"a87a28e1.8a8c38","x":867.2001571655273,"y":589.8001308441162,"wires":[["5a016820.5e07e8"]]},{"id":"79ad449a.26d10c","type":"http in","z":"a87a28e1.8a8c38","name":"","url":"/device/:id","method":"delete","upload":false,"swaggerDoc":"","x":143,"y":1550.0000324249268,"wires":[["bb61302a.d48c6"]]},{"id":"bb61302a.d48c6","type":"switch","z":"a87a28e1.8a8c38","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":139.5,"y":1504,"wires":[["e4ef4e80.afafc"],["69b5ad86.da6154"]]},{"id":"e4ef4e80.afafc","type":"function","z":"a87a28e1.8a8c38","name":"set para to obj","func":"msg.payload['id'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":136.5,"y":1453,"wires":[["d461892f.11a528"]]},{"id":"eceeb760.860d98","type":"switch","z":"a87a28e1.8a8c38","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":127.5,"y":1198.9999923706055,"wires":[["31f203c5.aa6f2c"],["9fd23463.bccb28"]]},{"id":"9fd23463.bccb28","type":"function","z":"a87a28e1.8a8c38","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":416.5,"y":1287.9999923706055,"wires":[["2a49bf63.1e14e"]]},{"id":"69b5ad86.da6154","type":"function","z":"a87a28e1.8a8c38","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":411,"y":1483,"wires":[["2a49bf63.1e14e"]]},{"id":"e67c0b91.498358","type":"function","z":"a87a28e1.8a8c38","name":"set sql del device","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_device_info` WHERE `deviceId` =' + actInfo.id\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1113.5001220703125,"y":1035.0001220703125,"wires":[["e5f64f53.4cc17"]]},{"id":"31f203c5.aa6f2c","type":"switch","z":"a87a28e1.8a8c38","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":390,"y":1183.9999923706055,"wires":[["e9946f07.04769"],["d3d5b8d.ccefd48"]]},{"id":"d3d5b8d.ccefd48","type":"function","z":"a87a28e1.8a8c38","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":637,"y":1223.9999923706055,"wires":[["2a49bf63.1e14e"]]},{"id":"883eef67.82ca7","type":"function","z":"a87a28e1.8a8c38","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['roleId'] = actInfo.roleId\nreturn msg","outputs":1,"noerr":0,"x":117.5,"y":1247.9999923706055,"wires":[["eceeb760.860d98"]]},{"id":"e5f64f53.4cc17","type":"subflow:cdf3e7e3.4b3ec8","z":"a87a28e1.8a8c38","x":1344.2000732421875,"y":1032.0001220703125,"wires":[["8ef9d2b8.89361"]]},{"id":"6634c8e4.751768","type":"function","z":"a87a28e1.8a8c38","name":"check result","func":"let newPayload = {}\nif(msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'delete success'\n    \n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = 'delete fail'\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1435.199951171875,"y":1297.199951171875,"wires":[["2a49bf63.1e14e"]]},{"id":"2a49bf63.1e14e","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":1528.7000732421875,"y":1482.1998291015625,"wires":[]},{"id":"93d5ed56.d83ad","type":"http in","z":"c9fba67e.2e3dc8","name":"","url":"/dl/:fport","method":"post","upload":false,"swaggerDoc":"","x":152.01422119140625,"y":1343.869116783142,"wires":[["7337c4f0.5a0b0c","aec8bb6b.1d40b8"]]},{"id":"7337c4f0.5a0b0c","type":"switch","z":"c9fba67e.2e3dc8","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":154.51421356201172,"y":1295.2692193984985,"wires":[["8bca402.f85bcc"],["cb7c91fd.8062"]]},{"id":"2d251da2.0b1a02","type":"function","z":"c9fba67e.2e3dc8","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg['actInfo'] = msg.payload\nmsg['fport'] = msg.req.params.fport\nlet systemFlg = true\nif(msg.payload['token'] != 'system_trigger'){\n  msg['token'] = encodeURIComponent(msg.payload['token'])  \n  systemFlg = false\n}\nmsg['systemFlg'] = systemFlg\nreturn msg","outputs":1,"noerr":0,"x":154.01422119140625,"y":1165.269287109375,"wires":[["33e34f94.8d1d1"]]},{"id":"f4d5780a.2be178","type":"function","z":"c9fba67e.2e3dc8","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":148.01422119140625,"y":899.2692375183105,"wires":[["1631270f.0f1819"]]},{"id":"1631270f.0f1819","type":"switch","z":"c9fba67e.2e3dc8","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":149.01422119140625,"y":851.2692375183105,"wires":[["ef4b900.352b97"],["74d73b9b.b17644"]]},{"id":"74d73b9b.b17644","type":"function","z":"c9fba67e.2e3dc8","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":529.0142211914062,"y":984.269287109375,"wires":[["6b20e8fb.20e7d8"]]},{"id":"cb7c91fd.8062","type":"function","z":"c9fba67e.2e3dc8","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":489.0142517089844,"y":1170.26904296875,"wires":[["6b20e8fb.20e7d8"]]},{"id":"be00e83b.691478","type":"switch","z":"c9fba67e.2e3dc8","name":"check message","property":"payload.message","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":164.51422119140625,"y":1207.2692651748657,"wires":[["2d251da2.0b1a02"],["cb7c91fd.8062"]]},{"id":"6b20e8fb.20e7d8","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":2129.0140380859375,"y":1227.869140625,"wires":[]},{"id":"bd30d41c.9bda58","type":"mqtt out","z":"c9fba67e.2e3dc8","name":"","topic":"","qos":"1","retain":"","broker":"2d8d8dfe.7a8582","x":3730,"y":640,"wires":[]},{"id":"b5d0de5c.33d16","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to mqtt","func":"let actInfo = msg['actInfo']\nmsg.payload = actInfo.message\nreturn msg","outputs":1,"noerr":0,"x":3118.013427734375,"y":564.4691772460938,"wires":[["b5483977.796678","26bb1330.a4a30c","18bcadb7.18c592"]]},{"id":"3d59d542.913dba","type":"function","z":"c9fba67e.2e3dc8","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'DL success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":3597.513916015625,"y":702.2691040039062,"wires":[["7659c3ae.2c808c"]]},{"id":"8bca402.f85bcc","type":"switch","z":"c9fba67e.2e3dc8","name":"check mac","property":"payload.mac.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":153.01422882080078,"y":1253.8693399429321,"wires":[["be00e83b.691478"],["cb7c91fd.8062"]]},{"id":"ef4b900.352b97","type":"switch","z":"c9fba67e.2e3dc8","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":355.6932067871094,"y":845.4544677734375,"wires":[["ca17cb1e.fd6a58"],["69991fb1.6e72"],["69991fb1.6e72"],["13af2980.8f7c37"]]},{"id":"13af2980.8f7c37","type":"function","z":"c9fba67e.2e3dc8","name":"set dataset fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Dataset error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":534.0142517089844,"y":942.3238363265991,"wires":[["6b20e8fb.20e7d8"]]},{"id":"69991fb1.6e72","type":"function","z":"c9fba67e.2e3dc8","name":"check device owner","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select deviceId from api_device_info where device_mac = \"'+actInfo.mac+'\" and device_type=\"'+actInfo.fport+'\" and device_status = 3 '\nif(msg['dataset'] == 1)\n  sqlStr = sqlStr + ' and device_cp_id = '+actInfo.cpId\nif(msg['dataset'] == 2)\n  sqlStr = sqlStr + ' and device_cp_id = '+actInfo.cpId + ' and device_user_id = '+actInfo.userId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":557.7017211914062,"y":850.3607788085938,"wires":[["73fb25f7.4dc57c"]]},{"id":"73fb25f7.4dc57c","type":"subflow:cdf3e7e3.4b3ec8","z":"c9fba67e.2e3dc8","x":757.6987915039062,"y":850.3721923828125,"wires":[["5f5a7fda.4e383"]]},{"id":"7659c3ae.2c808c","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":3762.791748046875,"y":701.0965576171875,"wires":[]},{"id":"5f5a7fda.4e383","type":"switch","z":"c9fba67e.2e3dc8","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":909.6987915039062,"y":850.54248046875,"wires":[["ca17cb1e.fd6a58"],["bde85dde.91443"]]},{"id":"bde85dde.91443","type":"function","z":"c9fba67e.2e3dc8","name":"set dataset fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Device access error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":873.0142440795898,"y":953.5966024398804,"wires":[["6b20e8fb.20e7d8"]]},{"id":"ca17cb1e.fd6a58","type":"function","z":"c9fba67e.2e3dc8","name":"check device type","func":"let actInfo = msg['actInfo']\nlet isArray = Array.isArray(actInfo['mac'])\nlet isVirtual = false\nif(isArray){\n  isVirtual = actInfo['mac'][0].indexOf('_') != -1 ? true:false    \n}else{\n  isVirtual = actInfo['mac'].indexOf('_') != -1 ? true:false\n}\nmsg['isVirtual'] = isVirtual\nmsg['isArray'] = isArray\ndelete msg['topic']\nreturn msg","outputs":1,"noerr":0,"x":977.6904296875,"y":799.0908813476562,"wires":[["b76d5573.07d338"]]},{"id":"c7020dc1.3ff49","type":"switch","z":"c9fba67e.2e3dc8","name":"check isVirtual","property":"isVirtual","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":872.099365234375,"y":699.991455078125,"wires":[["4d2e4e40.976ca"],["91e822c.d9451e"]]},{"id":"42e13f09.a23f","type":"function","z":"c9fba67e.2e3dc8","name":"set condition to metadata","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['device.macAddr'] = actInfo.mac\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1301.00830078125,"y":719.0907592773438,"wires":[["668cca69.aea874"]]},{"id":"668cca69.aea874","type":"mongodb in","z":"c9fba67e.2e3dc8","mongodb":"21e9f69a.3cd2ca","name":"get metadata by mac","collection":"metadata","operation":"find","x":1524.33203125,"y":740.2783203125,"wires":[["a0a202ea.10343"]]},{"id":"a0a202ea.10343","type":"switch","z":"c9fba67e.2e3dc8","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1717.1929931640625,"y":741.7214965820312,"wires":[["ce7089eb.baed78"],["a7403cd.f6ac4c"]]},{"id":"a7403cd.f6ac4c","type":"function","z":"c9fba67e.2e3dc8","name":"set dataset fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'Metadata not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1988.01416015625,"y":1141.7783813476562,"wires":[["6b20e8fb.20e7d8"]]},{"id":"ce7089eb.baed78","type":"function","z":"c9fba67e.2e3dc8","name":"get status ","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nlet dlSize = msg.payload[0].dl !== undefined ? msg.payload[0].dl.len !== undefined ? msg.payload[0].dl.len : 4 : 4\nlet dlVal = msg.payload[0].dl !== undefined ? msg.payload[0].dl.val !== undefined ? msg.payload[0].dl.val : 0 : 0\nif(msg.payload[0].device !== undefined){\n  let vDevice = {}\n  for(let i = 0 ; i < dlSize ; i++){\n    let pushObj = {}\n    vDevice = msg.payload[0].device[i]\n    if(vDevice !== undefined){\n      pushObj['macAddr'] = vDevice.macAddr\n      if(vDevice.macAddr == actInfo.mac){\n        pushObj['val'] = actInfo.message\n      }\n      else{\n        let tar = getTarget(vDevice.replace)\n        if(tar !== ''){\n          pushObj['val'] = ''\n          pushObj['replace'] = tar\n        }else{\n          pushObj['val'] = dlVal+''\n        }\n      }\n    }else{\n      pushObj['macAddr'] = 'notexist'+i\n      pushObj['val'] = dlVal+''\n    }\n    newPayload.push(pushObj)\n  }\n}\nif(msg.payload[0].dl !== undefined && msg.payload[0].dl.topic !== undefined){\n  msg['topic'] = msg.payload[0].dl.topic\n}\nif(actInfo.topic != undefined)\n  msg['topic'] = actInfo.topic\nmsg.payload = newPayload\nreturn msg\nfunction getTarget(r){\n  for(let i = 0 ; i < r.length ; i++){\n    if(r[i].target.indexOf('information') != -1){\n      return r[i].target\n    }\n  }\n  return ''\n}\n","outputs":1,"noerr":0,"x":1894.7014999389648,"y":738.3209609985352,"wires":[["4f58ca6c.ac3f74"]]},{"id":"4f58ca6c.ac3f74","type":"split","z":"c9fba67e.2e3dc8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2046.1902160644531,"y":738.6732120513916,"wires":[["7248aa5.d321354"]]},{"id":"2ebcb7af.8017d8","type":"join","z":"c9fba67e.2e3dc8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":2359.693115234375,"y":794.6588745117188,"wires":[["7988ef4c.b694d"]]},{"id":"7248aa5.d321354","type":"switch","z":"c9fba67e.2e3dc8","name":"","property":"payload.val","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"},{"t":"eq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2078.15625,"y":802.7186889648438,"wires":[["2ebcb7af.8017d8","7917ee08.337ad"],["6b1527f9.852338"]]},{"id":"6b4adef0.2d6d6","type":"http request","z":"c9fba67e.2e3dc8","name":"","method":"GET","ret":"obj","url":"","tls":"","x":2344.150390625,"y":902.7526245117188,"wires":[["d7d59eb3.1e293"]]},{"id":"ff0d7070.cd607","type":"function","z":"c9fba67e.2e3dc8","name":"get status by event","func":"let actInfo = msg['actInfo']\nlet url = 'http://127.0.0.1:1886/event?token={token}&fport={fport}&macAddr={macAddr}&limit=1'\nurl = url.replace('{token}', encodeURIComponent(actInfo.token)).replace('{fport}',actInfo.fport).replace('{macAddr}', msg.payload.macAddr)\nmsg['url'] = url\nmsg['meta'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":2226.46875,"y":858.7782592773438,"wires":[["6b4adef0.2d6d6"]]},{"id":"d7d59eb3.1e293","type":"function","z":"c9fba67e.2e3dc8","name":"set val to payload","func":"let newPayload = {}\nlet tar = '0'\nlet meta = msg['meta']  \nif(msg.payload.total > 0){\n  let event = msg.payload.data[0]\n  let tempObj = event\n  // get val\n  if(meta.replace.indexOf('.') != -1){\n    let eventArray = meta.replace.split('.')\n    for(let k = 0 ; k < eventArray.length ; k++){\n      if(k < eventArray.length -1){\n        tempObj = tempObj[eventArray[k]]\n      }else{\n        tar = tempObj[eventArray[k]]\n      }\n    }\n  }else{\n    tar = tempObj[strName]\n  }\n}\nif(tar == '2' || tar == '3'){\n  tar = '1'\n}\nnewPayload['macAddr'] = meta.macAddr\nnewPayload['val'] = tar\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":2419.147705078125,"y":954.099365234375,"wires":[["2ebcb7af.8017d8"]]},{"id":"9f9fa495.2c4638","type":"function","z":"c9fba67e.2e3dc8","name":"combine val 162","func":"let actInfo = msg['actInfo']\nlet newMsg = ''\nlet checkCnt = 6\nfor(let i = 0 ; i < msg.payload.length ; i++){\n  checkCnt = checkCnt + parseInt(msg.payload[i].val)\n  newMsg = newMsg + '0'+msg.payload[i].val\n}\nactInfo['message'] = '06'+newMsg+'0'+checkCnt.toString(16)\nmsg['actInfo'] = actInfo\nreturn msg","outputs":1,"noerr":0,"x":2755.149169921875,"y":822.0084228515625,"wires":[["b5d0de5c.33d16"]]},{"id":"7988ef4c.b694d","type":"switch","z":"c9fba67e.2e3dc8","name":"check fport","property":"fport","propertyType":"msg","rules":[{"t":"eq","v":"162","vt":"str"},{"t":"eq","v":"163","vt":"str"},{"t":"eq","v":"168","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":2541.0625,"y":792.5426025390625,"wires":[["9f9fa495.2c4638"],["4676077e.aa9e48"],["b684fdd7.a0fc5"]]},{"id":"4676077e.aa9e48","type":"function","z":"c9fba67e.2e3dc8","name":"combine val 163","func":"let actInfo = msg['actInfo']\n/*\nlet delayInfo = msg.payload\nlet delayTime = 1000\nif(delayInfo['responseCode'] == '000'){\n  let props = delayInfo['props']\n  delayTime = parseInt(props[0]['p_value'])\n}\nmsg['msgDelay'] = delayTime\nmsg['msgPreviousDelay'] = 0\n*/\nlet newMsg = ''\nfor(let i = 0 ; i < msg.payload.length ; i++){\n  newMsg = newMsg + msg.payload[i].val\n}\nactInfo['message'] = newMsg\nmsg['actInfo'] = actInfo\nreturn msg","outputs":1,"noerr":0,"x":2778.37744140625,"y":904.5057373046875,"wires":[["4acd7c4e.c90fd4"]]},{"id":"5bb872cd.79cdec","type":"subflow:691153b7.0e855c","z":"c9fba67e.2e3dc8","x":3095.510986328125,"y":933.75,"wires":[["17bc271d.9023c9"]]},{"id":"4acd7c4e.c90fd4","type":"function","z":"c9fba67e.2e3dc8","name":"get dlCnt","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nlet macId = ''\nlet mac = ''\nif(msg['isArray']){\n  let macObj = msg['macObj']\n  macId = macObj['mac']+'_dl'\n  mac = macObj['mac']\n}else{\n  let macArray = actInfo.mac.split('_') \n  macId = macArray[0]+'_dl'\n  mac = macArray[0]\n}\nlet topicArray = msg.topic.split('/')\nmsg['mac'] = mac\nmsg['gwid'] = topicArray[2]\nmsg['macId'] = macId\nnewPayload.push(macId)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":2953.519287109375,"y":890.45166015625,"wires":[["5bb872cd.79cdec"]]},{"id":"17bc271d.9023c9","type":"function","z":"c9fba67e.2e3dc8","name":"set dlCnt","func":"let actInfo = msg['actInfo']\nlet dlCnt = 10\nlet newMsgArray = []\nlet newMsg = {}\nlet extra = {}\nif(msg.payload !== null){\n  let tmpCnt = parseInt(msg.payload)+1\n  if(tmpCnt <= 99)\n    dlCnt = tmpCnt\n}\nnewMsg['macAddr'] = msg['mac']\nnewMsg['data'] = dlCnt + actInfo['message']\nnewMsg['id'] = msg['gwid']\nnewMsg['recv'] = new Date()\nextra['port'] = 2\nextra['txpara'] = '22'\nextra['fport'] = actInfo.fport\nnewMsg['extra'] = extra\nnewMsgArray.push(newMsg)\nmsg['dlCnt'] = dlCnt\nactInfo['message'] = newMsgArray\nmsg['actInfo'] = actInfo\nreturn msg","outputs":1,"noerr":0,"x":3286.83203125,"y":932.0510864257812,"wires":[["9df617de.390d68"]]},{"id":"9df617de.390d68","type":"function","z":"c9fba67e.2e3dc8","name":"set cache","func":"let newPayload = []\nnewPayload.push(msg['macId'])\nnewPayload.push(msg['dlCnt'])\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":3465.65087890625,"y":928.5056762695312,"wires":[["9711ec98.07a31"]]},{"id":"9711ec98.07a31","type":"redis-command","z":"c9fba67e.2e3dc8","server":"b55ac49f.330058","command":"set","name":"","topic":"","x":3050.650390625,"y":844.5056419372559,"wires":[["2b1c1eaf.a977c2"]]},{"id":"2b1c1eaf.a977c2","type":"switch","z":"c9fba67e.2e3dc8","name":"check result","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"OK","vt":"str"},{"t":"neq","v":"OK","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":3230.650390625,"y":842.505615234375,"wires":[["b5d0de5c.33d16"],["695b7d6f.32eca4"]]},{"id":"695b7d6f.32eca4","type":"function","z":"c9fba67e.2e3dc8","name":"set cache fail","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'insert redis fail'\nnewPayload['responseCode'] = '403'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":3646.741455078125,"y":894.5056762695312,"wires":[["b5d0de5c.33d16"]]},{"id":"aec8bb6b.1d40b8","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":421.96875,"y":1266.8692626953125,"wires":[]},{"id":"d163fabe.4a10d8","type":"http in","z":"b38da013.ce2ec","name":"","url":"/tag","method":"post","upload":false,"swaggerDoc":"","x":219.51420211791992,"y":3461.0056257247925,"wires":[["33d9a59e.47652a","3dc9f034.82bd9"]]},{"id":"10e16738.bf27f9","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":236.51419258117676,"y":3352.005608558655,"wires":[["916b5197.48c46"],["cd824e2b.a4d13"]]},{"id":"916b5197.48c46","type":"function","z":"b38da013.ce2ec","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":227.01419067382812,"y":3299.005615234375,"wires":[["93ac0d16.24ecc"]]},{"id":"cc06aee9.ab01d","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n    msg['roleId'] = actInfo['roleId']\n}\nreturn msg","outputs":1,"noerr":0,"x":215.01419067382812,"y":3082.005608201027,"wires":[["7fd9b6d.a6dd248"]]},{"id":"7fd9b6d.a6dd248","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":216.01419067382812,"y":3034.005608201027,"wires":[["9959b221.545ef"],["5a57283e.716b68"]]},{"id":"5a57283e.716b68","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":519.0141906738281,"y":3127.005608201027,"wires":[["2afa8ac8.1802f6"]]},{"id":"cd824e2b.a4d13","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":528.0141906738281,"y":3366.005615234375,"wires":[["2afa8ac8.1802f6"]]},{"id":"33d9a59e.47652a","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":470.51422119140625,"y":3450.005615234375,"wires":[]},{"id":"3dc9f034.82bd9","type":"switch","z":"b38da013.ce2ec","name":"check d","property":"payload.d","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":222.51420211791992,"y":3404.805562019348,"wires":[["10e16738.bf27f9"],["cd824e2b.a4d13"]]},{"id":"2afa8ac8.1802f6","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1169.514024734497,"y":3332.2780624628067,"wires":[]},{"id":"82286e1a.18c28","type":"function","z":"b38da013.ce2ec","name":"set device to payload","func":"let actInfo = msg['actInfo']\nif(actInfo.d.length > 0){\n  msg.payload = actInfo.d\n}\nmsg['map']=msg.payload\nreturn msg","outputs":1,"noerr":0,"x":1021.5140323638916,"y":2939.277678132057,"wires":[["12d71676.593aaa"]]},{"id":"12d71676.593aaa","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":1211.014108657837,"y":2936.2778993844986,"wires":[["fac345b1.d1bf88"],["bdccad51.f9258"]]},{"id":"fac345b1.d1bf88","type":"split","z":"b38da013.ce2ec","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1364.0141468048096,"y":2929.278074860573,"wires":[["af4dbde4.068b6"]]},{"id":"bdccad51.f9258","type":"function","z":"b38da013.ce2ec","name":"set no device result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'No device to add'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1217.5141010284424,"y":3058.278072953224,"wires":[["2afa8ac8.1802f6"]]},{"id":"9959b221.545ef","type":"switch","z":"b38da013.ce2ec","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":422.51421546936035,"y":3012.278355240822,"wires":[["4d59b5af.79892c"],["51b3bb07.14ac24"]]},{"id":"51b3bb07.14ac24","type":"function","z":"b38da013.ce2ec","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":623.514238357544,"y":3062.278317093849,"wires":[["2afa8ac8.1802f6"]]},{"id":"4d59b5af.79892c","type":"function","z":"b38da013.ce2ec","name":"get maps info","func":"let newPayload = {}\nnewPayload['deviceType'] = '165'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":619.1903057098389,"y":3006.5880666971207,"wires":[["49d9540a.6ebc3c"]]},{"id":"49d9540a.6ebc3c","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get maps by fport","collection":"maps","operation":"find","x":625.5142459869385,"y":2959.3695570230484,"wires":[["627eafa9.4a922"]]},{"id":"627eafa9.4a922","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":816.1931972503662,"y":2955.315624833107,"wires":[["82286e1a.18c28"],["1a9b7da8.b19af2"]]},{"id":"1a9b7da8.b19af2","type":"function","z":"b38da013.ce2ec","name":"set no maps","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'parsing rule not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":838.5142230987549,"y":3040.3695541620255,"wires":[["2afa8ac8.1802f6"]]},{"id":"af4dbde4.068b6","type":"function","z":"b38da013.ce2ec","name":"parsing data","func":"let rawObj = msg.payload\nlet mapObj = msg['map']\nlet actInfo = msg['actInfo']\nlet newPayload = {}\nlet mapInfo = {}\nif(mapObj.splitType == 'fix')\n  mapInfo = getMapData(rawObj.data, mapObj.map)\nif(mapObj.splitType == 'tlv')\n  mapInfo = getTlvData(rawObj.data, mapObj.map)\nnewPayload['macAddr'] = rawObj.mac\nnewPayload['data'] = rawObj.data\nnewPayload['createUser'] = actInfo.userId\nmsg['parseObj'] = newPayload\nmsg.payload = mapInfo\nreturn msg\nfunction getTlvData(rawObj, mapObj){\n  let info = {}\n  let splitPos = 0\n  let endPos = rawObj.length\n  let typeLen = mapObj.typelen !== undefined ? mapObj.typelen : 2\n  let lenLen = mapObj.lenLen !== undefined ? mapObj.lenLen : 2\n  let idx = 1\n  let typeName = ''\n  let lenName = ''\n  let start = 0\n  let end = 0\n  let dataType = ''\n  while(splitPos <= endPos){\n    typeName = 'type'+idx\n    lenName = 'len'+idx\n    start = Number(splitPos)\n    end = Number(start) + Number(typeLen)\n    //split type\n    let subStr = rawObj.substring(start, end)\n    let data = parseInt(subStr, 16)\n    dataType = 'type'+data\n    node.warn('st:'+start+' end:'+end+' subStr:'+subStr+' data:'+data)\n    info['type']=data\n    info[typeName] = data\n    start = end\n    end = start + Number(lenLen)\n    //split len\n    subStr = rawObj.substring(start, end)\n    data = parseInt(subStr, 16)\n    node.warn('st:'+start+' end:'+end+' subStr:'+subStr+' data:'+data)\n    info[lenName] = data\n    start = end\n    end = start + data*2\n    subStr = rawObj.substring(start, end)\n    //check data type\n    let valObj = mapObj[dataType]\n    switch(valObj.valType){\n      case 'ascii':\n        data = transferASCII(subStr)  \n        break\n      case 'dec':\n        data = parseInt(subStr)\n        break\n      case 'str':\n        data = subStr\n        break\n      default:\n        data = parseInt(subStr, 16)\n    }\n    node.warn('st:'+start+' end:'+end+' subStr:'+subStr+' data:'+data)\n    info[valObj.valName] = data\n    splitPos = end\n    idx++\n  }\n  return info\n}\nfunction getMapData(rawObj, mapObj){\n  let info = {}\n  for(let key in mapObj){\n    if(mapObj.hasOwnProperty(key)){\n      let parseData = getIntData(mapObj[key], rawObj)\n      if(parseData !== null)\n        info[key] = parseData\n    }\n  }\n  return info\n}\nfunction getIntData(arrRange,initData){\n  let ret = {}\n  let start = arrRange[0]\n  let end = arrRange[1]\n  let subStr = initData.substring(start,end)\n  if (subStr === '') {\n    return null;\n  }\n  let diff = arrRange[2]\n  if (diff === 'str') {\n    return subStr\n  } else if (diff==='dec') {\n    return parseInt(subStr)\n  }else if (diff==='signhex') {\n    return parseSignHex(subStr)\n  } else {\n  let data = parseInt(subStr, 16)\n  let result = eval(diff)\n    return Number(result.toFixed(2))\n  }\n}\n\nfunction parseSignHex(hex) {\n  if (hex.length % 2 != 0) {\n    hex = \"0\" + hex\n  }\n  let num = parseInt(hex, 16)\n  let maxVal = Math.pow(2, hex.length / 2 * 8);\n  if (num > maxVal / 2 - 1) {\n    num = num - maxVal\n  }\n  return num\n}\nfunction transferASCII(KeyOri) \n{ \nif (KeyOri.length==0) return; \nvar keylen= KeyOri.length; \nvar Keychar=\"\"; \nvar k=0;\n\nfor (i=0; i<keylen; i++) \n{ \nk=i%2; \nif(k == 0 ) \n{ \nKeychar +=String.fromCharCode(parseInt(KeyOri.substr(i, 2), 16)); \n} \n} \nreturn Keychar; \n} ","outputs":1,"noerr":0,"x":1517.7869815826416,"y":2929.096470475197,"wires":[["4739055b.d7816c"]]},{"id":"4739055b.d7816c","type":"function","z":"b38da013.ce2ec","name":"check parse data","func":"let parseObj = msg.payload\nlet newPayload = {}\nif( parseObj['type'] !== undefined ){\n  delete parseObj['type1']\n  delete parseObj['len1']\n  newPayload = parseObj\n}\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1708.4742984771729,"y":2929.317961335182,"wires":[["8093702f.715bc"]]},{"id":"8093702f.715bc","type":"function","z":"b38da013.ce2ec","name":"check result","func":"msg['emptyFlg'] = isEmptyObject(msg.payload)\nreturn msg\n\nfunction isEmptyObject(obj) { \n  for (var key in obj) { \n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\n      return false\n      }\n  }\n  return true \n}\n","outputs":1,"noerr":0,"x":1920.474115371704,"y":2928.3208919763565,"wires":[["9ae2cb26.9a20c8"]]},{"id":"9ae2cb26.9a20c8","type":"switch","z":"b38da013.ce2ec","name":"check emptyFlg","property":"emptyFlg","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1447.786828994751,"y":2993.278364777565,"wires":[["7592b395.540d1c"],["5731a161.a2488"]]},{"id":"7592b395.540d1c","type":"function","z":"b38da013.ce2ec","name":"set information","func":"// let parseObj = flow.get('parseObj')\nlet parseObj = msg['parseObj']\nlet newPayload = {}\nlet objFlg = false\nif(parseObj){\n  parseObj['information'] = msg.payload\n  let nowTime = new Date()\n  let ts = nowTime.getTime()\n  if(parseObj.recv !== undefined){\n    let dt = new Date(parseObj.recv)\n    ts = dt.getTime()\n  }else{\n    parseObj['recv'] = nowTime.toISOString()\n  }\n  msg['recv'] = parseObj['recv']\n  parseObj['createTs'] = ts\n  parseObj['createDt'] = nowTime\n  newPayload = parseObj\n//   flow.set('parseObj', parseObj)\n  msg['parseObj'] = parseObj\n  objFlg = true\n}\nmsg['objFlg'] = objFlg\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1717.2868194580078,"y":2990.2777878046036,"wires":[["bdc9fdcd.675fc"]]},{"id":"bdc9fdcd.675fc","type":"switch","z":"b38da013.ce2ec","name":"check objFlg","property":"objFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1899.7866764068604,"y":2991.278187394142,"wires":[["f065e3a7.3d46f"],["5731a161.a2488"]]},{"id":"f065e3a7.3d46f","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"recv","inputType":"msg","inTz":"ETC/GMT","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"recv","outputType":"msg","outTz":"Asia/Taipei","x":2097.7869091033936,"y":2972.278229355812,"wires":[["c9f4f315.b1f0d"]]},{"id":"c9f4f315.b1f0d","type":"function","z":"b38da013.ce2ec","name":"set data to event","func":"let newPayload = {}\nmsg.payload['createTime'] = msg.recv\nreturn msg","outputs":1,"noerr":0,"x":2170.7867603302,"y":2924.278322815895,"wires":[["f7c20777.d29d48","5b607fad.d2f94"]]},{"id":"5731a161.a2488","type":"function","z":"b38da013.ce2ec","name":"set error result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2031.7863063812256,"y":3060.278095841408,"wires":[["cd02a39b.e49e"]]},{"id":"f7c20777.d29d48","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":2437.474374771118,"y":2900.7812534570694,"wires":[]},{"id":"5b607fad.d2f94","type":"function","z":"b38da013.ce2ec","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2331.059564590454,"y":2981.278355240822,"wires":[["cd02a39b.e49e"]]},{"id":"cd02a39b.e49e","type":"join","z":"b38da013.ce2ec","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":2508.1046390533447,"y":3052.974252343178,"wires":[["20f55391.aa7dfc"]]},{"id":"20f55391.aa7dfc","type":"function","z":"b38da013.ce2ec","name":"check result","func":"let actInfo = msg['actInfo']\nlet tagCnt = actInfo.d.length\nlet checkCnt = 0\nlet errorCnt = 0\nlet newPayload = {}\nfor(let i = 0 ; i < msg.payload.length ; i++){\n  if(msg.payload[i].responseCode === '000')\n    checkCnt++\n  else\n    errorCnt++\n}\nif(tagCnt == checkCnt){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'insert success'\n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = 'successCnt:'+checkCnt+' errorCnt'+errorCnt\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2684.01674079895,"y":3051.596588730812,"wires":[["b265a2dd.8e053"]]},{"id":"b265a2dd.8e053","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":2865.5538425445557,"y":3052.6931797266006,"wires":[]},{"id":"80c7baed.384c98","type":"http in","z":"b38da013.ce2ec","name":"","url":"/tagType","method":"get","upload":false,"swaggerDoc":"","x":185.4998016357422,"y":1900.784423828125,"wires":[["d6ec6fed.9a3ca"]]},{"id":"d6ec6fed.9a3ca","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":193.3331298828125,"y":1852.451171875,"wires":[["25715c47.0e01a4"],["84589e43.d30d9"]]},{"id":"e6ca3de.9be9cc","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":172.83312225341797,"y":1555.1177215576172,"wires":[["c3bb7a2f.d7ee28"]]},{"id":"c3bb7a2f.d7ee28","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":173.83312225341797,"y":1507.1177215576172,"wires":[["86fd1c8a.b3d23"],["349e0b09.60e414"]]},{"id":"349e0b09.60e414","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":476.83312225341797,"y":1600.1177215576172,"wires":[["b07dd654.035dd8"]]},{"id":"84589e43.d30d9","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":495.8331298828125,"y":1798.784423828125,"wires":[["b07dd654.035dd8"]]},{"id":"b07dd654.035dd8","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1539.333122253418,"y":1701.1177215576172,"wires":[]},{"id":"86fd1c8a.b3d23","type":"function","z":"b38da013.ce2ec","name":"set search tag info","func":"let newPayload = {}\nnewPayload['deviceType'] = '165'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":479.33312225341797,"y":1506.1177215576172,"wires":[["e58673e2.d9fe9"]]},{"id":"e58673e2.d9fe9","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tag type from show_field","collection":"show_field","operation":"find","x":742.333122253418,"y":1506.1177215576172,"wires":[["6e55da65.721314","d1ce45cc.573848"]]},{"id":"6e55da65.721314","type":"function","z":"b38da013.ce2ec","name":"check result","func":"let newPayload = {}\nlet typeArray = []\nlet actInfo = msg['actInfo']\nlet typeFlg = false\nif(actInfo.type !== undefined)\n  typeFlg = true\nif(actInfo.locale == undefined){\n  actInfo.locale = 'zh-Hans'\n}\nif(msg.payload.length > 0){\n  let map = msg.payload[0].map\n  let typeSize = map.typeSize\n  for(let i = 1 ; i <= typeSize ; i++){\n    let name = 'type'+i\n    if(map[name] !== undefined){\n      let tags = map[name]\n    //   if(tags['tags'] == 1){\n        let tag = {}\n        tag['val'] = i\n        tag['name'] = name\n        if(tags['showField'] !== undefined){\n            if(actInfo.locale !== 'all' || actInfo['editFlg'] !== undefined){\n              for(let j = 0; j < tags['showField'].length; j++){\n                if(actInfo.locale !== 'all')\n                  tags['showField'][j].name = tags['showField'][j].name[actInfo.locale];\n                if(actInfo['editFlg'] !== undefined && tags['showField'][j].editFlg !== actInfo['editFlg'])\n                  delete tags['showField'][j]\n              }  \n            }\n          tag['showField'] = filter_array_values(tags['showField'])\n        }\n        if(typeFlg && i == actInfo.type || !typeFlg)\n          typeArray.push(tag)\n    //   }\n    }\n  }\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = typeArray.length\nnewPayload['tags'] = typeArray\nmsg['payload'] = newPayload  \nreturn msg\nfunction filter_array_values(arr) {\n  arr = arr.filter(isEligible);\n  return arr\n}\nfunction isEligible(value) {\n  if(value !== null) {\n    return value\n  }\n}","outputs":1,"noerr":0,"x":1052.3331146240234,"y":1539.1177062988281,"wires":[["b07dd654.035dd8"]]},{"id":"121b8336.c41ced","type":"function","z":"b38da013.ce2ec","name":"set flow obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":196.1664810180664,"y":1749.1177759170532,"wires":[["db71756a.a19cc8"]]},{"id":"ae1725b9.d29e78","type":"http in","z":"111006a3.51e0a9","name":"","url":"/sensor/detail/:mac","method":"get","upload":false,"swaggerDoc":"","x":142.71429443359375,"y":1051.4285888671875,"wires":[["bbbe9222.9e94c"]]},{"id":"bbbe9222.9e94c","type":"switch","z":"111006a3.51e0a9","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":142.21429443359375,"y":991.4285888671875,"wires":[["c8862f0a.6e165"],["ffbdb51c.939458"]]},{"id":"ffbdb51c.939458","type":"function","z":"111006a3.51e0a9","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":444.71429443359375,"y":992.4285888671875,"wires":[["1139205e.2a2c1"]]},{"id":"c8862f0a.6e165","type":"function","z":"111006a3.51e0a9","name":"set para to obj","func":"msg.payload['mac'] = msg.req.params.mac\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":127.71429443359375,"y":943.4285888671875,"wires":[["3f6377c9.8f8ee8"]]},{"id":"d064d8eb.6b2408","type":"switch","z":"111006a3.51e0a9","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":126.71429443359375,"y":677.4285888671875,"wires":[["37ad4c34.a7adc4"],["ac472e20.39835"]]},{"id":"ac472e20.39835","type":"function","z":"111006a3.51e0a9","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429.71429443359375,"y":770.4285888671875,"wires":[["1139205e.2a2c1"]]},{"id":"5f3b29e9.ac79e8","type":"function","z":"111006a3.51e0a9","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":804.7142944335938,"y":773.4285888671875,"wires":[["1139205e.2a2c1"]]},{"id":"fe5eaf08.bb622","type":"function","z":"111006a3.51e0a9","name":"set all device query","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type != \"LoRa\" '\nlet sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type != \"159\" and device_mac = \"'+actInfo.mac+'\" '\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_mac = \"'+actInfo.mac+'\" '\nif(actInfo.dstatus > 0)\n  sqlStr += ' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined)\n  sqlStr += ' and device_type = \"'+actInfo.fport +'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":817.2142944335938,"y":646.4285888671875,"wires":[["ffb41143.8f238"]]},{"id":"a6698bf3.b84938","type":"function","z":"111006a3.51e0a9","name":"set CP device query","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type != \"LoRa\" and device_cp_id = '+actInfo.cpId+' and device_status = '+actInfo.dstatus\nlet sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type != \"159\" and device_cp_id = '+actInfo.cpId + ' and device_mac = \"'+actInfo.mac+'\" '\nif(actInfo.dstatus > 0)\n  sqlStr += ' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined)\n  sqlStr += ' and device_type = \"'+actInfo.fport +'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":826.7142944335938,"y":689.4285888671875,"wires":[["ffb41143.8f238"]]},{"id":"a9bee80a.c47298","type":"function","z":"111006a3.51e0a9","name":"set user device query","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\n//let sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"未開啟\" when device_status = 1 then \"已啟用\"  when device_status = 2 then \"已綁定\" when device_status = 3 then \"使用中\" else \"無法辨識\" end as statusDesc  from api_device_info where device_type != \"LoRa\" and device_user_id = '+actInfo.userId\nlet sqlStr = 'select deviceId, device_mac, device_name, device_status, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_status, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type != \"159\" and device_user_id = '+actInfo.userId+ ' and device_mac = \"'+actInfo.mac+'\" '\nif(actInfo.dstatus > 0)\n  sqlStr += ' and device_status = '+actInfo.dstatus\nif(actInfo.fport !== undefined)\n  sqlStr += ' and device_type = \"'+actInfo.fport +'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":828.7142944335938,"y":729.4285888671875,"wires":[["ffb41143.8f238"]]},{"id":"37ad4c34.a7adc4","type":"switch","z":"111006a3.51e0a9","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","outputs":4,"x":418.21429443359375,"y":673.4285888671875,"wires":[["fe5eaf08.bb622"],["a6698bf3.b84938"],["a9bee80a.c47298"],["5f3b29e9.ac79e8"]]},{"id":"e9bbd6c8.1f4028","type":"switch","z":"111006a3.51e0a9","name":"check length","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":1261.2142944335938,"y":689.4285888671875,"wires":[["b76399.2d0e6c68"],["ad30c1d5.612ac"]]},{"id":"ad30c1d5.612ac","type":"function","z":"111006a3.51e0a9","name":"set no data result","func":"let newPayload = {}\nlet obj = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['device'] = obj\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1193.7142944335938,"y":840.4285888671875,"wires":[["1139205e.2a2c1"]]},{"id":"1e517465.03f90c","type":"function","z":"111006a3.51e0a9","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":125.71429443359375,"y":725.4285888671875,"wires":[["d064d8eb.6b2408"]]},{"id":"ffb41143.8f238","type":"subflow:cdf3e7e3.4b3ec8","z":"111006a3.51e0a9","x":1071.7142944335938,"y":684.4285888671875,"wires":[["e9bbd6c8.1f4028"]]},{"id":"1139205e.2a2c1","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":1236.4285714285713,"y":955.7142857142857,"wires":[]},{"id":"b76399.2d0e6c68","type":"function","z":"111006a3.51e0a9","name":"set meta query","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['macAddr'] = actInfo.mac\nnewPayload['type'] = 'meta'\nmsg['returnObj'] = msg.payload[0]\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1490.71431350708,"y":670.0000495910645,"wires":[["a0709cdb.58d76"]]},{"id":"a0709cdb.58d76","type":"mongodb in","z":"111006a3.51e0a9","mongodb":"21e9f69a.3cd2ca","name":"get meta by mac","collection":"metadata","operation":"find","x":1474.285789489746,"y":764.2857284545898,"wires":[["37808c91.d691f4"]]},{"id":"37808c91.d691f4","type":"function","z":"111006a3.51e0a9","name":"set meta returnObj","func":"let returnObj = msg['returnObj']\nlet newPayload = {}\nlet meta = {}\nif(msg.payload.length > 0){\n    meta = msg.payload[0]\n}\nreturnObj['meta'] = meta\nmsg['returnObj'] = returnObj\nreturn msg","outputs":1,"noerr":0,"x":1725.5714111328125,"y":690.4285278320312,"wires":[["82d50652.a69f08"]]},{"id":"dcf4498b.6585d8","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":2075,"y":667.8571166992188,"wires":[]},{"id":"222dc843.a59678","type":"http in","z":"b38da013.ce2ec","name":"","url":"/tag/:type/:id","method":"put","upload":false,"swaggerDoc":"","x":244.73457717895508,"y":4090.878372192383,"wires":[["c4df455f.4e3018","b7d3de2.23f9e2"]]},{"id":"b7d3de2.23f9e2","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":236.0202808380127,"y":4036.16405582428,"wires":[["343110a4.6a437"],["718afaad.0f14f4"]]},{"id":"343110a4.6a437","type":"function","z":"b38da013.ce2ec","name":"set para to obj","func":"msg.payload['id'] = msg.req.params.id\nmsg.payload['type'] = msg.req.params.type\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":226.52027893066406,"y":3983.1640625,"wires":[["ddc1582c.fdfee8"]]},{"id":"836c36b7.675098","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n    msg['roleId'] = actInfo['roleId']\n}\nreturn msg","outputs":1,"noerr":0,"x":227.52028274536133,"y":3761.1640520095825,"wires":[["666182a4.4f75fc"]]},{"id":"666182a4.4f75fc","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":239.32546997070312,"y":3710.80029296875,"wires":[["1211e958.8aa397"],["dbad42d.86308c"]]},{"id":"dbad42d.86308c","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":531.5202827453613,"y":3806.1640520095825,"wires":[["6c824b73.da8324"]]},{"id":"718afaad.0f14f4","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":538.8059997558594,"y":4009.021240234375,"wires":[["6c824b73.da8324"]]},{"id":"c4df455f.4e3018","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":490.59173583984375,"y":4082.5927734375,"wires":[]},{"id":"1211e958.8aa397","type":"switch","z":"b38da013.ce2ec","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":435.02030754089355,"y":3691.4367990493774,"wires":[["e53fb8fb.fedea8"],["ba9e79c6.b77048"]]},{"id":"ba9e79c6.b77048","type":"function","z":"b38da013.ce2ec","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":636.0203304290771,"y":3741.436760902405,"wires":[["6c824b73.da8324"]]},{"id":"e53fb8fb.fedea8","type":"function","z":"b38da013.ce2ec","name":"check tag exist","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nnewPayload['information.id'] = actInfo.id\nnewPayload['information.type'] = parseInt(actInfo.type)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":654.5535430908203,"y":3675.7465419769287,"wires":[["46902485.fb789c"]]},{"id":"6c824b73.da8324","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1582.430980682373,"y":4083.9889039993286,"wires":[]},{"id":"46902485.fb789c","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tag by id and type","collection":"tags","operation":"find","x":884.3060455322266,"y":3677.8001194000244,"wires":[["899cdb8c.07b928"]]},{"id":"899cdb8c.07b928","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1082.8775749206543,"y":3673.514570236206,"wires":[["6d06ad5d.05ed94"],["b7edf6a9.b5af98"]]},{"id":"b7edf6a9.b5af98","type":"function","z":"b38da013.ce2ec","name":"set no tag","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'tag not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1027.1632080078125,"y":3760.657470703125,"wires":[["6c824b73.da8324"]]},{"id":"6d06ad5d.05ed94","type":"function","z":"b38da013.ce2ec","name":"set info to update","func":"let updateObj = msg.payload[0]\nlet actInfo = msg['actInfo']\n/*\nif(actInfo.info !== undefined){\n  updateObj['info'] = actInfo.info\n}\nif(actInfo.loc !== undefined){\n  updateObj['loc'] = actInfo.loc\n}\n*/\n// delete token value\ndelete actInfo['id']\ndelete actInfo['type']\ndelete actInfo['grp']\ndelete actInfo['ts']\ndelete actInfo['userId']\ndelete actInfo['cpId']\ndelete actInfo['roleId']\ndelete actInfo['dataset']\ndelete actInfo['token']\nlet keys = Object.keys(actInfo);\nfor (let i = 0; i < keys.length; i++) {\n  updateObj[keys[i]] = actInfo[keys[i]]\n}\nlet nowTime = new Date()\nlet ts = nowTime.getTime()\nmsg['recv'] = nowTime.toISOString()\nupdateObj['updateTs'] = ts\nupdateObj['updateDt'] = nowTime\nmsg.payload = updateObj\nreturn msg","outputs":1,"noerr":0,"x":1279.9470672607422,"y":3645.5235748291016,"wires":[["cbb88c16.93199"]]},{"id":"6138d408.70a63c","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"update tag","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1809.9551620483398,"y":3596.951820373535,"wires":[]},{"id":"408109eb.8592c8","type":"function","z":"b38da013.ce2ec","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1642.2280960083008,"y":3784.8131160736084,"wires":[["6c824b73.da8324"]]},{"id":"cbb88c16.93199","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"recv","inputType":"msg","inTz":"ETC/GMT","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"recv","outputType":"msg","outTz":"Asia/Taipei","x":1437.4228515625,"y":3574.942964553833,"wires":[["db4c3f5c.4d32d"]]},{"id":"db4c3f5c.4d32d","type":"function","z":"b38da013.ce2ec","name":"set updateTime to tag","func":"msg.payload['updateTime'] = msg.recv\nreturn msg","outputs":1,"noerr":0,"x":1593.1371765136719,"y":3650.6574964523315,"wires":[["6138d408.70a63c","408109eb.8592c8"]]},{"id":"7157c8f3.8095a8","type":"comment","z":"b38da013.ce2ec","name":"fixed type:165","info":"","x":471.4488296508789,"y":1458.5794382095337,"wires":[]},{"id":"c3a3ff0.013e1","type":"http in","z":"17b8ee59.a67e72","name":"","url":"/meta/:fport/:type/:macAddr","method":"post","upload":false,"swaggerDoc":"","x":220,"y":580,"wires":[["47a4bf07.ddb97","ecc0541.19e5ea8"]]},{"id":"ecc0541.19e5ea8","type":"switch","z":"17b8ee59.a67e72","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":182.71427726745605,"y":525.2856149673462,"wires":[["f58a7861.e8a668"],["ae542158.f778f"]]},{"id":"f58a7861.e8a668","type":"function","z":"17b8ee59.a67e72","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg.payload['type'] = msg.req.params.type\nmsg.payload['macAddr'] = msg.req.params.macAddr\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":173.21427536010742,"y":472.2856216430664,"wires":[["727ee96a.500ad8"]]},{"id":"3a25d603.1a1b1a","type":"function","z":"17b8ee59.a67e72","name":"set token len","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n    msg['roleId'] = actInfo['roleId']\n}\nreturn msg","outputs":1,"noerr":0,"x":161.21427154541016,"y":275.2856674194336,"wires":[["df5cd88f.390bf8"]]},{"id":"df5cd88f.390bf8","type":"switch","z":"17b8ee59.a67e72","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":357.01945877075195,"y":260.92179918289185,"wires":[["63a3d85f.8a8bf8"],["beb0184f.f4d308"]]},{"id":"beb0184f.f4d308","type":"function","z":"17b8ee59.a67e72","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":465.21427154541016,"y":320.2856674194336,"wires":[["135b678a.8c0478"]]},{"id":"ae542158.f778f","type":"function","z":"17b8ee59.a67e72","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":494.49999618530273,"y":462.1427993774414,"wires":[["135b678a.8c0478"]]},{"id":"47a4bf07.ddb97","type":"debug","z":"17b8ee59.a67e72","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":488.57143783569336,"y":564.9998550415039,"wires":[]},{"id":"63a3d85f.8a8bf8","type":"switch","z":"17b8ee59.a67e72","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":368.7142963409424,"y":205.55841445922852,"wires":[["1a0b0ae0.393095"],["e025ae7f.8451b"]]},{"id":"e025ae7f.8451b","type":"function","z":"17b8ee59.a67e72","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":582.5714225769043,"y":262.7011375427246,"wires":[["135b678a.8c0478"]]},{"id":"1a0b0ae0.393095","type":"function","z":"17b8ee59.a67e72","name":"check meta exist","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nnewPayload['fport'] = parseInt(actInfo.fport)\nnewPayload['type'] = actInfo.type\nnewPayload['macAddr'] = actInfo.macAddr\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":584.2475242614746,"y":187.8681411743164,"wires":[["8faac700.4fcd48"]]},{"id":"135b678a.8c0478","type":"http response","z":"17b8ee59.a67e72","name":"","statusCode":"","headers":{},"x":940.3985023498535,"y":483.16790199279785,"wires":[]},{"id":"c720092e.96ba18","type":"switch","z":"17b8ee59.a67e72","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":804.8571434020996,"y":191.1426773071289,"wires":[["ac0eb12.ab91d5"],["13b508b6.f327c7"]]},{"id":"13b508b6.f327c7","type":"function","z":"17b8ee59.a67e72","name":"set info to insert","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nswitch(actInfo.type){\n  case 'sep':\n    if(actInfo.dl !== undefined){\n      newPayload['dl'] = actInfo.dl\n    }\n    if(actInfo.device !== undefined){\n      newPayload['device'] = actInfo.device\n    }\n    break\n  case 'meta':\n    if(actInfo.showFlg !== undefined){\n      newPayload['showFlg'] = actInfo.showFlg\n    }else{\n      newPayload['showFlg'] = 1\n    }\n    if(actInfo.dl !== undefined){\n      newPayload['dl'] = actInfo.dl\n    }\n    if(actInfo.meta !== undefined){\n      newPayload['meta'] = actInfo.meta\n    }\n    break\n  default:\n}\nlet nowTime = new Date()\nlet ts = nowTime.getTime()\nmsg['recv'] = nowTime.toISOString()\nnewPayload['fport'] = parseInt(actInfo.fport)\nnewPayload['name'] = actInfo.name\nnewPayload['type'] = actInfo.type\n//newPayload['showFlg'] = 1\nnewPayload['macAddr'] = actInfo.macAddr\nnewPayload['createTs'] = ts\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":972.2857475280762,"y":262.57133865356445,"wires":[["8ed96b44.875048"]]},{"id":"ac0eb12.ab91d5","type":"function","z":"17b8ee59.a67e72","name":"set info to update","func":"let updateObj = msg.payload[0]\nlet actInfo = msg['actInfo']\nswitch(actInfo.type){\n  case 'sep':\n    if(actInfo.dl !== undefined){\n      updateObj['dl'] = actInfo.dl\n    }\n    if(actInfo.device !== undefined){\n      updateObj['device'] = actInfo.device\n    }\n    break\n  case 'meta':\n    if(actInfo.dl !== undefined){\n      newPayload['dl'] = actInfo.dl\n    }\n    if(actInfo.meta !== undefined){\n      updateObj['meta'] = actInfo.meta\n    }\n    break\n  default:\n}\nlet nowTime = new Date()\nlet ts = nowTime.getTime()\nmsg['recv'] = nowTime.toISOString()\nupdateObj['updateTs'] = ts\nupdateObj['name'] = actInfo.name\nmsg.payload = updateObj\nreturn msg","outputs":1,"noerr":0,"x":983.7143211364746,"y":98.2856216430664,"wires":[["5b42283.9bf24d8"]]},{"id":"5b42283.9bf24d8","type":"moment","z":"17b8ee59.a67e72","name":"","topic":"","input":"recv","inputType":"msg","inTz":"ETC/GMT","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"recv","outputType":"msg","outTz":"Asia/Taipei","x":1146.904453277588,"y":186.27656364440918,"wires":[["2550dfe.cd1292"]]},{"id":"2550dfe.cd1292","type":"function","z":"17b8ee59.a67e72","name":"set updateTime to meta","func":"msg.payload['updateTime'] = msg.recv\nreturn msg","outputs":1,"noerr":0,"x":1306.9044303894043,"y":103.41954326629639,"wires":[["caece6b5.28c088","aaeb589c.6c4e08"]]},{"id":"aaeb589c.6c4e08","type":"function","z":"17b8ee59.a67e72","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1553.1381340026855,"y":131.86074829101562,"wires":[["4bb86514.5e364c"]]},{"id":"caece6b5.28c088","type":"mongodb out","z":"17b8ee59.a67e72","mongodb":"21e9f69a.3cd2ca","name":"update meta","collection":"metadata","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1513.7224159240723,"y":49.7138671875,"wires":[]},{"id":"4bb86514.5e364c","type":"http response","z":"17b8ee59.a67e72","name":"","statusCode":"","headers":{},"x":1778.9698867797852,"y":177.57545852661133,"wires":[]},{"id":"dd35426.bdcebc","type":"function","z":"17b8ee59.a67e72","name":"set createTime to meta","func":"msg.payload['createTime'] = msg.recv\nreturn msg","outputs":1,"noerr":0,"x":1333.7142143249512,"y":262.571346282959,"wires":[["5eb4dff2.89921","8efc1441.608378"]]},{"id":"5eb4dff2.89921","type":"function","z":"17b8ee59.a67e72","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'insert success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1559.168846130371,"y":231.14271068572998,"wires":[["4bb86514.5e364c"]]},{"id":"8efc1441.608378","type":"mongodb out","z":"17b8ee59.a67e72","mongodb":"21e9f69a.3cd2ca","name":"insert meta","collection":"metadata","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1743.740322113037,"y":333.2856216430664,"wires":[]},{"id":"e07fe90d.d77b48","type":"http in","z":"111006a3.51e0a9","name":"","url":"/sensor/:fport/:meta/:val","method":"get","upload":false,"swaggerDoc":"","x":187.02841186523438,"y":1769.193115234375,"wires":[["15cc9cbb.935d53"]]},{"id":"15cc9cbb.935d53","type":"switch","z":"111006a3.51e0a9","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":170.52841186523438,"y":1709.193115234375,"wires":[["e9656aae.e6e718"],["c6f7ed1a.436f5"]]},{"id":"c6f7ed1a.436f5","type":"function","z":"111006a3.51e0a9","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":487.0284118652344,"y":1709.193115234375,"wires":[["aeb698c7.8503f8"]]},{"id":"e9656aae.e6e718","type":"function","z":"111006a3.51e0a9","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg.payload['meta'] = msg.req.params.meta\nmsg.payload['val'] = msg.req.params.val\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":160.02841186523438,"y":1661.193115234375,"wires":[["49546933.c39008"]]},{"id":"534780c6.f640d","type":"switch","z":"111006a3.51e0a9","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":152.02841186523438,"y":1404.193115234375,"wires":[["fb8f6d0c.42181"],["3afa2a06.c75646"]]},{"id":"3afa2a06.c75646","type":"function","z":"111006a3.51e0a9","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":456.0284118652344,"y":1489.1931686401367,"wires":[["aeb698c7.8503f8"]]},{"id":"d9abcc9b.49a43","type":"switch","z":"111006a3.51e0a9","name":"check length","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":970.5284423828125,"y":1374.193115234375,"wires":[["b7c091f9.5bed8"],["e03cda42.597468"]]},{"id":"e03cda42.597468","type":"function","z":"111006a3.51e0a9","name":"set no data result","func":"let newPayload = {}\nlet obj = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['device'] = obj\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1220.0284118652344,"y":1559.1931686401367,"wires":[["aeb698c7.8503f8"]]},{"id":"d481bde1.26546","type":"function","z":"111006a3.51e0a9","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":152.02841186523438,"y":1444.1931686401367,"wires":[["534780c6.f640d"]]},{"id":"aeb698c7.8503f8","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":1262.742688860212,"y":1674.478865487235,"wires":[]},{"id":"b7c091f9.5bed8","type":"function","z":"111006a3.51e0a9","name":"set returnObj","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['device'] = msg.payload\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1188.8856201171875,"y":1365.193115234375,"wires":[["2a4f126.6132cee"]]},{"id":"2a4f126.6132cee","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":1430.3140869140625,"y":1359.6217041015625,"wires":[]},{"id":"fb8f6d0c.42181","type":"function","z":"111006a3.51e0a9","name":"set search by meta","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nlet loc = 'meta.'\nnewPayload['fport'] = parseInt(actInfo.fport)\nif(actInfo.showFlg !== undefined){\n  newPayload['showFlg'] = parseInt(actInfo.showFlg)\n}\n\nif(actInfo.meta != 'macAddr'){\n  loc += actInfo.meta +'.val'\n}else{\n  loc = actInfo.meta\n}\nnewPayload[loc] = actInfo.val\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":483,"y":1384,"wires":[["a874b091.ed16a"]]},{"id":"a874b091.ed16a","type":"mongodb in","z":"111006a3.51e0a9","mongodb":"21e9f69a.3cd2ca","name":"get by meta field","collection":"metadata","operation":"find","x":750,"y":1379,"wires":[["d9abcc9b.49a43"]]},{"id":"6768cff5.c8df","type":"switch","z":"b38da013.ce2ec","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":173.4285430908203,"y":1079.4285688400269,"wires":[["ffb52d96.15736"],["7fb86798.521488"]]},{"id":"ad70b0ed.27976","type":"switch","z":"b38da013.ce2ec","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":165.9285545349121,"y":1122.6285390853882,"wires":[["6768cff5.c8df"],["e5952bbe.f41208"]]},{"id":"e5952bbe.f41208","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":420.9285354614258,"y":1136.228539466858,"wires":[["6768cff5.c8df"]]},{"id":"7fb86798.521488","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":414.42852783203125,"y":1073.028561592102,"wires":[["ffb52d96.15736"]]},{"id":"808ee921.fca3c8","type":"switch","z":"b38da013.ce2ec","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":184.14283752441406,"y":314.85719108581543,"wires":[["de102dcd.843e9"],["dc04d6da.523278"]]},{"id":"59c9b38.d90544c","type":"switch","z":"b38da013.ce2ec","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":168.64285278320312,"y":366.057165145874,"wires":[["808ee921.fca3c8"],["34df1899.980208"]]},{"id":"34df1899.980208","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":438.642822265625,"y":351.65717124938965,"wires":[["808ee921.fca3c8"]]},{"id":"dc04d6da.523278","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":425.142822265625,"y":308.4571838378906,"wires":[["de102dcd.843e9"]]},{"id":"8888d275.bafef","type":"function","z":"4632a2e7.644ccc","name":"get monitor status","func":"let actInfo = msg.payload\nlet page_limit = 1\nlet newPayload = {}\nnewPayload['extra.fport'] = parseInt(actInfo.device_type)\nnewPayload['macAddr'] = actInfo.device_mac\nlet sort = {}\nsort['recv'] = -1\nmsg['sort'] = sort\nmsg['limit'] = page_limit\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1699,"y":191,"wires":[["c35cffa4.540f3"]]},{"id":"c35cffa4.540f3","type":"mongodb in","z":"4632a2e7.644ccc","mongodb":"21e9f69a.3cd2ca","name":"get status by mac","collection":"devices","operation":"find","x":1916,"y":188,"wires":[["5953d505.c0b36c"]]},{"id":"6a30733f.70e67c","type":"function","z":"4632a2e7.644ccc","name":"check result","func":"// let deviceList = flow.get('deviceInfo')\nlet deviceList = msg['deviceInfo']\nlet newPayload = {}\nlet gwArray = []\nfor(let i = 0 ; i < deviceList.length ; i++){\n    let d = deviceList[i]\n    /*\n    if(msg.payload[i].rows && msg.payload[i].rows.length > 0){\n        d['uptime'] = msg.payload[i].rows[0].value.data.boot_time\n    }else{\n        \n    }\n    */\n    d['uptime'] = 'NA'\n    gwArray.push(d)\n}\nif(gwArray.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = gwArray.length\n  newPayload['mList'] = gwArray\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2298,"y":83,"wires":[[]]},{"id":"84bfc291.ba14b","type":"debug","z":"4632a2e7.644ccc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2289,"y":195,"wires":[]},{"id":"8faac700.4fcd48","type":"mongodb in","z":"17b8ee59.a67e72","mongodb":"21e9f69a.3cd2ca","name":"get meta by fport/mac/type","collection":"metadata","operation":"find","x":702.9797019958496,"y":128.1606216430664,"wires":[["c720092e.96ba18"]]},{"id":"8ed96b44.875048","type":"moment","z":"17b8ee59.a67e72","name":"","topic":"","input":"recv","inputType":"msg","inTz":"ETC/GMT","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"recv","outputType":"msg","outTz":"Asia/Taipei","x":1149.9797019958496,"y":349.1606216430664,"wires":[["dd35426.bdcebc"]]},{"id":"b5483977.796678","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":3371,"y":576,"wires":[]},{"id":"c42ab664.ade258","type":"function","z":"c9fba67e.2e3dc8","name":"set condition to metadata","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['macAddr'] = actInfo.mac\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1536,"y":615,"wires":[["edf4d719.bd85d8"]]},{"id":"edf4d719.bd85d8","type":"mongodb in","z":"c9fba67e.2e3dc8","mongodb":"21e9f69a.3cd2ca","name":"get metadata by mac","collection":"metadata","operation":"find","x":1614,"y":687,"wires":[["f4108ab8.e4b2c8"]]},{"id":"ccd98e9b.e124b","type":"function","z":"c9fba67e.2e3dc8","name":"check len and set topic","func":"let actInfo = msg['actInfo']\nlet checkFlg = false\nif(msg.payload[0].dl !== undefined){\n  if(msg.payload[0].dl.topic !== undefined){\n    msg['topic'] = msg.payload[0].dl.topic\n  }\n  if(msg.payload[0].dl.len !== undefined){\n    if(actInfo['message'].length == msg.payload[0].dl.len)\n      checkFlg = true\n  }\n}\nif(actInfo.topic != undefined)\n  msg['topic'] = actInfo.topic\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":2206,"y":655,"wires":[["3274716a.0afb8e","21f59212.b7481e"]]},{"id":"f4108ab8.e4b2c8","type":"switch","z":"c9fba67e.2e3dc8","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1845,"y":679,"wires":[["b09c1ec0.3941"],["a7403cd.f6ac4c"]]},{"id":"3274716a.0afb8e","type":"switch","z":"c9fba67e.2e3dc8","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":2441,"y":684,"wires":[["d145f946.f0ac18"],["a6a44029.ae17b"]]},{"id":"d145f946.f0ac18","type":"function","z":"c9fba67e.2e3dc8","name":"set format fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'message format error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2651,"y":635,"wires":[["f4291964.43e9f8"]]},{"id":"f4291964.43e9f8","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":2893,"y":631,"wires":[]},{"id":"a6a44029.ae17b","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to mqtt","func":"let actInfo = msg['actInfo']\nlet newMsgArray = []\nlet newMsg = {}\nlet extra = {}\nlet topicArray = msg.topic.split('/')\nlet gwid = topicArray.length >= 2 ? topicArray[2] : 'NA'\nnewMsg['macAddr'] = actInfo['mac']\nnewMsg['data'] = actInfo['message']\nnewMsg['id'] = gwid\nnewMsg['recv'] = new Date()\nextra['port'] = 2\nextra['txpara'] = '22'\nextra['fport'] = actInfo.fport\nnewMsg['extra'] = extra\nnewMsgArray.push(newMsg)\nactInfo['message'] = newMsgArray\nreturn msg","outputs":1,"noerr":0,"x":2732,"y":701,"wires":[["b5d0de5c.33d16"]]},{"id":"21f59212.b7481e","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2456,"y":594,"wires":[]},{"id":"1828648c.63c74b","type":"mongodb out","z":"c9fba67e.2e3dc8","mongodb":"21e9f69a.3cd2ca","name":"save dl cmd","collection":"dl","payonly":true,"upsert":false,"multi":false,"operation":"store","x":3746,"y":553,"wires":[]},{"id":"e02c6bbc.bd6bd8","type":"function","z":"c9fba67e.2e3dc8","name":"set array to obj","func":"let isArray = Array.isArray(msg.payload)\nif(isArray){\n  msg.payload = msg.payload[0]  \n}\nmsg.payload['topic'] = msg['topic']\nmsg.payload['recv'] = new Date()\nreturn msg","outputs":1,"noerr":0,"x":3554,"y":571,"wires":[["1828648c.63c74b"]]},{"id":"91e822c.d9451e","type":"switch","z":"c9fba67e.2e3dc8","name":"check mac array","property":"isArray","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1121,"y":757,"wires":[["42e13f09.a23f"],["ed9f1ff0.4aa48"]]},{"id":"4d2e4e40.976ca","type":"switch","z":"c9fba67e.2e3dc8","name":"check mac array","property":"isArray","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1090,"y":657,"wires":[["ee7ab733.c22f88"],["5030bf8c.b2197"]]},{"id":"ed9f1ff0.4aa48","type":"function","z":"c9fba67e.2e3dc8","name":"set mac val together","func":"let newPayload = []\nlet actInfo = msg['actInfo']\nlet c_mac = ''\nlet macs = actInfo['mac']\nlet messages = actInfo['message']\nlet macObj = {}\nlet dlObj = {}\nfor(let i = 0 ; i < macs.length ; i++){\n  let macSplit = macs[i].split('_')\n  c_mac = macSplit[0]\n  let val = macObj[c_mac]\n  if(val !== undefined){\n    val = val + messages[i]+''\n  }else{\n    val = messages[i]+''\n  }\n  macObj[c_mac] = val\n  dlObj[macs[i]] = messages[i]+''\n}\n\nfor(let x in macObj){\n  let tmp = {}\n  tmp['mac'] = x\n  tmp['message'] = macObj[x]\n  newPayload.push(tmp)\n}\nmsg['dlObj'] = dlObj\nmsg.payload = newPayload\nmsg['macSize'] = newPayload.length\nreturn msg","outputs":1,"noerr":0,"x":1379,"y":847,"wires":[["defbb68e.220878"]]},{"id":"defbb68e.220878","type":"split","z":"c9fba67e.2e3dc8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1356,"y":900,"wires":[["b6c325fd.856388","dd6ee50e.e08178"]]},{"id":"b6c325fd.856388","type":"function","z":"c9fba67e.2e3dc8","name":"set condition to metadata","func":"msg['macObj'] = msg.payload\nlet newPayload = {}\nnewPayload['macAddr'] = msg.payload.mac\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1362,"y":953,"wires":[["94e9939f.d1bea"]]},{"id":"21b3bb9.9616144","type":"switch","z":"c9fba67e.2e3dc8","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1527,"y":990,"wires":[["7e8795b9.690a0c"],["a7403cd.f6ac4c"]]},{"id":"7e8795b9.690a0c","type":"function","z":"c9fba67e.2e3dc8","name":"get status ","func":"let actInfo = msg['actInfo']\nlet dlObj = msg['dlObj']\nlet newPayload = []\nlet dlSize = msg.payload[0].dl !== undefined ? msg.payload[0].dl.len !== undefined ? msg.payload[0].dl.len : 4 : 4\nlet dlVal = msg.payload[0].dl !== undefined ? msg.payload[0].dl.val !== undefined ? msg.payload[0].dl.val : 0 : 0\nif(msg.payload[0].device !== undefined){\n  let vDevice = {}\n  for(let i = 0 ; i < dlSize ; i++){\n    let pushObj = {}\n    vDevice = msg.payload[0].device[i]\n    if(vDevice !== undefined){\n      pushObj['macAddr'] = vDevice.macAddr\n      if(dlObj[vDevice['macAddr']] !== undefined){\n        pushObj['val'] = dlObj[vDevice['macAddr']]\n      }else{\n        let tar = getTarget(vDevice.replace)\n        if(tar !== ''){\n          pushObj['val'] = ''\n          pushObj['replace'] = tar\n        }else{\n          pushObj['val'] = dlVal+''\n        }\n      }\n    }else{\n      pushObj['macAddr'] = 'notexist'+i\n      pushObj['val'] = dlVal+''\n    }\n    newPayload.push(pushObj)\n  }\n}\nif(msg.payload[0].dl !== undefined && msg.payload[0].dl.topic !== undefined){\n  msg['topic'] = msg.payload[0].dl.topic\n}\nif(actInfo.topic != undefined)\n  msg['topic'] = actInfo.topic\nmsg.payload = newPayload\nreturn msg\nfunction getTarget(r){\n  for(let i = 0 ; i < r.length ; i++){\n    if(r[i].target.indexOf('information') != -1){\n      return r[i].target\n    }\n  }\n  return ''\n}","outputs":1,"noerr":0,"x":1682,"y":973,"wires":[["b4d5230b.6db82","4f58ca6c.ac3f74"]]},{"id":"94e9939f.d1bea","type":"mongodb in","z":"c9fba67e.2e3dc8","mongodb":"21e9f69a.3cd2ca","name":"get metadata by mac","collection":"metadata","operation":"find","x":1348,"y":996,"wires":[["21b3bb9.9616144"]]},{"id":"b4d5230b.6db82","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1730,"y":884,"wires":[]},{"id":"26bb1330.a4a30c","type":"switch","z":"c9fba67e.2e3dc8","name":"check mac array","property":"isArray","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":3298,"y":707,"wires":[["3d59d542.913dba"],["94f58fbd.b1d1c"]]},{"id":"94f58fbd.b1d1c","type":"join","z":"c9fba67e.2e3dc8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3461,"y":743,"wires":[["3d59d542.913dba"]]},{"id":"c8f2d253.dd0a3","type":"http request","z":"4632a2e7.644ccc","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":123,"y":295,"wires":[["4fede4be.53f65c"]]},{"id":"4fede4be.53f65c","type":"function","z":"4632a2e7.644ccc","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":118,"y":238,"wires":[["b2c657b6.bfc2e8"]]},{"id":"b2c657b6.bfc2e8","type":"switch","z":"4632a2e7.644ccc","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":117,"y":189,"wires":[["41b936bd.b2cd18"],["a2c0a244.5b7cd"]]},{"id":"a2c0a244.5b7cd","type":"http response","z":"4632a2e7.644ccc","name":"","statusCode":"","headers":{},"x":369.5,"y":212,"wires":[]},{"id":"49546933.c39008","type":"http request","z":"111006a3.51e0a9","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":159,"y":1608,"wires":[["531fc1b9.ef08e"]]},{"id":"531fc1b9.ef08e","type":"function","z":"111006a3.51e0a9","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":154,"y":1551,"wires":[["fe223a13.9af198"]]},{"id":"fe223a13.9af198","type":"switch","z":"111006a3.51e0a9","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":153,"y":1502,"wires":[["d481bde1.26546"],["26872911.3f3a86"]]},{"id":"26872911.3f3a86","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":423.5,"y":1562,"wires":[]},{"id":"3f6377c9.8f8ee8","type":"http request","z":"111006a3.51e0a9","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":129,"y":887,"wires":[["208aee36.08d582"]]},{"id":"208aee36.08d582","type":"function","z":"111006a3.51e0a9","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":124,"y":830,"wires":[["8679f341.9a93"]]},{"id":"8679f341.9a93","type":"switch","z":"111006a3.51e0a9","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":123,"y":781,"wires":[["1e517465.03f90c"],["ef96f0e8.0db92"]]},{"id":"ef96f0e8.0db92","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":393.5,"y":841,"wires":[]},{"id":"7ff8facd.7257d4","type":"http request","z":"111006a3.51e0a9","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":132,"y":263,"wires":[["2406d51a.74598a"]]},{"id":"2406d51a.74598a","type":"function","z":"111006a3.51e0a9","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":127,"y":206,"wires":[["fbac70f.7a9109"]]},{"id":"fbac70f.7a9109","type":"switch","z":"111006a3.51e0a9","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":126,"y":157,"wires":[["89b3efb5.06ae9"],["bb951c9a.0bec5"]]},{"id":"bb951c9a.0bec5","type":"http response","z":"111006a3.51e0a9","name":"","statusCode":"","headers":{},"x":396.5,"y":217,"wires":[]},{"id":"ddc1582c.fdfee8","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":226,"y":3933,"wires":[["9f037a3f.52d1b8"]]},{"id":"9f037a3f.52d1b8","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":221,"y":3876,"wires":[["3a5f3f11.be9cc"]]},{"id":"3a5f3f11.be9cc","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":220,"y":3827,"wires":[["836c36b7.675098"],["ef4cc05e.3750e"]]},{"id":"ef4cc05e.3750e","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":490.5,"y":3887,"wires":[]},{"id":"93ac0d16.24ecc","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":224,"y":3245,"wires":[["774ef0f0.38947"]]},{"id":"774ef0f0.38947","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":219,"y":3188,"wires":[["bf771465.c8a598"]]},{"id":"bf771465.c8a598","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":218,"y":3139,"wires":[["cc06aee9.ab01d"],["c0420506.79c608"]]},{"id":"c0420506.79c608","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":488.5,"y":3199,"wires":[]},{"id":"d171e9c2.0e6928","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":200,"y":2273,"wires":[["5215cc80.d63874"]]},{"id":"5215cc80.d63874","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":195,"y":2228,"wires":[["4a2b0f72.57a03"]]},{"id":"4a2b0f72.57a03","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":194,"y":2179,"wires":[["57ceabda.a102c4"],["7dfd86d4.566228"]]},{"id":"7dfd86d4.566228","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":487.5,"y":2300,"wires":[]},{"id":"9b976870.911988","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":182,"y":1611,"wires":[["e6ca3de.9be9cc"],["c358eda0.702a7"]]},{"id":"e6209889.565ab8","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":183,"y":1660,"wires":[["9b976870.911988"]]},{"id":"db71756a.a19cc8","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":188,"y":1705,"wires":[["e6209889.565ab8"]]},{"id":"c358eda0.702a7","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":452.5,"y":1671,"wires":[]},{"id":"ffb52d96.15736","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":174,"y":1018,"wires":[["532882ff.69588c"]]},{"id":"532882ff.69588c","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":169,"y":973,"wires":[["fe09eb70.a51028"]]},{"id":"fe09eb70.a51028","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":168,"y":924,"wires":[["56df5ab5.6f4ee4"],["695c755.4d6108c"]]},{"id":"695c755.4d6108c","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":438.5,"y":984,"wires":[]},{"id":"9f82bedc.d25e","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":178,"y":172,"wires":[["4aeb597e.2a7468"],["78b41fa2.f0643"]]},{"id":"18f160df.c2534f","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":179,"y":221,"wires":[["9f82bedc.d25e"]]},{"id":"de102dcd.843e9","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":184,"y":266,"wires":[["18f160df.c2534f"]]},{"id":"78b41fa2.f0643","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":448.5,"y":232,"wires":[]},{"id":"7adeca1e.72fe64","type":"http request","z":"c9fba67e.2e3dc8","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":146,"y":275,"wires":[["775d278a.4672f8"]]},{"id":"775d278a.4672f8","type":"function","z":"c9fba67e.2e3dc8","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":141,"y":230,"wires":[["8ffbed1a.0e485"]]},{"id":"8ffbed1a.0e485","type":"switch","z":"c9fba67e.2e3dc8","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":140,"y":181,"wires":[["de477fb6.dfe6f"],["e42ab870.b66498"]]},{"id":"e42ab870.b66498","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":410.5,"y":241,"wires":[]},{"id":"313640d8.4a4e2","type":"http request","z":"c9fba67e.2e3dc8","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":153,"y":1045,"wires":[["d4d0fea5.f0577"]]},{"id":"d4d0fea5.f0577","type":"function","z":"c9fba67e.2e3dc8","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":148,"y":1000,"wires":[["baf50419.155d18"]]},{"id":"baf50419.155d18","type":"switch","z":"c9fba67e.2e3dc8","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":147,"y":951,"wires":[["f4d5780a.2be178"],["8ddda658.13f3d8"]]},{"id":"8ddda658.13f3d8","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":338.5,"y":994,"wires":[]},{"id":"d461892f.11a528","type":"http request","z":"a87a28e1.8a8c38","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":132,"y":1400,"wires":[["5bbde64a.7ca8f8"]]},{"id":"5bbde64a.7ca8f8","type":"function","z":"a87a28e1.8a8c38","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":127,"y":1355,"wires":[["1001330e.0538fd"]]},{"id":"1001330e.0538fd","type":"switch","z":"a87a28e1.8a8c38","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":126,"y":1306,"wires":[["883eef67.82ca7"],["2d7e8948.f998c6"]]},{"id":"2d7e8948.f998c6","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":317.5,"y":1349,"wires":[]},{"id":"ec004ba2.193a08","type":"http request","z":"a87a28e1.8a8c38","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":128,"y":834,"wires":[["f8edb3fb.eb53b"]]},{"id":"f8edb3fb.eb53b","type":"function","z":"a87a28e1.8a8c38","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":123,"y":789,"wires":[["b18d24c8.98e808"]]},{"id":"b18d24c8.98e808","type":"switch","z":"a87a28e1.8a8c38","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":122,"y":740,"wires":[["2018832f.8b211c"],["402cff28.bad56"]]},{"id":"402cff28.bad56","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":313.5,"y":783,"wires":[]},{"id":"2cfe618b.f6a04e","type":"http request","z":"a87a28e1.8a8c38","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":121,"y":267,"wires":[["fd3d6299.f1626"]]},{"id":"fd3d6299.f1626","type":"function","z":"a87a28e1.8a8c38","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":116,"y":222,"wires":[["9600c673.e2d748"]]},{"id":"9600c673.e2d748","type":"switch","z":"a87a28e1.8a8c38","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":115,"y":173,"wires":[["cea3db15.9f6988"],["54875784.cc1e88"]]},{"id":"54875784.cc1e88","type":"http response","z":"a87a28e1.8a8c38","name":"","statusCode":"","headers":{},"x":306.5,"y":216,"wires":[]},{"id":"727ee96a.500ad8","type":"http request","z":"17b8ee59.a67e72","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":170.9797019958496,"y":428.1606216430664,"wires":[["2693623.3cd249e"]]},{"id":"2693623.3cd249e","type":"function","z":"17b8ee59.a67e72","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":165.9797019958496,"y":383.1606216430664,"wires":[["6e2e7e45.3f693"]]},{"id":"6e2e7e45.3f693","type":"switch","z":"17b8ee59.a67e72","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":164.9797019958496,"y":334.1606216430664,"wires":[["3a25d603.1a1b1a"],["7dead21a.b2440c"]]},{"id":"7dead21a.b2440c","type":"http response","z":"17b8ee59.a67e72","name":"","statusCode":"","headers":{},"x":356.4797019958496,"y":377.1606216430664,"wires":[]},{"id":"6b1527f9.852338","type":"switch","z":"c9fba67e.2e3dc8","name":"check fport","property":"fport","propertyType":"msg","rules":[{"t":"neq","v":"168","vt":"str"},{"t":"eq","v":"168","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2030,"y":876,"wires":[["ff0d7070.cd607"],["806367a4.a16fe8"]]},{"id":"806367a4.a16fe8","type":"function","z":"c9fba67e.2e3dc8","name":"set keep previous","func":"let newPayload = {}\nnewPayload['macAddr'] = msg.payload.macAddr\nnewPayload['val'] = '2'\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":2067,"y":963,"wires":[["2ebcb7af.8017d8"]]},{"id":"b684fdd7.a0fc5","type":"function","z":"c9fba67e.2e3dc8","name":"combine val 168","func":"let actInfo = msg['actInfo']\nlet newMsg = ''\nfor(let i = 0 ; i < msg.payload.length ; i++){\n  let biStr = ('0' + parseInt(msg.payload[i].val).toString(2)).slice(-2)\n  newMsg = newMsg + biStr\n}\nnewMsg = '000000'+newMsg\nnewMsg = parseInt(newMsg, 2).toString(16)\nnewMsg = '0'+newMsg\nactInfo['message'] = newMsg\nmsg['actInfo'] = actInfo\nlet url = 'http://127.0.0.1:1886/event?token={token}&fport={fport}&macAddr={macAddr}&limit=1'\nurl = url.replace('{token}', encodeURIComponent(actInfo.token)).replace('{fport}',actInfo.fport).replace('{macAddr}', msg.payload[0].macAddr)\nmsg['url'] = url\nreturn msg","outputs":1,"noerr":0,"x":2637.5,"y":1030,"wires":[["53bf008a.7f8fd"]]},{"id":"53bf008a.7f8fd","type":"http request","z":"c9fba67e.2e3dc8","name":"","method":"GET","ret":"obj","url":"","tls":"","x":2833,"y":1031,"wires":[["9f05a001.ddf67","5f72ad5d.1af2c4"]]},{"id":"b09c1ec0.3941","type":"switch","z":"c9fba67e.2e3dc8","name":"check fport","property":"fport","propertyType":"msg","rules":[{"t":"neq","v":"168","vt":"str"},{"t":"eq","v":"168","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1991,"y":672,"wires":[["ccd98e9b.e124b"],["bad60c97.0c437"]]},{"id":"bad60c97.0c437","type":"function","z":"c9fba67e.2e3dc8","name":"check len and set topic","func":"let actInfo = msg['actInfo']\nlet checkFlg = false\nif(msg.payload[0].dl !== undefined){\n  if(msg.payload[0].dl.topic !== undefined){\n    msg['topic'] = msg.payload[0].dl.topic\n  }\n  if(msg.payload[0].dl.len !== undefined){\n    if(actInfo['message'].length == 2)\n      checkFlg = true\n  }\n}\nif(actInfo.topic != undefined)\n  msg['topic'] = actInfo.topic\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":2202,"y":699,"wires":[["3274716a.0afb8e"]]},{"id":"7917ee08.337ad","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to switch","func":"let newPayload = []\nlet data = {}\ndata['macAddr'] = msg.payload.macAddr\ndata['time'] = new Date()\ndata['data'] = msg.payload.val+'0'\ndata['channel'] = 000000000\ndata['sf'] = 9\ndata['gwip'] = '127.0.0.1'\ndata['gwid'] = '0000000000000000'\ndata['repeater'] = '00000000ffffffff'\ndata['systype'] = 1\ndata['rssi'] = 0\ndata['snr'] = 0\ndata['snr_max'] = 0\ndata['snr_min'] = 0\ndata['fport'] = 169\nnewPayload.push(data)\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":2278.5,"y":752,"wires":[["feab044.dfab5f8"]]},{"id":"35dfed40.71c012","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2425.5,"y":1061,"wires":[]},{"id":"feab044.dfab5f8","type":"function","z":"c9fba67e.2e3dc8","name":"set to obj","func":"msg['testData'] = msg.payload\nlet newPayload = []\nnewPayload.push(msg.payload[0].macAddr)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":2500.5,"y":737,"wires":[["3406f763.e43298"]]},{"id":"3406f763.e43298","type":"subflow:691153b7.0e855c","z":"c9fba67e.2e3dc8","x":2679.5,"y":741,"wires":[["5feed7e8.bb09e8"]]},{"id":"5feed7e8.bb09e8","type":"function","z":"c9fba67e.2e3dc8","name":"set frameCnt","func":"let testData = msg['testData']\nif(msg.payload != null){\n  testData[0].frameCnt = parseInt(msg.payload)+1\n}else{\n  testData[0].frameCnt = 1  \n}\nmsg.payload = testData\nreturn msg","outputs":1,"noerr":0,"x":2881.5,"y":751,"wires":[["427c5d58.2315b4","35dfed40.71c012"]]},{"id":"427c5d58.2315b4","type":"mqtt out","z":"c9fba67e.2e3dc8","name":"","topic":"GIOT-GW/UL/123456789","qos":"1","retain":"","broker":"a72e7e06.4e35","x":3134.5,"y":762,"wires":[]},{"id":"9f05a001.ddf67","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":3008.5,"y":1056,"wires":[]},{"id":"2a19baab.10c8f6","type":"debug","z":"a87a28e1.8a8c38","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":835.5,"y":536,"wires":[]},{"id":"5f72ad5d.1af2c4","type":"function","z":"c9fba67e.2e3dc8","name":"set keepAlive","func":"let keepAlive = '1'\nlet newMessage = '0000'\nlet actInfo = msg['actInfo']\nlet macObj = msg['macObj']\nlet newPayload = []\nlet cmd = {}\nlet extra = {}\nlet data = ''\nif(msg.payload.responseCode == '000'){\n  if(msg.payload.total > 0){\n    let event = msg.payload.data[0]\n    keepAlive = event.information.keepAlive\n  }\n}\nkeepAlive = parseInt(keepAlive, 10).toString(16)\nkeepAlive = ('0000'+keepAlive).slice(-4)\nnewMessage = (newMessage+actInfo.message).slice(-4)\ndata = newMessage+keepAlive\nextra['port'] = 1\nextra['txpara'] = '22'\nextra['fport'] = actInfo.fport\ncmd['extra'] = extra\ncmd['macAddr'] = macObj['mac']\ncmd['data'] = data\ncmd['recv'] = new Date()\ncmd['id'] = getRandomNumber(1000)\nnewPayload.push(cmd)\nactInfo['message'] = newPayload\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":3053.5,"y":1000,"wires":[["b5d0de5c.33d16"]]},{"id":"b1d21fe.b946be","type":"delay","z":"c9fba67e.2e3dc8","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3489.5,"y":651,"wires":[["bd30d41c.9bda58","e02c6bbc.bd6bd8"]]},{"id":"4b086086.bd12e","type":"http request","z":"13cff304.82a29d","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/sys?token={{token}}&search=DL_DELAY_TIME","tls":"","x":312.5,"y":169,"wires":[[]]},{"id":"b76d5573.07d338","type":"subflow:13cff304.82a29d","z":"c9fba67e.2e3dc8","x":475.5,"y":723,"wires":[["110bdfa0.d37fb"]]},{"id":"110bdfa0.d37fb","type":"function","z":"c9fba67e.2e3dc8","name":"set delay","func":"let delayTime = 0\nlet delayInfo = msg.payload\nif(delayInfo['responseCode'] == '000'){\n  let props = delayInfo['props']\n  delayTime = parseInt(props[0]['p_value'])\n  msg['msgPreviousDelay'] = 0\n}\nmsg['msgDelay'] = delayTime\n\nreturn msg","outputs":1,"noerr":0,"x":681.5,"y":712,"wires":[["c7020dc1.3ff49"]]},{"id":"18bcadb7.18c592","type":"function","z":"c9fba67e.2e3dc8","name":"Increment the delay","func":"let parts = msg['parts'] !== undefined ? msg['parts'] : {'index':0}\nlet idx = parts['index']\nlet thisDelay = 0\nif (msg['msgDelay'] !== undefined) {\n  if(msg['msgDelay'] > 0){\n    thisDelay = msg['msgDelay'] * idx + msg['msgDelay']\n  }\n}\nnode.warn('thisDelay:'+thisDelay)\nmsg.delay = thisDelay\n\nreturn msg","outputs":1,"noerr":0,"x":3315,"y":664,"wires":[["b1d21fe.b946be"]]},{"id":"dd6ee50e.e08178","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1522.5,"y":887,"wires":[]},{"id":"ee7ab733.c22f88","type":"switch","z":"c9fba67e.2e3dc8","name":"check fport","property":"fport","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1338.5,"y":550,"wires":[["5ed39b75.0f51d4"],["a9fd9fda.98df"],["c42ab664.ade258"]]},{"id":"5030bf8c.b2197","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to split","func":"let actInfo = msg['actInfo']\nlet macArray = actInfo['mac']\nlet msgArray = actInfo['message']\nlet dlArray = []\nfor(let i = 0 ; i < macArray.length ; i++){\n  let tmp = {}\n  tmp['mac'] = macArray[i]\n  tmp['msg'] = msgArray[i]\n  dlArray.push(tmp)\n}\nmsg.payload = dlArray\nreturn msg","outputs":1,"noerr":0,"x":1311.5,"y":664,"wires":[["7609011f.fddc3"]]},{"id":"7609011f.fddc3","type":"split","z":"c9fba67e.2e3dc8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1302,"y":619,"wires":[["ee7ab733.c22f88"]]},{"id":"5ed39b75.0f51d4","type":"function","z":"c9fba67e.2e3dc8","name":"get tag info","func":"let newPayload = {}\nnewPayload['deveui'] = msg.payload['mac']\nmsg.limit = 1\nmsg.skip = 0\nmsg['dlObj'] = msg.payload\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1517.5,"y":489,"wires":[["5dc0d08b.f53a"]]},{"id":"5dc0d08b.f53a","type":"mongodb in","z":"c9fba67e.2e3dc8","mongodb":"21e9f69a.3cd2ca","name":"get tag by deveui","collection":"tags","operation":"find","x":1707,"y":490,"wires":[["57299fb6.6b50a"]]},{"id":"57299fb6.6b50a","type":"switch","z":"c9fba67e.2e3dc8","name":"check tag","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1892.5,"y":531,"wires":[["fa64a42c.441848"],["174dbe0d.fc4632"]]},{"id":"174dbe0d.fc4632","type":"function","z":"c9fba67e.2e3dc8","name":"set dataset fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'tag not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2084,"y":560,"wires":[["bd02b1e9.9936e"]]},{"id":"bd02b1e9.9936e","type":"http response","z":"c9fba67e.2e3dc8","name":"","statusCode":"","headers":{},"x":2776.5,"y":559,"wires":[]},{"id":"fa64a42c.441848","type":"function","z":"c9fba67e.2e3dc8","name":"check tagInfo","func":"let dlObj = msg['dlObj']\nlet tagInfo = msg.payload\nlet msgObj = dlObj['msg']\nlet dlFlg = false\nif(tagInfo['period_report_timer'] != msgObj['period_report_timer'] || tagInfo['normal_channel'] != msgObj['normal_channel'] || tagInfo['trigger_channel'] != msgObj['trigger_channel']){\n  dlFlg = true     \n}\nmsg['dlFlg'] = dlFlg\nreturn msg","outputs":1,"noerr":0,"x":2071.5,"y":497,"wires":[["1e7f340d.eca62c"]]},{"id":"1e7f340d.eca62c","type":"switch","z":"c9fba67e.2e3dc8","name":"check dlFlg","property":"dlFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2280.5,"y":459,"wires":[["2a1eac83.126a04","5e328843.184228"],["684ba52c.0f1a1c"]]},{"id":"2a1eac83.126a04","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to mqtt","func":"let dlObj = msg['dlObj']\nlet msgObj = dlObj['msg']\nlet actInfo = msg['actInfo']\nlet tagInfo = msg.payload[0]\nlet newPayload = {}\nlet dldata = {}\nlet extra = {}\nlet data = ''\nextra['port'] = parseInt(msg.fport)\nextra['txpara'] = '12'\nextra['gwid'] = '00001c497be8745a'\ndldata['extra'] = extra\ndldata['macAddr'] = dlObj['mac']\n//combine data\ndata = '8001'\nlet detect_timer = tagInfo['detect_timer']\nlet detect_delay_timer = tagInfo['detect_delay_timer']\nlet period_report_timer = msgObj['period_report_timer'] !== undefined ? msgObj['period_report_timer'] : tagInfo['period_report_timer']\nlet trigger_channel = msgObj['trigger_channel'] !== undefined ? msgObj['trigger_channel'] : tagInfo['trigger_channel']\nlet normal_channel = msgObj['normal_channel'] !== undefined ? msgObj['normal_channel'] : tagInfo['normal_channel']\n//detect_timer\ndetect_timer = parseHex(detect_timer, 4)\ndetect_timer = reverseStr(detect_timer)\ndata = data + detect_timer\n//detect_delay_timer\ndetect_delay_timer = parseHex(detect_delay_timer, 4)\ndetect_delay_timer = reverseStr(detect_delay_timer)\ndata = data + detect_delay_timer\n\n//period_report_timer\nperiod_report_timer = parseHex(period_report_timer, 8)\nperiod_report_timer = reverseStr(period_report_timer)\ndata = data + period_report_timer\n\n//trigger_channel\ntrigger_channel = trigger_channel * 1000000\ntrigger_channel = parseHex(trigger_channel, 8)\ntrigger_channel = reverseStr(trigger_channel)\ndata = data + trigger_channel\n\n//normal_channel\nnormal_channel = normal_channel * 1000000\nnormal_channel = parseHex(normal_channel, 8)\nnormal_channel = reverseStr(normal_channel)\ndata = data + normal_channel\n\n//devAddr\ndata = data + tagInfo['devAddr']\n//ap_key\ndata = data + tagInfo['ap_key']\n//ap_eui\ndata = data + tagInfo['ap_eui']\n//reboot\ndata = data + '01'\n\n//crc\nlet crc = getCRC(data)\ndata = data + crc\n\ndldata['data'] = data\nnewPayload['correlationId'] = '80-'+dlObj['mac']+'-'+Date.now()\nnewPayload['dldata'] = dldata\nactInfo.message = newPayload\nmsg['actInfo'] = actInfo\nmsg.topic = 'df.test.dldata'\nreturn msg\nfunction parseHex(str, len){\n  let bi = parseInt(str).toString(16)\n  let fillStr = '0'\n  for(let i = 0 ; i < len ; i++){\n    fillStr = fillStr + '0'\n  }\n  len = len * -1\n  bi = (fillStr+bi).slice(len)\n  return bi\n}\nfunction reverseStr(str){\n  let cnt = str.length / 2\n  var bi = ''\n  var tmp = []\n  for(let i = 0 ; i < cnt ; i++){\n    let st = i*2\n    var pop = str.substr(st, 2)\n    tmp.push(pop)\n  }\n  for(let j = tmp.length -1 ; j >= 0 ; j--){\n    bi = bi+tmp[j]\n  }\n  return bi\n}\nfunction getCRC(str){\n\n  let cnt = str.length / 2\n  let crc\n  for(let i = 0 ; i < cnt ; i++){\n    let st = i*2\n    let pop = str.substr(st, 2)\n    if(pop !== ''){\n      if(i == 0){\n        crc = parseInt(pop, 16)\n      }else{\n        crc ^= parseInt(pop, 16)\n      }\n    }\n  }\n  crc = ('00'+crc.toString(16)).slice(-2)\n  return crc\n}","outputs":1,"noerr":0,"x":2523.5,"y":415,"wires":[["b5d0de5c.33d16"]]},{"id":"5e328843.184228","type":"function","z":"c9fba67e.2e3dc8","name":"update unconfirm tag info","func":"let tagInfo = msg.payload[0]\nlet dlObj = msg['dlObj']\nlet msgObj = dlObj['msg']\nif(msgObj['period_report_timer'] !== undefined){\n  if(msgObj['period_report_timer'] != tagInfo['period_report_timer'])\n    tagInfo['period_report_timer_uncofirm'] = msgObj['period_report_timer']\n}\nif(msgObj['trigger_channel'] !== undefined){\n  if(msgObj['trigger_channel'] != tagInfo['trigger_channel'])\n    tagInfo['trigger_channel_uncofirm'] = msgObj['trigger_channel'].toFixed(1)  \n}\nif(msgObj['normal_channel'] !== undefined){\n  if(msgObj['normal_channel'] != tagInfo['normal_channel'])\n    tagInfo['normal_channel_uncofirm'] = msgObj['normal_channel'].toFixed(1)\n}\nmsg.payload = tagInfo\nreturn msg","outputs":1,"noerr":0,"x":2514.5,"y":372,"wires":[["388c7389.d78bec"]]},{"id":"388c7389.d78bec","type":"mongodb out","z":"c9fba67e.2e3dc8","mongodb":"21e9f69a.3cd2ca","name":"","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"store","x":2809.5,"y":349,"wires":[]},{"id":"33e34f94.8d1d1","type":"switch","z":"c9fba67e.2e3dc8","name":"systemFlg","property":"systemFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":150.5,"y":1102,"wires":[["ca17cb1e.fd6a58"],["313640d8.4a4e2"]]},{"id":"684ba52c.0f1a1c","type":"function","z":"c9fba67e.2e3dc8","name":"set dataset fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '403'\nnewPayload['responseMsg'] = 'no changes'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2301,"y":511,"wires":[["bd02b1e9.9936e"]]},{"id":"a9fd9fda.98df","type":"function","z":"c9fba67e.2e3dc8","name":"set payload to mqtt","func":"let actInfo = msg['actInfo']\nlet dlInfo = msg.payload\nlet newPayload = {}\nlet dldata = {}\nlet extra = {}\nlet dlMsg = actInfo['message']\nlet data = ''\nextra['port'] = 2\nextra['txpara'] = '12'\nextra['gwid'] = dlMsg['gwid']\ndldata['extra'] = extra\ndldata['macAddr'] = actInfo['mac']\n\nlet cmdId = dlMsg['data'].substring(0, 2)\n//crc\nlet crc = getCRC(dlMsg['data'])\ndata = dlMsg['data'] + crc\n\ndldata['data'] = data\nnewPayload['correlationId'] = cmdId +'-'+ actInfo['mac']+'-'+Date.now()\nnewPayload['dldata'] = dldata\nactInfo.message = newPayload\nmsg['actInfo'] = actInfo\nmsg.topic = 'df.test.dldata'\nreturn msg\nfunction getCRC(str){\n\n  let cnt = str.length / 2\n  let crc\n  for(let i = 0 ; i < cnt ; i++){\n    let st = i*2\n    let pop = str.substr(st, 2)\n    if(pop !== ''){\n      if(i == 0){\n        crc = parseInt(pop, 16)\n      }else{\n        crc ^= parseInt(pop, 16)\n      }\n    }\n  }\n  crc = ('00'+crc.toString(16)).slice(-2)\n  return crc\n}","outputs":1,"noerr":0,"x":2632,"y":505,"wires":[["ee79d15d.e94dc","b5d0de5c.33d16"]]},{"id":"ee79d15d.e94dc","type":"debug","z":"c9fba67e.2e3dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2916.5,"y":434,"wires":[]},{"id":"4a3ad194.9749d","type":"http in","z":"4632a2e7.644ccc","name":"","url":"/gw/login","method":"post","upload":false,"swaggerDoc":"","x":125,"y":1085,"wires":[["ec293e9c.90475"]]},{"id":"ec293e9c.90475","type":"switch","z":"4632a2e7.644ccc","name":"cehck acc","property":"payload.acc","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":127.5,"y":1027,"wires":[["163b6a56.22fd36"],["43180c8b.1ddee4"]]},{"id":"163b6a56.22fd36","type":"switch","z":"4632a2e7.644ccc","name":"cehck pwd","property":"payload.pwd","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":122,"y":970,"wires":[["76af622c.04a6ac"],["43180c8b.1ddee4"]]},{"id":"43180c8b.1ddee4","type":"function","z":"4632a2e7.644ccc","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":353,"y":1003,"wires":[["255ef488.11aefc"]]},{"id":"255ef488.11aefc","type":"http response","z":"4632a2e7.644ccc","name":"","statusCode":"","headers":{},"x":604.5,"y":807,"wires":[]},{"id":"76af622c.04a6ac","type":"function","z":"4632a2e7.644ccc","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":129.5,"y":922,"wires":[["80569043.671f4"]]},{"id":"80569043.671f4","type":"function","z":"4632a2e7.644ccc","name":"set device query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select device_type, deviceId, device_mac, device_name, device_type, device_active_time, device_bind_time, device_cp_id, device_user_id, device_status, device_share, remark, device_IoT_org, device_IoT_type, case when device_status = 0 then \"unopened\" when device_status = 1 then \"active\"  when device_status = 2 then \"binding\" when device_status = 3 then \"in used\" else \"unknown\" end as statusDesc  from api_device_info where device_type = \"159\"'\nsqlStr += ' and device_mac = '+actInfo.acc\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":132.5,"y":877,"wires":[["ae194f8d.b74bd"]]},{"id":"ae194f8d.b74bd","type":"subflow:cdf3e7e3.4b3ec8","z":"4632a2e7.644ccc","x":136.5,"y":830,"wires":[["bd1dc7d2.10a2d8"]]},{"id":"bd1dc7d2.10a2d8","type":"switch","z":"4632a2e7.644ccc","name":"cehck result","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":144.5,"y":772,"wires":[["cc375f55.84f3b"],["cfbb7140.15093"]]},{"id":"cfbb7140.15093","type":"function","z":"4632a2e7.644ccc","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'Device not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":354,"y":821,"wires":[["255ef488.11aefc"]]},{"id":"cc375f55.84f3b","type":"function","z":"4632a2e7.644ccc","name":"set secret","func":"let deviceInfo = msg.payload[0]\nmsg.payload = deviceInfo.device_IoT_secret\nreturn msg","outputs":1,"noerr":0,"x":152.5,"y":725,"wires":[["a38a18fc.9c7878"]]},{"id":"a38a18fc.9c7878","type":"decrypt","z":"4632a2e7.644ccc","name":"","algorithm":"TripleDES","key":"gemtekdevice","x":158.5,"y":676,"wires":[["e7b674c2.85aa08"]]},{"id":"e7b674c2.85aa08","type":"function","z":"4632a2e7.644ccc","name":"check secret","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nif(actInfo.pwd === msg.payload){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'login success'\n}else{\n  newPayload['responseCode'] = '403'\n  newPayload['responseMsg'] = 'password incorrect'\n}\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":177.5,"y":630,"wires":[["255ef488.11aefc"]]},{"id":"6a6d892.0941f78","type":"switch","z":"4632a2e7.644ccc","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":128.5,"y":339,"wires":[["c8f2d253.dd0a3"],["9eb35cbd.33433"]]},{"id":"91051b85.2fdfa8","type":"switch","z":"111006a3.51e0a9","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":134,"y":316,"wires":[["7ff8facd.7257d4"],["d9461df8.a864b"]]},{"id":"9ec93abf.4f8798","type":"switch","z":"a87a28e1.8a8c38","name":"","property":"payload.affectedRows","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1612.5,"y":43,"wires":[["c54ff18c.3b435"],["7fd281f8.ed133"]]},{"id":"c54ff18c.3b435","type":"function","z":"a87a28e1.8a8c38","name":"set payload to notification-svc","func":"let headers = {}\nheaders['Authorization'] = 'Bearer 1674a1969e6a5665f2140db0f9369a76'\nmsg['mysqlPayload'] = msg.payload\nmsg.payload = msg['terminalObj']\nmsg.headers = headers\nreturn msg","outputs":1,"noerr":0,"x":1853.5,"y":36,"wires":[["6a7d652f.33942c"]]},{"id":"6a7d652f.33942c","type":"http request","z":"a87a28e1.8a8c38","name":"insert to notification","method":"POST","ret":"obj","paytoqs":false,"url":"http://notification-svc:8080/notice-business/terminal/add","tls":"","proxy":"","x":2117.5,"y":30,"wires":[["46535911.421718"]]},{"id":"46535911.421718","type":"function","z":"a87a28e1.8a8c38","name":"set mysql result to payload","func":"msg.payload = msg['mysqlPayload']\nreturn msg","outputs":1,"noerr":0,"x":2357.5,"y":32,"wires":[["7fd281f8.ed133"]]},{"id":"8ef9d2b8.89361","type":"switch","z":"a87a28e1.8a8c38","name":"","property":"payload.affectedRows","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1092,"y":1110,"wires":[["6b0244c.54bdabc"],["6634c8e4.751768"]]},{"id":"6b0244c.54bdabc","type":"function","z":"a87a28e1.8a8c38","name":"set payload to notification-svc","func":"let headers = {}\nlet terminalObj = {}\nlet filterObj = {}\nfilterObj['mac'] = msg['mac']\nterminalObj['page'] = 1\nterminalObj['size'] = 1\nheaders['Authorization'] = 'Bearer 1674a1969e6a5665f2140db0f9369a76'\nmsg['mysqlPayload'] = msg.payload\nmsg.payload = terminalObj\nmsg.headers = headers\nreturn msg","outputs":1,"noerr":0,"x":1333,"y":1103,"wires":[["173e82be.99303d"]]},{"id":"173e82be.99303d","type":"http request","z":"a87a28e1.8a8c38","name":"get device from notification","method":"POST","ret":"obj","paytoqs":false,"url":"http://notification-svc:8080/notice-business/terminal/query","tls":"","proxy":"","x":1627,"y":1097,"wires":[["649fcb24.8b30b4"]]},{"id":"649fcb24.8b30b4","type":"function","z":"a87a28e1.8a8c38","name":"set delId to notification-svc","func":"let result = msg.payload\nlet headers = {}\nlet terminalObj = {}\nlet filterObj = {}\nlet delId = -1\nif(result.code == 1000){\n  let d = result['data']\n  delId = d[0].id\n}\nfilterObj['id'] = delId\nterminalObj['filter'] = filterObj\nterminalObj['userId'] = 1\nheaders['Authorization'] = 'Bearer 1674a1969e6a5665f2140db0f9369a76'\nmsg.payload = terminalObj\nmsg.headers = headers\nreturn msg","outputs":1,"noerr":0,"x":1899,"y":1095,"wires":[["66aad7ba.ff9148"]]},{"id":"e9946f07.04769","type":"function","z":"a87a28e1.8a8c38","name":"set sql get mac","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select device_mac FROM `api_device_info` WHERE `deviceId` =' + actInfo.id\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":413,"y":1129,"wires":[["a8158ae5.7c7ac8"]]},{"id":"a8158ae5.7c7ac8","type":"subflow:cdf3e7e3.4b3ec8","z":"a87a28e1.8a8c38","x":427,"y":1064,"wires":[["361da71c.734c28"]]},{"id":"361da71c.734c28","type":"switch","z":"a87a28e1.8a8c38","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":607.5,"y":1062,"wires":[["721f054a.6c1f9c"],["7d25bcc0.420c64"]]},{"id":"7d25bcc0.420c64","type":"function","z":"a87a28e1.8a8c38","name":"set 404 result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'device not exist'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":973,"y":1200,"wires":[["2a49bf63.1e14e"]]},{"id":"66aad7ba.ff9148","type":"http request","z":"a87a28e1.8a8c38","name":"del device from notification","method":"POST","ret":"obj","paytoqs":false,"url":"http://notification-svc:8080/notice-business/terminal/delete","tls":"","proxy":"","x":1511,"y":1179,"wires":[["cd74cab8.d972b8"]]},{"id":"cd74cab8.d972b8","type":"function","z":"a87a28e1.8a8c38","name":"set mysql result to payload","func":"msg.payload = msg['mysqlPayload']\nreturn msg","outputs":1,"noerr":0,"x":1836,"y":1177,"wires":[["6634c8e4.751768"]]},{"id":"82d50652.a69f08","type":"function","z":"111006a3.51e0a9","name":"set sep query","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['macAddr'] = actInfo.mac\nnewPayload['type'] = 'sep'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1752,"y":818,"wires":[["a05c06ae.9b0068"]]},{"id":"a05c06ae.9b0068","type":"mongodb in","z":"111006a3.51e0a9","mongodb":"21e9f69a.3cd2ca","name":"get sep by mac","collection":"metadata","operation":"find","x":1984,"y":796,"wires":[["6e8f63ea.eae2fc"]]},{"id":"6e8f63ea.eae2fc","type":"function","z":"111006a3.51e0a9","name":"set returnObj","func":"let returnObj = msg['returnObj']\nlet newPayload = {}\nlet sep = {}\nif(msg.payload.length > 0){\n    sep = msg.payload[0]\n}\nreturnObj['sep'] = sep\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['device'] = returnObj\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1914,"y":591,"wires":[["dcf4498b.6585d8"]]},{"id":"721f054a.6c1f9c","type":"function","z":"a87a28e1.8a8c38","name":"set payload to del metadata","func":"let newPayload = {}\nnewPayload['macAddr'] = msg.payload[0].device_mac\nmsg['mac'] = msg.payload[0].device_mac\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":800,"y":1029,"wires":[["e67c0b91.498358","91351190.4b2e8"]]},{"id":"91351190.4b2e8","type":"mongodb out","z":"a87a28e1.8a8c38","mongodb":"21e9f69a.3cd2ca","name":"update meta","collection":"metadata","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":1117,"y":977,"wires":[]},{"id":"57ab4e2e.1630a","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tag by _id","collection":"tags","operation":"find","x":528.2857055664062,"y":2093,"wires":[["188df6bf.2bee49"]]},{"id":"ba080fc9.876e1","type":"function","z":"b38da013.ce2ec","name":"set info to update","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = msg.payload[0]\nlet infoObj = msg.payload[0].information\ninfoObj['type'] = Number(obj.type)\nnewPayload['information'] = infoObj\nnewPayload['name'] = obj.name\nif(obj['data'] !== undefined)\n  newPayload['data'] = obj['data']\nnewPayload['updateTs'] = Date.now()\nnewPayload['updateDt'] = new Date()\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":958,"y":2034,"wires":[["8c55a0e2.724d6","d4a13c04.0541a"]]},{"id":"188df6bf.2bee49","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":716.5,"y":2048,"wires":[["ba080fc9.876e1"],["d86b871e.1b5108"]]},{"id":"d86b871e.1b5108","type":"function","z":"b38da013.ce2ec","name":"set tag not exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'Tag not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":769,"y":2118,"wires":[["3ece233b.067e1c"]]},{"id":"a5e02242.43d0b","type":"function","z":"b38da013.ce2ec","name":"set id to find","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['_id'] = obj['objId']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":431.5714416503906,"y":2046.571533203125,"wires":[["57ab4e2e.1630a"]]},{"id":"76e0ffb0.ae0c4","type":"function","z":"b38da013.ce2ec","name":"set id to find","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['_id'] = obj['_id']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":389.8571548461914,"y":1983.9999656677246,"wires":[["3cc7fc5e.253bc4"]]},{"id":"3cc7fc5e.253bc4","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tag by _id","collection":"tags","operation":"find","x":532,"y":1921,"wires":[["962f6533.5ffaa8"]]},{"id":"962f6533.5ffaa8","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":699,"y":1918,"wires":[["ea29e015.0fa39"],["346668bf.912d38"]]},{"id":"ea29e015.0fa39","type":"function","z":"b38da013.ce2ec","name":"set tag exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '500'\nnewPayload['responseMsg'] = 'Tag already exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1021,"y":1881,"wires":[["3ece233b.067e1c"]]},{"id":"25715c47.0e01a4","type":"switch","z":"b38da013.ce2ec","name":"check locale","property":"payload.locale.length","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":199,"y":1801,"wires":[["121b8336.c41ced"],["84589e43.d30d9"]]},{"id":"d1ce45cc.573848","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":997,"y":1398,"wires":[]},{"id":"2a3e7161.b0c35e","type":"http in","z":"b38da013.ce2ec","name":"","url":"/tag/:type/:id","method":"delete","upload":false,"swaggerDoc":"","x":260,"y":4742,"wires":[["4a1c13b5.41166c","df212d82.ffd42"]]},{"id":"df212d82.ffd42","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":251.28570365905762,"y":4687.285683631897,"wires":[["681e6f3a.9a745"],["e5b18dfc.0f266"]]},{"id":"681e6f3a.9a745","type":"function","z":"b38da013.ce2ec","name":"set para to obj","func":"msg.payload['id'] = msg.req.params.id\nmsg.payload['type'] = msg.req.params.type\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":241.78570175170898,"y":4634.285690307617,"wires":[["b87fa667.1cc7c8"]]},{"id":"9467e847.1d7b08","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n    msg['roleId'] = actInfo['roleId']\n}\nreturn msg","outputs":1,"noerr":0,"x":242.78570556640625,"y":4412.2856798172,"wires":[["6da3a524.4714dc"]]},{"id":"6da3a524.4714dc","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":254.59089279174805,"y":4361.921920776367,"wires":[["6fe01b81.2bc3f4"],["75e84f18.e314b"]]},{"id":"75e84f18.e314b","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":546.7857055664062,"y":4457.2856798172,"wires":[["47b5b7b0.3ad7c8"]]},{"id":"e5b18dfc.0f266","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":554.0714225769043,"y":4660.142868041992,"wires":[["47b5b7b0.3ad7c8"]]},{"id":"4a1c13b5.41166c","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":505.8571586608887,"y":4733.714401245117,"wires":[]},{"id":"6fe01b81.2bc3f4","type":"switch","z":"b38da013.ce2ec","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":450.2857303619385,"y":4342.558426856995,"wires":[["fd481fff.2bff1"],["6d3ca692.143bd8"]]},{"id":"6d3ca692.143bd8","type":"function","z":"b38da013.ce2ec","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":651.2857532501221,"y":4392.558388710022,"wires":[["47b5b7b0.3ad7c8"]]},{"id":"fd481fff.2bff1","type":"function","z":"b38da013.ce2ec","name":"check tag exist","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nnewPayload['information.id'] = actInfo.id\nnewPayload['information.type'] = parseInt(actInfo.type)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":669.8189659118652,"y":4326.868169784546,"wires":[["7cda97b.58ead68"]]},{"id":"47b5b7b0.3ad7c8","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":1597.696403503418,"y":4735.110531806946,"wires":[]},{"id":"7cda97b.58ead68","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tag by id and type","collection":"tags","operation":"find","x":899.5714683532715,"y":4328.921747207642,"wires":[["e2f22b45.313928"]]},{"id":"e2f22b45.313928","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1098.1429977416992,"y":4324.636198043823,"wires":[["772484f6.1cc24c"],["ef1f5a14.5235b8"]]},{"id":"ef1f5a14.5235b8","type":"function","z":"b38da013.ce2ec","name":"set no tag","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'tag not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1042.4286308288574,"y":4411.779098510742,"wires":[["47b5b7b0.3ad7c8"]]},{"id":"772484f6.1cc24c","type":"function","z":"b38da013.ce2ec","name":"set info to delete","func":"let updateObj = msg.payload[0]\nmsg.payload = updateObj\nreturn msg","outputs":1,"noerr":0,"x":1259.2125244140625,"y":4268.64501953125,"wires":[["6f3263ee.a4afac","19363ea2.c53831"]]},{"id":"6f3263ee.a4afac","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"delete tag","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":1815.2205848693848,"y":4248.073448181152,"wires":[]},{"id":"f775a7de.cf23f8","type":"function","z":"b38da013.ce2ec","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'delete success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1836.4935302734375,"y":4522.9345703125,"wires":[["47b5b7b0.3ad7c8"]]},{"id":"b87fa667.1cc7c8","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":241.26542282104492,"y":4584.121627807617,"wires":[["4cba7573.b90c3c"]]},{"id":"4cba7573.b90c3c","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":236.26542282104492,"y":4527.121627807617,"wires":[["e6e1fe24.61cc8"]]},{"id":"e6e1fe24.61cc8","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":235.26542282104492,"y":4478.121627807617,"wires":[["9467e847.1d7b08"],["547455f.33eeeac"]]},{"id":"547455f.33eeeac","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":505.7654228210449,"y":4538.121627807617,"wires":[]},{"id":"8080b393.d8ef","type":"switch","z":"b38da013.ce2ec","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2051,"y":1137,"wires":[["a5395503.dc21f8"],["9851ba8b.a69928"]]},{"id":"91231670.4a4c98","type":"function","z":"b38da013.ce2ec","name":"set token len","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":2019.4999923706055,"y":897.6665496826172,"wires":[["d1db4d81.1fe5c"]]},{"id":"d1db4d81.1fe5c","type":"switch","z":"b38da013.ce2ec","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2020.4999923706055,"y":849.6665496826172,"wires":[["c8b4333a.36a9f"],["c15ec9a.cf18838"]]},{"id":"c15ec9a.cf18838","type":"function","z":"b38da013.ce2ec","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2323.4999923706055,"y":942.6665496826172,"wires":[["cc1a0cb0.f0073"]]},{"id":"9851ba8b.a69928","type":"function","z":"b38da013.ce2ec","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2342.5,"y":1141.333251953125,"wires":[["cc1a0cb0.f0073"]]},{"id":"cc1a0cb0.f0073","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":3612,"y":1047.66650390625,"wires":[]},{"id":"c8b4333a.36a9f","type":"function","z":"b38da013.ce2ec","name":"set search tag info","func":"let newPayload = {}\nnewPayload['deviceType'] = '165'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":2325.9999923706055,"y":848.6665496826172,"wires":[["96627f26.02231"]]},{"id":"96627f26.02231","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get tag type from show_field","collection":"show_field","operation":"find","x":2588.9999923706055,"y":848.6665496826172,"wires":[["b91ec769.07d8f8","ca3578dc.741dc8"]]},{"id":"b29b95d8.e95178","type":"function","z":"b38da013.ce2ec","name":"check update result","func":"let newPayload = {}\nlet typeArray = []\nlet actInfo = msg['actInfo']\nlet updateFlg = false\nlet updateObj = msg.payload[0]\nlet map = updateObj['map']\nlet name = 'type'+actInfo['tagType']\nif(map !== undefined && map[name] !== undefined){\n  let tags = map[name]\n  tags['showField'] = actInfo['showField']\n  map[name] = tags\n  updateObj['map'] = map\n  updateFlg = true\n}\nmsg['payload'] = updateObj  \nmsg['updateFlg'] = updateFlg\nreturn msg","outputs":1,"noerr":0,"x":3060,"y":850.66650390625,"wires":[["2eded9d1.9b7626"]]},{"id":"a5395503.dc21f8","type":"function","z":"b38da013.ce2ec","name":"set flow obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":2042.833351135254,"y":1091.6666040420532,"wires":[["d057978c.9ecdf8"]]},{"id":"226af26c.6e079e","type":"comment","z":"b38da013.ce2ec","name":"fixed type:165","info":"","x":2318.1156997680664,"y":801.1282663345337,"wires":[]},{"id":"9954dc3c.751d","type":"switch","z":"b38da013.ce2ec","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2028.6668701171875,"y":953.548828125,"wires":[["91231670.4a4c98"],["8ab0b3ac.1d02e"]]},{"id":"8f34d268.860e3","type":"function","z":"b38da013.ce2ec","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":2029.6668701171875,"y":1002.548828125,"wires":[["9954dc3c.751d"]]},{"id":"d057978c.9ecdf8","type":"http request","z":"b38da013.ce2ec","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":2034.6668701171875,"y":1047.548828125,"wires":[["8f34d268.860e3"]]},{"id":"8ab0b3ac.1d02e","type":"http response","z":"b38da013.ce2ec","name":"","statusCode":"","headers":{},"x":2299.1668701171875,"y":1013.548828125,"wires":[]},{"id":"b91ec769.07d8f8","type":"debug","z":"b38da013.ce2ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2843.6668701171875,"y":740.548828125,"wires":[]},{"id":"8026d77e.6be6f8","type":"http in","z":"b38da013.ce2ec","name":"","url":"/:type/showField","method":"put","upload":false,"swaggerDoc":"","x":2048.1666259765625,"y":1190.333251953125,"wires":[["8080b393.d8ef"]]},{"id":"ca3578dc.741dc8","type":"switch","z":"b38da013.ce2ec","name":"check result","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2822.5,"y":868,"wires":[["b29b95d8.e95178"],["192b2cf3.35e103"]]},{"id":"192b2cf3.35e103","type":"function","z":"b38da013.ce2ec","name":"set maps not exists result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'tag not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":3044,"y":921,"wires":[["cc1a0cb0.f0073"]]},{"id":"2eded9d1.9b7626","type":"switch","z":"b38da013.ce2ec","name":"check updateFlg","property":"updateFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":3277.5,"y":833,"wires":[["b08ce983.53bec8","bc59b48.75f8848"],["5e040b05.33bc04"]]},{"id":"5e040b05.33bc04","type":"function","z":"b38da013.ce2ec","name":"set maps not exists result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'tag map not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":3307,"y":900,"wires":[["cc1a0cb0.f0073"]]},{"id":"b08ce983.53bec8","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"","collection":"show_field","payonly":true,"upsert":false,"multi":false,"operation":"store","x":3632,"y":794,"wires":[]},{"id":"bc59b48.75f8848","type":"function","z":"b38da013.ce2ec","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":3589,"y":867,"wires":[["cc1a0cb0.f0073"]]},{"id":"aa9bb1ed.426a2","type":"moment","z":"b38da013.ce2ec","name":"","topic":"","input":"recv","inputType":"msg","inTz":"ETC/GMT","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"recv","outputType":"msg","outTz":"Asia/Taipei","x":909,"y":1945,"wires":[["926d8fce.d3c33"]]},{"id":"926d8fce.d3c33","type":"function","z":"b38da013.ce2ec","name":"set createTime to tag","func":"msg.payload['createTime'] = msg.recv\nreturn msg","outputs":1,"noerr":0,"x":1151,"y":1928,"wires":[["1170c527.76515b","d4a13c04.0541a"]]},{"id":"d050003e.120de","type":"switch","z":"b38da013.ce2ec","name":"check objId","property":"payload.objId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":205.50000953674316,"y":2508.7999782562256,"wires":[["a7bd51c2.a2acc"],["7e41e8d2.94aac8"]]},{"id":"c18ed2d.208a53","type":"switch","z":"b38da013.ce2ec","name":"check system token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":234,"y":2314,"wires":[["d171e9c2.0e6928"],["b0d3a904.a62c08"]]},{"id":"19363ea2.c53831","type":"function","z":"b38da013.ce2ec","name":"check tag track exist","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nlet tagId = eval('/'+actInfo.type+'_'+actInfo.id+'/i')\nnewPayload['tagId'] = tagId\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":1320,"y":4358,"wires":[["3023b44.9b9894c"]]},{"id":"3023b44.9b9894c","type":"mongodb in","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"get track by tagId","collection":"track","operation":"find","x":1590,"y":4356,"wires":[["e96bf134.17d61"]]},{"id":"e96bf134.17d61","type":"switch","z":"b38da013.ce2ec","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1786,"y":4361,"wires":[["51367342.30da7c"],["f775a7de.cf23f8"]]},{"id":"ac5838b0.9f3498","type":"mongodb out","z":"b38da013.ce2ec","mongodb":"21e9f69a.3cd2ca","name":"delete track","collection":"track","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":2096,"y":4291,"wires":[]},{"id":"51367342.30da7c","type":"split","z":"b38da013.ce2ec","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1914.5,"y":4306,"wires":[["ac5838b0.9f3498"]]},{"id":"2f1c3d83.c80202","type":"comment","z":"b38da013.ce2ec","name":"deprecated","info":"","x":234.5,"y":3507,"wires":[]},{"id":"ee230a26.6ecd28","type":"debug","z":"a87a28e1.8a8c38","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1988.5,"y":327,"wires":[]},{"id":"19bf9b43.3ac245","type":"http in","z":"d31ca3d0.f06ed","name":"","url":"/state","method":"post","upload":false,"swaggerDoc":"","x":105.5,"y":58,"wires":[["84c9ba42.756658"]]},{"id":"582820df.1ac7f","type":"http response","z":"d31ca3d0.f06ed","name":"","statusCode":"","headers":{},"x":843.5,"y":48,"wires":[]},{"id":"56b9802c.fed09","type":"switch","z":"d31ca3d0.f06ed","name":"check macAddr exist","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":145,"y":273,"wires":[["8d2b05d5.79dbf8"],["b6c8d0af.f6f69"]]},{"id":"4755ff8d.b4d11","type":"function","z":"d31ca3d0.f06ed","name":"set macAddr to payload","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet newPayload = []\nlet mac = actInfo.data.macAddr\nif(mac.indexOf('_') !== -1){\n  let macArray = mac.split('_')\n  mac = macArray[0]\n}\nnewPayload.push(mac)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":148,"y":194,"wires":[["be782bcd.ec39a8"]]},{"id":"e3610fe5.37903","type":"function","z":"d31ca3d0.f06ed","name":"set payload to parameter","func":"msg['actInfo'] = msg.payload\nmsg['fport'] = msg.payload.data.extra.fport\nreturn msg","outputs":1,"noerr":0,"x":145,"y":148,"wires":[["4755ff8d.b4d11"]]},{"id":"84c9ba42.756658","type":"switch","z":"d31ca3d0.f06ed","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":115,"y":102,"wires":[["8d2b05d5.79dbf8"],["e3610fe5.37903"]]},{"id":"8d2b05d5.79dbf8","type":"function","z":"d31ca3d0.f06ed","name":"set missing parameter","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'missing data'\nnewPayload['responseCode'] = '404'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":516,"y":145,"wires":[["582820df.1ac7f"]]},{"id":"be782bcd.ec39a8","type":"subflow:691153b7.0e855c","z":"d31ca3d0.f06ed","x":126.5,"y":236,"wires":[["56b9802c.fed09"]]},{"id":"b6c8d0af.f6f69","type":"function","z":"d31ca3d0.f06ed","name":"get state by macAddr","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['macAddr'] = actInfo.data.macAddr\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":151.5,"y":323,"wires":[["aeba0dbc.72e64"]]},{"id":"aeba0dbc.72e64","type":"mongodb in","z":"d31ca3d0.f06ed","mongodb":"21e9f69a.3cd2ca","name":"get state","collection":"state","operation":"find","x":123.5,"y":374,"wires":[["d93820d3.93dfa"]]},{"id":"d93820d3.93dfa","type":"switch","z":"d31ca3d0.f06ed","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":280.5,"y":374,"wires":[["a273c405.9284d8"],["c6fa9b16.1f5338"]]},{"id":"a273c405.9284d8","type":"function","z":"d31ca3d0.f06ed","name":"insert state by macAddr","func":"let obj = msg['actInfo']\nlet newPayload = {}\nlet id = obj.data.macAddr\nnewPayload['extra'] = obj.data.extra !== undefined ? obj.data.extra : ''\nnewPayload['_id'] = id\nnewPayload['macAddr'] = id\nnewPayload['information'] = obj.data.information\nnewPayload['createTs'] = obj.data.timestamp\nnewPayload['createTime'] = obj.data.date\nnewPayload['last_updated'] = obj.data.timestamp\nnewPayload['last_changed'] = obj.data.timestamp\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":490.5,"y":327,"wires":[["835d9e09.6e69e","c04866cc.b00488"]]},{"id":"c6fa9b16.1f5338","type":"function","z":"d31ca3d0.f06ed","name":"update state by macAddr","func":"let obj = msg['actInfo']\nlet pre_state = msg.payload[0]\nif (!compareInfo(pre_state['information'], obj.data.information)) {\n  pre_state['last_changed'] = obj.data.timestamp  \n}\npre_state['last_updated'] = obj.data.timestamp\npre_state['pre_information'] = pre_state.information\npre_state['information'] = obj.data.information\npre_state['extra'] = obj.data.extra !== undefined ? obj.data.extra : ''\nmsg.payload = pre_state\nreturn msg\nfunction compareInfo(oldObj, newObj){\n  let oldStr = JSON.stringify(oldObj)\n  let newStr = JSON.stringify(newObj)\n  let compareFlg = false\n  if (oldStr == newStr) {\n    compareFlg = true\n  }\n  return compareFlg\n}","outputs":1,"noerr":0,"x":495,"y":398,"wires":[["e1f4c6e0.c1c738","b31896f0.774748"]]},{"id":"835d9e09.6e69e","type":"mongodb out","z":"d31ca3d0.f06ed","mongodb":"21e9f69a.3cd2ca","name":"insert state","collection":"state","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":556.5,"y":244,"wires":[]},{"id":"c04866cc.b00488","type":"function","z":"d31ca3d0.f06ed","name":"set result","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'insert success'\nnewPayload['responseCode'] = '000'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":716,"y":326,"wires":[["582820df.1ac7f"]]},{"id":"e1f4c6e0.c1c738","type":"function","z":"d31ca3d0.f06ed","name":"set result","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'update success'\nnewPayload['responseCode'] = '000'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":725,"y":397,"wires":[["582820df.1ac7f"]]},{"id":"b31896f0.774748","type":"mongodb out","z":"d31ca3d0.f06ed","mongodb":"21e9f69a.3cd2ca","name":"update state","collection":"state","payonly":true,"upsert":false,"multi":false,"operation":"store","x":615,"y":477,"wires":[]},{"id":"675bb9be.9ebcf8","type":"http in","z":"98bfa5b4.5b0408","name":"","url":"/showField/:fport/:type","method":"get","upload":false,"swaggerDoc":"","x":240,"y":520,"wires":[["931c4e78.ebce2"]]},{"id":"83917a05.934c48","type":"switch","z":"98bfa5b4.5b0408","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":236.5,"y":413,"wires":[["39b3fb18.660314"],["31ed03ab.1d779c"]]},{"id":"31ed03ab.1d779c","type":"function","z":"98bfa5b4.5b0408","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":519,"y":419,"wires":[["7654456d.8b79bc"]]},{"id":"39b3fb18.660314","type":"function","z":"98bfa5b4.5b0408","name":"set para to obj","func":"msg.payload['type'] = msg.req.params.type\nmsg.payload['fport'] = msg.req.params.fport\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":229,"y":371,"wires":[["8a0c0ce6.1c24b"]]},{"id":"802d4d11.6735c","type":"switch","z":"98bfa5b4.5b0408","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":215,"y":134.00005340576172,"wires":[["53335998.dc5d48"],["1f09934e.0fe9ad"]]},{"id":"1f09934e.0fe9ad","type":"function","z":"98bfa5b4.5b0408","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":507,"y":215,"wires":[["7654456d.8b79bc"]]},{"id":"53335998.dc5d48","type":"switch","z":"98bfa5b4.5b0408","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"lte","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":506.5,"y":130.00005340576172,"wires":[["8d3ce010.d9373"],["ce61a49c.026618"]]},{"id":"d63cc134.361f1","type":"function","z":"98bfa5b4.5b0408","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":214,"y":182.00005340576172,"wires":[["802d4d11.6735c"]]},{"id":"8d3ce010.d9373","type":"function","z":"98bfa5b4.5b0408","name":"set show_field query","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nnewPayload['deviceType'] = actInfo.fport\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":799.2857208251953,"y":61.00003242492676,"wires":[["eb566ac.5c1ee98"]]},{"id":"eb566ac.5c1ee98","type":"mongodb in","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"get showField by fport","collection":"show_field","operation":"find","x":860.5714721679688,"y":120.28564453125,"wires":[["5484cdda.0e5b84"]]},{"id":"ce61a49c.026618","type":"function","z":"98bfa5b4.5b0408","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":731,"y":183,"wires":[["7654456d.8b79bc"]]},{"id":"7654456d.8b79bc","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":942.5,"y":264,"wires":[]},{"id":"5484cdda.0e5b84","type":"function","z":"98bfa5b4.5b0408","name":"set returnObj","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nlet f = []\nif(actInfo.locale == undefined){\n  actInfo.locale = 'zh-Hans'\n}\nif(msg.payload.length > 0){\n  if(msg.payload[0].showField !== undefined){\n    let s = {}\n    s = msg.payload[0].showField\n    f = s[actInfo.type]\n    if(f !== undefined){\n      if(actInfo.locale !== 'all' || actInfo['editFlg'] !== undefined){\n        for(let j = 0; j < f.length; j++){\n          if(actInfo.locale !== 'all')\n            f[j].name = f[j].name[actInfo.locale]\n          if(actInfo['editFlg'] !== undefined && f[j].editFlg !== actInfo['editFlg'])\n            delete f[j]\n        }  \n      }\n    }\n  }\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['field'] = filter_array_values(f)\nmsg.payload = newPayload\nreturn msg\nfunction filter_array_values(arr) {\n  arr = arr.filter(isEligible);\n  return arr\n}\nfunction isEligible(value) {\n  if(value !== null) {\n    return value\n  }\n}","outputs":1,"noerr":0,"x":1077,"y":101,"wires":[["ac5ba51d.6a1df8"]]},{"id":"ac5ba51d.6a1df8","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":1268.4285507202148,"y":102.42855453491211,"wires":[]},{"id":"8a0c0ce6.1c24b","type":"http request","z":"98bfa5b4.5b0408","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":221,"y":330,"wires":[["f597e3a7.8b1ac"]]},{"id":"f597e3a7.8b1ac","type":"function","z":"98bfa5b4.5b0408","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":216,"y":285,"wires":[["d042415f.e2e19"]]},{"id":"d042415f.e2e19","type":"switch","z":"98bfa5b4.5b0408","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":215,"y":236,"wires":[["d63cc134.361f1"],["a18a3909.1d8818"]]},{"id":"a18a3909.1d8818","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":406.5,"y":279,"wires":[]},{"id":"931c4e78.ebce2","type":"switch","z":"98bfa5b4.5b0408","name":"check locale","property":"payload.locale","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":221,"y":464,"wires":[["83917a05.934c48"],["31ed03ab.1d779c"]]},{"id":"3d37bd4.2f3e842","type":"http in","z":"98bfa5b4.5b0408","name":"","url":"/showField/:fport/:type","method":"put","upload":false,"swaggerDoc":"","x":226.51776123046875,"y":1075.5070266723633,"wires":[["1353c966.13ed07"]]},{"id":"1353c966.13ed07","type":"switch","z":"98bfa5b4.5b0408","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":216.01776123046875,"y":1015.5070266723633,"wires":[["970ac01.997f14"],["1a721616.cae7aa"]]},{"id":"1a721616.cae7aa","type":"function","z":"98bfa5b4.5b0408","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":498.51776123046875,"y":1021.5070266723633,"wires":[["657d77d9.cd0338"]]},{"id":"970ac01.997f14","type":"function","z":"98bfa5b4.5b0408","name":"set para to obj","func":"msg.payload['type'] = msg.req.params.type\nmsg.payload['fport'] = msg.req.params.fport\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":208.51776123046875,"y":973.5070266723633,"wires":[["5763e11c.1114e"]]},{"id":"50d7d888.59fe48","type":"switch","z":"98bfa5b4.5b0408","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":194.51776123046875,"y":736.507080078125,"wires":[["9e285aad.b8eb38"],["98546f84.4e1b1"]]},{"id":"98546f84.4e1b1","type":"function","z":"98bfa5b4.5b0408","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":502.5177764892578,"y":871.5070266723633,"wires":[["657d77d9.cd0338"]]},{"id":"9e285aad.b8eb38","type":"switch","z":"98bfa5b4.5b0408","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"lte","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":486.0177764892578,"y":776.5070266723633,"wires":[["e2579c53.1f03a"],["f2071ad7.754098"]]},{"id":"55ff0ea7.b0721","type":"function","z":"98bfa5b4.5b0408","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":193.51776123046875,"y":784.507080078125,"wires":[["50d7d888.59fe48"]]},{"id":"e2579c53.1f03a","type":"function","z":"98bfa5b4.5b0408","name":"set showField query","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nnewPayload['deviceType'] = actInfo.fport\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":704.8034820556641,"y":741.5070266723633,"wires":[["7be36999.1b5d98"]]},{"id":"7be36999.1b5d98","type":"mongodb in","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"get showField by fport","collection":"show_field","operation":"find","x":917.0892486572266,"y":735.7926712036133,"wires":[["ebfa3c9e.e0fb4"]]},{"id":"f2071ad7.754098","type":"function","z":"98bfa5b4.5b0408","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":802.5177764892578,"y":821.5070266723633,"wires":[["657d77d9.cd0338"]]},{"id":"657d77d9.cd0338","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":1437.732032775879,"y":926.5069065093994,"wires":[]},{"id":"3cdac158.04f52e","type":"function","z":"98bfa5b4.5b0408","name":"set returnObj","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nlet updateObj = msg.payload[0]\nif(updateObj.showField !== undefined){\n  let s = {}\n  s = updateObj.showField\n  s[actInfo.type] = actInfo['showField']\n}\nmsg.payload = updateObj\nreturn msg","outputs":1,"noerr":0,"x":1291.6605987548828,"y":712.9354934692383,"wires":[["4e60df5c.e9a84","17b45ea5.8cb481"]]},{"id":"e60d717f.6fc8e","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":1652.8035430908203,"y":846.3639602661133,"wires":[]},{"id":"5763e11c.1114e","type":"http request","z":"98bfa5b4.5b0408","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":200.51776123046875,"y":932.5070266723633,"wires":[["b5d81209.b7dd8"]]},{"id":"b5d81209.b7dd8","type":"function","z":"98bfa5b4.5b0408","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":195.51776123046875,"y":887.5070266723633,"wires":[["f255be21.ea22c"]]},{"id":"f255be21.ea22c","type":"switch","z":"98bfa5b4.5b0408","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":194.51776123046875,"y":838.5070266723633,"wires":[["55ff0ea7.b0721"],["56c9aa23.318234"]]},{"id":"56c9aa23.318234","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":492.0177764892578,"y":939.5070266723633,"wires":[]},{"id":"ebfa3c9e.e0fb4","type":"switch","z":"98bfa5b4.5b0408","name":"check result","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1105.6605987548828,"y":729.3642044067383,"wires":[["3cdac158.04f52e"],["b86976e.5f38488"]]},{"id":"b86976e.5f38488","type":"function","z":"98bfa5b4.5b0408","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'showField not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1222.3749160766602,"y":786.7925872802734,"wires":[["657d77d9.cd0338"]]},{"id":"4e60df5c.e9a84","type":"mongodb out","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"","collection":"show_field","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1615.3749542236328,"y":699.0785598754883,"wires":[]},{"id":"17b45ea5.8cb481","type":"function","z":"98bfa5b4.5b0408","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1500.3749542236328,"y":799.3642044067383,"wires":[["e60d717f.6fc8e"]]},{"id":"2735853f.88734a","type":"http in","z":"17b8ee59.a67e72","name":"","url":"/meta/:fport/:type/:macAddr","method":"delete","upload":false,"swaggerDoc":"","x":307.9797019958496,"y":1095.1606216430664,"wires":[["373c69d1.4eff16","906ae231.82765"]]},{"id":"906ae231.82765","type":"switch","z":"17b8ee59.a67e72","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":270.69397926330566,"y":1040.4462366104126,"wires":[["2ad3653b.ede00a"],["a4733bc.b3743c8"]]},{"id":"2ad3653b.ede00a","type":"function","z":"17b8ee59.a67e72","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg.payload['type'] = msg.req.params.type\nmsg.payload['macAddr'] = msg.req.params.macAddr\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":261.19397735595703,"y":987.4462432861328,"wires":[["fe5d6af7.8fd448"]]},{"id":"df1bc8cb.650958","type":"function","z":"17b8ee59.a67e72","name":"set token len","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    // flow.set('actInfo', actInfo)\n    msg['actInfo'] = actInfo\n    msg['roleId'] = actInfo['roleId']\n}\nreturn msg","outputs":1,"noerr":0,"x":249.19397354125977,"y":790.4462890625,"wires":[["2a1adef.d053e22"]]},{"id":"2a1adef.d053e22","type":"switch","z":"17b8ee59.a67e72","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":444.99916076660156,"y":776.0824208259583,"wires":[["9a65bf4e.a3916"],["d5382811.2f0fa8"]]},{"id":"d5382811.2f0fa8","type":"function","z":"17b8ee59.a67e72","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":553.1939735412598,"y":835.4462890625,"wires":[["88c184b8.f5e3f8"]]},{"id":"a4733bc.b3743c8","type":"function","z":"17b8ee59.a67e72","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":582.4796981811523,"y":977.3034210205078,"wires":[["88c184b8.f5e3f8"]]},{"id":"373c69d1.4eff16","type":"debug","z":"17b8ee59.a67e72","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":576.551139831543,"y":1080.1604766845703,"wires":[]},{"id":"9a65bf4e.a3916","type":"switch","z":"17b8ee59.a67e72","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":456.693998336792,"y":720.7190361022949,"wires":[["325f289e.041b08"],["e6a19498.098768"]]},{"id":"e6a19498.098768","type":"function","z":"17b8ee59.a67e72","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":670.5511245727539,"y":777.861759185791,"wires":[["88c184b8.f5e3f8"]]},{"id":"325f289e.041b08","type":"function","z":"17b8ee59.a67e72","name":"check meta exist","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nnewPayload['fport'] = parseInt(actInfo.fport)\nnewPayload['type'] = actInfo.type\nnewPayload['macAddr'] = actInfo.macAddr\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":672.2272262573242,"y":703.0287628173828,"wires":[["e6366e7f.3709c"]]},{"id":"88c184b8.f5e3f8","type":"http response","z":"17b8ee59.a67e72","name":"","statusCode":"","headers":{},"x":1533.3782768249512,"y":939.5786437988281,"wires":[]},{"id":"ba14fc01.5a059","type":"switch","z":"17b8ee59.a67e72","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":894.2297019958496,"y":726.4106216430664,"wires":[["63ac5ea3.8ed25"],["e617ddc3.58f4e"]]},{"id":"63ac5ea3.8ed25","type":"function","z":"17b8ee59.a67e72","name":"set info to delete","func":"msg.payload = msg.payload[0]\nreturn msg","outputs":1,"noerr":0,"x":1074.2297019958496,"y":666.4106216430664,"wires":[["df121314.1587","b0ffa901.01b2a8"]]},{"id":"e6366e7f.3709c","type":"mongodb in","z":"17b8ee59.a67e72","mongodb":"21e9f69a.3cd2ca","name":"get meta by fport/mac/type","collection":"metadata","operation":"find","x":790.9594039916992,"y":643.3212432861328,"wires":[["ba14fc01.5a059"]]},{"id":"fe5d6af7.8fd448","type":"http request","z":"17b8ee59.a67e72","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":258.9594039916992,"y":943.3212432861328,"wires":[["c50ffdbb.04da7"]]},{"id":"c50ffdbb.04da7","type":"function","z":"17b8ee59.a67e72","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":253.95940399169922,"y":898.3212432861328,"wires":[["d1396dd5.06949"]]},{"id":"d1396dd5.06949","type":"switch","z":"17b8ee59.a67e72","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":252.95940399169922,"y":849.3212432861328,"wires":[["df1bc8cb.650958"],["d6b13585.38ae48"]]},{"id":"d6b13585.38ae48","type":"http response","z":"17b8ee59.a67e72","name":"","statusCode":"","headers":{},"x":444.4594039916992,"y":892.3212432861328,"wires":[]},{"id":"e617ddc3.58f4e","type":"function","z":"17b8ee59.a67e72","name":"set no metaInfo","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'metaInfo not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1124.2297019958496,"y":806.4106216430664,"wires":[["88c184b8.f5e3f8"]]},{"id":"b0ffa901.01b2a8","type":"mongodb out","z":"17b8ee59.a67e72","mongodb":"21e9f69a.3cd2ca","name":"delete metadata","collection":"metadata","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":1344.2297019958496,"y":646.4106216430664,"wires":[]},{"id":"df121314.1587","type":"function","z":"17b8ee59.a67e72","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'delete success'\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1344.2297019958496,"y":726.4106216430664,"wires":[["88c184b8.f5e3f8"]]},{"id":"aa14f7f4.bc3c58","type":"http in","z":"98bfa5b4.5b0408","name":"","url":"/showField","method":"get","upload":false,"swaggerDoc":"","x":206.51776123046875,"y":1815.5070266723633,"wires":[["9a1bab46.17e378"]]},{"id":"9a1bab46.17e378","type":"switch","z":"98bfa5b4.5b0408","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":190.01776123046875,"y":1764.5069789886475,"wires":[["4ff1c300.ad1b0c"],["419a9c86.8ece54"]]},{"id":"4ff1c300.ad1b0c","type":"function","z":"98bfa5b4.5b0408","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":180.01775360107422,"y":1723.5069780349731,"wires":[["1ceb0df7.879f82"]]},{"id":"3f76d5d5.fa363a","type":"function","z":"98bfa5b4.5b0408","name":"set search cond to get cnt","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport !== undefined){\n  newPayload['deviceType'] = obj.fport\n}\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":185.01775360107422,"y":1518.5070085525513,"wires":[["3c047c99.caa374"]]},{"id":"3c047c99.caa374","type":"mongodb in","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"find show_field data Cnt","collection":"show_field","operation":"count","x":206.01775360107422,"y":1465.5070085525513,"wires":[["b584cd37.deb48"]]},{"id":"419a9c86.8ece54","type":"function","z":"98bfa5b4.5b0408","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":492.0177688598633,"y":1787.5070142745972,"wires":[["6fd45a25.253564"]]},{"id":"6fd45a25.253564","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":1003.5177612304688,"y":1705.5070085525513,"wires":[]},{"id":"b584cd37.deb48","type":"switch","z":"98bfa5b4.5b0408","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":378.017765045166,"y":1467.5070095062256,"wires":[["4a216031.f7d2a"],["e7057e7a.c4035"]]},{"id":"e7057e7a.c4035","type":"function","z":"98bfa5b4.5b0408","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = 0\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":548.0177688598633,"y":1524.5070104599,"wires":[["6fd45a25.253564"]]},{"id":"4a216031.f7d2a","type":"function","z":"98bfa5b4.5b0408","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport){\n  newPayload['deviceType'] = obj.fport\n}\nlet paginate = true\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['deviceType'] = 1\nif(obj.sort && obj.sort == 'desc'){\n  sort['deviceType'] = -1\n}\nmsg['sort'] = sort\nobj['next'] = nextPage\nobj['previous'] = previous\nobj['page_limit'] = page_limit\nobj['total'] = msg.payload\n// flow.set('actInfo', obj)\nmsg['actInfo'] = obj\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":579.0177612304688,"y":1442.5070085525513,"wires":[["97a96875.829808"]]},{"id":"97a96875.829808","type":"mongodb in","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"find show_field data","collection":"show_field","operation":"find","x":839.0177726745605,"y":1439.5070085525513,"wires":[["e5d83870.bae568"]]},{"id":"e5d83870.bae568","type":"function","z":"98bfa5b4.5b0408","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet pageInfo = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = Number(obj['total'])\npageInfo['next'] = obj['next']\npageInfo['previous'] = obj['previous']\npageInfo['limit'] = obj['page_limit']\nnewPayload['pages'] = pageInfo\nnewPayload['data'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1111.0177612304688,"y":1514.5070085525513,"wires":[["6fd45a25.253564"]]},{"id":"cdf6117f.40fae","type":"http in","z":"98bfa5b4.5b0408","name":"","url":"/showField","method":"post","upload":false,"swaggerDoc":"","x":182.51776123046875,"y":2409.9070711135864,"wires":[["84b99359.aaa35"]]},{"id":"84b99359.aaa35","type":"switch","z":"98bfa5b4.5b0408","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":170.01776123046875,"y":2362.3070211410522,"wires":[["73e8afc1.47cbf"],["26f14f24.1ee9"]]},{"id":"33ea6af6.17ae36","type":"function","z":"98bfa5b4.5b0408","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":160.01775360107422,"y":2276.30699634552,"wires":[["d1fdd0dc.06054"]]},{"id":"26f14f24.1ee9","type":"function","z":"98bfa5b4.5b0408","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":477.0177688598633,"y":2375.3070344924927,"wires":[["b5447341.0973b"]]},{"id":"b5447341.0973b","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":1567.517749786377,"y":2336.5070219039917,"wires":[]},{"id":"73e8afc1.47cbf","type":"switch","z":"98bfa5b4.5b0408","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":169.01776123046875,"y":2319.707021713257,"wires":[["33ea6af6.17ae36"],["26f14f24.1ee9"]]},{"id":"a8f71edd.0e4b","type":"function","z":"98bfa5b4.5b0408","name":"set fport to parameter","func":"let actInfo = msg['actInfo']\nif(actInfo.data.deviceType !== undefined){\n  msg['fport'] = actInfo.data.deviceType  \n}else{\n  msg['fport'] = 'NA'\n}\nreturn msg","outputs":1,"noerr":0,"x":176.51776123046875,"y":2060.9070291519165,"wires":[["f088ea57.3de4e8"]]},{"id":"f088ea57.3de4e8","type":"switch","z":"98bfa5b4.5b0408","name":"","property":"fport","propertyType":"msg","rules":[{"t":"neq","v":"NA","vt":"str"},{"t":"eq","v":"NA","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":373.517765045166,"y":2053.3070793151855,"wires":[["7d4ad985.7dee08"],["4fbff030.30915"]]},{"id":"4fbff030.30915","type":"function","z":"98bfa5b4.5b0408","name":"set deviceType error","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'DeviceType not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":544.0177688598633,"y":2097.7069940567017,"wires":[["b5447341.0973b"]]},{"id":"7d4ad985.7dee08","type":"function","z":"98bfa5b4.5b0408","name":"set search cond to get cnt","func":"let newPayload = {}\nnewPayload['deviceType'] = msg['fport']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":552.0177688598633,"y":2011.1069927215576,"wires":[["7232ec82.1d85a4"]]},{"id":"7232ec82.1d85a4","type":"mongodb in","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"find show_field by deviceType","collection":"show_field","operation":"find","x":791.0177612304688,"y":1960.5070171356201,"wires":[["342e4677.78bb5a"]]},{"id":"342e4677.78bb5a","type":"switch","z":"98bfa5b4.5b0408","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":911.0177612304688,"y":2014.5070180892944,"wires":[["7ce4b637.6b6288"],["c4b0d0c1.90a33"]]},{"id":"18fed4be.abbbbb","type":"http in","z":"98bfa5b4.5b0408","name":"","url":"/showField/:fport","method":"delete","upload":false,"swaggerDoc":"","x":200.01776123046875,"y":3012.3070573806763,"wires":[["5a421eed.caf27"]]},{"id":"5a421eed.caf27","type":"switch","z":"98bfa5b4.5b0408","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":170.51776123046875,"y":2954.3070573806763,"wires":[["a03069c5.78d548"],["8d5bbb67.4d8d68"]]},{"id":"a03069c5.78d548","type":"function","z":"98bfa5b4.5b0408","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":165.51776123046875,"y":2907.3070573806763,"wires":[["91f34543.bfe238"]]},{"id":"168951da.e02e6e","type":"function","z":"98bfa5b4.5b0408","name":"set search cond to get cnt","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['deviceType'] = obj.fport\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":182.51775360107422,"y":2685.307050704956,"wires":[["28bf813c.e5056e"]]},{"id":"28bf813c.e5056e","type":"mongodb in","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"find show_field data Cnt","collection":"show_field","operation":"count","x":203.51775360107422,"y":2632.307050704956,"wires":[["552febe2.41d6e4"]]},{"id":"8d5bbb67.4d8d68","type":"function","z":"98bfa5b4.5b0408","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":489.5177688598633,"y":2954.307056427002,"wires":[["aa274e4c.50bea"]]},{"id":"552febe2.41d6e4","type":"switch","z":"98bfa5b4.5b0408","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":375.517765045166,"y":2634.3070516586304,"wires":[["6b6771e6.9cace"],["cd4cdc2a.a4742"]]},{"id":"cd4cdc2a.a4742","type":"function","z":"98bfa5b4.5b0408","name":"set empty result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'no maps to delete'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":545.5177688598633,"y":2691.3070526123047,"wires":[["aa274e4c.50bea"]]},{"id":"6b6771e6.9cace","type":"function","z":"98bfa5b4.5b0408","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport){\n  newPayload['deviceType'] = obj.fport\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":576.5177612304688,"y":2609.307050704956,"wires":[["e3d6682.3fcce98","e4bd0a85.492b78"]]},{"id":"e4bd0a85.492b78","type":"function","z":"98bfa5b4.5b0408","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'delete success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":824.5177612304688,"y":2717.3070526123047,"wires":[["aa274e4c.50bea"]]},{"id":"aa274e4c.50bea","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":924.5177736282349,"y":2865.907078742981,"wires":[]},{"id":"e3d6682.3fcce98","type":"mongodb out","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"remove show_field by fport","collection":"show_field","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":861.5177726745605,"y":2597.5070753097534,"wires":[]},{"id":"c4b0d0c1.90a33","type":"function","z":"98bfa5b4.5b0408","name":"set info to insert","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nobj.data['createTime'] = new Date()\nnewPayload = obj['data']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1036.0177612304688,"y":2055.30699634552,"wires":[["3010abf6.0ae0d4","917a9ccc.23c0a"]]},{"id":"3010abf6.0ae0d4","type":"mongodb out","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"insert show_field info","collection":"show_field","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1315.0177612304688,"y":2055.30699634552,"wires":[]},{"id":"917a9ccc.23c0a","type":"function","z":"98bfa5b4.5b0408","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'insert success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1110.0177459716797,"y":2146.5070180892944,"wires":[["b5447341.0973b"]]},{"id":"f6ea3aaf.09cfc8","type":"mongodb out","z":"98bfa5b4.5b0408","mongodb":"21e9f69a.3cd2ca","name":"upadte show_field info","collection":"show_field","payonly":true,"upsert":false,"multi":true,"operation":"store","x":1343.6177558898926,"y":1926.507016658783,"wires":[]},{"id":"7ce4b637.6b6288","type":"function","z":"98bfa5b4.5b0408","name":"set info to update","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nobj.data['updateTime'] = new Date()\nnewPayload = obj['data']\nnewPayload['_id'] = msg.payload[0]._id\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1107.6178283691406,"y":1976.5070161819458,"wires":[["f6ea3aaf.09cfc8","4cbf018e.16d11"]]},{"id":"4cbf018e.16d11","type":"function","z":"98bfa5b4.5b0408","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1320.6177520751953,"y":1997.5070171356201,"wires":[["b5447341.0973b"]]},{"id":"91f34543.bfe238","type":"http request","z":"98bfa5b4.5b0408","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":162.01776123046875,"y":2858.5070085525513,"wires":[["4158f338.e859ec"]]},{"id":"4158f338.e859ec","type":"function","z":"98bfa5b4.5b0408","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":157.01776123046875,"y":2801.5070085525513,"wires":[["fd497c5b.c7fb4"]]},{"id":"fd497c5b.c7fb4","type":"switch","z":"98bfa5b4.5b0408","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":156.01776123046875,"y":2752.5070085525513,"wires":[["168951da.e02e6e"],["aa274e4c.50bea"]]},{"id":"d1fdd0dc.06054","type":"http request","z":"98bfa5b4.5b0408","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":162.01776123046875,"y":2230.5070085525513,"wires":[["64bb1890.ba89d8"]]},{"id":"64bb1890.ba89d8","type":"function","z":"98bfa5b4.5b0408","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":157.01776123046875,"y":2173.5070085525513,"wires":[["885f2e7a.ab19e"]]},{"id":"885f2e7a.ab19e","type":"switch","z":"98bfa5b4.5b0408","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":156.01776123046875,"y":2124.5070085525513,"wires":[["a8f71edd.0e4b"],["6fe61506.94c55c"]]},{"id":"6fe61506.94c55c","type":"http response","z":"98bfa5b4.5b0408","name":"","statusCode":"","headers":{},"x":361.51776123046875,"y":2122.5070085525513,"wires":[]},{"id":"1ceb0df7.879f82","type":"http request","z":"98bfa5b4.5b0408","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":176.01776123046875,"y":1673.5070085525513,"wires":[["4d41cc7d.4c9844"]]},{"id":"4d41cc7d.4c9844","type":"function","z":"98bfa5b4.5b0408","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":171.01776123046875,"y":1616.5070085525513,"wires":[["9371ab86.2313e8"]]},{"id":"9371ab86.2313e8","type":"switch","z":"98bfa5b4.5b0408","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":170.01776123046875,"y":1567.5070085525513,"wires":[["3f76d5d5.fa363a"],["6fd45a25.253564"]]},{"id":"a92d410.c8346c","type":"http in","z":"ef7281df.ce773","name":"","url":"/searchField","method":"get","upload":false,"swaggerDoc":"","x":160,"y":480,"wires":[["309f1990.4469a6"]]},{"id":"309f1990.4469a6","type":"switch","z":"ef7281df.ce773","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":170.5,"y":426.0000534057617,"wires":[["f2864516.54a728"],["493af6e7.2511d8"]]},{"id":"493af6e7.2511d8","type":"function","z":"ef7281df.ce773","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":405,"y":402.0000534057617,"wires":[["9a4d4e6e.2fef9"]]},{"id":"f2864516.54a728","type":"function","z":"ef7281df.ce773","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":160,"y":365.0000534057617,"wires":[["9e06cdb7.e5e12"]]},{"id":"d5a6d2dc.5ed2c","type":"switch","z":"ef7281df.ce773","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":155,"y":125.00010681152344,"wires":[["e24e26b.8fe06d8"],["eecd2f93.ec8ac"]]},{"id":"eecd2f93.ec8ac","type":"function","z":"ef7281df.ce773","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":447,"y":206.00005340576172,"wires":[["9a4d4e6e.2fef9"]]},{"id":"e24e26b.8fe06d8","type":"switch","z":"ef7281df.ce773","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"lte","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":446.5,"y":121.00010681152344,"wires":[["d03b276d.e6ffc8"],["455a34f9.e1219c"]]},{"id":"68c46b10.f2e8c4","type":"function","z":"ef7281df.ce773","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":154,"y":173.00010681152344,"wires":[["d5a6d2dc.5ed2c"]]},{"id":"d03b276d.e6ffc8","type":"function","z":"ef7281df.ce773","name":"set showField query ","func":"let newPayload = {}\nnewPayload['deviceType'] = '165'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":739.2857208251953,"y":52.00008583068848,"wires":[["e9f232a2.3052f"]]},{"id":"e9f232a2.3052f","type":"mongodb in","z":"ef7281df.ce773","mongodb":"21e9f69a.3cd2ca","name":"get showField by fport","collection":"show_field","operation":"find","x":800.5714721679688,"y":111.28569793701172,"wires":[["567d9113.7e8ac"]]},{"id":"455a34f9.e1219c","type":"function","z":"ef7281df.ce773","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":671,"y":174.00005340576172,"wires":[["9a4d4e6e.2fef9"]]},{"id":"9a4d4e6e.2fef9","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":882.5,"y":255.00005340576172,"wires":[]},{"id":"567d9113.7e8ac","type":"function","z":"ef7281df.ce773","name":"set returnObj","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nlet f = []\nif(msg.payload.length > 0){\n  if(actInfo.type !== undefined){\n    if(actInfo.type == 'personnel'){\n      if(msg.payload[0].securityField !== undefined)\n        f = msg.payload[0].securityField\n    }else{\n      if(msg.payload[0].metaField !== undefined)\n        f = msg.payload[0].metaField    \n    }\n  }else{\n    if(msg.payload[0].metaField !== undefined)\n      f = msg.payload[0].metaField  \n  }\n}\nif(f.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['field'] = f\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'search field not exist'\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1017,"y":92.00005340576172,"wires":[["13ba8dc0.00af02"]]},{"id":"13ba8dc0.00af02","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":1208.4285507202148,"y":93.42860794067383,"wires":[]},{"id":"9e06cdb7.e5e12","type":"http request","z":"ef7281df.ce773","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":159.48223876953125,"y":316.4929733276367,"wires":[["949be432.bb2998"]]},{"id":"949be432.bb2998","type":"function","z":"ef7281df.ce773","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":154.48223876953125,"y":271.4929733276367,"wires":[["6e26faca.098544"]]},{"id":"6e26faca.098544","type":"switch","z":"ef7281df.ce773","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":153.48223876953125,"y":222.49297332763672,"wires":[["68c46b10.f2e8c4"],["3b03e784.420488"]]},{"id":"3b03e784.420488","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":344.98223876953125,"y":265.4929733276367,"wires":[]},{"id":"2887f7a2.510198","type":"http in","z":"ef7281df.ce773","name":"","url":"/option/:meta","method":"get","upload":false,"swaggerDoc":"","x":190,"y":1000,"wires":[["9a2ffe42.3096f"]]},{"id":"9a2ffe42.3096f","type":"switch","z":"ef7281df.ce773","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":190.5,"y":946.0000534057617,"wires":[["ad80cf63.8525f"],["86366c69.b6438"]]},{"id":"86366c69.b6438","type":"function","z":"ef7281df.ce773","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":472,"y":953.0000534057617,"wires":[["6fb32fe2.6d49"]]},{"id":"ad80cf63.8525f","type":"function","z":"ef7281df.ce773","name":"set para to obj","func":"msg.payload['meta'] = msg.req.params.meta\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":180,"y":885.0000534057617,"wires":[["5111644d.71b37c"]]},{"id":"28f8fe07.7398f2","type":"switch","z":"ef7281df.ce773","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":172.99998474121094,"y":640.0000438690186,"wires":[["c38313bf.683ea"],["34ee0363.f7f35c"]]},{"id":"34ee0363.f7f35c","type":"function","z":"ef7281df.ce773","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":464.99998474121094,"y":720.9999904632568,"wires":[["6fb32fe2.6d49"]]},{"id":"c38313bf.683ea","type":"switch","z":"ef7281df.ce773","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"lte","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":464.49998474121094,"y":636.0000438690186,"wires":[["232a97fb.cd9ed8"],["33aa5d79.bbf262"]]},{"id":"1dd18fd6.5bf78","type":"function","z":"ef7281df.ce773","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":171.99998474121094,"y":688.0000438690186,"wires":[["28f8fe07.7398f2"]]},{"id":"232a97fb.cd9ed8","type":"function","z":"ef7281df.ce773","name":"set maps query","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nlet cnt = {}\nlet grp = {}\nlet match = {}\nlet matchAnd = {}\nlet matchType = {}\nlet matchFport = {}\nlet matchShow = {}\nlet matchArray = []\nlet cond = {}\nlet sort = {}\nlet sortField = {}\nlet grpObj = {}\nmatchFport['fport'] = parseInt(actInfo.fport)\nmatchType['type'] = 'meta'\nif(actInfo.showFlg !== undefined){\n  matchShow['showFlg'] = parseInt(actInfo.showFlg)\n  matchArray.push(matchShow)\n}\nmatchArray.push(matchFport)\nmatchArray.push(matchType)\nmatchAnd['$and'] = matchArray\nmatch['$match'] = matchAnd\ncnt['$sum'] = 1\ngrpObj['val'] = '$meta.'+actInfo.meta+'.val'\ngrpObj['name'] = '$meta.'+actInfo.meta+'.name'\ngrp['_id'] = grpObj\ngrp['count'] = cnt\ncond['$group'] = grp\nsortField['_id'] = 1\nsort['$sort'] = sortField\nnewPayload.push(match)\nnewPayload.push(cond)\nnewPayload.push(sort)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":737.2857055664062,"y":567.0000228881836,"wires":[["acf74324.6b91b","1db243ca.f9c1dc"]]},{"id":"acf74324.6b91b","type":"mongodb in","z":"ef7281df.ce773","mongodb":"21e9f69a.3cd2ca","name":"aggregate by meta field","collection":"metadata","operation":"aggregate","x":807.5714721679688,"y":626.2856369018555,"wires":[["154cea93.961f45"]]},{"id":"33aa5d79.bbf262","type":"function","z":"ef7281df.ce773","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":688.9999847412109,"y":688.9999904632568,"wires":[["6fb32fe2.6d49"]]},{"id":"6fb32fe2.6d49","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":900.4999847412109,"y":769.9999904632568,"wires":[]},{"id":"154cea93.961f45","type":"function","z":"ef7281df.ce773","name":"set returnObj","func":"let newPayload = {}\nlet f = []\nif(msg.payload.length > 0){\n  for(let i = 0 ; i < msg.payload.length ; i++){\n    let d = msg.payload[i]\n    if(d._id.val !== undefined)\n      f.push(d)\n  }\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['option'] = f\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1028,"y":625.9999923706055,"wires":[["edf56f2e.2738d"]]},{"id":"edf56f2e.2738d","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":1226.4285354614258,"y":608.428544998169,"wires":[]},{"id":"1db243ca.f9c1dc","type":"debug","z":"ef7281df.ce773","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":917.0714111328125,"y":558.1428756713867,"wires":[]},{"id":"2f6381bf.1a476e","type":"switch","z":"ef7281df.ce773","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":180.0714111328125,"y":1508.142936706543,"wires":[["2ceed1f8.2705ae"],["f824c195.f2104"]]},{"id":"f824c195.f2104","type":"function","z":"ef7281df.ce773","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":456.5714111328125,"y":1471.1428756713867,"wires":[["a5e552ff.2bf0e"]]},{"id":"2ceed1f8.2705ae","type":"function","z":"ef7281df.ce773","name":"set para to obj","func":"msg.payload['meta'] = msg.req.params.meta\nmsg.payload['val'] = msg.req.params.val\nmsg.payload['target'] = msg.req.params.target\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":169.5714111328125,"y":1447.142936706543,"wires":[["dd2c1c6e.5bb02"]]},{"id":"3bf803df.28fb9c","type":"switch","z":"ef7281df.ce773","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":165.5714111328125,"y":1204.1429290771484,"wires":[["a087121.5d94cf"],["a1c3f16e.088d9"]]},{"id":"a1c3f16e.088d9","type":"function","z":"ef7281df.ce773","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":457.5714111328125,"y":1285.1428756713867,"wires":[["a5e552ff.2bf0e"]]},{"id":"a087121.5d94cf","type":"switch","z":"ef7281df.ce773","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"lte","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":378.07140350341797,"y":1199.142930984497,"wires":[["62120603.699198"],["52cc9757.c94108"]]},{"id":"bbb5741.d54a788","type":"function","z":"ef7281df.ce773","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":164.5714111328125,"y":1252.1429290771484,"wires":[["3bf803df.28fb9c"]]},{"id":"7103aee1.f00d","type":"function","z":"ef7281df.ce773","name":"set meta query","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nlet cnt = {}\nlet grp = {}\nlet match = {}\nlet matchAnd = {}\nlet matchType = {}\nlet matchShow = {}\nlet matchMeta = {}\nlet matchFport = {}\nlet matchArray = []\nlet cond = {}\nlet sort = {}\nlet sortField = {}\nlet grpObj = {}\nmatchFport['fport'] = parseInt(actInfo.fport)\nmatchType['type'] = 'meta'\nif(actInfo.showFlg !== undefined){\n  matchShow['showFlg'] = parseInt(actInfo.showFlg)\n  matchArray.push(matchShow)\n}\nmatchMeta['meta.'+actInfo.meta+'.val'] = actInfo.val\nmatchArray.push(matchFport)\nmatchArray.push(matchType)\nmatchArray.push(matchMeta)\nmatchAnd['$and'] = matchArray\nmatch['$match'] = matchAnd\ncnt['$sum'] = 1\ngrpObj['val'] = '$meta.'+actInfo.target+'.val'\ngrpObj['name'] = '$meta.'+actInfo.target+'.name'\ngrp['_id'] = grpObj\ngrp['count'] = cnt\ncond['$group'] = grp\nsortField['_id'] = 1\nsort['$sort'] = sortField\nnewPayload.push(match)\nnewPayload.push(cond)\nnewPayload.push(sort)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":729.8571319580078,"y":1131.1429080963135,"wires":[["884143e6.6accc","83de5fb7.e80f5"]]},{"id":"884143e6.6accc","type":"mongodb in","z":"ef7281df.ce773","mongodb":"21e9f69a.3cd2ca","name":"aggregate by meta field","collection":"metadata","operation":"aggregate","x":947.1428833007812,"y":1130.4285202026367,"wires":[["b8c23ca0.1e42d"]]},{"id":"52cc9757.c94108","type":"function","z":"ef7281df.ce773","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Role missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":681.5714111328125,"y":1253.1428756713867,"wires":[["a5e552ff.2bf0e"]]},{"id":"a5e552ff.2bf0e","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":893.0714111328125,"y":1334.1428756713867,"wires":[]},{"id":"b8c23ca0.1e42d","type":"function","z":"ef7281df.ce773","name":"set returnObj","func":"let newPayload = {}\nlet f = []\nif(msg.payload.length > 0){\n  f = msg.payload\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['option'] = f\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1228.571044921875,"y":1129.1428604125977,"wires":[["e0a9b9fb.3d0888"]]},{"id":"e0a9b9fb.3d0888","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":1466.999397277832,"y":1127.5714597702026,"wires":[]},{"id":"83de5fb7.e80f5","type":"debug","z":"ef7281df.ce773","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":897.6428298950195,"y":1053.2857677936554,"wires":[]},{"id":"62120603.699198","type":"switch","z":"ef7281df.ce773","name":"check target","property":"actInfo.target","propertyType":"msg","rules":[{"t":"neq","v":"macAddr","vt":"str"},{"t":"eq","v":"macAddr","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":575.2645721435547,"y":1180.4553527832031,"wires":[["7103aee1.f00d"],["c78adc4c.c65f2"]]},{"id":"c78adc4c.c65f2","type":"function","z":"ef7281df.ce773","name":"set meta query for macAddr","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['fport'] = Number(actInfo.fport)\nif(actInfo.showFlg !== undefined){\n  newPayload['showFlg'] = parseInt(actInfo.showFlg)\n}\nnewPayload['meta.'+actInfo.meta+'.val'] = actInfo.val\nlet sort = {}\nsort['macAddr'] = 1\nmsg['sort'] = sort\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":788.5856323242188,"y":1198.7849044799805,"wires":[["2dbadb11.16ec64"]]},{"id":"2dbadb11.16ec64","type":"mongodb in","z":"ef7281df.ce773","mongodb":"21e9f69a.3cd2ca","name":"get device by meta field","collection":"metadata","operation":"find","x":1080.5855712890625,"y":1197.875846862793,"wires":[["b8c23ca0.1e42d"]]},{"id":"dd2c1c6e.5bb02","type":"http request","z":"ef7281df.ce773","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":169.5714111328125,"y":1392.1428756713867,"wires":[["3b5fc198.579d5e"]]},{"id":"3b5fc198.579d5e","type":"function","z":"ef7281df.ce773","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":164.5714111328125,"y":1347.1428756713867,"wires":[["172735e3.920f1a"]]},{"id":"172735e3.920f1a","type":"switch","z":"ef7281df.ce773","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":163.5714111328125,"y":1298.1428756713867,"wires":[["bbb5741.d54a788"],["188b326a.cf150e"]]},{"id":"188b326a.cf150e","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":355.0714111328125,"y":1341.1428756713867,"wires":[]},{"id":"edb93bc4.3cbdf8","type":"switch","z":"ef7281df.ce773","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":175.5714111328125,"y":740.1428756713867,"wires":[["1dd18fd6.5bf78"],["9a37e32d.be73a"]]},{"id":"5d8ad4fd.bb377c","type":"function","z":"ef7281df.ce773","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":176.5714111328125,"y":789.1428756713867,"wires":[["edb93bc4.3cbdf8"]]},{"id":"5111644d.71b37c","type":"http request","z":"ef7281df.ce773","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":181.5714111328125,"y":834.1428756713867,"wires":[["5d8ad4fd.bb377c"]]},{"id":"9a37e32d.be73a","type":"http response","z":"ef7281df.ce773","name":"","statusCode":"","headers":{},"x":367.0714111328125,"y":783.1428756713867,"wires":[]},{"id":"c6449c1a.feb8f","type":"http in","z":"ef7281df.ce773","name":"","url":"/option/:meta/:val/:target","method":"get","upload":false,"swaggerDoc":"","x":209.5714111328125,"y":1562.1428833007812,"wires":[["2f6381bf.1a476e"]]}]
[{"id":"e2b837c2.9e2be8","type":"tab","label":"Login Flow","disabled":false,"info":""},{"id":"497feb9e.421f54","type":"tab","label":"Logout Flow","disabled":false,"info":""},{"id":"21db4fe9.158d2","type":"tab","label":"ldap Flow","disabled":false,"info":""},{"id":"cafe140c.d22e68","type":"tab","label":"Token Flow","disabled":false,"info":""},{"id":"c4ef04b6.f3ef08","type":"tab","label":"SysProp Flow","disabled":false,"info":""},{"id":"5daf8c52.99ee44","type":"tab","label":"History Flow","disabled":false,"info":""},{"id":"c2effd8c.b7a2d","type":"tab","label":"Function mgm Flow","disabled":false,"info":""},{"id":"e9de16c5.c95d08","type":"tab","label":"Role mgm Flow","disabled":false,"info":""},{"id":"30582f0c.49a88","type":"tab","label":"Grp mgm Flow","disabled":false,"info":""},{"id":"98edc07.d8c374","type":"tab","label":"CP mgm Flow","disabled":false,"info":""},{"id":"ef8c2a97.a89548","type":"tab","label":"User mgm Flow","disabled":false,"info":""},{"id":"839d47f7.2507b8","type":"tab","label":"Mapping mgm Flow","disabled":false,"info":""},{"id":"ba684eb9.17776","type":"tab","label":"LINE Flow","disabled":false,"info":""},{"id":"7a3748cb.a6fe98","type":"tab","label":"Register Flow","disabled":false,"info":""},{"id":"d6879688.334818","type":"tab","label":"Social Login","disabled":false,"info":""},{"id":"84c55f2c.56d0e","type":"tab","label":"Update Social Mapping","disabled":false,"info":""},{"id":"bfabdc2e.53fdf","type":"tab","label":"Get Social List","disabled":false,"info":""},{"id":"42cc5e2a.1f178","type":"subflow","name":"MySQL flow","info":"","in":[{"x":39,"y":74,"wires":[{"id":"d3bad3a8.f470b"}]}],"out":[{"x":483,"y":70,"wires":[{"id":"3c5d28e5.0271d8","port":0},{"id":"e9e32afa.2b8a48","port":0},{"id":"aa59a2f.fd8676","port":0}]}]},{"id":"47f0f2eb.a3493c","type":"subflow","name":"Redis get flow","info":"","in":[{"x":65,"y":79,"wires":[{"id":"1869744b.0b0d4c"}]}],"out":[{"x":447,"y":82,"wires":[{"id":"14ef4506.5367cb","port":0},{"id":"1ccf01b9.39ea0e","port":0},{"id":"d5ab2a6d.b5de28","port":0}]}]},{"id":"d829b1e4.26b7d","type":"subflow","name":"Check flow","info":"","in":[{"x":25,"y":228,"wires":[{"id":"2ed2089b.b6ebd8"}]}],"out":[{"x":834,"y":42,"wires":[{"id":"f398cc9f.1e34c","port":0}]}]},{"id":"c8b8ab14.3c2f48","type":"MySQLdatabase","z":"","host":"mysqldb","port":"3306","db":"cloudb_dev","tz":""},{"id":"366c9503.fe3e5a","type":"MySQLdatabase","z":"","host":"mysqldb","port":"3306","db":"cloudb_dev","tz":""},{"id":"1cc07558.8db6bb","type":"redis-config","z":"","host":"redis-svr","port":"6379","dbase":"0","pass":""},{"id":"2b254c02.220054","type":"node-red-contrib-nr-ldapauth-cred","z":"","host":"10.5.1.101","port":"389","ldaps":false,"certificatepath":"","name":"gemtek_ldap"},{"id":"f61937b6.35a578","type":"redis-config","z":"","host":"redis-svr","port":"6379","dbase":"0","pass":""},{"id":"42c65af9.ad7ff4","type":"redis-config","z":"47f0f2eb.a3493c","host":"redis-svr","port":"6379","dbase":"0","pass":""},{"id":"8032dbcd.04df78","type":"redis-config","z":"47f0f2eb.a3493c","host":"redis-svr","port":"6379","dbase":"0","pass":""},{"id":"b6853919.862288","type":"firebase admin","z":"","name":"MERC Notify"},{"id":"d3bad3a8.f470b","type":"switch","z":"42cc5e2a.1f178","name":"lbs","property":"flow","propertyType":"msg","rules":[{"t":"lte","v":"5","vt":"str"},{"t":"gt","v":"5","vt":"str"}],"checkall":"true","outputs":2,"x":139,"y":73,"wires":[["3c5d28e5.0271d8"],["e9e32afa.2b8a48"]]},{"id":"3c5d28e5.0271d8","type":"mysql","z":"42cc5e2a.1f178","mydb":"c8b8ab14.3c2f48","name":"cloudb_17","x":322,"y":39,"wires":[[]]},{"id":"e9e32afa.2b8a48","type":"mysql","z":"42cc5e2a.1f178","mydb":"366c9503.fe3e5a","name":"cloudb_12","x":306,"y":103,"wires":[[]]},{"id":"fa8a8ba.f984478","type":"catch","z":"42cc5e2a.1f178","name":"","scope":["e9e32afa.2b8a48","3c5d28e5.0271d8"],"x":76.5,"y":221,"wires":[["aa59a2f.fd8676"]]},{"id":"aa59a2f.fd8676","type":"function","z":"42cc5e2a.1f178","name":"set no data to output","func":"let emptyArray = []\nmsg.payload = emptyArray\nreturn msg","outputs":1,"noerr":0,"x":291.5,"y":221,"wires":[[]]},{"id":"fdda7208.13bc5","type":"http in","z":"e2b837c2.9e2be8","name":"","url":"/login/:cp","method":"post","upload":false,"swaggerDoc":"","x":98.00000762939453,"y":857.0000243186951,"wires":[["6c7868eb.411df8","7ba35f5e.10942"]]},{"id":"ab0dc096.bfcf7","type":"switch","z":"e2b837c2.9e2be8","name":"check pwd","property":"payload.pwd","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":104.00000762939453,"y":756,"wires":[["d17329cf.958908"],["642bcaf2.ef8bb4"]]},{"id":"d17329cf.958908","type":"switch","z":"e2b837c2.9e2be8","name":"check acc","property":"payload.acc","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":97.00000762939453,"y":702.999997138977,"wires":[["262cc0ad.32f73"],["642bcaf2.ef8bb4"]]},{"id":"642bcaf2.ef8bb4","type":"function","z":"e2b837c2.9e2be8","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":353.0000114440918,"y":731.5000047683716,"wires":[["a0dc81b9.ec6b1"]]},{"id":"a0dc81b9.ec6b1","type":"http response","z":"e2b837c2.9e2be8","name":"","statusCode":"","headers":{},"x":551.0000114440918,"y":735.5000047683716,"wires":[]},{"id":"262cc0ad.32f73","type":"function","z":"e2b837c2.9e2be8","name":"set user data to flow","func":"let ip = msg.req.get(\"x-client-ip\")\nif(ip !== undefined && ip.indexOf(\",\") != -1){\n    let ar = ip.split(',')\n    ip = ar[0]\n}else{\n  ip = msg.req.connection.remoteAddress\n}\nmsg.payload['ip'] = ip\nmsg.payload['cp'] = msg.req.params.cp\nmsg['userInfo'] = msg.payload\nmsg.payload = msg.payload.pwd\nreturn msg","outputs":1,"noerr":0,"x":118.00000762939453,"y":643.999997138977,"wires":[["d0bec150.e3b23"]]},{"id":"d0bec150.e3b23","type":"function","z":"e2b837c2.9e2be8","name":"set user query","func":"let newUser = msg['userInfo']\nlet sqlStr = 'select usr.*, r.roleName, r.dataset from ((select * from api_user where userBlock = 0 and cpId =(select cpId from api_cp where cpName = \"'+newUser.cp+'\") and (userName = \"'+newUser.acc+'\" or email = \"'+newUser.acc+'\")) as usr left join api_role as r on usr.roleId = r.roleId)'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":123.00000762939453,"y":583.999997138977,"wires":[["f65152af.f4bc1"]]},{"id":"5822d359.875fdc","type":"switch","z":"e2b837c2.9e2be8","name":"check user exist","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":120.75001525878906,"y":471.25,"wires":[["cb594b5c.5b7758"],["827bcfff.d0e49"]]},{"id":"827bcfff.d0e49","type":"function","z":"e2b837c2.9e2be8","name":"set no data result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'No user data'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":383.00000762939453,"y":517.250002861023,"wires":[["43598ef7.22db6"]]},{"id":"a7a2e8f7.2560e8","type":"http response","z":"e2b837c2.9e2be8","name":"admin","statusCode":"","headers":{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, GET, OPTIONS"},"x":700.75,"y":50,"wires":[]},{"id":"cb594b5c.5b7758","type":"function","z":"e2b837c2.9e2be8","name":"set user to flow","func":"msg['dbUser'] = msg.payload[0]\nlet sqlStr = 'select g.grpId, g.grpName, m.createFlg, m.updateFlg, m.deleteFlg from api_ra_mapping m left join api_grp g on m.grpId = g.grpId where roleId = '+msg.payload[0].roleId + ' order by m.sortId'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":120.2500228881836,"y":425.75,"wires":[["e411cc4e.528ec"]]},{"id":"a523dd06.eb747","type":"decrypt","z":"e2b837c2.9e2be8","name":"decrypt","algorithm":"TripleDES","key":"gemtek","x":112.25000762939453,"y":294.00000381469727,"wires":[["82b4cab3.a61ff8"]]},{"id":"82b4cab3.a61ff8","type":"function","z":"e2b837c2.9e2be8","name":"check pwd","func":"let userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet newPayload = {}\nif(userInfo.pwd === msg.payload){\n    newPayload['responseCode'] = '000'\n}else{\n    if(dbUser.userBlock === 1){\n        newPayload['responseCode'] = '401'\n        newPayload['responseMsg'] = 'user block'\n    }else{\n        newPayload['responseCode'] = '403'\n        newPayload['responseMsg'] = 'password incorrect'    \n    }\n}\nmsg['payload'] = newPayload\nreturn msg;","outputs":1,"noerr":0,"x":115.75000762939453,"y":245.75000429153442,"wires":[["9da87684.b11948"]]},{"id":"9da87684.b11948","type":"switch","z":"e2b837c2.9e2be8","name":"check statusCode","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","outputs":2,"x":133.50001525878906,"y":200.00000476837158,"wires":[["9ba1fafb.40e218"],["c2c51396.6859"]]},{"id":"9ba1fafb.40e218","type":"function","z":"e2b837c2.9e2be8","name":"gen token","func":"let userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet grps = msg['grps']\nlet grpStr = ''\nlet d = new Date()\nlet nowSeconds = Math.round(d.getTime() / 1000)\nif(grps && grps.length > 0){\n    for(let i = 0 ; i < grps.length ; i++){\n      grpStr += grps[i].grpId\n      if( i < grps.length - 1)\n        grpStr += ','\n    }\n}\nmsg.payload = grpStr+':'+nowSeconds+\":\"+dbUser.userId+\":\"+dbUser.cpId+\":\"+dbUser.roleId+\":\"+dbUser.dataset\nuserInfo['decryptToken'] = msg.payload\nmsg['userInfo'] = userInfo\nreturn msg;","outputs":1,"noerr":0,"x":124.25,"y":151,"wires":[["1b541a41.c512a6"]]},{"id":"1b541a41.c512a6","type":"encrypt","z":"e2b837c2.9e2be8","name":"encrypt token","algorithm":"TripleDES","key":"gemtektoken","x":142.5,"y":106.25,"wires":[["ed0082a8.39a14"]]},{"id":"ed0082a8.39a14","type":"function","z":"e2b837c2.9e2be8","name":"insert login history","func":"let userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet newPayload = []\nuserInfo['token'] = msg.payload\n\nlet sqlStr = 'insert into api_login_history(userId, userToken, history_login_time, history_ip, history_type, createTime) values ('+dbUser.userId+',\"'+msg.payload+'\", current_time(), \"'+userInfo.ip+'\", '+userInfo.type+', current_time())'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['userInfo'] = userInfo\nnewPayload.push(msg.payload)\nnewPayload.push(60)\nnewPayload.push('')\nmsg.payload = newPayload\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":150,"y":60,"wires":[["2d4797f3.db5d48","5f6c88de.2c9448"]]},{"id":"c02467e0.f5e608","type":"function","z":"e2b837c2.9e2be8","name":"set result","func":"let newPayload = {}\nlet userData = {}\nlet userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet grps = msg['grps']\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n    userData['name'] = dbUser['userName']\n    userData['nickName'] = dbUser['nickName']\n    userData['gender'] = dbUser['gender']\n    userData['pic'] = dbUser['pic']\n    userData['email'] = dbUser['email']\n    newPayload['userInfo'] = userData\n    newPayload['services'] = grps\n    newPayload['role'] = dbUser['roleName']\n    newPayload['authToken'] = userInfo['token']\n    newPayload['responseCode'] = '000'\n    newPayload['responseMsg'] = 'login success'\n}else{\n    newPayload['responseCode'] = '999'\n    newPayload['responseMsg'] = 'insert history fail'\n}\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":537.2500305175781,"y":51.00000762939453,"wires":[["a7a2e8f7.2560e8","cc710d94.824d5"]]},{"id":"f65152af.f4bc1","type":"subflow:42cc5e2a.1f178","z":"e2b837c2.9e2be8","x":119.00000762939453,"y":519.999997138977,"wires":[["5822d359.875fdc"]]},{"id":"2d4797f3.db5d48","type":"subflow:42cc5e2a.1f178","z":"e2b837c2.9e2be8","x":350,"y":60,"wires":[["c02467e0.f5e608"]]},{"id":"6e9c31e.cce88d","type":"inject","z":"e2b837c2.9e2be8","name":"","topic":"","payload":"U2FsdGVkX1+i7l3qj1yfscFyNUof914vQUcwaA5bP3M=","payloadType":"str","repeat":"","crontab":"","once":false,"x":111.00000381469727,"y":933.5000219345093,"wires":[["65d09213.bb713c"]]},{"id":"65d09213.bb713c","type":"decrypt","z":"e2b837c2.9e2be8","name":"","algorithm":"TripleDES","key":"gemtek","x":301.00000762939453,"y":932.5000243186951,"wires":[["2bb99e12.941b42"]]},{"id":"2bb99e12.941b42","type":"debug","z":"e2b837c2.9e2be8","name":"","active":true,"console":"false","complete":"false","x":477.00000762939453,"y":931.5000243186951,"wires":[]},{"id":"43598ef7.22db6","type":"http response","z":"e2b837c2.9e2be8","name":"","statusCode":"","headers":{},"x":658.7500190734863,"y":539.7500047683716,"wires":[]},{"id":"c2c51396.6859","type":"http response","z":"e2b837c2.9e2be8","name":"","statusCode":"","headers":{},"x":352.25001525878906,"y":256.0000047683716,"wires":[]},{"id":"c7f4a687.ba8af8","type":"inject","z":"e2b837c2.9e2be8","name":"","topic":"","payload":"DASHBOARD","payloadType":"str","repeat":"","crontab":"","once":false,"x":140.50000381469727,"y":975.5000247955322,"wires":[["4fecb414.a8f4fc"]]},{"id":"274f3cc3.89a924","type":"debug","z":"e2b837c2.9e2be8","name":"","active":true,"console":"false","complete":"false","x":487.50000381469727,"y":972.5000247955322,"wires":[]},{"id":"4fecb414.a8f4fc","type":"encrypt","z":"e2b837c2.9e2be8","name":"","algorithm":"TripleDES","key":"gemtek","x":293.00000381469727,"y":975.5000247955322,"wires":[["274f3cc3.89a924"]]},{"id":"e411cc4e.528ec","type":"subflow:42cc5e2a.1f178","z":"e2b837c2.9e2be8","x":124.5,"y":384,"wires":[["6a82bfdd.442e8"]]},{"id":"6a82bfdd.442e8","type":"function","z":"e2b837c2.9e2be8","name":"set pwd","func":"let dbUser = msg['dbUser']\nmsg['grps'] = msg.payload\nmsg.payload = dbUser.userPwd\nreturn msg","outputs":1,"noerr":0,"x":123.5,"y":342,"wires":[["a523dd06.eb747"]]},{"id":"cc710d94.824d5","type":"debug","z":"e2b837c2.9e2be8","name":"","active":true,"tosidebar":true,"console":false,"complete":"true","x":664.5,"y":105,"wires":[]},{"id":"892932d5.ef5af","type":"redis-command","z":"e2b837c2.9e2be8","server":"1cc07558.8db6bb","command":"setex","name":"","topic":"","x":530,"y":180,"wires":[["35fa3d28.933402"]]},{"id":"35fa3d28.933402","type":"debug","z":"e2b837c2.9e2be8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":690,"y":180,"wires":[]},{"id":"5f6c88de.2c9448","type":"function","z":"e2b837c2.9e2be8","name":"set property sql","func":"let userInfo = msg['userInfo']\nlet sqlStr = 'select * from api_system_properties where p_name = \"TOKEN_EXPIRE\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":360,"y":100,"wires":[["e0370f91.1f4fd"]]},{"id":"e0370f91.1f4fd","type":"subflow:42cc5e2a.1f178","z":"e2b837c2.9e2be8","x":350,"y":140,"wires":[["7dba2ffc.f23df"]]},{"id":"7dba2ffc.f23df","type":"function","z":"e2b837c2.9e2be8","name":"set expire","func":"let newPayload = []\nlet userInfo = msg['userInfo']\nlet expireTime = 86400\nif(msg.payload.length > 0){\n  expireTime = msg.payload[0]['p_value']\n}\nnewPayload.push(userInfo.token)\nnewPayload.push(expireTime)\nnewPayload.push(userInfo.decryptToken)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":360,"y":180,"wires":[["892932d5.ef5af"]]},{"id":"609c4ec7.66dad","type":"http in","z":"21db4fe9.158d2","name":"","url":"/ldap/login","method":"post","upload":false,"swaggerDoc":"","x":92,"y":302,"wires":[["c2366b2c.892708"]]},{"id":"a6086d4b.64bf","type":"node-red-contrib-nr-ldapauth","z":"21db4fe9.158d2","name":"","server":"2b254c02.220054","filter":"(&(objectClass=user)(sAMAccountName={{username}}))","searchbase":"dc=gemteks,dc=com","x":261,"y":93,"wires":[["1894d099.2f850f","e5023db8.4ae0d"]]},{"id":"c2366b2c.892708","type":"switch","z":"21db4fe9.158d2","name":"check u","property":"payload.u","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":93,"y":254,"wires":[["5590d490.e8ff6c"],["dbc1b740.8f9c18"]]},{"id":"5590d490.e8ff6c","type":"switch","z":"21db4fe9.158d2","name":"check p","property":"payload.p","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":92,"y":208,"wires":[["25d37732.1016b8"],["dbc1b740.8f9c18"]]},{"id":"dbc1b740.8f9c18","type":"function","z":"21db4fe9.158d2","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":287,"y":238,"wires":[["5ff841de.cb832"]]},{"id":"5ff841de.cb832","type":"http response","z":"21db4fe9.158d2","name":"","statusCode":"","headers":{},"x":851,"y":208,"wires":[]},{"id":"25d37732.1016b8","type":"function","z":"21db4fe9.158d2","name":"set ip","func":"msg.req.ip = \"10.5.1.101\"\nnode.warn(\"ip:\"+msg.req.ip)\nreturn msg","outputs":1,"noerr":0,"x":100,"y":157,"wires":[["a6086d4b.64bf","845bab05.9e9338"]]},{"id":"845bab05.9e9338","type":"debug","z":"21db4fe9.158d2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":223,"y":154,"wires":[]},{"id":"1894d099.2f850f","type":"debug","z":"21db4fe9.158d2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":469,"y":58,"wires":[]},{"id":"e5023db8.4ae0d","type":"function","z":"21db4fe9.158d2","name":"check result","func":"let newPayload = {}\nif(msg.auth){\n  newPayload.responseCode = '000'\n  newPayload.responseMsg = 'login success'\n}else{\n  newPayload.responseCode = '403'\n  newPayload.responseMsg = 'login fail'\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":478,"y":124,"wires":[["5ff841de.cb832"]]},{"id":"9ec4fd89.cbba9","type":"http in","z":"497feb9e.421f54","name":"","url":"/logout","method":"post","upload":false,"swaggerDoc":"","x":112,"y":404,"wires":[["7b414f3.bb7dab"]]},{"id":"7b414f3.bb7dab","type":"switch","z":"497feb9e.421f54","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":131,"y":324,"wires":[["521e959.4eef46c"],["25841c72.7dad04"]]},{"id":"25841c72.7dad04","type":"function","z":"497feb9e.421f54","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":326.5,"y":351,"wires":[["82664abd.fa3dd8"]]},{"id":"82664abd.fa3dd8","type":"http response","z":"497feb9e.421f54","name":"","statusCode":"","headers":{},"x":884.5,"y":348,"wires":[]},{"id":"521e959.4eef46c","type":"function","z":"497feb9e.421f54","name":"set token to decrypt","func":"msg['tokenInfo'] = msg.payload\nmsg.payload = msg.payload.token\nreturn msg","outputs":1,"noerr":0,"x":168,"y":249,"wires":[["27c1f0b1.35d55"]]},{"id":"27c1f0b1.35d55","type":"decrypt","z":"497feb9e.421f54","name":"decrypt token","algorithm":"TripleDES","key":"gemtektoken","x":158,"y":184,"wires":[["552e94d.1c3d36c"]]},{"id":"552e94d.1c3d36c","type":"function","z":"497feb9e.421f54","name":"set update sql","func":"let tokenInfo = msg['tokenInfo']\nlet token = msg.payload\nlet newPayload = []\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n}\nlet sqlStr = 'update api_login_history set history_logout_time = current_time() where history_logout_time is null and userToken = \"'+tokenInfo.token+'\" and userId = ' + ar[2]\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nnewPayload.push(tokenInfo.token)\nmsg.payload = newPayload\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\n","outputs":1,"noerr":0,"x":161,"y":127,"wires":[["85f83a5b.8f9e28"]]},{"id":"85f83a5b.8f9e28","type":"switch","z":"497feb9e.421f54","name":"check decrypt token","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":164,"y":74,"wires":[["297ea8a4.a27008","dafb791d.f9db38"],["d7d7cfb6.41dec"]]},{"id":"d7d7cfb6.41dec","type":"function","z":"497feb9e.421f54","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'token fail'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":445,"y":251,"wires":[["82664abd.fa3dd8"]]},{"id":"f1e63d38.fae9a","type":"function","z":"497feb9e.421f54","name":"set result","func":"let newPayload = {}\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n    newPayload['responseCode'] = '000'\n    newPayload['responseMsg'] = 'logout success'    \n}else{\n    newPayload['responseCode'] = '404'\n    newPayload['responseMsg'] = 'alredy logout or no login data'\n}\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":612.5,"y":90,"wires":[["82664abd.fa3dd8"]]},{"id":"297ea8a4.a27008","type":"redis-command","z":"497feb9e.421f54","server":"f61937b6.35a578","command":"del","name":"del cache","topic":"","x":432.5,"y":163,"wires":[["7a3d0d02.b6e524"]]},{"id":"7a3d0d02.b6e524","type":"debug","z":"497feb9e.421f54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":582.5,"y":163,"wires":[]},{"id":"dafb791d.f9db38","type":"subflow:42cc5e2a.1f178","z":"497feb9e.421f54","x":404,"y":74,"wires":[["f1e63d38.fae9a"]]},{"id":"6c7868eb.411df8","type":"debug","z":"e2b837c2.9e2be8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":306.50000381469727,"y":855.8000240325928,"wires":[]},{"id":"7ba35f5e.10942","type":"json","z":"e2b837c2.9e2be8","name":"","property":"payload","action":"obj","pretty":false,"x":92.5,"y":809.6001214981079,"wires":[["ab0dc096.bfcf7"]]},{"id":"9d6040ad.09235","type":"http in","z":"cafe140c.d22e68","name":"","url":"/chkToken","method":"get","upload":false,"swaggerDoc":"","x":115.5,"y":456,"wires":[["cea3d073.f2b31","aacd1230.b55dd"]]},{"id":"e0372c12.dc7ae","type":"function","z":"cafe140c.d22e68","name":"check login history","func":"let actInfo = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg","outputs":1,"noerr":0,"x":122,"y":364,"wires":[["ac7c7b43.99e238"]]},{"id":"a4b6cdeb.d24cd","type":"switch","z":"cafe140c.d22e68","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":117.5,"y":258,"wires":[["cf0f2759.555a08"],["9443e59e.7be398"]]},{"id":"ac7c7b43.99e238","type":"subflow:42cc5e2a.1f178","z":"cafe140c.d22e68","x":118.5,"y":311,"wires":[["a4b6cdeb.d24cd"]]},{"id":"cea3d073.f2b31","type":"switch","z":"cafe140c.d22e68","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":120,"y":413,"wires":[["e0372c12.dc7ae"],["9492bdbf.27302"]]},{"id":"9492bdbf.27302","type":"function","z":"cafe140c.d22e68","name":"set missing para","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'missing parameters'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":361.5,"y":397,"wires":[["f91046c1.8773c8"]]},{"id":"f91046c1.8773c8","type":"http response","z":"cafe140c.d22e68","name":"","statusCode":"","headers":{},"x":694.5,"y":254,"wires":[]},{"id":"1869744b.0b0d4c","type":"switch","z":"47f0f2eb.a3493c","name":"lbs","property":"flow","propertyType":"msg","rules":[{"t":"gte","v":"5","vt":"str"},{"t":"lt","v":"5","vt":"str"}],"checkall":"true","outputs":2,"x":165.5,"y":78,"wires":[["14ef4506.5367cb"],["1ccf01b9.39ea0e"]]},{"id":"14ef4506.5367cb","type":"redis-command","z":"47f0f2eb.a3493c","server":"42c65af9.ad7ff4","command":"get","name":"redis_23","topic":"","x":318.5,"y":52,"wires":[[]]},{"id":"1ccf01b9.39ea0e","type":"redis-command","z":"47f0f2eb.a3493c","server":"8032dbcd.04df78","command":"get","name":"redis_22","topic":"","x":317,"y":109,"wires":[[]]},{"id":"ae6b6d22.2992a","type":"catch","z":"47f0f2eb.a3493c","name":"","scope":["1ccf01b9.39ea0e","14ef4506.5367cb"],"x":99.5,"y":242,"wires":[["d5ab2a6d.b5de28"]]},{"id":"d5ab2a6d.b5de28","type":"function","z":"47f0f2eb.a3493c","name":"set null to payload","func":"msg.payload = null\nreturn msg","outputs":1,"noerr":0,"x":317.5,"y":240,"wires":[[]]},{"id":"cf0f2759.555a08","type":"function","z":"cafe140c.d22e68","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":149,"y":202,"wires":[["4e5110ab.93e0a"]]},{"id":"4e5110ab.93e0a","type":"subflow:47f0f2eb.a3493c","z":"cafe140c.d22e68","x":134,"y":150,"wires":[["3d5a238d.3a858c"]]},{"id":"3d5a238d.3a858c","type":"switch","z":"cafe140c.d22e68","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":144,"y":108,"wires":[["e8e9e2dd.d6432"],["45e3dd17.27c094"]]},{"id":"9443e59e.7be398","type":"function","z":"cafe140c.d22e68","name":"set logout","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'User already logout'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":370,"y":279,"wires":[["f91046c1.8773c8"]]},{"id":"45e3dd17.27c094","type":"function","z":"cafe140c.d22e68","name":"set token expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":387,"y":164,"wires":[["f91046c1.8773c8"]]},{"id":"e8e9e2dd.d6432","type":"function","z":"cafe140c.d22e68","name":"set success","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'token verify success'\nnewPayload['data'] = msg.payload\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":394.5,"y":84,"wires":[["f91046c1.8773c8"]]},{"id":"9447ad10.ce4cc","type":"switch","z":"c4ef04b6.f3ef08","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":122,"y":435,"wires":[["d0b1df1.c2aa52"],["8b57094c.396d78"]]},{"id":"d0b1df1.c2aa52","type":"function","z":"c4ef04b6.f3ef08","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":134,"y":389,"wires":[["9990d313.f4a6a"]]},{"id":"8b57094c.396d78","type":"function","z":"c4ef04b6.f3ef08","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":383,"y":454,"wires":[["52aa22f9.28c42c"]]},{"id":"52aa22f9.28c42c","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1136,"y":416,"wires":[]},{"id":"40f8d8ed.3d0098","type":"switch","z":"c4ef04b6.f3ef08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":122,"y":301,"wires":[["863f039d.1f555"],["752f28f2.f090a8"]]},{"id":"752f28f2.f090a8","type":"function","z":"c4ef04b6.f3ef08","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":389,"y":350,"wires":[["52aa22f9.28c42c"]]},{"id":"39990ff1.6c9c2","type":"switch","z":"c4ef04b6.f3ef08","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":150,"y":97,"wires":[["9db0f732.3c3f38"],["fc6caa69.b98fb8"]]},{"id":"fc6caa69.b98fb8","type":"function","z":"c4ef04b6.f3ef08","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":390,"y":117,"wires":[["52aa22f9.28c42c"]]},{"id":"a9023c42.74a5","type":"function","z":"c4ef04b6.f3ef08","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":380,"y":197,"wires":[["52aa22f9.28c42c"]]},{"id":"3830ad29.31d952","type":"function","z":"c4ef04b6.f3ef08","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":800,"y":117,"wires":[["52aa22f9.28c42c"]]},{"id":"d37ebc5d.77304","type":"function","z":"c4ef04b6.f3ef08","name":"set all prop query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select p_name, p_value, p_desc, p_type, createTime from api_system_properties where (p_type = \"ALL\" or p_type in ('+msg.grps+')) '\nif(actInfo.search && actInfo.search.length > 0){\n  sqlStr = sqlStr + ' and p_name like \"%'+actInfo.search+'%\" '\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":800,"y":37,"wires":[["7489dd32.ceffd4"]]},{"id":"6a08ab0a.d18584","type":"function","z":"c4ef04b6.f3ef08","name":"set result","func":"let newPayload = {}\nif(msg.payload.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = msg.payload.length\n  newPayload['props'] = msg.payload\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":37,"wires":[["139a20e3.fa164f"]]},{"id":"9db0f732.3c3f38","type":"function","z":"c4ef04b6.f3ef08","name":"check grp","func":"let actInfo = msg['actInfo']\nlet accessFlg = false\nlet grpStr = actInfo.grp\nif(grpStr){\n  let ar = grpStr.split(',')\n    for(let i = 0 ; i < ar.length ; i++){\n      if(ar[i] === '29'){\n        accessFlg = true\n      }\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nmsg['grps'] = actInfo.grp\nreturn msg","outputs":1,"noerr":0,"x":370,"y":77,"wires":[["ea7f6dd9.4bbe3"]]},{"id":"ea7f6dd9.4bbe3","type":"switch","z":"c4ef04b6.f3ef08","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":580,"y":77,"wires":[["d37ebc5d.77304"],["3830ad29.31d952"]]},{"id":"863f039d.1f555","type":"function","z":"c4ef04b6.f3ef08","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":170,"y":257,"wires":[["3a41be77.11d0c2"]]},{"id":"51d7372f.c83ee8","type":"switch","z":"c4ef04b6.f3ef08","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":177,"y":181,"wires":[["cc0517c7.8b11c8"],["a9023c42.74a5"]]},{"id":"cc0517c7.8b11c8","type":"function","z":"c4ef04b6.f3ef08","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":147,"y":141,"wires":[["39990ff1.6c9c2"]]},{"id":"f353b709.247228","type":"http in","z":"c4ef04b6.f3ef08","name":"","url":"/sys","method":"get","upload":false,"swaggerDoc":"","x":115,"y":481,"wires":[["9447ad10.ce4cc"]]},{"id":"139a20e3.fa164f","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1340,"y":37,"wires":[]},{"id":"9990d313.f4a6a","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":110.5,"y":344,"wires":[["40f8d8ed.3d0098"]]},{"id":"7489dd32.ceffd4","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":1014.5,"y":37,"wires":[["6a08ab0a.d18584"]]},{"id":"3a41be77.11d0c2","type":"subflow:47f0f2eb.a3493c","z":"c4ef04b6.f3ef08","x":156.5,"y":216,"wires":[["51d7372f.c83ee8"]]},{"id":"7e2da779.179158","type":"http in","z":"c4ef04b6.f3ef08","name":"","url":"/sys","method":"post","upload":false,"swaggerDoc":"","x":95,"y":1255.2499923706055,"wires":[["3f64d0d0.fd4b7"]]},{"id":"2af2f26f.75023e","type":"switch","z":"c4ef04b6.f3ef08","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":95,"y":971.2499923706055,"wires":[["7a6aaf5e.a5d0d"],["4f3542c7.931f8c"]]},{"id":"7a6aaf5e.a5d0d","type":"function","z":"c4ef04b6.f3ef08","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":107,"y":925.2499923706055,"wires":[["737bf6b6.ec7938"]]},{"id":"4f3542c7.931f8c","type":"function","z":"c4ef04b6.f3ef08","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":430,"y":1080.2499923706055,"wires":[["9824f059.f841e"]]},{"id":"9824f059.f841e","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1109,"y":952.2499923706055,"wires":[]},{"id":"73d26648.b51eb8","type":"switch","z":"c4ef04b6.f3ef08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":95,"y":837.2499923706055,"wires":[["5d1cc887.9d8388"],["c937a9e0.eb79f8"]]},{"id":"c937a9e0.eb79f8","type":"function","z":"c4ef04b6.f3ef08","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":362,"y":886.2499923706055,"wires":[["9824f059.f841e"]]},{"id":"90b08a6a.ffa588","type":"switch","z":"c4ef04b6.f3ef08","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":110,"y":640.2499923706055,"wires":[["63162dd5.e4f014"],["7e2be241.a951ac"]]},{"id":"7e2be241.a951ac","type":"function","z":"c4ef04b6.f3ef08","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":370,"y":680.2499923706055,"wires":[["9824f059.f841e"]]},{"id":"696682f7.a05d1c","type":"function","z":"c4ef04b6.f3ef08","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":360,"y":760.2499923706055,"wires":[["9824f059.f841e"]]},{"id":"76f5bf31.59b8e","type":"function","z":"c4ef04b6.f3ef08","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":700,"y":680.2499923706055,"wires":[["9824f059.f841e"]]},{"id":"b59d8427.a45218","type":"function","z":"c4ef04b6.f3ef08","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nif(msg.action === 'update'){\n  newPayload['responseMsg'] = 'update ' + res\n}\nif(msg.action === 'insert'){\n  newPayload['responseMsg'] = 'insert ' + res\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1710,"y":600.2499923706055,"wires":[["be66309a.e9d74"]]},{"id":"be66309a.e9d74","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1740,"y":520.2499923706055,"wires":[]},{"id":"f586ac39.94562","type":"switch","z":"c4ef04b6.f3ef08","name":"check type","property":"payload.type.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":100,"y":1065.2499923706055,"wires":[["10759c97.56bb13"],["4f3542c7.931f8c"]]},{"id":"5745b3c3.a4b0fc","type":"switch","z":"c4ef04b6.f3ef08","name":"check sysId","property":"sysId","propertyType":"msg","rules":[{"t":"eq","v":"-1","vt":"num"},{"t":"neq","v":"-1","vt":"str"}],"checkall":"true","outputs":2,"x":740,"y":580.2499923706055,"wires":[["22aaf929.b22386"],["d7f12eed.0d591"]]},{"id":"d7f12eed.0d591","type":"function","z":"c4ef04b6.f3ef08","name":"set update properties query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'UPDATE `cloudb`.`api_system_properties` SET  `p_value` = \"'+actInfo.value+'\", `p_desc` = \"'+actInfo.desc+'\", `p_type` = \"'+actInfo.type+'\", `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `p_name` = \"'+actInfo.name+'\"'\nmsg['action'] = 'update'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":950,"y":600.2499923706055,"wires":[["409a2323.304c8c"]]},{"id":"d01a42a5.a2a85","type":"switch","z":"c4ef04b6.f3ef08","name":"check name","property":"payload.name.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":103,"y":1161.2499923706055,"wires":[["697a2ee5.a030a"],["4f3542c7.931f8c"]]},{"id":"697a2ee5.a030a","type":"switch","z":"c4ef04b6.f3ef08","name":"check value","property":"payload.value.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":99,"y":1111.2499923706055,"wires":[["f586ac39.94562"],["4f3542c7.931f8c"]]},{"id":"3f64d0d0.fd4b7","type":"switch","z":"c4ef04b6.f3ef08","name":"check sysId","property":"payload.sysId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":96,"y":1207.2499923706055,"wires":[["d01a42a5.a2a85"],[]]},{"id":"10759c97.56bb13","type":"switch","z":"c4ef04b6.f3ef08","name":"check desc","property":"payload.desc.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":102,"y":1020.2499923706055,"wires":[["2af2f26f.75023e"],[]]},{"id":"22aaf929.b22386","type":"function","z":"c4ef04b6.f3ef08","name":"set get prop query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select p_name, p_value, p_desc, p_type, createTime from api_system_properties where p_name = \"'+actInfo.name+'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":920,"y":540.2499923706055,"wires":[["7f5742cf.abbb2c"]]},{"id":"ee4d307e.d82a5","type":"switch","z":"c4ef04b6.f3ef08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":1198.1250190734863,"y":506.4999990463257,"wires":[["fa0f4161.0faa4"],["baeb7f76.f5482"]]},{"id":"baeb7f76.f5482","type":"function","z":"c4ef04b6.f3ef08","name":"set properties exist","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'properties name exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1240,"y":560.2499923706055,"wires":[["d2641bfc.dc3bc8"]]},{"id":"d2641bfc.dc3bc8","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1400,"y":560.2499923706055,"wires":[]},{"id":"63162dd5.e4f014","type":"function","z":"c4ef04b6.f3ef08","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n    if(ar[i] === '29'){\n      accessFlg = true\n    }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":350,"y":600.2499923706055,"wires":[["fc4aff43.843c6"]]},{"id":"fc4aff43.843c6","type":"switch","z":"c4ef04b6.f3ef08","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":540,"y":600.2499923706055,"wires":[["5745b3c3.a4b0fc"],["76f5bf31.59b8e"]]},{"id":"5d1cc887.9d8388","type":"function","z":"c4ef04b6.f3ef08","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":130,"y":800.2499923706055,"wires":[["5b2a76ab.4d2198"]]},{"id":"7a741c4d.172504","type":"switch","z":"c4ef04b6.f3ef08","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":137,"y":724.2499923706055,"wires":[["c74e1d6c.5184b"],["696682f7.a05d1c"]]},{"id":"c74e1d6c.5184b","type":"function","z":"c4ef04b6.f3ef08","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":107,"y":684.2499923706055,"wires":[["90b08a6a.ffa588"]]},{"id":"fa0f4161.0faa4","type":"function","z":"c4ef04b6.f3ef08","name":"set insert properties query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'INSERT INTO `cloudb`.`api_system_properties` (`p_name`, `p_value`, `p_desc`, `p_type`, `createTime`, `createUser`) VALUES (\"'+actInfo.name+'\", \"'+actInfo.value+'\", \"'+actInfo.desc+'\", \"'+actInfo.type+'\", current_time(), '+actInfo.userId+') '\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1424.25,"y":472,"wires":[["409a2323.304c8c"]]},{"id":"5b2a76ab.4d2198","type":"subflow:47f0f2eb.a3493c","z":"c4ef04b6.f3ef08","x":126.5,"y":765,"wires":[["7a741c4d.172504"]]},{"id":"7f5742cf.abbb2c","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":1065.5,"y":498,"wires":[["ee4d307e.d82a5"]]},{"id":"409a2323.304c8c","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":1555.5,"y":597,"wires":[["b59d8427.a45218"]]},{"id":"737bf6b6.ec7938","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":100.5,"y":879,"wires":[["73d26648.b51eb8"]]},{"id":"aedba914.8bf258","type":"http in","z":"c4ef04b6.f3ef08","name":"","url":"/sys","method":"delete","upload":false,"swaggerDoc":"","x":119,"y":1809,"wires":[["3cbc24f4.b74f6c"]]},{"id":"8a4817a4.6e9fb8","type":"switch","z":"c4ef04b6.f3ef08","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":112.33332824707031,"y":1699.999924659729,"wires":[["3d242f04.89d58"],["686bf069.3dbce"]]},{"id":"3d242f04.89d58","type":"function","z":"c4ef04b6.f3ef08","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":124.33332824707031,"y":1653.999924659729,"wires":[["e5b2d8f3.476fa8"]]},{"id":"686bf069.3dbce","type":"function","z":"c4ef04b6.f3ef08","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":437.33333587646484,"y":1728.999924659729,"wires":[["58d9771a.a805e8"]]},{"id":"58d9771a.a805e8","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1126.3333282470703,"y":1680.999924659729,"wires":[]},{"id":"35d590ce.a8de3","type":"switch","z":"c4ef04b6.f3ef08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":112.33332824707031,"y":1565.999924659729,"wires":[["c67a70fa.5f751"],["cd465414.40b8a8"]]},{"id":"cd465414.40b8a8","type":"function","z":"c4ef04b6.f3ef08","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":427.33333587646484,"y":1608.999924659729,"wires":[["58d9771a.a805e8"]]},{"id":"719298bd.400868","type":"switch","z":"c4ef04b6.f3ef08","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":127.33333587646484,"y":1368.999924659729,"wires":[["543ce10b.aebd3"],["825f2a43.4dac98"]]},{"id":"825f2a43.4dac98","type":"function","z":"c4ef04b6.f3ef08","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":427.33333587646484,"y":1408.999924659729,"wires":[["58d9771a.a805e8"]]},{"id":"356225cb.5d1b1a","type":"function","z":"c4ef04b6.f3ef08","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":417.33333587646484,"y":1508.999924659729,"wires":[["58d9771a.a805e8"]]},{"id":"db8bfc62.70011","type":"function","z":"c4ef04b6.f3ef08","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":857.3333358764648,"y":1348.999924659729,"wires":[["58d9771a.a805e8"]]},{"id":"180802a5.a7092d","type":"function","z":"c4ef04b6.f3ef08","name":"set delete prop query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `cloudb`.`api_system_properties` WHERE p_name = \"'+actInfo.name+'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":867.3333358764648,"y":1268.999924659729,"wires":[["317edb99.ec73a4"]]},{"id":"f781ed29.bffe6","type":"http response","z":"c4ef04b6.f3ef08","name":"","statusCode":"","headers":{},"x":1397.3333358764648,"y":1268.999924659729,"wires":[]},{"id":"543ce10b.aebd3","type":"function","z":"c4ef04b6.f3ef08","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n    if(ar[i] === '29'){\n      accessFlg = true\n    }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":407.33333587646484,"y":1308.999924659729,"wires":[["f4d9a9cd.1c1348"]]},{"id":"f4d9a9cd.1c1348","type":"switch","z":"c4ef04b6.f3ef08","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":617.3333358764648,"y":1308.999924659729,"wires":[["180802a5.a7092d"],["db8bfc62.70011"]]},{"id":"3cbc24f4.b74f6c","type":"switch","z":"c4ef04b6.f3ef08","name":"check name","property":"payload.name.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":117.33332824707031,"y":1750.6664247512817,"wires":[["8a4817a4.6e9fb8"],["686bf069.3dbce"]]},{"id":"2fb16b32.5b0214","type":"function","z":"c4ef04b6.f3ef08","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nnewPayload['responseMsg'] = 'delete ' + res\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1247.3333358764648,"y":1268.999924659729,"wires":[["f781ed29.bffe6"]]},{"id":"c67a70fa.5f751","type":"function","z":"c4ef04b6.f3ef08","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":147.33333587646484,"y":1528.999924659729,"wires":[["b6c5a40.5d1236"]]},{"id":"60c55b04.8c9654","type":"switch","z":"c4ef04b6.f3ef08","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":154.33333587646484,"y":1452.999924659729,"wires":[["90ba0c11.d5124"],["356225cb.5d1b1a"]]},{"id":"90ba0c11.d5124","type":"function","z":"c4ef04b6.f3ef08","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  flow.set('actInfo', actInfo)\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":124.33333587646484,"y":1412.999924659729,"wires":[["719298bd.400868"]]},{"id":"b6c5a40.5d1236","type":"subflow:47f0f2eb.a3493c","z":"c4ef04b6.f3ef08","x":139.5,"y":1493,"wires":[["60c55b04.8c9654"]]},{"id":"e5b2d8f3.476fa8","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":107.5,"y":1606,"wires":[["35d590ce.a8de3"]]},{"id":"317edb99.ec73a4","type":"subflow:42cc5e2a.1f178","z":"c4ef04b6.f3ef08","x":1062.5,"y":1269,"wires":[["2fb16b32.5b0214"]]},{"id":"edc2627e.5345d","type":"http in","z":"5daf8c52.99ee44","name":"","url":"/login/record","method":"get","upload":false,"swaggerDoc":"","x":210.00001525878906,"y":633,"wires":[["2b0c3d63.28d022"]]},{"id":"5a383fdb.0733d","type":"http in","z":"5daf8c52.99ee44","name":"","url":"/login/recordCnt","method":"get","upload":false,"swaggerDoc":"","x":205,"y":1295.818166732788,"wires":[["43a3b15.23da75"]]},{"id":"2b0c3d63.28d022","type":"switch","z":"5daf8c52.99ee44","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":213.00001525878906,"y":583,"wires":[["5641c1da.5d001"],["48827d34.df1704"]]},{"id":"48827d34.df1704","type":"function","z":"5daf8c52.99ee44","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":521.0000076293945,"y":597.9999961853027,"wires":[["c2b9c449.6e6678"]]},{"id":"5641c1da.5d001","type":"switch","z":"5daf8c52.99ee44","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":202,"y":532,"wires":[["3d4294b6.d0128c"],["be159924.dbfc38"]]},{"id":"be159924.dbfc38","type":"moment","z":"5daf8c52.99ee44","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":442.9999771118164,"y":541.5999717712402,"wires":[["3d4294b6.d0128c"]]},{"id":"b4442472.1212e8","type":"moment","z":"5daf8c52.99ee44","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":436.4999694824219,"y":478.3999938964844,"wires":[["26542532.bd2f8a"]]},{"id":"3d4294b6.d0128c","type":"switch","z":"5daf8c52.99ee44","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":211.4999771118164,"y":474.7999839782715,"wires":[["26542532.bd2f8a"],["b4442472.1212e8"]]},{"id":"26542532.bd2f8a","type":"function","z":"5daf8c52.99ee44","name":"check login history","func":"let actInfo = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":232,"y":432,"wires":[["43fc084c.7d84d8"]]},{"id":"43fc084c.7d84d8","type":"subflow:42cc5e2a.1f178","z":"5daf8c52.99ee44","x":219.5,"y":390,"wires":[["e8647b90.a3cb88"]]},{"id":"e8647b90.a3cb88","type":"switch","z":"5daf8c52.99ee44","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":221.5,"y":337,"wires":[["7127bbe7.2ef1b4"],["35a97f30.dde4a"]]},{"id":"7127bbe7.2ef1b4","type":"function","z":"5daf8c52.99ee44","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":227,"y":289,"wires":[["851be808.a9cfb8"]]},{"id":"851be808.a9cfb8","type":"subflow:47f0f2eb.a3493c","z":"5daf8c52.99ee44","x":224,"y":242,"wires":[["548ec28b.236ecc"]]},{"id":"548ec28b.236ecc","type":"switch","z":"5daf8c52.99ee44","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":231,"y":193,"wires":[["78603a40.13b444"],["338c9b19.e94ae4"]]},{"id":"338c9b19.e94ae4","type":"function","z":"5daf8c52.99ee44","name":"set token expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":476,"y":275,"wires":[["c2b9c449.6e6678"]]},{"id":"35a97f30.dde4a","type":"function","z":"5daf8c52.99ee44","name":"set logout","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'User already logout'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":472,"y":377,"wires":[["c2b9c449.6e6678"]]},{"id":"c2b9c449.6e6678","type":"http response","z":"5daf8c52.99ee44","name":"","statusCode":"","headers":{},"x":851,"y":451,"wires":[]},{"id":"78603a40.13b444","type":"function","z":"5daf8c52.99ee44","name":"set sql to get count","func":"let actInfo = msg['actInfo']\nlet nowDate = new Date()\nlet curYear = nowDate.getFullYear()\nlet curMonth = nowDate.getMonth()+1\nlet curDay = ('00'+nowDate.getDate()).slice(-2)\nlet lastDate = new Date(curYear, curMonth-1, 0)\nlet lastMonth = lastDate.getMonth()+1\nlet lastDay = ('00'+lastDate.getDate()).slice(-2)\nlet curFrom = curYear +'-'+lastMonth+'-'+lastDay+' 16:00:00'\nlet curTo = curYear +'-'+curMonth+'-'+curDay+' 16:00:00'\nlet fromStr = msg['from'] !== undefined ? msg['from'] : curFrom\nlet toStr = msg['to'] !== undefined ? msg['to'] : curTo\nlet sqlStr = 'select count(1) as cnt from api_login_history where userId = '+actInfo.userId+' and history_login_time between \"'+fromStr+'\" and \"'+toStr+'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['from'] = fromStr\nmsg['to'] = toStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":492,"y":177,"wires":[["94917633.94b558"]]},{"id":"94917633.94b558","type":"subflow:42cc5e2a.1f178","z":"5daf8c52.99ee44","x":687,"y":177,"wires":[["cbe72445.17f9b8"]]},{"id":"cbe72445.17f9b8","type":"function","z":"5daf8c52.99ee44","name":"check cnt","func":"let cntObj = msg.payload[0]\nemptyFlg = false\nif(cntObj['cnt'] <= 0){\n  emptyFlg = true\n}\nmsg['emptyFlg'] = emptyFlg\nmsg['total'] = cntObj['cnt']\nreturn msg","outputs":1,"noerr":0,"x":855.2727470397949,"y":175.90908432006836,"wires":[["68cafbef.3718d4"]]},{"id":"68cafbef.3718d4","type":"switch","z":"5daf8c52.99ee44","name":"check emptyFlg","property":"emptyFlg","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1020.4545516967773,"y":177.27272033691406,"wires":[["56c8548c.3af0fc"],["eca101a6.0c0ce"]]},{"id":"eca101a6.0c0ce","type":"function","z":"5daf8c52.99ee44","name":"set empty result","func":"let newPayload = {}\nlet records = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = records.length\nnewPayload['data'] = records\nreturn msg","outputs":1,"noerr":0,"x":1206.8181818181818,"y":228.18181818181816,"wires":[["554408c9.91f888"]]},{"id":"554408c9.91f888","type":"http response","z":"5daf8c52.99ee44","name":"","statusCode":"","headers":{},"x":1792.2727012634277,"y":230.00000953674316,"wires":[]},{"id":"56c8548c.3af0fc","type":"function","z":"5daf8c52.99ee44","name":"set sql to get records","func":"let actInfo = msg['actInfo']\nlet fromStr = msg['from']\nlet toStr = msg['to']\nlet limit = 10\nlet page = 1\nif(actInfo['limit'] != undefined){\n  limit = parseInt(actInfo['limit'])\n}\nif(actInfo['page'] != undefined){\n  page = parseInt(actInfo['page'])\n}\nlet offset = (page-1) * limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\n\nlet sqlStr = 'select historyId, userId, history_login_time, history_logout_time, history_ip, history_type from api_login_history where userId = '+actInfo.userId+' and history_login_time between \"'+fromStr+'\" and \"'+toStr+'\" order by history_login_time desc limit '+offset+','+limit\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nactInfo['next'] = nextPage\nactInfo['previous'] = previous\nactInfo['page_limit'] = limit\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1242.727294921875,"y":148.1818084716797,"wires":[["30d2ad0d.e0e1f2"]]},{"id":"30d2ad0d.e0e1f2","type":"subflow:42cc5e2a.1f178","z":"5daf8c52.99ee44","x":1455.454475402832,"y":148.18181991577148,"wires":[["6ea39f2c.00089"]]},{"id":"6ea39f2c.00089","type":"function","z":"5daf8c52.99ee44","name":"set result","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nlet pages = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = msg['total']\npages['next'] = actInfo['next']\npages['previous'] = actInfo['previous']\npages['limit'] = actInfo['page_limit']\nnewPayload['pages'] = pages\nnewPayload['data'] = msg.payload\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1640.4545135498047,"y":187.27273082733154,"wires":[["554408c9.91f888"]]},{"id":"43a3b15.23da75","type":"switch","z":"5daf8c52.99ee44","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":208.1818084716797,"y":1240.9090576171875,"wires":[["425c5ee7.98938"],["d7b2356e.2b8688"]]},{"id":"d7b2356e.2b8688","type":"function","z":"5daf8c52.99ee44","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":516.1818008422852,"y":1255.9090538024902,"wires":[["c2b4cb7c.5ee568"]]},{"id":"425c5ee7.98938","type":"switch","z":"5daf8c52.99ee44","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":197.18179321289062,"y":1189.9090576171875,"wires":[["2c6971cf.8a1e8e"],["2e6d1186.2366fe"]]},{"id":"2e6d1186.2366fe","type":"moment","z":"5daf8c52.99ee44","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":438.18177032470703,"y":1199.5090293884277,"wires":[["2c6971cf.8a1e8e"]]},{"id":"c034979b.69bde8","type":"moment","z":"5daf8c52.99ee44","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":431.6817626953125,"y":1136.3090515136719,"wires":[["3fdbf3ac.eb015c"]]},{"id":"2c6971cf.8a1e8e","type":"switch","z":"5daf8c52.99ee44","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":206.68177032470703,"y":1132.709041595459,"wires":[["3fdbf3ac.eb015c"],["c034979b.69bde8"]]},{"id":"3fdbf3ac.eb015c","type":"function","z":"5daf8c52.99ee44","name":"check login history","func":"let actInfo = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":227.18179321289062,"y":1089.9090576171875,"wires":[["63810e6b.536b4"]]},{"id":"63810e6b.536b4","type":"subflow:42cc5e2a.1f178","z":"5daf8c52.99ee44","x":214.68179321289062,"y":1047.9090576171875,"wires":[["76e182d3.60e7bc"]]},{"id":"76e182d3.60e7bc","type":"switch","z":"5daf8c52.99ee44","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":216.68179321289062,"y":994.9090576171875,"wires":[["581e3f76.64ec6"],["432d0ab3.95ab54"]]},{"id":"581e3f76.64ec6","type":"function","z":"5daf8c52.99ee44","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":222.18179321289062,"y":946.9090576171875,"wires":[["dc7349ef.231738"]]},{"id":"dc7349ef.231738","type":"subflow:47f0f2eb.a3493c","z":"5daf8c52.99ee44","x":219.18179321289062,"y":899.9090576171875,"wires":[["a69e3310.964d9"]]},{"id":"a69e3310.964d9","type":"switch","z":"5daf8c52.99ee44","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":226.18179321289062,"y":850.9090576171875,"wires":[["d0fb5459.626768"],["bbfe05e1.49eda8"]]},{"id":"bbfe05e1.49eda8","type":"function","z":"5daf8c52.99ee44","name":"set token expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":471.1817932128906,"y":932.9090576171875,"wires":[["c2b4cb7c.5ee568"]]},{"id":"432d0ab3.95ab54","type":"function","z":"5daf8c52.99ee44","name":"set logout","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'User already logout'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":467.1817932128906,"y":1034.9090576171875,"wires":[["c2b4cb7c.5ee568"]]},{"id":"d0fb5459.626768","type":"function","z":"5daf8c52.99ee44","name":"set sql to get count","func":"let actInfo = msg['actInfo']\nlet nowDate = new Date()\nlet curYear = nowDate.getFullYear()\nlet curMonth = nowDate.getMonth()+1\nlet curDay = ('00'+nowDate.getDate()).slice(-2)\nlet lastDate = new Date(curYear, curMonth-1, 0)\nlet lastMonth = lastDate.getMonth()+1\nlet lastDay = ('00'+lastDate.getDate()).slice(-2)\nlet curFrom = curYear +'-'+lastMonth+'-'+lastDay+' 16:00:00'\nlet curTo = curYear +'-'+curMonth+'-'+curDay+' 16:00:00'\nlet fromStr = msg['from'] !== undefined ? msg['from'] : curFrom\nlet toStr = msg['to'] !== undefined ? msg['to'] : curTo\nlet sqlStr = 'select count(1) as cnt from api_login_history where userId = '+actInfo.userId+' and history_login_time between \"'+fromStr+'\" and \"'+toStr+'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['from'] = fromStr\nmsg['to'] = toStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":487.1817932128906,"y":834.9090576171875,"wires":[["8f0551f8.85cce"]]},{"id":"8f0551f8.85cce","type":"subflow:42cc5e2a.1f178","z":"5daf8c52.99ee44","x":682.1817932128906,"y":834.9090576171875,"wires":[["7b8e6371.f7802c"]]},{"id":"7b8e6371.f7802c","type":"function","z":"5daf8c52.99ee44","name":"check cnt","func":"let cntObj = msg.payload[0]\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = cntObj['cnt']\nmsg['payload'] = newPayload  \nreturn msg","outputs":1,"noerr":0,"x":844.5454502105713,"y":834.5454044342041,"wires":[["c2b4cb7c.5ee568"]]},{"id":"c2b4cb7c.5ee568","type":"http response","z":"5daf8c52.99ee44","name":"","statusCode":"","headers":{},"x":1013.1818181818181,"y":969.090909090909,"wires":[]},{"id":"fed7a24a.8d15b","type":"http in","z":"c2effd8c.b7a2d","name":"","url":"/func","method":"get","upload":false,"swaggerDoc":"","x":128,"y":607,"wires":[["d5bbf21.1619d1"]]},{"id":"d5bbf21.1619d1","type":"switch","z":"c2effd8c.b7a2d","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":138,"y":567,"wires":[["1909a39f.7af14c"],["e2d66d01.10fd9"]]},{"id":"725c88c3.131108","type":"function","z":"c2effd8c.b7a2d","name":"check login history","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":138,"y":403,"wires":[["fceb8214.cbf15"]]},{"id":"e2d66d01.10fd9","type":"function","z":"c2effd8c.b7a2d","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":427,"y":514,"wires":[["48cc7192.b546b"]]},{"id":"48cc7192.b546b","type":"http response","z":"c2effd8c.b7a2d","name":"","statusCode":"","headers":{},"x":1145,"y":433,"wires":[]},{"id":"2d1bc393.c9e1bc","type":"switch","z":"c2effd8c.b7a2d","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":131,"y":318,"wires":[["715ebbc7.a38ae4"],["66733503.a42c0c"]]},{"id":"66733503.a42c0c","type":"function","z":"c2effd8c.b7a2d","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":398,"y":367,"wires":[["48cc7192.b546b"]]},{"id":"7f269649.7e7ea8","type":"switch","z":"c2effd8c.b7a2d","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":148,"y":107,"wires":[["f33a7388.8e43b"],["d7ca4481.ea11f8"]]},{"id":"d7ca4481.ea11f8","type":"function","z":"c2effd8c.b7a2d","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":388,"y":127,"wires":[["48cc7192.b546b"]]},{"id":"180c3887.3b73c7","type":"function","z":"c2effd8c.b7a2d","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":378,"y":207,"wires":[["48cc7192.b546b"]]},{"id":"7c04c67c.949bd8","type":"function","z":"c2effd8c.b7a2d","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":778,"y":107,"wires":[["48cc7192.b546b"]]},{"id":"472f6a3b.fda074","type":"function","z":"c2effd8c.b7a2d","name":"set all func query","func":"let actInfo = msg['actInfo']\nlet searchTxt = msg['search']\nlet sqlStr = 'select f.functionId, f.functionName, f.functionUrl, f.parentId, f.sortId, f.hiddenFlg, f.delFlg, f.createTime, f.grpId from  api_function f where 1 = 1 '\nif(searchTxt && searchTxt.length > 0){\n  if(searchTxt.indexOf(':') !== -1){\n    let condArr = searchTxt.split('&')\n    for (let i = 0 ; i < condArr.length ; i ++){\n      let arr = condArr[i].split(':')\n      if(arr.length === 3){\n        if(arr[0] === 'roleId'){\n        if(arr[1] === '=')\n          sqlStr = sqlStr + ' and f.functionId in (select functionId from api_function_mapping where '+arr[0]+' = ' +arr[2] +')'\n        if(arr[1] === '!=')\n          sqlStr = sqlStr + ' and f.functionId not in (select functionId from api_function_mapping where '+arr[0]+' = ' +arr[2]+')'            \n        }\n        if(arr[0] === 'grpId'){\n          if(arr[1] === '=')\n            sqlStr = sqlStr +  ' and f.grpId in ('+arr[2]+')'\n          if(arr[1] === '!=')\n            sqlStr = sqlStr +  ' and f.grpId not in ('+arr[2]+')'\n        }\n      }    \n    }\n  }else{\n    sqlStr = sqlStr + ' and f.functionName like \"%'+searchTxt+'%\" '\n  }\n}\nsqlStr = sqlStr + ' order by sortId'\nnode.warn(sqlStr)\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":778,"y":47,"wires":[["9f6f451c.2ffc08"]]},{"id":"9ef6e1d2.7fdd5","type":"function","z":"c2effd8c.b7a2d","name":"set result","func":"let newPayload = {}\nif(msg.payload.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = msg.payload.length\n  newPayload['funcs'] = msg.payload\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1148,"y":47,"wires":[["cbfbee40.3c9c7"]]},{"id":"cbfbee40.3c9c7","type":"http response","z":"c2effd8c.b7a2d","name":"","statusCode":"","headers":{},"x":1298,"y":47,"wires":[]},{"id":"5f2b7cd.868fb84","type":"http in","z":"c2effd8c.b7a2d","name":"","url":"/func","method":"post","upload":false,"swaggerDoc":"","x":125.22222137451172,"y":1392.8888864517212,"wires":[["3b13987b.96b088"]]},{"id":"bfe26b04.2f7e38","type":"switch","z":"c2effd8c.b7a2d","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":132.8888931274414,"y":1056.1110801696777,"wires":[["c154746.e6d9688"],["84ec65d0.911118"]]},{"id":"c154746.e6d9688","type":"function","z":"c2effd8c.b7a2d","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":144.8888931274414,"y":1010.1110801696777,"wires":[["153299ba.c09b66"]]},{"id":"84ec65d0.911118","type":"function","z":"c2effd8c.b7a2d","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":459,"y":1114,"wires":[["14dbcd94.9a1cb2"]]},{"id":"14dbcd94.9a1cb2","type":"http response","z":"c2effd8c.b7a2d","name":"","statusCode":"","headers":{},"x":1138,"y":986,"wires":[]},{"id":"4de5768d.b9f518","type":"switch","z":"c2effd8c.b7a2d","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":132.8888931274414,"y":922.1110801696777,"wires":[["1e1cdf6a.481ae1"],["2a06179.8de47e8"]]},{"id":"2a06179.8de47e8","type":"function","z":"c2effd8c.b7a2d","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":399.8888931274414,"y":971.1110801696777,"wires":[["14dbcd94.9a1cb2"]]},{"id":"93cc923f.f78d1","type":"switch","z":"c2effd8c.b7a2d","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":128,"y":707,"wires":[["6dfda4a8.2d602c"],["6e46e241.601e3c"]]},{"id":"6e46e241.601e3c","type":"function","z":"c2effd8c.b7a2d","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":488,"y":767,"wires":[["14dbcd94.9a1cb2"]]},{"id":"83f0833b.b2fd5","type":"function","z":"c2effd8c.b7a2d","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":478,"y":827,"wires":[["14dbcd94.9a1cb2"]]},{"id":"7b857930.b1b108","type":"function","z":"c2effd8c.b7a2d","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":758,"y":727,"wires":[["14dbcd94.9a1cb2"]]},{"id":"a8c7f52.c461d08","type":"function","z":"c2effd8c.b7a2d","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nif(msg.action === 'update'){\n  newPayload['responseMsg'] = 'update ' + res\n}\nif(msg.action === 'insert'){\n  newPayload['responseMsg'] = 'insert ' + res\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1428,"y":647,"wires":[["81ec2384.1a29f"]]},{"id":"81ec2384.1a29f","type":"http response","z":"c2effd8c.b7a2d","name":"","statusCode":"","headers":{},"x":1578,"y":647,"wires":[]},{"id":"a699cd3.4360e3","type":"switch","z":"c2effd8c.b7a2d","name":"check name","property":"payload.funcName.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":134.22222900390625,"y":1097.8888893127441,"wires":[["bfe26b04.2f7e38"],["84ec65d0.911118"]]},{"id":"3b13987b.96b088","type":"switch","z":"c2effd8c.b7a2d","name":"check funcId","property":"payload.funcId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":131.88890075683594,"y":1349.5556735992432,"wires":[["5c93d36f.a77c5c"],["84ec65d0.911118"]]},{"id":"3c97abed.ee21c4","type":"switch","z":"c2effd8c.b7a2d","name":"check funcId","property":"actInfo.funcId","propertyType":"msg","rules":[{"t":"eq","v":"-1","vt":"num"},{"t":"neq","v":"-1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":738,"y":667,"wires":[["17900bc8.17eb74"],["35c8dcbd.b78a34"]]},{"id":"17900bc8.17eb74","type":"function","z":"c2effd8c.b7a2d","name":"set insert func query","func":"let actInfo = msg['actInfo']\nlet delFlg = 1\nif(actInfo.delFlg && actInfo.delFlg.length > 0)\n  delFlg = actInfo.delFlg\nlet sqlStr = 'INSERT INTO `api_function` ( `functionName`, `functionUrl`, `parentId`, `sortId`, `hiddenFlg`, `delFlg`, `grpId`, `createTime`, `createUser`) VALUES ( \"'+actInfo.funcName+'\", \"'+actInfo.funcUrl+'\", '+actInfo.parentId+', '+actInfo.sortId+', \"'+actInfo.hiddenFlg+'\", '+delFlg+', '+actInfo.grpId+', current_time(), '+actInfo.userId+') '\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1008,"y":627,"wires":[["2e46e6c9.236c5a"]]},{"id":"35c8dcbd.b78a34","type":"function","z":"c2effd8c.b7a2d","name":"set update func query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'UPDATE `api_function` SET `functionName` = \"'+actInfo.funcName+'\", `functionUrl` = \"'+actInfo.funcUrl+'\", `parentId` = '+actInfo.parentId+', `sortId` = '+actInfo.sortId+', `hiddenFlg` = \"'+actInfo.hiddenFlg+'\", `grpId` = '+actInfo.grpId+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `functionId` = '+ actInfo.funcId\nmsg['action'] = 'update'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1008,"y":687,"wires":[["2e46e6c9.236c5a"]]},{"id":"8348f007.40fa1","type":"switch","z":"c2effd8c.b7a2d","name":"check url","property":"payload.funcUrl.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":138.66666412353516,"y":1264.8888683319092,"wires":[["99836f12.a1f99"],["84ec65d0.911118"]]},{"id":"99836f12.a1f99","type":"switch","z":"c2effd8c.b7a2d","name":"check sortId","property":"payload.sortId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":139.33333587646484,"y":1222.2223348617554,"wires":[["84a91fc7.c3ff5"],["84ec65d0.911118"]]},{"id":"5c93d36f.a77c5c","type":"switch","z":"c2effd8c.b7a2d","name":"check parentId","property":"payload.parentId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":133.2222137451172,"y":1307.777744293213,"wires":[["8348f007.40fa1"],["84ec65d0.911118"]]},{"id":"9eec11c1.fef29","type":"http in","z":"c2effd8c.b7a2d","name":"","url":"/func","method":"delete","upload":false,"swaggerDoc":"","x":122.99999237060547,"y":2029.2222576141357,"wires":[["6936f273.608a0c"]]},{"id":"324f2a1e.b11876","type":"switch","z":"c2effd8c.b7a2d","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":118.11109924316406,"y":1924.4444751739502,"wires":[["46a1dcdc.469294"],["fb362d37.40977"]]},{"id":"46a1dcdc.469294","type":"function","z":"c2effd8c.b7a2d","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":130.11109924316406,"y":1878.4444751739502,"wires":[["4883ad1d.ce8484"]]},{"id":"fb362d37.40977","type":"function","z":"c2effd8c.b7a2d","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":439.7777786254883,"y":1953.4444284439087,"wires":[["4f1c2bb.cb222d4"]]},{"id":"4f1c2bb.cb222d4","type":"http response","z":"c2effd8c.b7a2d","name":"","statusCode":"","headers":{},"x":1140.9999923706055,"y":1771,"wires":[]},{"id":"c62d5278.4b8d4","type":"switch","z":"c2effd8c.b7a2d","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":118.11109924316406,"y":1790.4444751739502,"wires":[["aaa97893.daadf8"],["e55b8a34.635b88"]]},{"id":"e55b8a34.635b88","type":"function","z":"c2effd8c.b7a2d","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":385.11109924316406,"y":1839.4444751739502,"wires":[["4f1c2bb.cb222d4"]]},{"id":"d9e63a70.4f29d8","type":"switch","z":"c2effd8c.b7a2d","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":128,"y":1567,"wires":[["d0b8dc0b.02687"],["c1b608df.dd40e8"]]},{"id":"c1b608df.dd40e8","type":"function","z":"c2effd8c.b7a2d","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":408,"y":1607,"wires":[["4f1c2bb.cb222d4"]]},{"id":"4f70b32d.9e114c","type":"function","z":"c2effd8c.b7a2d","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":418,"y":1687,"wires":[["4f1c2bb.cb222d4"]]},{"id":"b6bc4e74.17176","type":"function","z":"c2effd8c.b7a2d","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":818,"y":1607,"wires":[["4f1c2bb.cb222d4"]]},{"id":"6936f273.608a0c","type":"switch","z":"c2effd8c.b7a2d","name":"check funcId","property":"payload.funcId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":127.1111068725586,"y":1976.777847290039,"wires":[["324f2a1e.b11876"],["fb362d37.40977"]]},{"id":"54d7a48f.44d53c","type":"function","z":"c2effd8c.b7a2d","name":"set delete func query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_function` WHERE delFlg = 1 and grpId in ('+actInfo.grp+') and functionId = '+ actInfo.funcId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":868,"y":1507,"wires":[["f1b7ffc1.ad7d4"]]},{"id":"97d1d186.5218d","type":"function","z":"c2effd8c.b7a2d","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'func fail'\n}\nnewPayload['responseMsg'] = 'delete ' + res\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1235,"y":1507,"wires":[["df4f14bb.3bf4d8"]]},{"id":"7088614a.f4ae3","type":"http response","z":"c2effd8c.b7a2d","name":"","statusCode":"","headers":{},"x":1899,"y":1496,"wires":[]},{"id":"7a403cc1.a7e924","type":"switch","z":"c2effd8c.b7a2d","name":"check hiddenFlg","property":"payload.hiddenFlg.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":140.7777862548828,"y":1140.3331861495972,"wires":[["a699cd3.4360e3"],["84ec65d0.911118"]]},{"id":"dd920875.2f0c18","type":"switch","z":"c2effd8c.b7a2d","name":"check search","property":"payload.search","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":138,"y":487,"wires":[["91602c44.0097"],["2f0bbff0.471ca"]]},{"id":"1909a39f.7af14c","type":"function","z":"c2effd8c.b7a2d","name":"set msg info","func":"msg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":138,"y":527,"wires":[["dd920875.2f0c18"]]},{"id":"2f0bbff0.471ca","type":"function","z":"c2effd8c.b7a2d","name":"set search text","func":"msg.payload = msg.payload.search\nreturn msg","outputs":1,"noerr":0,"x":350,"y":446,"wires":[["941d10fe.1696b"]]},{"id":"941d10fe.1696b","type":"decrypt","z":"c2effd8c.b7a2d","name":"","algorithm":"TripleDES","key":"gemtek","x":508,"y":446,"wires":[["56589618.5d4488","60bcf6bf.3d8328"]]},{"id":"56589618.5d4488","type":"function","z":"c2effd8c.b7a2d","name":"set to flow","func":"msg['search'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":676,"y":437,"wires":[["725c88c3.131108"]]},{"id":"84a91fc7.c3ff5","type":"switch","z":"c2effd8c.b7a2d","name":"check grpId","property":"payload.grpId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":140.22220993041992,"y":1180.333475112915,"wires":[["7a403cc1.a7e924"],["84ec65d0.911118"]]},{"id":"f33a7388.8e43b","type":"function","z":"c2effd8c.b7a2d","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.userGrp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n    if(ar[i] === '29'){\n      accessFlg = true\n    }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":368,"y":67,"wires":[["34112652.8ecfea"]]},{"id":"34112652.8ecfea","type":"switch","z":"c2effd8c.b7a2d","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":558,"y":67,"wires":[["472f6a3b.fda074"],["7c04c67c.949bd8"]]},{"id":"6dfda4a8.2d602c","type":"function","z":"c2effd8c.b7a2d","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":348,"y":687,"wires":[["77f0357e.5b08cc"]]},{"id":"77f0357e.5b08cc","type":"switch","z":"c2effd8c.b7a2d","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":538,"y":687,"wires":[["3c97abed.ee21c4"],["7b857930.b1b108"]]},{"id":"d0b8dc0b.02687","type":"function","z":"c2effd8c.b7a2d","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":388,"y":1527,"wires":[["d2b772c8.41d5f"]]},{"id":"d2b772c8.41d5f","type":"switch","z":"c2effd8c.b7a2d","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":598,"y":1527,"wires":[["54d7a48f.44d53c"],["b6bc4e74.17176"]]},{"id":"60bcf6bf.3d8328","type":"debug","z":"c2effd8c.b7a2d","name":"","active":true,"console":"false","complete":"true","x":621.5,"y":478,"wires":[]},{"id":"715ebbc7.a38ae4","type":"function","z":"c2effd8c.b7a2d","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":168,"y":267,"wires":[["cfc080be.3238b"]]},{"id":"6ec8c56e.61ca2c","type":"switch","z":"c2effd8c.b7a2d","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":175,"y":191,"wires":[["d29f1514.d22518"],["180c3887.3b73c7"]]},{"id":"d29f1514.d22518","type":"function","z":"c2effd8c.b7a2d","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['userGrp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":145,"y":151,"wires":[["7f269649.7e7ea8"]]},{"id":"1e1cdf6a.481ae1","type":"function","z":"c2effd8c.b7a2d","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":168,"y":887,"wires":[["42fef646.910e28"]]},{"id":"964aa51e.fe4538","type":"switch","z":"c2effd8c.b7a2d","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":175,"y":811,"wires":[["f3bd5afd.bb93e8"],["83f0833b.b2fd5"]]},{"id":"f3bd5afd.bb93e8","type":"function","z":"c2effd8c.b7a2d","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":145,"y":771,"wires":[["93cc923f.f78d1"]]},{"id":"aaa97893.daadf8","type":"function","z":"c2effd8c.b7a2d","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":168,"y":1747,"wires":[["846f9a00.1c9678"]]},{"id":"5071346a.cb6a5c","type":"switch","z":"c2effd8c.b7a2d","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":175,"y":1671,"wires":[["bdfa7c04.e56c5"],["4f70b32d.9e114c"]]},{"id":"bdfa7c04.e56c5","type":"function","z":"c2effd8c.b7a2d","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":145,"y":1631,"wires":[["d9e63a70.4f29d8"]]},{"id":"91602c44.0097","type":"function","z":"c2effd8c.b7a2d","name":"clear search text","func":"msg['search'] = ''\nreturn msg","outputs":1,"noerr":0,"x":148,"y":447,"wires":[["725c88c3.131108"]]},{"id":"fceb8214.cbf15","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":117.5,"y":363,"wires":[["2d1bc393.c9e1bc"]]},{"id":"9f6f451c.2ffc08","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":965.5,"y":49,"wires":[["9ef6e1d2.7fdd5"]]},{"id":"153299ba.c09b66","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":137.5,"y":968,"wires":[["4de5768d.b9f518"]]},{"id":"2e46e6c9.236c5a","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":1220.5,"y":648,"wires":[["a8c7f52.c461d08"]]},{"id":"4883ad1d.ce8484","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":118.5,"y":1837,"wires":[["c62d5278.4b8d4"]]},{"id":"f1b7ffc1.ad7d4","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":1069.5,"y":1508,"wires":[["97d1d186.5218d"]]},{"id":"cfc080be.3238b","type":"subflow:47f0f2eb.a3493c","z":"c2effd8c.b7a2d","x":159.5,"y":229,"wires":[["6ec8c56e.61ca2c"]]},{"id":"42fef646.910e28","type":"subflow:47f0f2eb.a3493c","z":"c2effd8c.b7a2d","x":160.5,"y":849,"wires":[["964aa51e.fe4538"]]},{"id":"846f9a00.1c9678","type":"subflow:47f0f2eb.a3493c","z":"c2effd8c.b7a2d","x":154.5,"y":1707,"wires":[["5071346a.cb6a5c"]]},{"id":"8f1745ef.0cfab8","type":"http in","z":"e9de16c5.c95d08","name":"","url":"/roles","method":"get","upload":false,"swaggerDoc":"","x":116,"y":488,"wires":[["6e682b40.041d44"]]},{"id":"6e682b40.041d44","type":"switch","z":"e9de16c5.c95d08","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":123,"y":442,"wires":[["3a35fdf7.0558a2"],["2dadf395.3050fc"]]},{"id":"3a35fdf7.0558a2","type":"function","z":"e9de16c5.c95d08","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":135,"y":396,"wires":[["962bc3a0.da3c4"]]},{"id":"2dadf395.3050fc","type":"function","z":"e9de16c5.c95d08","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":384,"y":461,"wires":[["31a430b6.68ad"]]},{"id":"31a430b6.68ad","type":"http response","z":"e9de16c5.c95d08","name":"","statusCode":"","headers":{},"x":1137,"y":423,"wires":[]},{"id":"41727880.0b2028","type":"switch","z":"e9de16c5.c95d08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":123,"y":308,"wires":[["208125e1.eaa23a"],["141dd08e.a9603f"]]},{"id":"141dd08e.a9603f","type":"function","z":"e9de16c5.c95d08","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":390,"y":357,"wires":[["31a430b6.68ad"]]},{"id":"dbf301d9.0bc9d","type":"switch","z":"e9de16c5.c95d08","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":133,"y":102,"wires":[["d79388b6.d507c8"],["14199765.c78eb9"]]},{"id":"14199765.c78eb9","type":"function","z":"e9de16c5.c95d08","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":433,"y":162,"wires":[["31a430b6.68ad"]]},{"id":"bb594906.dc4b48","type":"function","z":"e9de16c5.c95d08","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":423,"y":222,"wires":[["31a430b6.68ad"]]},{"id":"5ae4a879.29b298","type":"function","z":"e9de16c5.c95d08","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":863,"y":122,"wires":[["31a430b6.68ad"]]},{"id":"f7755eaf.ffbec","type":"function","z":"e9de16c5.c95d08","name":"set all roles query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select roleId, roleName, dataset, editFlg, delFlg, createTime from api_role where (roleId in (select roleId from api_ra_mapping where grpId in (select grpId from api_cp_mapping where cpId = '+actInfo.cpId+')) or createUser = '+actInfo.userId+' or updateUser = '+actInfo.userId+')'\nif(actInfo.search && actInfo.search.length > 0){\n  sqlStr = sqlStr + ' and roleName like \"%'+actInfo.search+'%\" '\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":883,"y":42,"wires":[["9d5c18f8.e6f018"]]},{"id":"2abd6996.421dc6","type":"function","z":"e9de16c5.c95d08","name":"set result","func":"let newPayload = {}\nlet roles = msg['roles']\nlet roleArray = []\nif(roles.length > 0){\n  for(let i = 0 ; i < roles.length ; i++){\n    let role = roles[i]\n    role['grps'] = msg.payload[i] ? msg.payload[i]:\"NA\"\n    roleArray.push(role)\n  }\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = roleArray.length\n  newPayload['roles'] = roleArray\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg","outputs":1,"noerr":0,"x":1313,"y":182,"wires":[["dbd03bed.c43178"]]},{"id":"dbd03bed.c43178","type":"http response","z":"e9de16c5.c95d08","name":"","statusCode":"","headers":{},"x":1523,"y":182,"wires":[]},{"id":"538fdd43.bcd854","type":"http in","z":"e9de16c5.c95d08","name":"","url":"/roles","method":"post","upload":false,"swaggerDoc":"","x":115,"y":1177,"wires":[["7e376ab3.e135f4"]]},{"id":"5ba5e3e9.1827ac","type":"switch","z":"e9de16c5.c95d08","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":116,"y":995,"wires":[["280b543e.af36ac"],["ff182941.039f18"]]},{"id":"280b543e.af36ac","type":"function","z":"e9de16c5.c95d08","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":128,"y":949,"wires":[["98bbc981.149ef8"]]},{"id":"ff182941.039f18","type":"function","z":"e9de16c5.c95d08","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":377,"y":1014,"wires":[["8373d668.762f78"]]},{"id":"8373d668.762f78","type":"http response","z":"e9de16c5.c95d08","name":"","statusCode":"","headers":{},"x":1130,"y":976,"wires":[]},{"id":"e55f4940.004ef8","type":"switch","z":"e9de16c5.c95d08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":116,"y":861,"wires":[["6702c0ad.fee4c"],["451f72c5.6e4e3c"]]},{"id":"451f72c5.6e4e3c","type":"function","z":"e9de16c5.c95d08","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":393,"y":882,"wires":[["8373d668.762f78"]]},{"id":"f9ec25c9.d4bd58","type":"switch","z":"e9de16c5.c95d08","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":133,"y":662,"wires":[["650bbb44.fdbe44"],["f5345d77.23e21"]]},{"id":"f5345d77.23e21","type":"function","z":"e9de16c5.c95d08","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":413,"y":682,"wires":[["8373d668.762f78"]]},{"id":"62055f43.9ba05","type":"function","z":"e9de16c5.c95d08","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":403,"y":802,"wires":[["8373d668.762f78"]]},{"id":"34d4bbfa.aabbc4","type":"function","z":"e9de16c5.c95d08","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":663,"y":642,"wires":[["8373d668.762f78"]]},{"id":"2bba824b.0336be","type":"function","z":"e9de16c5.c95d08","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nif(msg.action === 'update'){\n  newPayload['responseMsg'] = 'update ' + res\n}\nif(msg.action === 'insert'){\n  newPayload['responseMsg'] = 'insert ' + res\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1313,"y":582,"wires":[["8c9d99cd.45e4d8"]]},{"id":"8c9d99cd.45e4d8","type":"http response","z":"e9de16c5.c95d08","name":"","statusCode":"","headers":{},"x":1463,"y":582,"wires":[]},{"id":"1d6ee87c.f3b318","type":"switch","z":"e9de16c5.c95d08","name":"check name","property":"payload.roleName.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":124,"y":1039,"wires":[["5ba5e3e9.1827ac"],["ff182941.039f18"]]},{"id":"a65449cc.3a4098","type":"switch","z":"e9de16c5.c95d08","name":"check roleId","property":"payload.roleId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":132,"y":1080,"wires":[["1d6ee87c.f3b318"],["ff182941.039f18"]]},{"id":"7f3f4ff3.f7679","type":"switch","z":"e9de16c5.c95d08","name":"check roleId","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"-1","vt":"num"},{"t":"neq","v":"-1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":643,"y":582,"wires":[["8216f8a9.e6ce98"],["a6629aa5.bb4478"]]},{"id":"8216f8a9.e6ce98","type":"function","z":"e9de16c5.c95d08","name":"set insert role query","func":"let actInfo = msg['actInfo']\nlet editFlg = 1\nif(actInfo.editFlg && actInfo.editFlg.length > 0)\n  editFlg = actInfo.editFlg\nlet delFlg = 1\nif(actInfo.delFlg && actInfo.delFlg.length > 0)\n  delFlg = actInfo.delFlg\nlet sqlStr = 'INSERT INTO `api_role` ( `roleName`, `dataset`, `editFlg`, `delFlg`, `createTime`, `createUser`) VALUES ( \"'+actInfo.roleName+'\", '+actInfo.dataId+', '+editFlg+', '+delFlg+', current_time(), '+actInfo.userId+') '\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":883,"y":562,"wires":[["e9d72938.8321a8"]]},{"id":"a6629aa5.bb4478","type":"function","z":"e9de16c5.c95d08","name":"set update role query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'UPDATE `api_role` SET `roleName` = \"'+actInfo.roleName+'\", `dataset` ='+actInfo.dataId+' ,`updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `editFlg` = 1 and `roleId` = '+actInfo.roleId\nmsg['action'] = 'update'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":893,"y":602,"wires":[["e9d72938.8321a8"]]},{"id":"7e376ab3.e135f4","type":"switch","z":"e9de16c5.c95d08","name":"check dataId","property":"payload.dataId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":127,"y":1126,"wires":[["a65449cc.3a4098"],["ff182941.039f18"]]},{"id":"30bc1150.4ef82e","type":"split","z":"e9de16c5.c95d08","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1103,"y":122,"wires":[["5bb0f231.42cc7c"]]},{"id":"a8e3cfc6.76d98","type":"function","z":"e9de16c5.c95d08","name":"set roles to flow","func":"msg['roles'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":1273,"y":42,"wires":[["30bc1150.4ef82e"]]},{"id":"82a495ca.ada908","type":"join","z":"e9de16c5.c95d08","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":1643,"y":122,"wires":[["2abd6996.421dc6"]]},{"id":"ec4b1bd7.8923f8","type":"http in","z":"e9de16c5.c95d08","name":"","url":"/roles","method":"delete","upload":false,"swaggerDoc":"","x":123,"y":1842,"wires":[["55593986.11af78"]]},{"id":"7d268622.691e88","type":"switch","z":"e9de16c5.c95d08","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":118,"y":1742.3333024978638,"wires":[["b9eb31f8.48073"],["e34daee1.f5924"]]},{"id":"b9eb31f8.48073","type":"function","z":"e9de16c5.c95d08","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":130,"y":1696.3333024978638,"wires":[["648e9fc8.db99a"]]},{"id":"e34daee1.f5924","type":"function","z":"e9de16c5.c95d08","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":386,"y":1705.3333024978638,"wires":[["64f4c91a.dc6428"]]},{"id":"64f4c91a.dc6428","type":"http response","z":"e9de16c5.c95d08","name":"","statusCode":"","headers":{},"x":1292,"y":1669.3333024978638,"wires":[]},{"id":"aa4d0211.efbb6","type":"switch","z":"e9de16c5.c95d08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":118,"y":1608.3333024978638,"wires":[["883277b9.f15768"],["e2a72f44.36c84"]]},{"id":"e2a72f44.36c84","type":"function","z":"e9de16c5.c95d08","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":392,"y":1601.3333024978638,"wires":[["64f4c91a.dc6428"]]},{"id":"ae6f5cf2.80bad","type":"switch","z":"e9de16c5.c95d08","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":133,"y":1402,"wires":[["86c60f6b.94aa1"],["b12ffaf8.e748f8"]]},{"id":"b12ffaf8.e748f8","type":"function","z":"e9de16c5.c95d08","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":473,"y":1482,"wires":[["64f4c91a.dc6428"]]},{"id":"2edc4263.ccf66e","type":"switch","z":"e9de16c5.c95d08","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":153,"y":1482,"wires":[["11719a0d.6c5ff6"],["5878c28d.ed91fc"]]},{"id":"5878c28d.ed91fc","type":"function","z":"e9de16c5.c95d08","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":423,"y":1542,"wires":[["64f4c91a.dc6428"]]},{"id":"72232685.e031d8","type":"function","z":"e9de16c5.c95d08","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":563,"y":1422,"wires":[["64f4c91a.dc6428"]]},{"id":"55593986.11af78","type":"switch","z":"e9de16c5.c95d08","name":"check roleId","property":"payload.roleId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":123,"y":1787.6666259765625,"wires":[["7d268622.691e88"],["e34daee1.f5924"]]},{"id":"63a28f31.ab7eb","type":"function","z":"e9de16c5.c95d08","name":"set delete role query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_role` WHERE delFlg = 1 and roleId = '+actInfo.roleId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1353,"y":1322,"wires":[["285cc401.28350c"]]},{"id":"e75f200.ac91be","type":"http response","z":"e9de16c5.c95d08","name":"","statusCode":"","headers":{},"x":2121.3333740234375,"y":1531.3331298828125,"wires":[]},{"id":"5a533ab2.86c824","type":"function","z":"e9de16c5.c95d08","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nnewPayload['responseMsg'] = 'delete ' + res\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1605,"y":1348.666748046875,"wires":[["6ee9b031.7a07d"]]},{"id":"a16a0835.2f21e8","type":"function","z":"e9de16c5.c95d08","name":"set check user query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select count(1) as Cnt from api_user where roleId = '+actInfo.roleId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":562,"y":1342,"wires":[["e23f4703.4fac28"]]},{"id":"c0877a11.844928","type":"function","z":"e9de16c5.c95d08","name":"check user Cnt","func":"let userExist = false\nif(msg.payload.length > 0 && msg.payload[0].Cnt > 0){\n    userExist = true\n}\nmsg['userExist'] = userExist\nreturn msg","outputs":1,"noerr":0,"x":953,"y":1342,"wires":[["47b85d35.e1bd94"]]},{"id":"47b85d35.e1bd94","type":"switch","z":"e9de16c5.c95d08","name":"check userExist","property":"userExist","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","outputs":2,"x":1133,"y":1342,"wires":[["63a28f31.ab7eb"],["7981ade2.9ddcc4"]]},{"id":"7981ade2.9ddcc4","type":"function","z":"e9de16c5.c95d08","name":"set user exist","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'user exist error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1297,"y":1431.3334245681763,"wires":[["64f4c91a.dc6428"]]},{"id":"d79388b6.d507c8","type":"function","z":"e9de16c5.c95d08","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":453,"y":62,"wires":[["a76b6188.38eae"]]},{"id":"a76b6188.38eae","type":"switch","z":"e9de16c5.c95d08","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":643,"y":62,"wires":[["f7755eaf.ffbec"],["5ae4a879.29b298"]]},{"id":"650bbb44.fdbe44","type":"function","z":"e9de16c5.c95d08","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":133,"y":602,"wires":[["2c6b42a4.ae594e"]]},{"id":"2c6b42a4.ae594e","type":"switch","z":"e9de16c5.c95d08","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":363,"y":602,"wires":[["7f3f4ff3.f7679"],["34d4bbfa.aabbc4"]]},{"id":"86c60f6b.94aa1","type":"function","z":"e9de16c5.c95d08","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":113,"y":1362,"wires":[["7ed84a3.091dcb4"]]},{"id":"7ed84a3.091dcb4","type":"switch","z":"e9de16c5.c95d08","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":323,"y":1362,"wires":[["a16a0835.2f21e8"],["72232685.e031d8"]]},{"id":"5bb0f231.42cc7c","type":"function","z":"e9de16c5.c95d08","name":"set grps query by role","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select g.grpId, g.grpName, g.createTime, m.createFlg, m.updateFlg, m.deleteFlg, m.sortId from api_ra_mapping m left join api_grp g on m.grpId = g.grpId where m.roleId = '+msg.payload.roleId+' order by m.sortId '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1273,"y":122,"wires":[["5eb56f94.4e64b"]]},{"id":"11719a0d.6c5ff6","type":"function","z":"e9de16c5.c95d08","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['userRoleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":123,"y":1442,"wires":[["ae6f5cf2.80bad"]]},{"id":"883277b9.f15768","type":"function","z":"e9de16c5.c95d08","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":146,"y":1558,"wires":[["ad223879.c45df8"]]},{"id":"6702c0ad.fee4c","type":"function","z":"e9de16c5.c95d08","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":153,"y":822,"wires":[["37f6e650.92f2aa"]]},{"id":"9564ea03.920d28","type":"switch","z":"e9de16c5.c95d08","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":160,"y":746,"wires":[["c7eafe9b.23693"],["62055f43.9ba05"]]},{"id":"c7eafe9b.23693","type":"function","z":"e9de16c5.c95d08","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['userRoleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":130,"y":706,"wires":[["f9ec25c9.d4bd58"]]},{"id":"208125e1.eaa23a","type":"function","z":"e9de16c5.c95d08","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":153,"y":262,"wires":[["b30845be.4191f8"]]},{"id":"2b38f200.37752e","type":"switch","z":"e9de16c5.c95d08","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":160,"y":186,"wires":[["b6d44669.e83158"],["bb594906.dc4b48"]]},{"id":"b6d44669.e83158","type":"function","z":"e9de16c5.c95d08","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":130,"y":146,"wires":[["dbf301d9.0bc9d"]]},{"id":"962bc3a0.da3c4","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":118.5,"y":355,"wires":[["41727880.0b2028"]]},{"id":"9d5c18f8.e6f018","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":1066.5,"y":42,"wires":[["a8e3cfc6.76d98"]]},{"id":"5eb56f94.4e64b","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":1479.5,"y":122,"wires":[["82a495ca.ada908"]]},{"id":"98bbc981.149ef8","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":107.5,"y":906,"wires":[["e55f4940.004ef8"]]},{"id":"e9d72938.8321a8","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":1102.5,"y":580,"wires":[["2bba824b.0336be"]]},{"id":"648e9fc8.db99a","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":114.5,"y":1651,"wires":[["aa4d0211.efbb6"]]},{"id":"e23f4703.4fac28","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":766.5,"y":1344,"wires":[["c0877a11.844928"]]},{"id":"285cc401.28350c","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":1492.5,"y":1258,"wires":[["5a533ab2.86c824"]]},{"id":"b30845be.4191f8","type":"subflow:47f0f2eb.a3493c","z":"e9de16c5.c95d08","x":145.5,"y":222,"wires":[["2b38f200.37752e"]]},{"id":"37f6e650.92f2aa","type":"subflow:47f0f2eb.a3493c","z":"e9de16c5.c95d08","x":143.5,"y":782,"wires":[["9564ea03.920d28"]]},{"id":"ad223879.c45df8","type":"subflow:47f0f2eb.a3493c","z":"e9de16c5.c95d08","x":140.5,"y":1522,"wires":[["2edc4263.ccf66e"]]},{"id":"95ab98c0.9585d8","type":"http in","z":"30582f0c.49a88","name":"","url":"/grp","method":"get","upload":false,"swaggerDoc":"","x":112,"y":495,"wires":[["b6caf7a.12bbe08"]]},{"id":"b6caf7a.12bbe08","type":"switch","z":"30582f0c.49a88","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":119,"y":449,"wires":[["7f8e601a.a54e8"],["7be60129.d676e"]]},{"id":"7f8e601a.a54e8","type":"function","z":"30582f0c.49a88","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":131,"y":403,"wires":[["375efb82.eb4d34"]]},{"id":"7be60129.d676e","type":"function","z":"30582f0c.49a88","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":380,"y":468,"wires":[["5cb62f6b.e2a58"]]},{"id":"5cb62f6b.e2a58","type":"http response","z":"30582f0c.49a88","name":"","statusCode":"","headers":{},"x":1133,"y":430,"wires":[]},{"id":"eaa5afed.07fe","type":"switch","z":"30582f0c.49a88","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":119,"y":315,"wires":[["9b3586e3.cc50f8"],["c2785665.85a4c8"]]},{"id":"c2785665.85a4c8","type":"function","z":"30582f0c.49a88","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":386,"y":364,"wires":[["5cb62f6b.e2a58"]]},{"id":"311a3853.3020e8","type":"switch","z":"30582f0c.49a88","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":133,"y":92,"wires":[["b952eff3.317c8"],["c29814a9.f00e78"]]},{"id":"c29814a9.f00e78","type":"function","z":"30582f0c.49a88","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":453,"y":152,"wires":[["5cb62f6b.e2a58"]]},{"id":"23db25e7.f20e3a","type":"function","z":"30582f0c.49a88","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":423,"y":192,"wires":[["5cb62f6b.e2a58"]]},{"id":"ec30b8ec.bc0578","type":"function","z":"30582f0c.49a88","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1023,"y":152,"wires":[["5cb62f6b.e2a58"]]},{"id":"a29dc5a6.433af8","type":"function","z":"30582f0c.49a88","name":"set all grp by cp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select g.`grpId`, g.`grpName`, g.`createTime` from api_cp_mapping m left join api_grp g on m.grpId = g.grpId where m.cpId = '+actInfo.cpId\nif(actInfo.search && actInfo.search.length > 0){\n  sqlStr = sqlStr + ' and g.grpName like \"%'+actInfo.search+'%\" '\n}\nsqlStr = sqlStr + ' order by createTime desc'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1033,"y":92,"wires":[["333429d4.09ac06"]]},{"id":"8b50e202.fb18","type":"function","z":"30582f0c.49a88","name":"set result","func":"let newPayload = {}\nif(msg.payload.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = msg.payload.length\n  newPayload['grps'] = msg.payload\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1442,"y":71,"wires":[["39c48044.e637d"]]},{"id":"39c48044.e637d","type":"http response","z":"30582f0c.49a88","name":"","statusCode":"","headers":{},"x":1601,"y":69,"wires":[]},{"id":"208ee71d.dd9908","type":"http in","z":"30582f0c.49a88","name":"","url":"/grp","method":"post","upload":false,"swaggerDoc":"","x":121,"y":1157,"wires":[["203ea6b1.52116a"]]},{"id":"1c5e668b.2bd569","type":"switch","z":"30582f0c.49a88","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":112,"y":1002,"wires":[["4e6ba8e3.673818"],["122286ce.e43b69"]]},{"id":"4e6ba8e3.673818","type":"function","z":"30582f0c.49a88","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":124,"y":956,"wires":[["8a79a359.a14fd"]]},{"id":"122286ce.e43b69","type":"function","z":"30582f0c.49a88","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":447,"y":1111,"wires":[["5f2bcd7a.aeac04"]]},{"id":"5f2bcd7a.aeac04","type":"http response","z":"30582f0c.49a88","name":"","statusCode":"","headers":{},"x":1126,"y":983,"wires":[]},{"id":"bcab7920.d91f98","type":"switch","z":"30582f0c.49a88","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":112,"y":868,"wires":[["698993bb.4479dc"],["fbc7aabe.243628"]]},{"id":"fbc7aabe.243628","type":"function","z":"30582f0c.49a88","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":379,"y":917,"wires":[["5f2bcd7a.aeac04"]]},{"id":"617019ca.b012b8","type":"switch","z":"30582f0c.49a88","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":153,"y":652,"wires":[["fbed33f.893b6d"],["f3b4435b.e4f5f"]]},{"id":"f3b4435b.e4f5f","type":"function","z":"30582f0c.49a88","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":433,"y":712,"wires":[["5f2bcd7a.aeac04"]]},{"id":"63fb0c9e.00a854","type":"function","z":"30582f0c.49a88","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":403,"y":772,"wires":[["5f2bcd7a.aeac04"]]},{"id":"c68eb7f7.9099c8","type":"function","z":"30582f0c.49a88","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":763,"y":692,"wires":[["5f2bcd7a.aeac04"]]},{"id":"c60f1462.027b58","type":"function","z":"30582f0c.49a88","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nif(msg.action === 'update'){\n  newPayload['responseMsg'] = 'update ' + res\n}\nif(msg.action === 'insert'){\n  newPayload['responseMsg'] = 'insert ' + res\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1433,"y":612,"wires":[["c90f068c.4b7d08"]]},{"id":"c90f068c.4b7d08","type":"http response","z":"30582f0c.49a88","name":"","statusCode":"","headers":{},"x":1583,"y":612,"wires":[]},{"id":"560fd29e.0e15dc","type":"switch","z":"30582f0c.49a88","name":"check grpId","property":"grpId","propertyType":"msg","rules":[{"t":"eq","v":"-1","vt":"num"},{"t":"neq","v":"-1","vt":"num"}],"checkall":"true","outputs":2,"x":743,"y":612,"wires":[["67d4fb3f.32f614"],["38b9a654.60475a"]]},{"id":"67d4fb3f.32f614","type":"function","z":"30582f0c.49a88","name":"set insert Grp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'INSERT INTO `api_grp` ( `grpName`, `createTime`, `createUser`) VALUES ( \"'+actInfo.name+'\", current_time(), '+actInfo.userId+') '\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1033,"y":592,"wires":[["8d4d6f8a.fe583"]]},{"id":"38b9a654.60475a","type":"function","z":"30582f0c.49a88","name":"set update Grp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'UPDATE `api_grp` SET `grpName` = \"'+actInfo.name+'\", `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `grpId` = '+actInfo.grpId\nmsg['action'] = 'update'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1033,"y":632,"wires":[["8d4d6f8a.fe583"]]},{"id":"af53a943.2aa428","type":"switch","z":"30582f0c.49a88","name":"check name","property":"payload.name.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":119,"y":1053,"wires":[["1c5e668b.2bd569"],["122286ce.e43b69"]]},{"id":"203ea6b1.52116a","type":"switch","z":"30582f0c.49a88","name":"check grpId","property":"payload.grpId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":121,"y":1105,"wires":[["af53a943.2aa428"],[]]},{"id":"5e6f2fb6.eb334","type":"function","z":"30582f0c.49a88","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":613,"y":92,"wires":[["f9a1b31.5868e5"]]},{"id":"f9a1b31.5868e5","type":"switch","z":"30582f0c.49a88","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":803,"y":112,"wires":[["a29dc5a6.433af8"],["ec30b8ec.bc0578"]]},{"id":"b952eff3.317c8","type":"switch","z":"30582f0c.49a88","name":"check role","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":423,"y":72,"wires":[["6fdc4785.a5aa98"],["5e6f2fb6.eb334"]]},{"id":"6fdc4785.a5aa98","type":"function","z":"30582f0c.49a88","name":"set all grp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select g.`grpId`, g.`grpName`, g.`createTime` from api_grp g where 1 = 1 '\nif(actInfo.search && actInfo.search.length > 0){\n  sqlStr = sqlStr + ' and g.grpName like \"%'+actInfo.search+'%\" '\n}\nsqlStr = sqlStr + ' order by createTime desc'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":833,"y":52,"wires":[["333429d4.09ac06"]]},{"id":"fbed33f.893b6d","type":"switch","z":"30582f0c.49a88","name":"check role","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":463,"y":632,"wires":[["560fd29e.0e15dc"],["c68eb7f7.9099c8"]]},{"id":"eb9bb8a1.2a6668","type":"http in","z":"30582f0c.49a88","name":"","url":"/grp","method":"delete","upload":false,"swaggerDoc":"","x":145.8571319580078,"y":1812.000072479248,"wires":[["63a62def.18f254"]]},{"id":"cf701be0.5c80f8","type":"switch","z":"30582f0c.49a88","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":141.14285278320312,"y":1714.1429443359375,"wires":[["dda9e1f6.ee41c"],["9dc7dab6.816178"]]},{"id":"dda9e1f6.ee41c","type":"function","z":"30582f0c.49a88","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":153.14285278320312,"y":1668.1429443359375,"wires":[["85f89393.66511"]]},{"id":"9dc7dab6.816178","type":"function","z":"30582f0c.49a88","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":476.1428527832031,"y":1823.1429443359375,"wires":[["fd37d4c.e5ba928"]]},{"id":"fd37d4c.e5ba928","type":"http response","z":"30582f0c.49a88","name":"","statusCode":"","headers":{},"x":1155.1428527832031,"y":1695.1429443359375,"wires":[]},{"id":"6101a7d5.d22d68","type":"switch","z":"30582f0c.49a88","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":141.14285278320312,"y":1580.1429443359375,"wires":[["11685a4b.cef436"],["d14438fb.7653b8"]]},{"id":"d14438fb.7653b8","type":"function","z":"30582f0c.49a88","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":408.1428527832031,"y":1629.1429443359375,"wires":[["fd37d4c.e5ba928"]]},{"id":"ee0efc0.38ef108","type":"switch","z":"30582f0c.49a88","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":153,"y":1352,"wires":[["8eae8a67.659858"],["b6c3574b.c5a7a8"]]},{"id":"b6c3574b.c5a7a8","type":"function","z":"30582f0c.49a88","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":453,"y":1412,"wires":[["fd37d4c.e5ba928"]]},{"id":"c21dac28.1c8df","type":"function","z":"30582f0c.49a88","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":443,"y":1472,"wires":[["fd37d4c.e5ba928"]]},{"id":"e985a634.cd9a68","type":"function","z":"30582f0c.49a88","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":723,"y":1392,"wires":[["fd37d4c.e5ba928"]]},{"id":"63a62def.18f254","type":"switch","z":"30582f0c.49a88","name":"check grpId","property":"payload.grpId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":144.4285659790039,"y":1755.7143421173096,"wires":[["cf701be0.5c80f8"],["9dc7dab6.816178"]]},{"id":"8eae8a67.659858","type":"switch","z":"30582f0c.49a88","name":"check role","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":463,"y":1352,"wires":[["43eba7ba.a64148"],["e985a634.cd9a68"]]},{"id":"43eba7ba.a64148","type":"function","z":"30582f0c.49a88","name":"set delete sql","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_grp` WHERE grpId = '+actInfo.grpId\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":713,"y":1332,"wires":[["4a1c30f.548bed"]]},{"id":"2c85c69a.780eea","type":"function","z":"30582f0c.49a88","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail grp'\n}\nnewPayload['responseMsg'] = 'delete ' + res\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1095,"y":1332,"wires":[["59687ba3.f6c754"]]},{"id":"3367bca3.2788f4","type":"http response","z":"30582f0c.49a88","name":"","statusCode":"","headers":{},"x":1417,"y":1468,"wires":[]},{"id":"9b3586e3.cc50f8","type":"function","z":"30582f0c.49a88","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":153,"y":272,"wires":[["3a6566c3.7fa15a"]]},{"id":"d002a117.56f2c","type":"switch","z":"30582f0c.49a88","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":153,"y":192,"wires":[["711d72be.62ca2c"],["23db25e7.f20e3a"]]},{"id":"711d72be.62ca2c","type":"function","z":"30582f0c.49a88","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":123,"y":152,"wires":[["311a3853.3020e8"]]},{"id":"698993bb.4479dc","type":"function","z":"30582f0c.49a88","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":153,"y":812,"wires":[["6ad0e7e7.1927f8"]]},{"id":"b75dfa93.572a38","type":"switch","z":"30582f0c.49a88","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":160,"y":736,"wires":[["29465d14.f5b982"],["63fb0c9e.00a854"]]},{"id":"29465d14.f5b982","type":"function","z":"30582f0c.49a88","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n  msg['grpId'] = actInfo.grpId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":130,"y":696,"wires":[["617019ca.b012b8"]]},{"id":"11685a4b.cef436","type":"function","z":"30582f0c.49a88","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":173,"y":1532,"wires":[["6b811caf.3f1ce4"]]},{"id":"bd371c46.34564","type":"switch","z":"30582f0c.49a88","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":180,"y":1456,"wires":[["ef9ff891.3b89c8"],["c21dac28.1c8df"]]},{"id":"ef9ff891.3b89c8","type":"function","z":"30582f0c.49a88","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":150,"y":1416,"wires":[["ee0efc0.38ef108"]]},{"id":"375efb82.eb4d34","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":128.5,"y":362,"wires":[["eaa5afed.07fe"]]},{"id":"333429d4.09ac06","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":1266.5,"y":69,"wires":[["8b50e202.fb18"]]},{"id":"8a79a359.a14fd","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":109.5,"y":909,"wires":[["bcab7920.d91f98"]]},{"id":"8d4d6f8a.fe583","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":1255.5,"y":609,"wires":[["c60f1462.027b58"]]},{"id":"85f89393.66511","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":145.5,"y":1625,"wires":[["6101a7d5.d22d68"]]},{"id":"4a1c30f.548bed","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":913.5,"y":1333,"wires":[["2c85c69a.780eea"]]},{"id":"3a6566c3.7fa15a","type":"subflow:47f0f2eb.a3493c","z":"30582f0c.49a88","x":147.5,"y":234,"wires":[["d002a117.56f2c"]]},{"id":"6ad0e7e7.1927f8","type":"subflow:47f0f2eb.a3493c","z":"30582f0c.49a88","x":146.5,"y":775,"wires":[["b75dfa93.572a38"]]},{"id":"6b811caf.3f1ce4","type":"subflow:47f0f2eb.a3493c","z":"30582f0c.49a88","x":169.5,"y":1493,"wires":[["bd371c46.34564"]]},{"id":"154430f0.50529f","type":"http in","z":"98edc07.d8c374","name":"","url":"/cps","method":"get","upload":false,"swaggerDoc":"","x":112,"y":526,"wires":[["366e11fd.4c606e"]]},{"id":"366e11fd.4c606e","type":"switch","z":"98edc07.d8c374","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":119,"y":480,"wires":[["64d80450.6282ac"],["de0897b4.471568"]]},{"id":"64d80450.6282ac","type":"function","z":"98edc07.d8c374","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":131,"y":434,"wires":[["64c3bfc7.3c82f"]]},{"id":"de0897b4.471568","type":"function","z":"98edc07.d8c374","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":380,"y":499,"wires":[["a0b3a03e.7618e"]]},{"id":"a0b3a03e.7618e","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":1133,"y":461,"wires":[]},{"id":"c621c5f7.514438","type":"switch","z":"98edc07.d8c374","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":119,"y":346,"wires":[["25502b77.bebc54"],["4295d3c.a48fd2c"]]},{"id":"4295d3c.a48fd2c","type":"function","z":"98edc07.d8c374","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":386,"y":395,"wires":[["a0b3a03e.7618e"]]},{"id":"38d45a10.17bb66","type":"switch","z":"98edc07.d8c374","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":169,"y":142,"wires":[["a8da16af.14b088"],["1a64dc36.97cd44"]]},{"id":"1a64dc36.97cd44","type":"function","z":"98edc07.d8c374","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":469,"y":182,"wires":[["a0b3a03e.7618e"]]},{"id":"c79ea43.b055e58","type":"function","z":"98edc07.d8c374","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":419,"y":242,"wires":[["a0b3a03e.7618e"]]},{"id":"a8da16af.14b088","type":"switch","z":"98edc07.d8c374","name":"check role","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":199,"y":82,"wires":[["d0c7c270.a11e5"],["28b0915.fe4976e"]]},{"id":"2b4b3e64.788642","type":"function","z":"98edc07.d8c374","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1009.2500152587891,"y":205.25000190734863,"wires":[["a0b3a03e.7618e"]]},{"id":"d0c7c270.a11e5","type":"function","z":"98edc07.d8c374","name":"set all cp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select cpId, cpName, createTime from api_cp where 1 = 1 '\nif(actInfo.search && actInfo.search.length > 0){\n  sqlStr = sqlStr + ' and cpName like \"%'+actInfo.search+'%\" '\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":469,"y":42,"wires":[["5fa5c84f.4c60e8"]]},{"id":"ad2793f6.368df","type":"function","z":"98edc07.d8c374","name":"set cp","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select cpId, cpName, createTime from api_cp where cpId = '+actInfo.cpId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":899,"y":102,"wires":[["5fa5c84f.4c60e8"]]},{"id":"c70e9220.3faae","type":"function","z":"98edc07.d8c374","name":"set result","func":"let newPayload = {}\nlet cps = msg['cps']\nlet cpArray = []\nif(cps.length > 0){\n  for(let i = 0 ; i < cps.length ; i++){\n    let cp = cps[i]\n    cp['grps'] = msg.payload[i]?msg.payload[i]:\"NA\"\n    cpArray.push(cp)\n  }\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = cpArray.length\n  newPayload['cps'] = cpArray\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg","outputs":1,"noerr":0,"x":1665,"y":187,"wires":[["7452a29b.64691c"]]},{"id":"7452a29b.64691c","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":1745,"y":113,"wires":[]},{"id":"824a42a5.73ee5","type":"http in","z":"98edc07.d8c374","name":"","url":"/cps","method":"post","upload":false,"swaggerDoc":"","x":125,"y":1159,"wires":[["28fecd42.b98d92"]]},{"id":"75cb492a.7cd9a8","type":"switch","z":"98edc07.d8c374","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":131,"y":1015,"wires":[["e4c0e417.cc2798"],["1433c558.fac76b"]]},{"id":"e4c0e417.cc2798","type":"function","z":"98edc07.d8c374","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":143,"y":969,"wires":[["d0d49268.1980c"]]},{"id":"1433c558.fac76b","type":"function","z":"98edc07.d8c374","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":401,"y":1048,"wires":[["7b396265.ca45ec"]]},{"id":"7b396265.ca45ec","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":1397,"y":1001,"wires":[]},{"id":"9f52d787.3ec498","type":"switch","z":"98edc07.d8c374","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":131,"y":881,"wires":[["c6f7b4a2.945bb8"],["f448e7e1.75e2c8"]]},{"id":"f448e7e1.75e2c8","type":"function","z":"98edc07.d8c374","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":398,"y":930,"wires":[["7b396265.ca45ec"]]},{"id":"673e8bcc.5574a4","type":"switch","z":"98edc07.d8c374","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":169,"y":642,"wires":[["1be1e2af.396f8d"],["31421864.7fd558"]]},{"id":"31421864.7fd558","type":"function","z":"98edc07.d8c374","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":449,"y":742,"wires":[["7b396265.ca45ec"]]},{"id":"36a0a92.851e556","type":"function","z":"98edc07.d8c374","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":419,"y":802,"wires":[["7b396265.ca45ec"]]},{"id":"18bf5373.1ef2ed","type":"switch","z":"98edc07.d8c374","name":"check cpId","property":"actInfo.cpId","propertyType":"msg","rules":[{"t":"eq","v":"-1","vt":"num"},{"t":"neq","v":"-1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1397,"y":517,"wires":[["ac530a4a.5e52f8"],["cd1b884c.86a758"]]},{"id":"d112f4a8.3b1598","type":"function","z":"98edc07.d8c374","name":"set insert cp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'INSERT INTO `api_cp` ( `cpName`, `createTime`, `createUser`) VALUES ( \"'+actInfo.cpName+'\", current_time(), '+actInfo.userId+') '\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1592,"y":486,"wires":[["5307d9c5.833408"]]},{"id":"cd1b884c.86a758","type":"function","z":"98edc07.d8c374","name":"set update cp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'UPDATE `api_cp` SET `cpName` = \"'+actInfo.cpName+'\", `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `cpId` = '+actInfo.cpId\nmsg['action'] = 'update'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1609,"y":556,"wires":[["5307d9c5.833408"]]},{"id":"24c7e08.62f632","type":"function","z":"98edc07.d8c374","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nif(msg.action === 'update'){\n  newPayload['responseMsg'] = 'update ' + res\n}\nif(msg.action === 'insert'){\n  newPayload['responseMsg'] = 'insert ' + res\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1976,"y":523,"wires":[["f6dfb872.eb1308"]]},{"id":"f6dfb872.eb1308","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":2108,"y":523,"wires":[]},{"id":"bd4c5e8d.b114c","type":"switch","z":"98edc07.d8c374","name":"check name","property":"payload.cpName.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":130,"y":1056,"wires":[["75cb492a.7cd9a8"],["1433c558.fac76b"]]},{"id":"28fecd42.b98d92","type":"switch","z":"98edc07.d8c374","name":"check cpId","property":"payload.cpId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":133,"y":1102,"wires":[["bd4c5e8d.b114c"],["1433c558.fac76b"]]},{"id":"b0da928b.380c5","type":"function","z":"98edc07.d8c374","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":958,"y":723,"wires":[["7b396265.ca45ec"]]},{"id":"9e2d49d3.75ab58","type":"switch","z":"98edc07.d8c374","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":134,"y":1677,"wires":[["4130b8e7.37c2c8"],["ba2ff0e4.e9a31"]]},{"id":"4130b8e7.37c2c8","type":"function","z":"98edc07.d8c374","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":146,"y":1631,"wires":[["e1be1633.eafe08"]]},{"id":"ba2ff0e4.e9a31","type":"function","z":"98edc07.d8c374","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":404,"y":1710,"wires":[["11e9fb84.ef21f4"]]},{"id":"11e9fb84.ef21f4","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":1388,"y":1659,"wires":[]},{"id":"de4ebcf3.1f7f7","type":"switch","z":"98edc07.d8c374","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":134,"y":1543,"wires":[["5661d64f.e7f6d8"],["14e2e073.6214c"]]},{"id":"14e2e073.6214c","type":"function","z":"98edc07.d8c374","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":401,"y":1592,"wires":[["11e9fb84.ef21f4"]]},{"id":"c0506b14.e6c9d8","type":"switch","z":"98edc07.d8c374","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":149,"y":1302,"wires":[["c0345e54.01524"],["a00e520a.9cca5"]]},{"id":"a00e520a.9cca5","type":"function","z":"98edc07.d8c374","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429,"y":1382,"wires":[["11e9fb84.ef21f4"]]},{"id":"a220016b.e59af","type":"function","z":"98edc07.d8c374","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":399,"y":1462,"wires":[["11e9fb84.ef21f4"]]},{"id":"d14a7555.26b358","type":"function","z":"98edc07.d8c374","name":"set delete cp query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_cp` WHERE cpId = '+actInfo.cpId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1329,"y":1159,"wires":[["aa5b2aa4.36c8f8"]]},{"id":"a0baded7.21822","type":"switch","z":"98edc07.d8c374","name":"check id","property":"payload.cpId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":137,"y":1720,"wires":[["9e2d49d3.75ab58"],["ba2ff0e4.e9a31"]]},{"id":"c3f5e791.6b5128","type":"function","z":"98edc07.d8c374","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":719,"y":1322,"wires":[["11e9fb84.ef21f4"]]},{"id":"adf5f88c.0bb528","type":"function","z":"98edc07.d8c374","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nnewPayload['responseMsg'] = 'delete ' + res\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1504.5000190734863,"y":1240.7500190734863,"wires":[["6fb76be6.1285e4"]]},{"id":"6fb76be6.1285e4","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":1526.5000228881836,"y":1290.7500190734863,"wires":[]},{"id":"c9b49e0f.721bc","type":"http in","z":"98edc07.d8c374","name":"","url":"/cps","method":"delete","upload":false,"swaggerDoc":"","x":137,"y":1769,"wires":[["a0baded7.21822"]]},{"id":"94890e73.d8da2","type":"function","z":"98edc07.d8c374","name":"set check user query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select count(1) as Cnt from api_user where cpId = '+actInfo.cpId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":709,"y":1262,"wires":[["c0a4fbdb.d8caf8"]]},{"id":"77bca425.54b00c","type":"function","z":"98edc07.d8c374","name":"check user Cnt","func":"let userExist = false\nif(msg.payload.length > 0 && msg.payload[0].Cnt > 0){\n    userExist = true\n}\nmsg['userExist'] = userExist\nreturn msg","outputs":1,"noerr":0,"x":1087.875,"y":1210.75,"wires":[["1a658957.c0b957"]]},{"id":"c0345e54.01524","type":"switch","z":"98edc07.d8c374","name":"check role","property":"roleId","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":399,"y":1302,"wires":[["94890e73.d8da2"],["c3f5e791.6b5128"]]},{"id":"1a658957.c0b957","type":"switch","z":"98edc07.d8c374","name":"check userExist","property":"userExist","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","outputs":2,"x":1276.5,"y":1212,"wires":[["d14a7555.26b358"],["d9f1ecf8.13fff"]]},{"id":"d9f1ecf8.13fff","type":"function","z":"98edc07.d8c374","name":"set user exist","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'user exist error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1256.5,"y":1334,"wires":[["11e9fb84.ef21f4"]]},{"id":"1be1e2af.396f8d","type":"function","z":"98edc07.d8c374","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":369,"y":642,"wires":[["a13618c5.630608"]]},{"id":"a13618c5.630608","type":"switch","z":"98edc07.d8c374","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":579,"y":642,"wires":[["b563978c.e0c6f8"],["b0da928b.380c5"]]},{"id":"28b0915.fe4976e","type":"function","z":"98edc07.d8c374","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":449,"y":82,"wires":[["781d5dd5.5643b4"]]},{"id":"781d5dd5.5643b4","type":"switch","z":"98edc07.d8c374","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":699,"y":122,"wires":[["ad2793f6.368df"],["2b4b3e64.788642"]]},{"id":"b563978c.e0c6f8","type":"function","z":"98edc07.d8c374","name":"set name query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select * from api_cp where cpName = \"'+actInfo.cpName+'\" '\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['cpId'] = actInfo.cpId\nmsg['roleId'] = actInfo.roleId\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":829,"y":602,"wires":[["37b1bbb8.4e5804"]]},{"id":"946a6f24.22d5a","type":"switch","z":"98edc07.d8c374","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":1237.5,"y":521,"wires":[["18bf5373.1ef2ed"],["80eb3a90.afdde8"]]},{"id":"80eb3a90.afdde8","type":"function","z":"98edc07.d8c374","name":"set name exist","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'cp name already exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1197,"y":657,"wires":[["7b396265.ca45ec"]]},{"id":"47783f37.c44d4","type":"function","z":"98edc07.d8c374","name":"set cps to flow","func":"msg['cps'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":1249,"y":42,"wires":[["a2450738.3b7838"]]},{"id":"a2450738.3b7838","type":"split","z":"98edc07.d8c374","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1239,"y":102,"wires":[["1aacc47c.61f46c"]]},{"id":"1aacc47c.61f46c","type":"function","z":"98edc07.d8c374","name":"set grps query by cp","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select g.grpId, g.grpName, g.createTime from api_cp_mapping m left join api_grp g on m.grpId = g.grpId where m.cpId = '+msg.payload.cpId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1289,"y":142,"wires":[["f058cda4.e00e"]]},{"id":"869cbb5c.f29088","type":"join","z":"98edc07.d8c374","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":1512,"y":198,"wires":[["c70e9220.3faae"]]},{"id":"ac530a4a.5e52f8","type":"switch","z":"98edc07.d8c374","name":"check role","property":"roleId","propertyType":"msg","rules":[{"t":"neq","v":"1","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":1390,"y":463,"wires":[["5c016b9c.74d064"],["d112f4a8.3b1598"]]},{"id":"5c016b9c.74d064","type":"function","z":"98edc07.d8c374","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1572,"y":406,"wires":[["eebab07b.a2f83"]]},{"id":"eebab07b.a2f83","type":"http response","z":"98edc07.d8c374","name":"","statusCode":"","headers":{},"x":1785,"y":409,"wires":[]},{"id":"25502b77.bebc54","type":"function","z":"98edc07.d8c374","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":169,"y":302,"wires":[["4747ed6c.b0d3b4"]]},{"id":"43ed558b.2a8f8c","type":"switch","z":"98edc07.d8c374","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":176,"y":226,"wires":[["b7767bce.2e26a8"],["c79ea43.b055e58"]]},{"id":"b7767bce.2e26a8","type":"function","z":"98edc07.d8c374","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":146,"y":186,"wires":[["38d45a10.17bb66"]]},{"id":"c6f7b4a2.945bb8","type":"function","z":"98edc07.d8c374","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":169,"y":842,"wires":[["a2032fef.9318f"]]},{"id":"9d3c34cf.cb2328","type":"switch","z":"98edc07.d8c374","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":176,"y":766,"wires":[["c6aa9826.84dd48"],["36a0a92.851e556"]]},{"id":"c6aa9826.84dd48","type":"function","z":"98edc07.d8c374","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['userCpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":146,"y":726,"wires":[["673e8bcc.5574a4"]]},{"id":"5661d64f.e7f6d8","type":"function","z":"98edc07.d8c374","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":169,"y":1502,"wires":[["ec2edeb.b71252"]]},{"id":"e9c2d433.5bf1b8","type":"switch","z":"98edc07.d8c374","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":176,"y":1426,"wires":[["28dfa6bb.5076aa"],["a220016b.e59af"]]},{"id":"28dfa6bb.5076aa","type":"function","z":"98edc07.d8c374","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['userCpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":146,"y":1386,"wires":[["c0506b14.e6c9d8"]]},{"id":"64c3bfc7.3c82f","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":116.5,"y":395,"wires":[["c621c5f7.514438"]]},{"id":"5fa5c84f.4c60e8","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":1042.5,"y":41,"wires":[["47783f37.c44d4"]]},{"id":"f058cda4.e00e","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":1307.5,"y":198,"wires":[["869cbb5c.f29088"]]},{"id":"d0d49268.1980c","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":119.5,"y":922,"wires":[["9f52d787.3ec498"]]},{"id":"37b1bbb8.4e5804","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":1024.5,"y":546,"wires":[["946a6f24.22d5a"]]},{"id":"5307d9c5.833408","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":1801.5,"y":512,"wires":[["24c7e08.62f632"]]},{"id":"e1be1633.eafe08","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":148.5,"y":1586,"wires":[["de4ebcf3.1f7f7"]]},{"id":"c0a4fbdb.d8caf8","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":916.5,"y":1259,"wires":[["77bca425.54b00c"]]},{"id":"aa5b2aa4.36c8f8","type":"subflow:42cc5e2a.1f178","z":"98edc07.d8c374","x":1520.5,"y":1162,"wires":[["adf5f88c.0bb528"]]},{"id":"4747ed6c.b0d3b4","type":"subflow:47f0f2eb.a3493c","z":"98edc07.d8c374","x":160.5,"y":266,"wires":[["43ed558b.2a8f8c"]]},{"id":"a2032fef.9318f","type":"subflow:47f0f2eb.a3493c","z":"98edc07.d8c374","x":156.5,"y":803,"wires":[["9d3c34cf.cb2328"]]},{"id":"ec2edeb.b71252","type":"subflow:47f0f2eb.a3493c","z":"98edc07.d8c374","x":155.5,"y":1463,"wires":[["e9c2d433.5bf1b8"]]},{"id":"2ed2089b.b6ebd8","type":"switch","z":"d829b1e4.26b7d","name":"checkStr","property":"checkStr","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":152.5,"y":219,"wires":[["97a98dcb.efa29"],["96db3fee.aec57"]]},{"id":"d814cd38.9ac41","type":"function","z":"d829b1e4.26b7d","name":"check format","func":"let re = new RegExp(msg.payload[0].p_value, 'g')\nmsg['checkFlg'] = re.test(msg.checkStr)\nreturn msg","outputs":1,"noerr":0,"x":527.5,"y":59,"wires":[["f398cc9f.1e34c"]]},{"id":"2a928908.8c25b6","type":"function","z":"d829b1e4.26b7d","name":"get check properties","func":"let sqlStr = 'select * from api_system_properties where p_name = \"'+msg.properties+'\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg","outputs":1,"noerr":0,"x":182,"y":103,"wires":[["bccde13d.15cf3"]]},{"id":"8ca580fd.4774c","type":"switch","z":"d829b1e4.26b7d","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":359,"y":51,"wires":[["d814cd38.9ac41"],["96db3fee.aec57"]]},{"id":"96db3fee.aec57","type":"function","z":"d829b1e4.26b7d","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'Missing Parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":596,"y":200,"wires":[["1552442b.134b6c"]]},{"id":"1552442b.134b6c","type":"http response","z":"d829b1e4.26b7d","name":"","statusCode":"","headers":{},"x":839,"y":201,"wires":[]},{"id":"97a98dcb.efa29","type":"switch","z":"d829b1e4.26b7d","name":"check properties","property":"properties","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":182.5,"y":158,"wires":[["2a928908.8c25b6"],["96db3fee.aec57"]]},{"id":"f398cc9f.1e34c","type":"switch","z":"d829b1e4.26b7d","name":"check flg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":712.5,"y":51,"wires":[[],["9dfc4b83.5c3418"]]},{"id":"9dfc4b83.5c3418","type":"function","z":"d829b1e4.26b7d","name":"set format error","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = msg.properties+' error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":726.5,"y":133,"wires":[["1552442b.134b6c"]]},{"id":"dbcc4c35.c4558","type":"http in","z":"ef8c2a97.a89548","name":"","url":"/users","method":"get","upload":false,"swaggerDoc":"","x":129,"y":650,"wires":[["3f311037.28e08"]]},{"id":"3f311037.28e08","type":"switch","z":"ef8c2a97.a89548","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":128,"y":599,"wires":[["ed5de142.6e9ea"],["66c66f34.1b53e"]]},{"id":"b58b0d5f.dea78","type":"function","z":"ef8c2a97.a89548","name":"check login history","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":132.5,"y":420,"wires":[["73958ab6.f03604"]]},{"id":"66c66f34.1b53e","type":"function","z":"ef8c2a97.a89548","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":466.5,"y":591,"wires":[["8a63bc96.aadda"]]},{"id":"8a63bc96.aadda","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1134.5,"y":447,"wires":[]},{"id":"9cb8f2fb.cd711","type":"switch","z":"ef8c2a97.a89548","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":120.5,"y":332,"wires":[["df4f4672.e9c0f8"],["632c4960.39fd08"]]},{"id":"632c4960.39fd08","type":"function","z":"ef8c2a97.a89548","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":387.5,"y":381,"wires":[["8a63bc96.aadda"]]},{"id":"b53f1f99.b4e0b","type":"switch","z":"ef8c2a97.a89548","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":129,"y":110,"wires":[["b4f4b328.1aafe"],["a19f5998.12b138"]]},{"id":"a19f5998.12b138","type":"function","z":"ef8c2a97.a89548","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429,"y":170,"wires":[["8a63bc96.aadda"]]},{"id":"c32dc38.b1e4f4","type":"function","z":"ef8c2a97.a89548","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":419,"y":230,"wires":[["8a63bc96.aadda"]]},{"id":"3b531e9c.fda692","type":"function","z":"ef8c2a97.a89548","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1116.5,"y":223,"wires":[["8a63bc96.aadda"]]},{"id":"d1b4bab5.765698","type":"function","z":"ef8c2a97.a89548","name":"set all user query","func":"let actInfo = msg['actInfo']\nlet searchTxt = msg['search']\nlet sqlStr = 'select u.userId, u.cpId, u.roleId, u.userName, u.pic, u.email, u.userBlock, u.userType, u.createTime, c.cpName, r.roleName, case when u.userBlock = 0 then \"unblock\"  when u.userBlock = 1 then \"block\" else \"unknown\" end as blockDesc from api_user u left join api_cp c on u.cpId = c.cpId left join api_role r on u.roleId = r.roleId where 1 =1 '\nif(searchTxt && searchTxt.length > 0){\n  if(searchTxt.indexOf(':') !== -1){\n    let arr = searchTxt.split(':')\n    if(arr.length === 3){\n      sqlStr = sqlStr + ' and u.' + arr[0] + ' ' +arr[1] + ' \"' +arr[2] +'\"'\n    }\n    if(arr.length === 5){\n      sqlStr = sqlStr + ' and u.' + arr[0] + ' ' +arr[1] + ' \"' +arr[2] + '\" ' +arr[3] + ' \"' +arr[4] +'\"'\n    }\n  }else{\n    sqlStr = sqlStr + ' and (u.userName like \"%'+searchTxt+'%\" or u.email like \"%'+searchTxt+'%\" or c.cpName like \"%'+searchTxt+'%\")'\n  }\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1139.5,"y":29,"wires":[["cc796fe1.7d9ab"]]},{"id":"9e234fa5.39073","type":"function","z":"ef8c2a97.a89548","name":"set all user by cp","func":"let actInfo = msg['actInfo']\nlet searchTxt = msg['search']\nlet sqlStr = 'select u.userId, u.cpId, u.roleId, u.userName, u.pic, u.email, u.userBlock, u.userType, u.createTime, c.cpName, r.roleName, case when u.userBlock = 0 then \"unblock\"  when u.userBlock = 1 then \"block\" else \"unknown\" end as blockDesc from api_user u left join api_cp c on u.cpId = c.cpId left join api_role r on u.roleId = r.roleId where u.cpId = '+actInfo.cpId\nif(searchTxt && searchTxt.length > 0){\n  if(searchTxt.indexOf(':') !== -1){\n    let arr = searchTxt.split(':')\n    if(arr.length === 3){\n      sqlStr = sqlStr + ' and u.' + arr[0] + ' ' +arr[1] + ' \"' +arr[2] +'\"'\n    }\n    if(arr.length === 5){\n      sqlStr = sqlStr + ' and u.' + arr[0] + ' ' +arr[1] + ' \"' +arr[2] + '\" ' +arr[3] + ' \"' +arr[4] +'\"'\n    }\n  }else{\n    sqlStr = sqlStr + ' and (u.userName like \"%'+searchTxt+'%\" or u.email like \"%'+searchTxt+'%\")'\n  }\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1144.5,"y":81.33333587646484,"wires":[["cc796fe1.7d9ab"]]},{"id":"f0fbf87c.b544b8","type":"function","z":"ef8c2a97.a89548","name":"set result","func":"let newPayload = {}\nif(msg.payload.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = msg.payload.length\n  newPayload['users'] = msg.payload\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1583.5,"y":75,"wires":[["d5967c5c.7e5ba"]]},{"id":"d5967c5c.7e5ba","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1740.5,"y":74,"wires":[]},{"id":"42f58ce9.3979d4","type":"http in","z":"ef8c2a97.a89548","name":"","url":"/users","method":"put","upload":false,"swaggerDoc":"","x":149,"y":1270,"wires":[["8e36c870.327de8"]]},{"id":"9f1a0b53.ccc298","type":"switch","z":"ef8c2a97.a89548","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":139,"y":1070,"wires":[["722aa951.497268"],["1fbbefe3.ad59"]]},{"id":"722aa951.497268","type":"function","z":"ef8c2a97.a89548","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nif(msg.payload.pwd !== undefined){\n  msg['resetPwdFlg'] = true\n}else{\n  msg['resetPwdFlg'] = false\n}\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":139,"y":1030,"wires":[["92d311df.0d4a4"]]},{"id":"1fbbefe3.ad59","type":"function","z":"ef8c2a97.a89548","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":539,"y":1177,"wires":[["8c058e48.25753"]]},{"id":"8c058e48.25753","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1130,"y":1281,"wires":[]},{"id":"d8a71ee1.a91ea","type":"switch","z":"ef8c2a97.a89548","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":119,"y":950,"wires":[["d824b7c8.0166d8"],["fe277ea1.ad2c3"]]},{"id":"fe277ea1.ad2c3","type":"function","z":"ef8c2a97.a89548","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":393,"y":1022,"wires":[["8c058e48.25753"]]},{"id":"cea0bcac.e71fb","type":"switch","z":"ef8c2a97.a89548","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":149,"y":730,"wires":[["aeae0048.5ffc6"],["b6f4a5ef.8f6858"]]},{"id":"b6f4a5ef.8f6858","type":"function","z":"ef8c2a97.a89548","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429,"y":810,"wires":[["8c058e48.25753"]]},{"id":"44e9d43f.3fe8cc","type":"function","z":"ef8c2a97.a89548","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":419,"y":890,"wires":[["8c058e48.25753"]]},{"id":"458d0f72.b1ddc","type":"function","z":"ef8c2a97.a89548","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1084,"y":907,"wires":[["8c058e48.25753"]]},{"id":"3927e672.f5fe8a","type":"function","z":"ef8c2a97.a89548","name":"set update user query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'UPDATE `api_user` SET `cpId` = '+actInfo.catId+', `roleId` = '+actInfo.roleId+', `userBlock` = '+actInfo.userBlock+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `userId` = '+actInfo.mUserId\nif(msg['resetPwdFlg']){\n  sqlStr = 'UPDATE `api_user` SET `cpId` = '+actInfo.catId+', `roleId` = '+actInfo.roleId+', `userBlock` = '+actInfo.userBlock+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+', `userPwd` = \"' + msg.payload + '\" WHERE `userId` = '+actInfo.mUserId\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1405,"y":666,"wires":[["e92cc2e3.e8032"]]},{"id":"2aeb70e8.c1003","type":"function","z":"ef8c2a97.a89548","name":"set result","func":"let newPayload = {}\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'update success'\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1820,"y":666,"wires":[["9815822a.dd6f8"]]},{"id":"9815822a.dd6f8","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1927,"y":607,"wires":[]},{"id":"da07c36.3d0ed4","type":"switch","z":"ef8c2a97.a89548","name":"check search","property":"payload.search","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":134,"y":503,"wires":[["3fc14954.769bc6"],["6ba1c8cf.c76308"]]},{"id":"6ba1c8cf.c76308","type":"function","z":"ef8c2a97.a89548","name":"set search text","func":"msg.payload = msg.payload.search\nreturn msg","outputs":1,"noerr":0,"x":329,"y":510,"wires":[["8982264a.2f8e18"]]},{"id":"8982264a.2f8e18","type":"decrypt","z":"ef8c2a97.a89548","name":"","algorithm":"TripleDES","key":"gemtek","x":489,"y":510,"wires":[["12231a5a.6daa46"]]},{"id":"12231a5a.6daa46","type":"function","z":"ef8c2a97.a89548","name":"set to flow","func":"msg['search'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":647.5,"y":474,"wires":[["b58b0d5f.dea78"]]},{"id":"ed5de142.6e9ea","type":"function","z":"ef8c2a97.a89548","name":"set flow info","func":"msg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":133,"y":549,"wires":[["da07c36.3d0ed4"]]},{"id":"6a9e62e6.6a17cc","type":"http in","z":"ef8c2a97.a89548","name":"","url":"/users","method":"delete","upload":false,"swaggerDoc":"","x":120.66666412353516,"y":1993.333209991455,"wires":[["5ebf454b.09012c","ac5d79.49eca288"]]},{"id":"7cab3606.cffb18","type":"switch","z":"ef8c2a97.a89548","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":117.33332824707031,"y":1872.333251953125,"wires":[["8ec1cf0e.9a334"],["b844d71b.e533c8"]]},{"id":"8ec1cf0e.9a334","type":"function","z":"ef8c2a97.a89548","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":129.3333282470703,"y":1826.333251953125,"wires":[["f42ba3ef.598e"]]},{"id":"b844d71b.e533c8","type":"function","z":"ef8c2a97.a89548","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":378.3333282470703,"y":1891.333251953125,"wires":[["1950b24e.793a7e"]]},{"id":"1950b24e.793a7e","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1131.3333282470703,"y":1853.333251953125,"wires":[]},{"id":"a6c7dc89.5b244","type":"switch","z":"ef8c2a97.a89548","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":117.33332824707031,"y":1738.333251953125,"wires":[["95de028.bc717"],["53b5d390.6c15bc"]]},{"id":"53b5d390.6c15bc","type":"function","z":"ef8c2a97.a89548","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":384.3333282470703,"y":1787.333251953125,"wires":[["1950b24e.793a7e"]]},{"id":"f3598a93.98ac08","type":"switch","z":"ef8c2a97.a89548","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":109,"y":1530,"wires":[["a8c72fa9.03c0c"],["846eadd4.338b2"]]},{"id":"846eadd4.338b2","type":"function","z":"ef8c2a97.a89548","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429,"y":1570,"wires":[["1950b24e.793a7e"]]},{"id":"51f9b485.6ee2fc","type":"function","z":"ef8c2a97.a89548","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":399,"y":1650,"wires":[["1950b24e.793a7e"]]},{"id":"ec5cb75.0ee5848","type":"function","z":"ef8c2a97.a89548","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":999,"y":1590,"wires":[["1950b24e.793a7e"]]},{"id":"a3baabae.a4a058","type":"function","z":"ef8c2a97.a89548","name":"set del user query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nif(msg.dataset == 0){\n  sqlStr = 'delete from api_user where userId = '+actInfo.delUserId    \n}else{\n  sqlStr = 'delete from api_user where cpId = '+actInfo.cpId +' and userId = '+actInfo.delUserId\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":970,"y":1452,"wires":[["9cd29732.f045c8"]]},{"id":"e8192b62.62ea48","type":"function","z":"ef8c2a97.a89548","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nnewPayload['responseMsg'] = 'delete ' + res\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1409,"y":1450,"wires":[["f2aa9b8a.6173f8"]]},{"id":"f2aa9b8a.6173f8","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1579,"y":1450,"wires":[]},{"id":"5ebf454b.09012c","type":"switch","z":"ef8c2a97.a89548","name":"check delUserId","property":"payload.delUserId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":129.99998474121094,"y":1937.000249862671,"wires":[["7cab3606.cffb18","ac5d79.49eca288"],["b844d71b.e533c8"]]},{"id":"13cad137.c6834f","type":"switch","z":"ef8c2a97.a89548","name":"check roleId","property":"payload.roleId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":139,"y":1150,"wires":[["ea492f41.67cca"],["1fbbefe3.ad59"]]},{"id":"ea492f41.67cca","type":"switch","z":"ef8c2a97.a89548","name":"check userBlock","property":"payload.userBlock","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":139,"y":1110,"wires":[["9f1a0b53.ccc298"],["1fbbefe3.ad59"]]},{"id":"8e36c870.327de8","type":"switch","z":"ef8c2a97.a89548","name":"check mUserId","property":"payload.mUserId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":149,"y":1230,"wires":[["63f05a3e.8e6624"],["1fbbefe3.ad59"]]},{"id":"ac5d79.49eca288","type":"debug","z":"ef8c2a97.a89548","name":"","active":true,"console":"false","complete":"true","x":357.3000259399414,"y":1988.7833518981934,"wires":[]},{"id":"5842242b.84de3c","type":"http in","z":"ef8c2a97.a89548","name":"","url":"/users","method":"post","upload":false,"swaggerDoc":"","x":151.75000381469727,"y":3117.00004863739,"wires":[["6b95ac73.02cce4"]]},{"id":"8fea09b1.d13208","type":"switch","z":"ef8c2a97.a89548","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":148.00000381469727,"y":2898.500044822693,"wires":[["7f361c12.ea3854"],["a298ac2.966995"]]},{"id":"4df75a48.c65644","type":"function","z":"ef8c2a97.a89548","name":"check login history","func":"let userInfo = msg['actInfo']\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + userInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":141,"y":2504.750036239624,"wires":[["5b1d44fa.b74cfc"]]},{"id":"a298ac2.966995","type":"function","z":"ef8c2a97.a89548","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":597.0000076293945,"y":2723.2500381469727,"wires":[["7282e050.45166"]]},{"id":"7282e050.45166","type":"http response","z":"ef8c2a97.a89548","name":"","statusCode":"","headers":{},"x":1784.2500267028809,"y":2728.5000400543213,"wires":[]},{"id":"2652347b.482e1c","type":"switch","z":"ef8c2a97.a89548","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":129,"y":2408,"wires":[["e1db9dc0.8561b"],["2d80c0f1.28587"]]},{"id":"2d80c0f1.28587","type":"function","z":"ef8c2a97.a89548","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":396,"y":2457,"wires":[["7282e050.45166"]]},{"id":"c4b43f73.63b1b","type":"switch","z":"ef8c2a97.a89548","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":129,"y":2210,"wires":[["d73319f4.adc098"],["8b64641c.3a6318"]]},{"id":"8b64641c.3a6318","type":"function","z":"ef8c2a97.a89548","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429,"y":2270,"wires":[["7282e050.45166"]]},{"id":"d2bd3fcf.63c91","type":"function","z":"ef8c2a97.a89548","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":419,"y":2350,"wires":[["7282e050.45166"]]},{"id":"6b30aa46.3a4b14","type":"function","z":"ef8c2a97.a89548","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":939,"y":2290,"wires":[["7282e050.45166"]]},{"id":"774f244e.5424ec","type":"switch","z":"ef8c2a97.a89548","name":"check roleId","property":"payload.roleId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":148.50000381469727,"y":2985.750045776367,"wires":[["4d44158d.d698dc"],["a298ac2.966995"]]},{"id":"4d44158d.d698dc","type":"switch","z":"ef8c2a97.a89548","name":"check userBlock","property":"payload.userBlock","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":149.75000381469727,"y":2942.750044822693,"wires":[["8fea09b1.d13208"],["a298ac2.966995"]]},{"id":"fd7c0671.6f9608","type":"switch","z":"ef8c2a97.a89548","name":"check catId","property":"payload.catId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":149.75000381469727,"y":3032.0000467300415,"wires":[["774f244e.5424ec"],["a298ac2.966995"]]},{"id":"6b95ac73.02cce4","type":"switch","z":"ef8c2a97.a89548","name":"check gender","property":"payload.gender.length","propertyType":"msg","rules":[{"t":"gt","v":"","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":152.75000381469727,"y":3076.25004863739,"wires":[["fd7c0671.6f9608"],["a298ac2.966995"]]},{"id":"7f361c12.ea3854","type":"function","z":"ef8c2a97.a89548","name":"set data to flow","func":"msg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":143.37500762939453,"y":2851.250044822693,"wires":[["61d15961.ead418"]]},{"id":"61d15961.ead418","type":"function","z":"ef8c2a97.a89548","name":"set acc check","func":"let userInfo = msg['actInfo']\nmsg['properties'] = 'ACC_FORMAT'\nmsg['checkStr'] = userInfo.name\nreturn msg;","outputs":1,"noerr":0,"x":145.25,"y":2806.2500438690186,"wires":[["2614de7f.69f802"]]},{"id":"2614de7f.69f802","type":"subflow:d829b1e4.26b7d","z":"ef8c2a97.a89548","x":139.00000762939453,"y":2760.0000381469727,"wires":[["25db27cc.901108"]]},{"id":"25db27cc.901108","type":"function","z":"ef8c2a97.a89548","name":"set mail check","func":"let userInfo = msg['actInfo']\nmsg['properties'] = 'EMAIL_FORMAT'\nmsg['checkStr'] = userInfo.email\nreturn msg;","outputs":1,"noerr":0,"x":144.50000762939453,"y":2713.0000381469727,"wires":[["1da83440.3760bc"]]},{"id":"1da83440.3760bc","type":"subflow:d829b1e4.26b7d","z":"ef8c2a97.a89548","x":135.00000762939453,"y":2660.0000381469727,"wires":[["e5750e99.da456"]]},{"id":"e5750e99.da456","type":"function","z":"ef8c2a97.a89548","name":"set pwd check","func":"let userInfo = msg['actInfo']\nmsg['properties'] = 'PWD_FORMAT'\nmsg['checkStr'] = userInfo.pwd\nreturn msg;","outputs":1,"noerr":0,"x":153.00000762939453,"y":2611.0000381469727,"wires":[["293c70bc.490d8"]]},{"id":"293c70bc.490d8","type":"subflow:d829b1e4.26b7d","z":"ef8c2a97.a89548","x":141.00000762939453,"y":2556.0000381469727,"wires":[["4df75a48.c65644"]]},{"id":"2da270e3.ac25b","type":"function","z":"ef8c2a97.a89548","name":"set check user sql","func":"let userInfo = msg['actInfo']\nlet sqlStr = 'select * from api_user where cpId ='+userInfo.cpId+' and (userName = \"'+userInfo.name+'\" or email = \"'+userInfo.email+'\")'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":999,"y":2150,"wires":[["25b1fd5a.de7162"]]},{"id":"465c6c2c.f1b984","type":"switch","z":"ef8c2a97.a89548","name":"check user exist","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"str"},{"t":"gt","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":1269,"y":2150,"wires":[["8f2d79d7.493018"],["6396311d.c6278"]]},{"id":"6396311d.c6278","type":"function","z":"ef8c2a97.a89548","name":"set user exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '403'\nnewPayload['responseMsg'] = 'username or email exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1299,"y":2270,"wires":[["7282e050.45166"]]},{"id":"8f2d79d7.493018","type":"function","z":"ef8c2a97.a89548","name":"encrypt pwd","func":"let userInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload = userInfo.pwd\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1496.5,"y":2087.75,"wires":[["2e77d22c.8a1c9e"]]},{"id":"2e77d22c.8a1c9e","type":"encrypt","z":"ef8c2a97.a89548","name":"","algorithm":"TripleDES","key":"gemtek","x":1514.5,"y":2147.75,"wires":[["dc52a186.9dab2"]]},{"id":"dc52a186.9dab2","type":"function","z":"ef8c2a97.a89548","name":"set insert user sql","func":"let userInfo = msg['actInfo']\nlet sqlStr = 'insert into api_user( cpId, roleId, userName, nickName, gender, userPwd, deviceType, pic, email, userBlock, userType, createTime, createUser) values ('+userInfo.catId+', '+userInfo.roleId+', \"'+userInfo.name+'\", \"'+userInfo.name+'\", \"'+userInfo.gender+'\", \"'+msg.payload+'\", 3, \"dummy\", \"'+userInfo.email+'\", '+userInfo.userBlock+', 3, current_time(), '+userInfo.userId+')'\nnode.warn(sqlStr)\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1559.5,"y":2200.75,"wires":[["cb63fbb5.4812e8"]]},{"id":"47f5b1ba.88666","type":"function","z":"ef8c2a97.a89548","name":"set result","func":"let newPayload = {}\nlet userInfo = flow.get('userInfo')\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n    newPayload['responseCode'] = '000'\n    newPayload['responseMsg'] = 'insert success'    \n}else{\n    newPayload['responseCode'] = '999'\n    newPayload['responseMsg'] = 'insert fail'\n}\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1568,"y":2328.75,"wires":[["7282e050.45166"]]},{"id":"b4f4b328.1aafe","type":"function","z":"ef8c2a97.a89548","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":321,"y":92,"wires":[["bf447bb.ed7a388"]]},{"id":"bf447bb.ed7a388","type":"switch","z":"ef8c2a97.a89548","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":579,"y":91,"wires":[["3f3dccdd.d550e4"],["3b531e9c.fda692"]]},{"id":"3f3dccdd.d550e4","type":"switch","z":"ef8c2a97.a89548","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":886,"y":59,"wires":[["d1b4bab5.765698"],["9e234fa5.39073"],["3b531e9c.fda692"]]},{"id":"aeae0048.5ffc6","type":"function","z":"ef8c2a97.a89548","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":389,"y":730,"wires":[["9d349f0f.5e433"]]},{"id":"9d349f0f.5e433","type":"switch","z":"ef8c2a97.a89548","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":602,"y":728,"wires":[["afbc9b05.813f48"],["458d0f72.b1ddc"]]},{"id":"afbc9b05.813f48","type":"switch","z":"ef8c2a97.a89548","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"true","outputs":3,"x":845,"y":647,"wires":[["4a543437.16224c"],["4a543437.16224c"],["458d0f72.b1ddc"]]},{"id":"a8c72fa9.03c0c","type":"function","z":"ef8c2a97.a89548","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":129,"y":1470,"wires":[["26209a64.6bf876"]]},{"id":"26209a64.6bf876","type":"switch","z":"ef8c2a97.a89548","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":359,"y":1470,"wires":[["a391ca14.ee6e88"],["ec5cb75.0ee5848"]]},{"id":"a391ca14.ee6e88","type":"switch","z":"ef8c2a97.a89548","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"true","outputs":3,"x":636,"y":1438,"wires":[["a3baabae.a4a058"],["a3baabae.a4a058"],["ec5cb75.0ee5848"]]},{"id":"d73319f4.adc098","type":"function","z":"ef8c2a97.a89548","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n    if(ar[i] === '29'){\n      accessFlg = true\n    }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":129,"y":2170,"wires":[["a37900a6.9cc46"]]},{"id":"a37900a6.9cc46","type":"switch","z":"ef8c2a97.a89548","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":359,"y":2170,"wires":[["5ec93cb3.16dcd4"],["6b30aa46.3a4b14"]]},{"id":"5ec93cb3.16dcd4","type":"switch","z":"ef8c2a97.a89548","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"true","outputs":3,"x":667,"y":2142,"wires":[["2da270e3.ac25b"],["2da270e3.ac25b"],["6b30aa46.3a4b14"]]},{"id":"63f05a3e.8e6624","type":"switch","z":"ef8c2a97.a89548","name":"check catId","property":"payload.catId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":139,"y":1190,"wires":[["13cad137.c6834f"],["1fbbefe3.ad59"]]},{"id":"d824b7c8.0166d8","type":"function","z":"ef8c2a97.a89548","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":169,"y":910,"wires":[["76af03f0.c3f9dc"]]},{"id":"1ff14396.c6b23c","type":"switch","z":"ef8c2a97.a89548","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":169,"y":830,"wires":[["14db1a94.220c95"],["44e9d43f.3fe8cc"]]},{"id":"14db1a94.220c95","type":"function","z":"ef8c2a97.a89548","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":139,"y":790,"wires":[["cea0bcac.e71fb"]]},{"id":"95de028.bc717","type":"function","z":"ef8c2a97.a89548","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":149,"y":1690,"wires":[["eb2e6a3.9e89a98"]]},{"id":"42628173.4b06f","type":"switch","z":"ef8c2a97.a89548","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":156,"y":1614,"wires":[["260793.eb77286e"],["51f9b485.6ee2fc"]]},{"id":"260793.eb77286e","type":"function","z":"ef8c2a97.a89548","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":126,"y":1574,"wires":[["f3598a93.98ac08"]]},{"id":"e1db9dc0.8561b","type":"function","z":"ef8c2a97.a89548","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":169,"y":2370,"wires":[["ebdb1d8a.930e1"]]},{"id":"79429d16.2cec94","type":"switch","z":"ef8c2a97.a89548","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":176,"y":2294,"wires":[["75ee3a71.0fae24"],["d2bd3fcf.63c91"]]},{"id":"75ee3a71.0fae24","type":"function","z":"ef8c2a97.a89548","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['userRoleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":146,"y":2254,"wires":[["c4b43f73.63b1b"]]},{"id":"df4f4672.e9c0f8","type":"function","z":"ef8c2a97.a89548","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":149,"y":270,"wires":[["40ec251c.00167c"]]},{"id":"63b3b2e2.270a7c","type":"switch","z":"ef8c2a97.a89548","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":156,"y":194,"wires":[["8ed3564a.4e7e68"],["c32dc38.b1e4f4"]]},{"id":"8ed3564a.4e7e68","type":"function","z":"ef8c2a97.a89548","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":126,"y":154,"wires":[["b53f1f99.b4e0b"]]},{"id":"3fc14954.769bc6","type":"function","z":"ef8c2a97.a89548","name":"clear search text","func":"msg['search'] = ''\nreturn msg","outputs":1,"noerr":0,"x":129,"y":470,"wires":[["b58b0d5f.dea78"]]},{"id":"73958ab6.f03604","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":133.5,"y":379,"wires":[["9cb8f2fb.cd711"]]},{"id":"cc796fe1.7d9ab","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":1398.5,"y":65,"wires":[["f0fbf87c.b544b8"]]},{"id":"92d311df.0d4a4","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":136.5,"y":992,"wires":[["d8a71ee1.a91ea"]]},{"id":"e92cc2e3.e8032","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":1633.5,"y":664,"wires":[["2aeb70e8.c1003"]]},{"id":"f42ba3ef.598e","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":130.5,"y":1785,"wires":[["a6c7dc89.5b244"]]},{"id":"9cd29732.f045c8","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":1187.5,"y":1450,"wires":[["e8192b62.62ea48"]]},{"id":"5b1d44fa.b74cfc","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":128.5,"y":2466,"wires":[["2652347b.482e1c"]]},{"id":"25b1fd5a.de7162","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":1137.5,"y":2081,"wires":[["465c6c2c.f1b984"]]},{"id":"cb63fbb5.4812e8","type":"subflow:42cc5e2a.1f178","z":"ef8c2a97.a89548","x":1561.5,"y":2264,"wires":[["47f5b1ba.88666"]]},{"id":"40ec251c.00167c","type":"subflow:47f0f2eb.a3493c","z":"ef8c2a97.a89548","x":142.5,"y":234,"wires":[["63b3b2e2.270a7c"]]},{"id":"76af03f0.c3f9dc","type":"subflow:47f0f2eb.a3493c","z":"ef8c2a97.a89548","x":157.5,"y":868,"wires":[["1ff14396.c6b23c"]]},{"id":"eb2e6a3.9e89a98","type":"subflow:47f0f2eb.a3493c","z":"ef8c2a97.a89548","x":139.5,"y":1651,"wires":[["42628173.4b06f"]]},{"id":"ebdb1d8a.930e1","type":"subflow:47f0f2eb.a3493c","z":"ef8c2a97.a89548","x":158.5,"y":2334,"wires":[["79429d16.2cec94"]]},{"id":"a6794a2b.97a7a8","type":"http in","z":"839d47f7.2507b8","name":"","url":"/mapping","method":"post","upload":false,"swaggerDoc":"","x":92,"y":748,"wires":[["b24a0c83.019ef"]]},{"id":"fb55b94.fbc6548","type":"switch","z":"839d47f7.2507b8","name":"check token","property":"payload.token.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":93.5,"y":610,"wires":[["a9d82901.c66b78"],["634c34b6.15f9ac"]]},{"id":"9c232d62.b8103","type":"function","z":"839d47f7.2507b8","name":"check login history","func":"msg['actInfo'] = msg.payload\nlet sqlStr = 'select * from api_login_history where history_logout_time is null and userToken = \"' + msg.payload.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":145.5,"y":398,"wires":[["2f7a8f6.2b8eb7"]]},{"id":"634c34b6.15f9ac","type":"function","z":"839d47f7.2507b8","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":699.5,"y":621,"wires":[["a849ae5b.f0437"]]},{"id":"a849ae5b.f0437","type":"http response","z":"839d47f7.2507b8","name":"","statusCode":"","headers":{},"x":1181.5,"y":536,"wires":[]},{"id":"c8ea86fe.dc0fb8","type":"switch","z":"839d47f7.2507b8","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":116.5,"y":307,"wires":[["8dc05739.e390f8"],["b5fdcba6.2b83a8"]]},{"id":"b5fdcba6.2b83a8","type":"function","z":"839d47f7.2507b8","name":"set logout result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'User already logout'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":457.5,"y":325,"wires":[["a849ae5b.f0437"]]},{"id":"26e2f468.5029ec","type":"switch","z":"839d47f7.2507b8","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","outputs":2,"x":117.5,"y":105,"wires":[["464174f2.2c23ac"],["88eef3b0.cba99"]]},{"id":"88eef3b0.cba99","type":"function","z":"839d47f7.2507b8","name":"set token error","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token length error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":457.5,"y":165,"wires":[["a849ae5b.f0437"]]},{"id":"daa6b8f4.360708","type":"function","z":"839d47f7.2507b8","name":"set expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":447.5,"y":225,"wires":[["a849ae5b.f0437"]]},{"id":"18a4b1d3.7e119e","type":"function","z":"839d47f7.2507b8","name":"set no permission","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'no permission to access'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":827.5,"y":185,"wires":[["a849ae5b.f0437"]]},{"id":"d6bdd7cf.836758","type":"function","z":"839d47f7.2507b8","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nnewPayload['responseMsg'] = 'update ' + res\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2646.5,"y":31,"wires":[["36bff80e.5ad3b8"]]},{"id":"36bff80e.5ad3b8","type":"http response","z":"839d47f7.2507b8","name":"","statusCode":"","headers":{},"x":2815.5,"y":31,"wires":[]},{"id":"eaf7cae6.9b7a68","type":"function","z":"839d47f7.2507b8","name":"set update mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nlet userStr = ''\nfor (var i in actInfo.users) {\n  userStr +=  actInfo.users[i].id\n  if(i < actInfo.users.length-1)\n  userStr += ','\n}\nif(actInfo.type === 'CP'){\n  sqlStr = 'UPDATE `api_user` SET `cpId` = -1, `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE cpId = '+actInfo.catId+' and `userId` not in ('+userStr +');'\n  sqlStr += 'UPDATE `api_user` SET `cpId` = '+actInfo.catId+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `userId` in ('+userStr +')'\n}\nif(actInfo.type === 'Role'){\n  sqlStr = 'UPDATE `api_user` SET `roleId` = -1, `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE roleId = '+actInfo.catId+' and `userId` not in ('+userStr +');'\n  sqlStr += 'UPDATE `api_user` SET `roleId` = '+actInfo.catId+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `userId` in ('+userStr +')'\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1919.5,"y":42,"wires":[["82fa6bc2.c83e78"]]},{"id":"610e42f3.dd856c","type":"switch","z":"839d47f7.2507b8","name":"check type","property":"payload.type.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":91.5,"y":660,"wires":[["fb55b94.fbc6548"],["634c34b6.15f9ac"]]},{"id":"b24a0c83.019ef","type":"switch","z":"839d47f7.2507b8","name":"check catId","property":"payload.catId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":94.5,"y":705,"wires":[["610e42f3.dd856c"],["634c34b6.15f9ac"]]},{"id":"3ab9f4aa.17107c","type":"function","z":"839d47f7.2507b8","name":"set users to payload","func":"let actInfo = msg['actInfo']\nlet updateFlg = false\nif(actInfo.users.length > 0){\n  msg.payload = actInfo.users\n  updateFlg = true\n}\nmsg['updateFlg'] = updateFlg\nreturn msg","outputs":1,"noerr":0,"x":1177.5,"y":45,"wires":[["95c26a10.401a18"]]},{"id":"95c26a10.401a18","type":"switch","z":"839d47f7.2507b8","name":"check updateFlg","property":"updateFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":1407.5,"y":85,"wires":[["baa21a15.d5b6e8"],["35cd516.53665ae"]]},{"id":"757d2e2.a65a0d","type":"function","z":"839d47f7.2507b8","name":"set remove mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nif(actInfo.type === 'CP'){\n  sqlStr = 'UPDATE `api_user` SET `cpId` = -1, `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `cpId` = '+actInfo.catId\n}\nif(actInfo.type === 'Role'){\n  sqlStr = 'UPDATE `api_user` SET `roleId` = -1, `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `roleId` = '+actInfo.catId \n}\nif(actInfo.type === 'Egrp'){\n  sqlStr = 'DELETE FROM `api_user_mapping` WHERE locId = '+actInfo.catId \n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1704.5,"y":188,"wires":[["e1e72380.1751f"]]},{"id":"3eee128d.95f84e","type":"function","z":"839d47f7.2507b8","name":"set unknown type","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'unknown type'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1147.5,"y":225,"wires":[["a849ae5b.f0437"]]},{"id":"3e129c4d.431804","type":"function","z":"839d47f7.2507b8","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail'\n}\nnewPayload['responseMsg'] = 'update ' + res\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2103.5,"y":220,"wires":[["b0c9e62a.c2a8c8"]]},{"id":"b0c9e62a.c2a8c8","type":"http response","z":"839d47f7.2507b8","name":"","statusCode":"","headers":{},"x":2289,"y":296,"wires":[]},{"id":"8042fbfc.eba858","type":"switch","z":"839d47f7.2507b8","name":"check mappingType","property":"mappingType","propertyType":"msg","rules":[{"t":"eq","v":"CP","vt":"str"},{"t":"eq","v":"Role","vt":"str"},{"t":"eq","v":"Egrp","vt":"str"},{"t":"eq","v":"Func","vt":"str"},{"t":"eq","v":"GRole","vt":"str"},{"t":"eq","v":"GCp","vt":"str"},{"t":"eq","v":"GFunc","vt":"str"},{"t":"else"}],"checkall":"true","outputs":8,"x":877.5,"y":85,"wires":[["3ab9f4aa.17107c"],["3ab9f4aa.17107c"],["3ab9f4aa.17107c"],["4379f526.f7f94c"],["ba10d500.9eb4d8"],["ba10d500.9eb4d8"],["4379f526.f7f94c"],["3eee128d.95f84e"]]},{"id":"4379f526.f7f94c","type":"function","z":"839d47f7.2507b8","name":"set funcs to payload","func":"let actInfo = msg['actInfo']\nlet updateFlg = false\nif(actInfo.func && actInfo.func.length > 0){\n  msg.payload = actInfo.func\n  updateFlg = true\n}\nmsg['updateFlg'] = updateFlg\nreturn msg","outputs":1,"noerr":0,"x":1177.5,"y":85,"wires":[["95c26a10.401a18"]]},{"id":"baa21a15.d5b6e8","type":"switch","z":"839d47f7.2507b8","name":"switch mappingType","property":"mappingType","propertyType":"msg","rules":[{"t":"eq","v":"CP","vt":"str"},{"t":"eq","v":"Role","vt":"str"},{"t":"eq","v":"Egrp","vt":"str"},{"t":"eq","v":"Func","vt":"str"},{"t":"eq","v":"GRole","vt":"str"},{"t":"eq","v":"GCp","vt":"str"},{"t":"eq","v":"GFunc","vt":"str"}],"checkall":"true","outputs":7,"x":1666,"y":65,"wires":[["eaf7cae6.9b7a68"],["eaf7cae6.9b7a68"],["e17044e3.dad438"],["e17044e3.dad438"],["e17044e3.dad438"],["e17044e3.dad438"],["b53e4d52.7d666"]]},{"id":"35cd516.53665ae","type":"switch","z":"839d47f7.2507b8","name":"check mappingType","property":"mappingType","propertyType":"msg","rules":[{"t":"eq","v":"Func","vt":"str"},{"t":"eq","v":"GRole","vt":"str"},{"t":"eq","v":"CP","vt":"str"},{"t":"eq","v":"Role","vt":"str"},{"t":"eq","v":"Egrp","vt":"str"},{"t":"eq","v":"GCp","vt":"str"},{"t":"eq","v":"GFunc","vt":"str"}],"checkall":"true","outputs":7,"x":1421.5,"y":225,"wires":[["9a06ff63.83b88"],["5a385f57.0d1bf"],["757d2e2.a65a0d"],["757d2e2.a65a0d"],["757d2e2.a65a0d"],["787906ce.7c0348"],["469c05f2.ab591c"]]},{"id":"9a06ff63.83b88","type":"function","z":"839d47f7.2507b8","name":"set function empty","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Function in role can not be empty'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1693.5,"y":246,"wires":[["b0c9e62a.c2a8c8"]]},{"id":"eae8faa0.2a1a98","type":"split","z":"839d47f7.2507b8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2770.428382873535,"y":157.85713958740234,"wires":[["b3ab48b6.d41bb8"]]},{"id":"b3ab48b6.d41bb8","type":"function","z":"839d47f7.2507b8","name":"set update mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nlet userStr = ''\nif(actInfo.type === 'Egrp'){\n  sqlStr = 'UPDATE `api_user_mapping` SET `locId` = '+actInfo.catId+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `userId` = '+msg.payload['id']\n}\nif(actInfo.type === 'Func'){\n  sqlStr = 'UPDATE `api_function_mapping` SET `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `roleId` = '+actInfo.catId+' and `functionId` = '+msg.payload['id']\n}\nif(actInfo.type === 'GRole'){\n  sqlStr = 'UPDATE `api_ra_mapping` SET `createFlg` = '+msg.payload['createFlg']+',`updateFlg` = '+msg.payload['updateFlg']+',`deleteFlg` = '+msg.payload['deleteFlg']+',`sortId` = '+msg.payload['sortId']+',`updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `roleId` = '+actInfo.catId+' and `grpId` = '+msg.payload['id']\n}\nif(actInfo.type === 'GCp'){\n  sqlStr = 'UPDATE `api_cp_mapping` SET `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `cpId` = '+actInfo.catId+' and `grpId` = '+msg.payload['id']\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['splitObj'] = msg.payload\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":2858.071304321289,"y":90.28571701049805,"wires":[["3de62ba6.31efc4"]]},{"id":"cf62ad2e.1f8da","type":"function","z":"839d47f7.2507b8","name":"set update result","func":"let updateFlg = false\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  updateFlg = true\n}\nmsg['updateFlg'] = updateFlg  \nreturn msg","outputs":1,"noerr":0,"x":3142.5000534057617,"y":76.85714340209961,"wires":[["86e789c7.e602e8"]]},{"id":"86e789c7.e602e8","type":"switch","z":"839d47f7.2507b8","name":"check updateFlg","property":"updateFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":3243.714401245117,"y":162.5714271068573,"wires":[["3e279497.2bb51c"],["8af7522d.bb2be"]]},{"id":"8af7522d.bb2be","type":"function","z":"839d47f7.2507b8","name":"set insert mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nif(actInfo.type === 'Egrp'){\n  sqlStr = 'INSERT INTO `api_user_mapping` (`userId`, `locId`, `createTime`, `createUser`) VALUES ('+msg.splitObj.id+', '+actInfo.catId+', current_time(), '+actInfo.userId+')'\n}\nif(actInfo.type === 'Func'){\n  sqlStr = 'INSERT INTO `api_function_mapping` (`roleId`, `functionId`, `createTime`, `createUser`) VALUES ('+actInfo.catId+', '+msg.splitObj.id+', current_time(), '+actInfo.userId+')'\n}\nif(actInfo.type === 'GRole'){\n  sqlStr = 'INSERT INTO `api_ra_mapping`(`roleId`, `grpId`, `sortId`, `createFlg`, `updateFlg`, `deleteFlg`, `createTime`, `createUser`) VALUES ('+actInfo.catId+', '+msg.splitObj.id+', '+msg.splitObj.sortId+', '+msg.splitObj.createFlg+', '+msg.splitObj.updateFlg+', '+msg.splitObj.deleteFlg+', current_time(), '+actInfo.userId+')'\n}\nif(actInfo.type === 'GCp'){\n  sqlStr = 'INSERT INTO `api_cp_mapping`(`cpId`, `grpId`, `createTime`, `createUser`) VALUES ('+actInfo.catId+', '+msg.splitObj.id+', current_time(), '+actInfo.userId+')'\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":3396.928825378418,"y":230.4285774230957,"wires":[["d1a32155.4137c"]]},{"id":"3e279497.2bb51c","type":"join","z":"839d47f7.2507b8","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":3661.714433670044,"y":107.57143688201904,"wires":[["6bb88c45.036ec4"]]},{"id":"6bb88c45.036ec4","type":"function","z":"839d47f7.2507b8","name":"check cnt","func":"let actInfo = msg['actInfo']\nlet totalLen = 0\nlet affectRow = 0\nlet title = ''\nlet targetId = ''\nlet newPayload = {}\nlet errorDtl = {}\nlet errorMsg = []\nif(msg['mappingType'] === 'Egrp'){\n  title = 'User'\n  totalLen = actInfo.users.length\n}\nif(msg['mappingType'] === 'Func'){\n  title = 'Function'\n  totalLen = actInfo.func.length    \n}\nif(msg['mappingType'] === 'GRole' || msg['mappingType'] === 'GCp'){\n  title = 'GRole'\n  totalLen = actInfo.grps.length    \n}\n\nfor(let i = 0 ; i < msg.payload.length ; i++){\n  errorDtl = {}\n  if(msg.payload[i].affectedRows > 0){\n    affectRow++\n  }else{\n    if(msg['mappingType'] === 'Egrp'){\n      targetId = actInfo.users[i].id\n    }\n    if(msg['mappingType'] === 'Func'){\n      targetId = actInfo.func[i].id\n    }\n    if(msg['mappingType'] === 'GRole' || msg['mappingType'] === 'GCp'){\n      targetId = actInfo.grps[i].id\n    }\n    errorDtl['msg'] = 'update '+title+ ' : '+targetId+' fail'\n    errorMsg.push(errorDtl)\n  }\n}\nif(totalLen == affectRow){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'update success'\n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = errorMsg\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":3756.5714683532715,"y":163.28570652008057,"wires":[["37b96e19.2b3332"]]},{"id":"37b96e19.2b3332","type":"http response","z":"839d47f7.2507b8","name":"","statusCode":"","headers":{},"x":3893.999897003174,"y":120.42857933044434,"wires":[]},{"id":"464174f2.2c23ac","type":"function","z":"839d47f7.2507b8","name":"check grp","func":"let actInfo = msg['actInfo']\nlet grpStr = actInfo.grp\nlet ar = grpStr.split(',')\nlet accessFlg = false\nfor(let i = 0 ; i < ar.length ; i++){\n  if(ar[i] === '29'){\n    accessFlg = true\n  }\n}\nmsg['accessFlg'] = accessFlg\nmsg['dataset'] = actInfo.dataset\nmsg['mappingType'] = actInfo.type\nreturn msg","outputs":1,"noerr":0,"x":417.5,"y":105,"wires":[["6e4d313d.e526f"]]},{"id":"6e4d313d.e526f","type":"switch","z":"839d47f7.2507b8","name":"check accessFlg","property":"accessFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":627.5,"y":105,"wires":[["8042fbfc.eba858"],["18a4b1d3.7e119e"]]},{"id":"a9d82901.c66b78","type":"switch","z":"839d47f7.2507b8","name":"check type","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"Func","vt":"str"},{"t":"eq","v":"GRole","vt":"str"},{"t":"eq","v":"GCp","vt":"str"},{"t":"else"},{"t":"eq","v":"GFunc","vt":"str"}],"checkall":"true","outputs":5,"x":95,"y":542,"wires":[["399d331f.94c68c"],["6e563d0e.60f2e4"],["6e563d0e.60f2e4"],["9c232d62.b8103"],["399d331f.94c68c"]]},{"id":"ba10d500.9eb4d8","type":"function","z":"839d47f7.2507b8","name":"set grps to payload","func":"let actInfo = msg['actInfo']\nlet updateFlg = false\nif(actInfo.grps.length > 0){\n  msg.payload = actInfo.grps\n  updateFlg = true\n}\nmsg['updateFlg'] = updateFlg\nreturn msg","outputs":1,"noerr":0,"x":1167.5,"y":125,"wires":[["95c26a10.401a18"]]},{"id":"5a385f57.0d1bf","type":"function","z":"839d47f7.2507b8","name":"set grp empty","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Grp in role can not be empty'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1688.5,"y":298,"wires":[["b0c9e62a.c2a8c8"]]},{"id":"d5fb939f.29ae6","type":"split","z":"839d47f7.2507b8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2106.928638458252,"y":157.9999966621399,"wires":[[]]},{"id":"e17044e3.dad438","type":"function","z":"839d47f7.2507b8","name":"set remove not in mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nlet inStr = ''\nif(actInfo.type === 'Egrp'){\n  inStr = ''\n  for (var i in actInfo.users) {\n      inStr +=  actInfo.users[i].id\n      if(i < actInfo.users.length-1)\n        inStr += ','\n  }\n  sqlStr = 'delete from  `api_user_mapping` where `locId` = '+actInfo.catId+' and `userId` not in (' + inStr +')'\n}\nif(actInfo.type === 'Func'){\n  inStr = ''\n  for (var i in actInfo.func) {\n      inStr +=  actInfo.func[i].id\n      if(i < actInfo.func.length-1)\n        inStr += ','\n  }\n  sqlStr = 'delete from  `api_function_mapping` where `roleId` = '+actInfo.catId+' and `functionId` not in (' + inStr +')'\n}\nif(actInfo.type === 'GRole' || actInfo.type === 'GCp'){\n  inStr = ''\n  for (var i in actInfo.grps) {\n      inStr +=  actInfo.grps[i].id\n      if(i < actInfo.grps.length-1)\n        inStr += ','\n  }\n  if(actInfo.type === 'GRole')\n    sqlStr = 'delete from  `api_ra_mapping` where `roleId` = '+actInfo.catId+' and `grpId` not in (' + inStr +')'\n  if(actInfo.type === 'GCp')\n    sqlStr = 'delete from  `api_cp_mapping` where `cpId` = '+actInfo.catId+' and `grpId` not in (' + inStr +')'\n}\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1928.9285888671875,"y":82.1428451538086,"wires":[["82d864b3.658698"]]},{"id":"6e563d0e.60f2e4","type":"switch","z":"839d47f7.2507b8","name":"check grps","property":"payload.grps.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":290.5,"y":512,"wires":[["9c232d62.b8103"],["634c34b6.15f9ac"]]},{"id":"399d331f.94c68c","type":"switch","z":"839d47f7.2507b8","name":"check func","property":"payload.func.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":287,"y":475,"wires":[["9c232d62.b8103"],["634c34b6.15f9ac"]]},{"id":"14488fad.fea34","type":"switch","z":"839d47f7.2507b8","name":"switch mappingType","property":"mappingType","propertyType":"msg","rules":[{"t":"eq","v":"Egrp","vt":"str"},{"t":"eq","v":"Func","vt":"str"},{"t":"eq","v":"GRole","vt":"str"},{"t":"eq","v":"GCp","vt":"str"}],"checkall":"true","outputs":4,"x":2321.7855682373047,"y":145.00000953674316,"wires":[["7070af3d.0975"],["526092f6.88037c"],["644ab915.22e458"],["644ab915.22e458"]]},{"id":"7070af3d.0975","type":"function","z":"839d47f7.2507b8","name":"set users to payload","func":"let actInfo = msg['actInfo']\nif(actInfo.users.length > 0){\n  msg.payload = actInfo.users\n}\nreturn msg","outputs":1,"noerr":0,"x":2557.499954223633,"y":120.71429824829102,"wires":[["eae8faa0.2a1a98"]]},{"id":"526092f6.88037c","type":"function","z":"839d47f7.2507b8","name":"set funcs to payload","func":"let actInfo = msg['actInfo']\nif(actInfo.func.length > 0){\n  msg.payload = actInfo.func\n}\nreturn msg","outputs":1,"noerr":0,"x":2553.285598754883,"y":158.8571548461914,"wires":[["eae8faa0.2a1a98"]]},{"id":"644ab915.22e458","type":"function","z":"839d47f7.2507b8","name":"set grps to payload","func":"let actInfo = msg['actInfo']\nif(actInfo.grps.length > 0){\n  msg.payload = actInfo.grps\n}\nreturn msg","outputs":1,"noerr":0,"x":2552.5714569091797,"y":195.42857933044434,"wires":[["eae8faa0.2a1a98"]]},{"id":"787906ce.7c0348","type":"function","z":"839d47f7.2507b8","name":"set grp empty","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Grp in cp can not be empty'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1687.5,"y":354,"wires":[["b0c9e62a.c2a8c8"]]},{"id":"469c05f2.ab591c","type":"function","z":"839d47f7.2507b8","name":"set grp empty","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Func in grp can not be empty'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1687.5,"y":407,"wires":[["b0c9e62a.c2a8c8"]]},{"id":"b53e4d52.7d666","type":"function","z":"839d47f7.2507b8","name":"set update mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = ''\nlet funcStr = ''\nfor (var i in actInfo.func) {\n  funcStr +=  actInfo.func[i].id\n  if(i < actInfo.func.length-1)\n  funcStr += ','\n}\nif(actInfo.type === 'GFunc'){\n  sqlStr = 'UPDATE `api_function` SET `grpId` = -1, `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE grpId = '+actInfo.catId+' and `functionId` not in ('+funcStr +');'\n  sqlStr = 'UPDATE `api_function` SET `grpId` = '+actInfo.catId+', `updateTime` = current_time(), `updateUser` = '+actInfo.userId+' WHERE `functionId` in ('+funcStr +')'\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1918.5,"y":124,"wires":[["82fa6bc2.c83e78"]]},{"id":"8dc05739.e390f8","type":"function","z":"839d47f7.2507b8","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":157.5,"y":265,"wires":[["6958a770.4cb978"]]},{"id":"8f916b8.902f698","type":"switch","z":"839d47f7.2507b8","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":164.5,"y":189,"wires":[["9c2f1520.cafae8"],["daa6b8f4.360708"]]},{"id":"9c2f1520.cafae8","type":"function","z":"839d47f7.2507b8","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet check = 0\nlet ar = token.split(':')\nif(ar.length == 6){\n  check = 1\n  actInfo['grp'] = ar[0]\n  actInfo['ts'] = ar[1]\n  actInfo['userId'] = ar[2]\n  actInfo['cpId'] = ar[3]\n  actInfo['roleId'] = ar[4]\n  actInfo['dataset'] = ar[5]\n  msg['actInfo'] = actInfo\n  msg['roleId'] = actInfo.roleId\n}\nmsg['check'] = check\nreturn msg","outputs":1,"noerr":0,"x":134.5,"y":149,"wires":[["26e2f468.5029ec"]]},{"id":"2f7a8f6.2b8eb7","type":"subflow:42cc5e2a.1f178","z":"839d47f7.2507b8","x":131.5,"y":349,"wires":[["c8ea86fe.dc0fb8"]]},{"id":"e1e72380.1751f","type":"subflow:42cc5e2a.1f178","z":"839d47f7.2507b8","x":1928.5,"y":204,"wires":[["3e129c4d.431804"]]},{"id":"82d864b3.658698","type":"subflow:42cc5e2a.1f178","z":"839d47f7.2507b8","x":2156.5,"y":88,"wires":[["14488fad.fea34"]]},{"id":"82fa6bc2.c83e78","type":"subflow:42cc5e2a.1f178","z":"839d47f7.2507b8","x":2425.5,"y":34,"wires":[["d6bdd7cf.836758"]]},{"id":"3de62ba6.31efc4","type":"subflow:42cc5e2a.1f178","z":"839d47f7.2507b8","x":3004.5,"y":155,"wires":[["cf62ad2e.1f8da"]]},{"id":"d1a32155.4137c","type":"subflow:42cc5e2a.1f178","z":"839d47f7.2507b8","x":3527.5,"y":169,"wires":[["3e279497.2bb51c"]]},{"id":"6958a770.4cb978","type":"subflow:47f0f2eb.a3493c","z":"839d47f7.2507b8","x":144.5,"y":228,"wires":[["8f916b8.902f698"]]},{"id":"bccde13d.15cf3","type":"subflow:42cc5e2a.1f178","z":"d829b1e4.26b7d","x":198.5,"y":58,"wires":[["8ca580fd.4774c"]]},{"id":"96c3645d.bf9d68","type":"function","z":"c2effd8c.b7a2d","name":"set delete func_mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_function_mapping` WHERE functionId = '+ actInfo.funcId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1407,"y":1429,"wires":[["8b5d7341.6e9ea","f89cc996.f465f8"]]},{"id":"8b5d7341.6e9ea","type":"subflow:42cc5e2a.1f178","z":"c2effd8c.b7a2d","x":1646,"y":1415,"wires":[["57e68051.721ab","e3965ff7.aee24"]]},{"id":"d68ba51c.b0e308","type":"function","z":"e9de16c5.c95d08","name":"set delete func_mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_function_mapping` WHERE roleId = '+actInfo.roleId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1846,"y":1313,"wires":[["19639c95.c18143"]]},{"id":"6ee9b031.7a07d","type":"switch","z":"e9de16c5.c95d08","name":"check responseCode","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1601.5,"y":1436,"wires":[["d68ba51c.b0e308"],["e75f200.ac91be"]]},{"id":"9afeee8c.edaa7","type":"function","z":"e9de16c5.c95d08","name":"set delete ra_mapping query","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_ra_mapping` WHERE roleId = '+actInfo.roleId\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":2113,"y":1365,"wires":[["6514647a.f3c73c"]]},{"id":"19639c95.c18143","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":2096,"y":1307,"wires":[["bc98b8fa.ff28d8"]]},{"id":"6514647a.f3c73c","type":"subflow:42cc5e2a.1f178","z":"e9de16c5.c95d08","x":2353,"y":1364,"wires":[["d5e42ae.bf0bed8"]]},{"id":"d5e42ae.bf0bed8","type":"function","z":"e9de16c5.c95d08","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail ra_mapping'\n}\nnewPayload['responseMsg'] = 'delete ' + res\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":2241,"y":1482,"wires":[["e75f200.ac91be"]]},{"id":"df4f14bb.3bf4d8","type":"switch","z":"c2effd8c.b7a2d","name":"check responseCode","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1420,"y":1487,"wires":[["96c3645d.bf9d68"],["7088614a.f4ae3"]]},{"id":"57e68051.721ab","type":"function","z":"c2effd8c.b7a2d","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'func_mapping fail'\n}\nnewPayload['responseMsg'] = 'delete ' + res\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1818,"y":1415,"wires":[["7088614a.f4ae3"]]},{"id":"bc98b8fa.ff28d8","type":"function","z":"e9de16c5.c95d08","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail func_mapping'\n}\nnewPayload['responseMsg'] = 'delete ' + res\n\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1863,"y":1365,"wires":[["dd25b971.274a28"]]},{"id":"dd25b971.274a28","type":"switch","z":"e9de16c5.c95d08","name":"check responseCode","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1915,"y":1417,"wires":[["9afeee8c.edaa7"],["e75f200.ac91be"]]},{"id":"59687ba3.f6c754","type":"switch","z":"30582f0c.49a88","name":"check responseCode","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1073,"y":1411,"wires":[["d3c15471.e29408"],["3367bca3.2788f4"]]},{"id":"d3c15471.e29408","type":"function","z":"30582f0c.49a88","name":"set delete ra_mapping sql","func":"let actInfo = msg['actInfo']\nlet sqlStr = 'DELETE FROM `api_ra_mapping` WHERE grpId = '+actInfo.grpId\nmsg['action'] = 'insert'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1388,"y":1327,"wires":[["1edc4304.bf416d"]]},{"id":"1edc4304.bf416d","type":"subflow:42cc5e2a.1f178","z":"30582f0c.49a88","x":1344,"y":1380,"wires":[["52b8164f.6f4ea8"]]},{"id":"52b8164f.6f4ea8","type":"function","z":"30582f0c.49a88","name":"set result","func":"let newPayload = {}\nlet res = ''\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n  newPayload['responseCode'] = '000'\n  res = 'success'    \n}else{\n  newPayload['responseCode'] = '999'\n  res = 'fail ra_mapping'\n}\nnewPayload['responseMsg'] = 'delete ' + res\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1537,"y":1372,"wires":[["3367bca3.2788f4"]]},{"id":"aacd1230.b55dd","type":"debug","z":"cafe140c.d22e68","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":328.5,"y":474,"wires":[]},{"id":"4a543437.16224c","type":"switch","z":"ef8c2a97.a89548","name":"check resetPwdFlg","property":"resetPwdFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1055.5,"y":613,"wires":[["d9a4879c.83fd78"],["3927e672.f5fe8a"]]},{"id":"d9a4879c.83fd78","type":"function","z":"ef8c2a97.a89548","name":"encrypt pwd","func":"let userInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload = userInfo.pwd\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1336,"y":551,"wires":[["a5a5f364.47347"]]},{"id":"a5a5f364.47347","type":"encrypt","z":"ef8c2a97.a89548","name":"","algorithm":"TripleDES","key":"gemtek","x":1356,"y":601,"wires":[["3927e672.f5fe8a"]]},{"id":"f89cc996.f465f8","type":"debug","z":"c2effd8c.b7a2d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1612.5,"y":1361,"wires":[]},{"id":"e3965ff7.aee24","type":"debug","z":"c2effd8c.b7a2d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1827.5,"y":1355,"wires":[]},{"id":"4f8cc6d9.5fc578","type":"http in","z":"ba684eb9.17776","name":"","url":"/LINE/login/callback","method":"get","upload":false,"swaggerDoc":"","x":170,"y":240,"wires":[["131a88c2.4f1747","724bc3f1.23068c"]]},{"id":"131a88c2.4f1747","type":"debug","z":"ba684eb9.17776","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":420,"y":160,"wires":[]},{"id":"d8afd508.9abad8","type":"http in","z":"ba684eb9.17776","name":"","url":"/LINE/login/revoke","method":"post","upload":false,"swaggerDoc":"","x":100,"y":500,"wires":[["e452e65f.eb6a08"]]},{"id":"e452e65f.eb6a08","type":"switch","z":"ba684eb9.17776","name":"check access_token","property":"payload.access_token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":500,"wires":[["f9d9552d.aa5128"],["44d29ef1.1a952"]]},{"id":"44d29ef1.1a952","type":"function","z":"ba684eb9.17776","name":"set error msg","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'missing parameter'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":530,"y":560,"wires":[["2bd9e917.87a9e6"]]},{"id":"2bd9e917.87a9e6","type":"http response","z":"ba684eb9.17776","name":"","statusCode":"","headers":{},"x":1200,"y":560,"wires":[]},{"id":"f9d9552d.aa5128","type":"function","z":"ba684eb9.17776","name":"set payload to LINE","func":"let newPayload = {}\nlet header = {}\nnewPayload['access_token'] = msg.payload.access_token\nnewPayload['client_id'] = '1563051612'\nnewPayload['client_secret'] = '7ca20acee4a99ab38ef0fa67ccd7871d'\nmsg.payload = newPayload\nheader['content-type'] = 'application/x-www-form-urlencoded'\nmsg['headers'] = header\nreturn msg","outputs":1,"noerr":0,"x":570,"y":440,"wires":[["f53e6a4e.884028"]]},{"id":"f53e6a4e.884028","type":"http request","z":"ba684eb9.17776","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"https://api.line.me/oauth2/v2.1/revoke","tls":"","proxy":"","authType":"basic","x":790,"y":420,"wires":[["987a9529.a2dd68"]]},{"id":"987a9529.a2dd68","type":"function","z":"ba684eb9.17776","name":"set result to resp","func":"let newPayload = {}\nif(msg.payload == ''){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'revoke success'\n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = 'revoke fail'\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":980,"y":420,"wires":[["2bd9e917.87a9e6"]]},{"id":"724bc3f1.23068c","type":"switch","z":"ba684eb9.17776","name":"check code","property":"payload.code","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":240,"wires":[["feff2bdc.3d97a8"],["dab3e833.2bde58"]]},{"id":"dab3e833.2bde58","type":"function","z":"ba684eb9.17776","name":"set error msg","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'permission deny'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":620,"y":280,"wires":[["ca5280c5.8bac1"]]},{"id":"ca5280c5.8bac1","type":"http response","z":"ba684eb9.17776","name":"","statusCode":"","headers":{},"x":1480,"y":280,"wires":[]},{"id":"feff2bdc.3d97a8","type":"function","z":"ba684eb9.17776","name":"set payload to LINE","func":"let newPayload = {}\nlet header = {}\nnewPayload['grant_type'] = 'authorization_code'\nnewPayload['code'] = msg.payload.code\nnewPayload['redirect_uri'] = 'http://122.146.86.14:1880/LINE/login/callback'\nnewPayload['client_id'] = '1563051612'\nnewPayload['client_secret'] = '7ca20acee4a99ab38ef0fa67ccd7871d'\nmsg.payload = newPayload\nheader['content-type'] = 'application/x-www-form-urlencoded'\nmsg['headers'] = header\nreturn msg","outputs":1,"noerr":0,"x":640,"y":140,"wires":[["22a53c2c.ee7574"]]},{"id":"22a53c2c.ee7574","type":"http request","z":"ba684eb9.17776","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.line.me/oauth2/v2.1/token","tls":"","proxy":"","authType":"basic","x":840,"y":140,"wires":[["59686d0b.0ac144","cb2f2d90.d9f8c"]]},{"id":"59686d0b.0ac144","type":"switch","z":"ba684eb9.17776","name":"check error","property":"payload.error","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":1000,"y":140,"wires":[["d193f2b4.599a4","91c5e117.60a0d"],["d2ee4d52.7354b"]]},{"id":"d2ee4d52.7354b","type":"function","z":"ba684eb9.17776","name":"set error msg","func":"let newPayload = {}\nnewPayload['responseCode'] = '500'\nnewPayload['responseMsg'] = msg.payload.error_description\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1200,"y":180,"wires":[["ca5280c5.8bac1"]]},{"id":"d193f2b4.599a4","type":"function","z":"ba684eb9.17776","name":"set redirect","func":"msg.statusCode = 303;\n\nlet redirectUrl = decodeURIComponent(msg.req.originalUrl.substring(msg.req.originalUrl.indexOf(\"state=\") + 6))\n\nif (redirectUrl.indexOf(\"?\") > 0) {\n    redirectUrl += \"&\"\n} else {\n    redirectUrl += \"?\"\n}\n\nnode.warn(redirectUrl)\n\nmsg.headers = {\n    Location: redirectUrl + \"access_token=\"+msg.payload.access_token+'&refresh_token='+msg.payload.refresh_token\n}\ndelete msg.payload\nreturn msg","outputs":1,"noerr":0,"x":1200,"y":120,"wires":[["ca5280c5.8bac1","91c5e117.60a0d"]]},{"id":"cb2f2d90.d9f8c","type":"debug","z":"ba684eb9.17776","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1020,"y":60,"wires":[]},{"id":"91c5e117.60a0d","type":"debug","z":"ba684eb9.17776","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1360,"y":60,"wires":[]},{"id":"a926ed2c.3962e","type":"http in","z":"7a3748cb.a6fe98","name":"","url":"/register/:cp","method":"post","upload":false,"swaggerDoc":"","x":189,"y":928.0000610351562,"wires":[["d93dc3e8.135ab"]]},{"id":"b5609409.bee578","type":"function","z":"7a3748cb.a6fe98","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":635.2500076293945,"y":662.2500381469727,"wires":[["a55e0972.8b9ea8"]]},{"id":"a55e0972.8b9ea8","type":"http response","z":"7a3748cb.a6fe98","name":"","statusCode":"","headers":{},"x":866.5,"y":440.50006103515625,"wires":[]},{"id":"22631a65.98bb36","type":"switch","z":"7a3748cb.a6fe98","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"str"},{"t":"gt","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":147.25,"y":351,"wires":[["1d929dca.9a8812"],["cdd46296.048fc"]]},{"id":"cdd46296.048fc","type":"function","z":"7a3748cb.a6fe98","name":"set user exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '403'\nnewPayload['responseMsg'] = 'username or email exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":452.25,"y":358,"wires":[["a55e0972.8b9ea8"]]},{"id":"e71ff811.6ace18","type":"switch","z":"7a3748cb.a6fe98","name":"check type","property":"payload.type","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":171,"y":835.0000610351562,"wires":[["cf7393e2.d3fad"],["b5609409.bee578"]]},{"id":"d93dc3e8.135ab","type":"switch","z":"7a3748cb.a6fe98","name":"check gender","property":"payload.gender.length","propertyType":"msg","rules":[{"t":"gt","v":"","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":181,"y":881.2500629425049,"wires":[["e71ff811.6ace18"],["b5609409.bee578"]]},{"id":"cf7393e2.d3fad","type":"function","z":"7a3748cb.a6fe98","name":"set data to flow","func":"msg.payload['cp'] = msg.req.params.cp\nmsg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":181.62500762939453,"y":790.2500448226929,"wires":[["117e560f.4e9bda"]]},{"id":"117e560f.4e9bda","type":"function","z":"7a3748cb.a6fe98","name":"set acc check","func":"let userInfo = msg['actInfo']\nmsg['properties'] = 'ACC_FORMAT'\nmsg['checkStr'] = userInfo.name\nreturn msg;","outputs":1,"noerr":0,"x":180.5,"y":746.2500610351562,"wires":[["5a4f1831.a711f8"]]},{"id":"95d74124.9f137","type":"function","z":"7a3748cb.a6fe98","name":"set mail check","func":"let userInfo = msg['actInfo']\nmsg['properties'] = 'EMAIL_FORMAT'\nmsg['checkStr'] = userInfo.email\nreturn msg;","outputs":1,"noerr":0,"x":179.75000762939453,"y":649.0000610351562,"wires":[["b45ecd8d.9c536"]]},{"id":"669b0143.981d4","type":"function","z":"7a3748cb.a6fe98","name":"set pwd check","func":"let userInfo = msg['actInfo']\nmsg['properties'] = 'PWD_FORMAT'\nmsg['checkStr'] = userInfo.pwd\nreturn msg;","outputs":1,"noerr":0,"x":180.25000762939453,"y":550.0000610351562,"wires":[["1f6ec733.c1e0c9"]]},{"id":"1d929dca.9a8812","type":"function","z":"7a3748cb.a6fe98","name":"set check cp sql","func":"let userInfo = msg['actInfo']\nlet sqlStr = 'select cpId from api_cp where cpName = \"'+userInfo.cp+'\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":174.25,"y":298,"wires":[["94b1087.2d1b7f8"]]},{"id":"a7f2884b.c38158","type":"function","z":"7a3748cb.a6fe98","name":"encrypt pwd","func":"let userInfo = msg['actInfo']\nuserInfo['cpId'] = msg.payload[0].cpId\nlet newPayload = {}\nnewPayload = userInfo.pwd\nmsg.payload = newPayload\nmsg['actInfo'] = userInfo\nreturn msg\n","outputs":1,"noerr":0,"x":161.75,"y":143.75,"wires":[["44c98bfe.0ebd34"]]},{"id":"44c98bfe.0ebd34","type":"encrypt","z":"7a3748cb.a6fe98","name":"","algorithm":"TripleDES","key":"gemtek","x":151.75,"y":95.75,"wires":[["5c80f780.1a8988"]]},{"id":"5c80f780.1a8988","type":"function","z":"7a3748cb.a6fe98","name":"set insert user sql","func":"let userInfo = msg['actInfo']\nlet role = 15\nlet sqlStr = `\nINSERT INTO api_user \n( \n            cpid, \n            roleid, \n            username, \n            nickname, \n            gender, \n            userpwd, \n            devicetype, \n            pic, \n            email, \n            userblock, \n            usertype, \n            createtime, \n            createuser \n) \nVALUES \n( \n            ${userInfo.cpId}, \n            ${role}, \n            \"${userInfo.name}\", \n            \"${userInfo.name}\", \n            \"${userInfo.gender}\", \n            \"${msg.payload}\", \n            ${userInfo.type}, \n            \"dummy\", \n            \"${userInfo.email}\", \n            0, \n            0, \n            CURRENT_TIME(), \n            1 \n);\nSELECT LAST_INSERT_ID() AS last_insert_id;\n`\n\nnode.warn(sqlStr)\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\n\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":440,"y":100,"wires":[["dbaa6ae5.51a268"]]},{"id":"11330413.e3b63c","type":"function","z":"7a3748cb.a6fe98","name":"set result","func":"let newPayload = {}\n\nlet insertUserResult = msg[\"insertUserResult\"]\n\nif(insertUserResult[0].affectedRows && insertUserResult[0].affectedRows > 0){\n    newPayload['responseCode'] = '000'\n    newPayload['responseMsg'] = 'insert success'    \n}else{\n    newPayload['responseCode'] = '999'\n    newPayload['responseMsg'] = 'insert fail'\n}\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":720,"y":270,"wires":[["a55e0972.8b9ea8"]]},{"id":"c008ea89.340e28","type":"function","z":"7a3748cb.a6fe98","name":"set check user sql","func":"let userInfo = msg['actInfo']\nlet sqlStr = 'select * from api_user where cpId =(select cpId from api_cp where cpName = \"'+userInfo.cp+'\") and (userName = \"'+userInfo.name+'\" or email = \"'+userInfo.email+'\")'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":187.25,"y":448.7500305175781,"wires":[["2ad33cf9.64f2b4"]]},{"id":"d874530b.1cc4a","type":"switch","z":"7a3748cb.a6fe98","name":"check cp exist","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":173,"y":190,"wires":[["a7f2884b.c38158"],["5fcf4a90.082eb4"]]},{"id":"5fcf4a90.082eb4","type":"function","z":"7a3748cb.a6fe98","name":"set cp no exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'Cp not exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":462,"y":315,"wires":[["a55e0972.8b9ea8"]]},{"id":"f95991e2.81143","type":"http in","z":"d6879688.334818","name":"","url":"/socialLogin/:cp","method":"post","upload":false,"swaggerDoc":"","x":152,"y":1016,"wires":[["c4e29ed5.6b317","60a594c1.02fd9c"]]},{"id":"e7f508d7.018078","type":"function","z":"d6879688.334818","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":377,"y":895.5,"wires":[["c8b9edac.623df"]]},{"id":"c8b9edac.623df","type":"http response","z":"d6879688.334818","name":"","statusCode":"","headers":{},"x":572,"y":895.5,"wires":[]},{"id":"c897b5cf.edf688","type":"function","z":"d6879688.334818","name":"set user data to flow","func":"let ip = msg.req.get(\"x-client-ip\")\nif(ip !== undefined && ip.indexOf(\",\") != -1){\n    let ar = ip.split(',')\n    ip = ar[0]\n}else{\n  ip = msg.req.connection.remoteAddress\n}\nmsg.payload['ip'] = ip\nmsg.payload['cp'] = msg.req.params.cp\nmsg.payload['type'] = 0\nmsg['userInfo'] = msg.payload\nmsg.payload = msg.payload.pwd\nreturn msg","outputs":1,"noerr":0,"x":151,"y":612,"wires":[["c63fc38c.5cf7d"]]},{"id":"c63fc38c.5cf7d","type":"function","z":"d6879688.334818","name":"set user query","func":"let socialUid      = msg['userInfo'].providerData[0].uid\nlet socialProvider = msg['userInfo'].providerData[0].providerId\nlet cp             = msg.req.params.cp\n\nlet sqlStr = \n`SELECT usr.*, \n       r.rolename, \n       r.dataset \nFROM   ((SELECT * \n        FROM   api_user \n        WHERE  userblock = 0 \n               AND cpid = (SELECT cpid \n                           FROM   api_cp \n                           WHERE  cpname = \"${cp}\") \n               AND userid = (SELECT userid \n                             FROM   api_user_social_mapping \n                             WHERE  socialtype = \"${socialProvider}\" \n                                    AND socialid = \"${socialUid}\")) AS usr \n        LEFT JOIN api_role AS r \n               ON usr.roleid = r.roleid)`\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":153,"y":558.999997138977,"wires":[["8d660fa5.0cad6"]]},{"id":"14ea1c35.6ff004","type":"switch","z":"d6879688.334818","name":"check user exist","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","outputs":2,"x":150.75000762939453,"y":446.25,"wires":[["f6044a8a.5ea7e8"],["fef6b658.470a58"]]},{"id":"fef6b658.470a58","type":"function","z":"d6879688.334818","name":"set no data result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'No user data'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":413,"y":492.25000286102295,"wires":[["d6fac1be.caf24"]]},{"id":"4dd8f350.3a7f2c","type":"http response","z":"d6879688.334818","name":"admin","statusCode":"","headers":{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, GET, OPTIONS"},"x":730.7499923706055,"y":25,"wires":[]},{"id":"f6044a8a.5ea7e8","type":"function","z":"d6879688.334818","name":"set user to flow","func":"msg['dbUser'] = msg.payload[0]\nlet sqlStr = 'select g.grpId, g.grpName, m.createFlg, m.updateFlg, m.deleteFlg from api_ra_mapping m left join api_grp g on m.grpId = g.grpId where roleId = '+msg.payload[0].roleId + ' order by m.sortId'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":150.25001525878906,"y":400.75,"wires":[["e56d0aa7.993878"]]},{"id":"d82ed2c8.0c3ed","type":"function","z":"d6879688.334818","name":"gen token","func":"let userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet grps = msg['grps']\nlet grpStr = ''\nlet d = new Date()\nlet nowSeconds = Math.round(d.getTime() / 1000)\nif(grps && grps.length > 0){\n    for(let i = 0 ; i < grps.length ; i++){\n      grpStr += grps[i].grpId\n      if( i < grps.length - 1)\n        grpStr += ','\n    }\n}\nmsg.payload = grpStr+':'+nowSeconds+\":\"+dbUser.userId+\":\"+dbUser.cpId+\":\"+dbUser.roleId+\":\"+dbUser.dataset\nuserInfo['decryptToken'] = msg.payload\nmsg['userInfo'] = userInfo\nreturn msg;","outputs":1,"noerr":0,"x":154.24999237060547,"y":126,"wires":[["ea66e42.0b1be18"]]},{"id":"ea66e42.0b1be18","type":"encrypt","z":"d6879688.334818","name":"encrypt token","algorithm":"TripleDES","key":"gemtektoken","x":172.49999237060547,"y":81.25,"wires":[["aeb7db9.bc69728"]]},{"id":"aeb7db9.bc69728","type":"function","z":"d6879688.334818","name":"insert login history","func":"let userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet newPayload = []\nuserInfo['token'] = msg.payload\n\nlet sqlStr = 'insert into api_login_history(userId, userToken, history_login_time, history_ip, history_type, createTime) values ('+dbUser.userId+',\"'+msg.payload+'\", current_time(), \"'+userInfo.ip+'\", '+userInfo.type+', current_time())'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['userInfo'] = userInfo\nnewPayload.push(msg.payload)\nnewPayload.push(60)\nnewPayload.push('')\nmsg.payload = newPayload\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":179.99999237060547,"y":35,"wires":[["b5c1129c.1583a","178dfe49.0b1e72"]]},{"id":"27ad0248.987a2e","type":"function","z":"d6879688.334818","name":"set result","func":"let newPayload = {}\nlet userData = {}\nlet userInfo = msg['userInfo']\nlet dbUser = msg['dbUser']\nlet grps = msg['grps']\nif(msg.payload.affectedRows && msg.payload.affectedRows > 0){\n    userData['name'] = dbUser['userName']\n    userData['nickName'] = dbUser['nickName']\n    userData['gender'] = dbUser['gender']\n    userData['pic'] = dbUser['pic']\n    userData['email'] = dbUser['email']\n    newPayload['userInfo'] = userData\n    newPayload['services'] = grps\n    newPayload['role'] = dbUser['roleName']\n    newPayload['authToken'] = userInfo['token']\n    newPayload['responseCode'] = '000'\n    newPayload['responseMsg'] = 'login success'\n}else{\n    newPayload['responseCode'] = '999'\n    newPayload['responseMsg'] = 'insert history fail'\n}\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":567.2500228881836,"y":26.00000762939453,"wires":[["4dd8f350.3a7f2c","83ce19af.074ec8"]]},{"id":"d6fac1be.caf24","type":"http response","z":"d6879688.334818","name":"","statusCode":"","headers":{},"x":688.75,"y":492.75,"wires":[]},{"id":"c926eef0.356d5","type":"function","z":"d6879688.334818","name":"set pwd","func":"let dbUser = msg['dbUser']\nmsg['grps'] = msg.payload\nmsg.payload = dbUser.userPwd\nreturn msg","outputs":1,"noerr":0,"x":142.49996948242188,"y":294,"wires":[["d82ed2c8.0c3ed"]]},{"id":"83ce19af.074ec8","type":"debug","z":"d6879688.334818","name":"","active":true,"tosidebar":true,"console":false,"complete":"true","x":694.4999923706055,"y":80,"wires":[]},{"id":"4e89d009.737a6","type":"redis-command","z":"d6879688.334818","server":"1cc07558.8db6bb","command":"setex","name":"","topic":"","x":550,"y":160,"wires":[["b6ad1cf8.1ebaa"]]},{"id":"b6ad1cf8.1ebaa","type":"debug","z":"d6879688.334818","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":710,"y":160,"wires":[]},{"id":"b5c1129c.1583a","type":"function","z":"d6879688.334818","name":"set property sql","func":"let userInfo = msg['userInfo']\nlet sqlStr = 'select * from api_system_properties where p_name = \"TOKEN_EXPIRE\"'\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":389.99999237060547,"y":75,"wires":[["5b63bf80.49eaa"]]},{"id":"4f4e4238.28a80c","type":"function","z":"d6879688.334818","name":"set expire","func":"let newPayload = []\nlet userInfo = msg['userInfo']\nlet expireTime = 86400\nif(msg.payload.length > 0){\n  expireTime = msg.payload[0]['p_value']\n}\nnewPayload.push(userInfo.token)\nnewPayload.push(expireTime)\nnewPayload.push(userInfo.decryptToken)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":380,"y":160,"wires":[["4e89d009.737a6"]]},{"id":"c4e29ed5.6b317","type":"debug","z":"d6879688.334818","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":435.5,"y":1010.8000249862671,"wires":[]},{"id":"d3673ab1.c3e028","type":"firebase-auth-get-user","z":"d6879688.334818","name":"","queryType":"uid","queryValue":"","admin":"b6853919.862288","x":599.5,"y":728,"wires":[["9c633f06.909a"]]},{"id":"fe8705d2.06cd78","type":"function","z":"d6879688.334818","name":"UID in Firebase","func":"msg.payload = {\n    firebase: {\n        type: \"\",\n        query: msg.payload.socialId\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":396.5,"y":729,"wires":[["d3673ab1.c3e028"]]},{"id":"d8372beb.d5cd58","type":"switch","z":"d6879688.334818","name":"check social id","property":"payload.socialId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":133,"y":855,"wires":[["c74265c4.1d6eb8"],["e7f508d7.018078"]]},{"id":"c74265c4.1d6eb8","type":"switch","z":"d6879688.334818","name":"check cp","property":"req.params.cp","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":114,"y":798,"wires":[["d7a64b29.c2ae68"],["e7f508d7.018078"]]},{"id":"9c633f06.909a","type":"switch","z":"d6879688.334818","name":"check payload","property":"payload.providerData","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":435,"y":683,"wires":[["c897b5cf.edf688","c4e29ed5.6b317"],["47b42a39.e30664"]]},{"id":"47b42a39.e30664","type":"function","z":"d6879688.334818","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Error fetching user data'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":684,"y":690,"wires":[["47206f3a.a70f8"]]},{"id":"47206f3a.a70f8","type":"http response","z":"d6879688.334818","name":"","statusCode":"","headers":{},"x":902,"y":690,"wires":[]},{"id":"60a594c1.02fd9c","type":"json","z":"d6879688.334818","name":"","property":"payload","action":"obj","pretty":false,"x":102,"y":966,"wires":[["23ced409.72a97c"]]},{"id":"23ced409.72a97c","type":"switch","z":"d6879688.334818","name":"check social type","property":"payload.socialType","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":143.5,"y":911,"wires":[["d8372beb.d5cd58"],["e7f508d7.018078"]]},{"id":"d7a64b29.c2ae68","type":"switch","z":"d6879688.334818","name":"choose social type","property":"payload.socialType","propertyType":"msg","rules":[{"t":"eq","v":"firebase","vt":"str"},{"t":"eq","v":"line","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":140.5,"y":735,"wires":[["fe8705d2.06cd78"],["431508f3.78d4d8"]]},{"id":"106a217f.6846ff","type":"http in","z":"84c55f2c.56d0e","name":"","url":"/socialUpdate","method":"post","upload":false,"swaggerDoc":"","x":125,"y":637,"wires":[["f632cf.37889d3","9775bef.b24404"]]},{"id":"5a67400.8304fc","type":"function","z":"84c55f2c.56d0e","name":"check login history","func":"let actInfo = msg.payload\nlet sqlStr = ' SELECT * FROM api_login_history WHERE  history_logout_time IS NULL AND usertoken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg","outputs":1,"noerr":0,"x":125.5,"y":414,"wires":[["a0334f1.d670ab"]]},{"id":"5961429a.00d4ac","type":"switch","z":"84c55f2c.56d0e","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":80,"y":310,"wires":[["a23d340c.dc1608"],["61c9d03.5cabc3"]]},{"id":"f632cf.37889d3","type":"switch","z":"84c55f2c.56d0e","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":105.5,"y":569,"wires":[["d5b47791.0e0258"],["515046df.08df88"]]},{"id":"515046df.08df88","type":"function","z":"84c55f2c.56d0e","name":"set missing para","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'missing parameters'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":392,"y":574,"wires":[["f5520949.f35928"]]},{"id":"f5520949.f35928","type":"http response","z":"84c55f2c.56d0e","name":"","statusCode":"","headers":{},"x":1216,"y":508,"wires":[]},{"id":"a23d340c.dc1608","type":"function","z":"84c55f2c.56d0e","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":131.5,"y":255,"wires":[["1c6e6576.6f88bb"]]},{"id":"b324004a.6e672","type":"switch","z":"84c55f2c.56d0e","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":128.5,"y":135,"wires":[["3be98e4b.e810f2","f9f354da.eda708"],["ea9800bf.56f6d"]]},{"id":"61c9d03.5cabc3","type":"function","z":"84c55f2c.56d0e","name":"set logout","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'User already logout'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":380,"y":320,"wires":[["f5520949.f35928"]]},{"id":"ea9800bf.56f6d","type":"function","z":"84c55f2c.56d0e","name":"set token expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":410,"y":160,"wires":[["f5520949.f35928"]]},{"id":"14b2f9f1.577166","type":"function","z":"84c55f2c.56d0e","name":"set existing user","func":"let actInfo = msg['actInfo']\n\nlet result = msg.payload.split(':')\nif (result && result.length > 2) {\n    msg[\"existingUserId\"] = result[2]\n}\n\nlet newPayload = {\n    firebase: {\n        type: \"\",\n        query: actInfo.socialId\n    }\n}\n\nmsg.payload = newPayload\n\nreturn msg","outputs":1,"noerr":0,"x":550,"y":60,"wires":[["8da4c0a3.41605"]]},{"id":"9775bef.b24404","type":"debug","z":"84c55f2c.56d0e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":364,"y":636,"wires":[]},{"id":"d5b47791.0e0258","type":"switch","z":"84c55f2c.56d0e","name":"check social id","property":"payload.socialId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":113,"y":512,"wires":[["af695dcd.45585"],["515046df.08df88"]]},{"id":"8da4c0a3.41605","type":"firebase-auth-get-user","z":"84c55f2c.56d0e","name":"","queryType":"uid","queryValue":"","admin":"b6853919.862288","x":783,"y":63,"wires":[["ccbdcaa.a9c3838"]]},{"id":"ccbdcaa.a9c3838","type":"switch","z":"84c55f2c.56d0e","name":"check providerData","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":110,"wires":[["3ceb2e8a.a49c82"],["74d00dec.09d294"]]},{"id":"74d00dec.09d294","type":"function","z":"84c55f2c.56d0e","name":"set missing para","func":"let newPayload = {}\nnewPayload['responseCode'] = 999\nnewPayload['responseMsg'] = 'social account not found'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":921,"y":219,"wires":[["f5520949.f35928"]]},{"id":"3ceb2e8a.a49c82","type":"function","z":"84c55f2c.56d0e","name":"update social account","func":"let socialUid      = msg.payload.providerData[0].uid\nlet socialProvider = msg.payload.providerData[0].providerId\nlet existingUserId = msg['existingUserId']\n\nlet sqlStr = `INSERT INTO cloudb_dev.api_user_social_mapping (userId, socialType, socialId, createTime, createUser)\nSELECT * FROM (SELECT ${existingUserId} AS userId, '${socialProvider}', '${socialUid}', current_time(), ${existingUserId} AS createUser) AS tmp\nWHERE  NOT EXISTS (SELECT mappingId \n                   FROM   cloudb_dev.api_user_social_mapping\n                   WHERE  socialType = '${socialProvider}' AND socialId = '${socialUid}')`\n                   \nif (msg.req.method === 'DELETE') {\n    sqlStr = `DELETE FROM cloudb_dev.api_user_social_mapping WHERE userId = ${existingUserId} AND socialType = '${socialProvider}' AND socialId = '${socialUid}'`\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\n\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg;","outputs":1,"noerr":0,"x":1058.5,"y":126,"wires":[["72fa97dd.7b5658","e9b3512a.d0f8d"]]},{"id":"923f47ea.8fae38","type":"switch","z":"84c55f2c.56d0e","name":"","property":"payload.affectedRows","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1210,"y":170,"wires":[["f00f1a09.4222b8"],["66a93f5f.3eb75"]]},{"id":"66a93f5f.3eb75","type":"function","z":"84c55f2c.56d0e","name":"set update failed","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'social account update failed'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1209,"y":264,"wires":[["f5520949.f35928"]]},{"id":"f00f1a09.4222b8","type":"function","z":"84c55f2c.56d0e","name":"set update successfully","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'social account update successfully'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1224,"y":220,"wires":[["f5520949.f35928"]]},{"id":"6c82ebf4.dc88a4","type":"http in","z":"84c55f2c.56d0e","name":"","url":"/socialUpdate","method":"delete","upload":false,"swaggerDoc":"","x":137,"y":708,"wires":[["9775bef.b24404","f632cf.37889d3"]]},{"id":"72fa97dd.7b5658","type":"debug","z":"84c55f2c.56d0e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"actInfo","x":1256.5,"y":34,"wires":[]},{"id":"3be98e4b.e810f2","type":"debug","z":"84c55f2c.56d0e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"actInfo","x":100,"y":70,"wires":[]},{"id":"af695dcd.45585","type":"switch","z":"84c55f2c.56d0e","name":"check social type","property":"payload.socialType","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":125,"y":460,"wires":[["5a67400.8304fc"],["515046df.08df88"]]},{"id":"f9f354da.eda708","type":"switch","z":"84c55f2c.56d0e","name":"","property":"actInfo.socialType","propertyType":"msg","rules":[{"t":"eq","v":"firebase","vt":"str"},{"t":"eq","v":"line","vt":"str"},{"t":"eq","v":"google.com","vt":"str"},{"t":"eq","v":"facebook.com","vt":"str"},{"t":"eq","v":"twitter.com","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":370.5,"y":93,"wires":[["14b2f9f1.577166"],["ad73e062.d50c5"],["ad73e062.d50c5"],["ad73e062.d50c5"],["ad73e062.d50c5"]]},{"id":"5a4f1831.a711f8","type":"subflow:d829b1e4.26b7d","z":"7a3748cb.a6fe98","name":"","x":170,"y":700,"wires":[["95d74124.9f137"]]},{"id":"b45ecd8d.9c536","type":"subflow:d829b1e4.26b7d","z":"7a3748cb.a6fe98","name":"","x":170,"y":600,"wires":[["669b0143.981d4"]]},{"id":"1f6ec733.c1e0c9","type":"subflow:d829b1e4.26b7d","z":"7a3748cb.a6fe98","name":"","x":170,"y":500,"wires":[["c008ea89.340e28"]]},{"id":"2ad33cf9.64f2b4","type":"subflow:42cc5e2a.1f178","z":"7a3748cb.a6fe98","name":"","x":170,"y":400,"wires":[["22631a65.98bb36"]]},{"id":"94b1087.2d1b7f8","type":"subflow:42cc5e2a.1f178","z":"7a3748cb.a6fe98","name":"","x":170,"y":240,"wires":[["d874530b.1cc4a"]]},{"id":"dbaa6ae5.51a268","type":"subflow:42cc5e2a.1f178","z":"7a3748cb.a6fe98","name":"","x":670,"y":100,"wires":[["9ae32cd3.c4932","c64d15f9.c643a8"]]},{"id":"8d660fa5.0cad6","type":"subflow:42cc5e2a.1f178","z":"d6879688.334818","name":"","x":140,"y":500,"wires":[["14ea1c35.6ff004"]]},{"id":"e56d0aa7.993878","type":"subflow:42cc5e2a.1f178","z":"d6879688.334818","name":"","x":140,"y":360,"wires":[["c926eef0.356d5"]]},{"id":"178dfe49.0b1e72","type":"subflow:42cc5e2a.1f178","z":"d6879688.334818","name":"","x":390,"y":40,"wires":[["27ad0248.987a2e"]]},{"id":"5b63bf80.49eaa","type":"subflow:42cc5e2a.1f178","z":"d6879688.334818","name":"","x":380,"y":120,"wires":[["4f4e4238.28a80c"]]},{"id":"1c6e6576.6f88bb","type":"subflow:47f0f2eb.a3493c","z":"84c55f2c.56d0e","name":"","x":120,"y":200,"wires":[["b324004a.6e672"]]},{"id":"a0334f1.d670ab","type":"subflow:42cc5e2a.1f178","z":"84c55f2c.56d0e","name":"","x":100,"y":360,"wires":[["5961429a.00d4ac"]]},{"id":"e9b3512a.d0f8d","type":"subflow:42cc5e2a.1f178","z":"84c55f2c.56d0e","name":"","x":1030,"y":170,"wires":[["923f47ea.8fae38"]]},{"id":"431508f3.78d4d8","type":"function","z":"d6879688.334818","name":"set user data to flow","func":"let ip = msg.req.get(\"x-client-ip\")\nif(ip !== undefined && ip.indexOf(\",\") != -1){\n    let ar = ip.split(',')\n    ip = ar[0]\n}else{\n  ip = msg.req.connection.remoteAddress\n}\nmsg.payload['ip'] = ip\nmsg.payload['cp'] = msg.req.params.cp\nmsg.payload['type'] = 0\nmsg['userInfo'] = msg.payload\nmsg.payload = msg.payload.pwd\nreturn msg","outputs":1,"noerr":0,"x":410,"y":780,"wires":[["3a32e118.71937e"]]},{"id":"3a32e118.71937e","type":"function","z":"d6879688.334818","name":"set user query","func":"let socialUid      = msg['userInfo'].socialId\nlet socialProvider = msg['userInfo'].socialType\nlet cp             = msg.req.params.cp\n\nlet sqlStr = \n`SELECT usr.*, \n       r.rolename, \n       r.dataset \nFROM   ((SELECT * \n        FROM   api_user \n        WHERE  userblock = 0 \n               AND cpid = (SELECT cpid \n                           FROM   api_cp \n                           WHERE  cpname = \"${cp}\") \n               AND userid = (SELECT userid \n                             FROM   api_user_social_mapping \n                             WHERE  socialtype = \"${socialProvider}\" \n                                    AND socialid = \"${socialUid}\")) AS usr \n        LEFT JOIN api_role AS r \n               ON usr.roleid = r.roleid)`\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":640,"y":780,"wires":[["8d660fa5.0cad6"]]},{"id":"9ae32cd3.c4932","type":"debug","z":"7a3748cb.a6fe98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":890,"y":90,"wires":[]},{"id":"c64d15f9.c643a8","type":"function","z":"7a3748cb.a6fe98","name":"Keep Insert User Result","func":"let actInfo = msg['actInfo']\n\nmsg[\"insertUserResult\"] = msg.payload;\n\nif (actInfo.socialType && actInfo.socialId) {\n    msg.payload = true;\n} else {\n    msg.payload = false;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":170,"wires":[["d9a927a5.e0afd8"]]},{"id":"d9a927a5.e0afd8","type":"switch","z":"7a3748cb.a6fe98","name":"Social Update?","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":170,"wires":[["dc9be586.7744a8"],["11330413.e3b63c"]]},{"id":"dc9be586.7744a8","type":"switch","z":"7a3748cb.a6fe98","name":"Check Social Type","property":"actInfo.socialType","propertyType":"msg","rules":[{"t":"eq","v":"firebase","vt":"str"},{"t":"eq","v":"line","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1000,"y":170,"wires":[["5b8e89eb.6b2cc8"],["dfd0d39e.00495"],["11330413.e3b63c"]]},{"id":"dfd0d39e.00495","type":"function","z":"7a3748cb.a6fe98","name":"Prepare SQL","func":"let actInfo = msg[\"actInfo\"]\nlet insertUserResult = msg[\"insertUserResult\"]\n\nlet lastInsertId = insertUserResult[1][0].last_insert_id\n\nvar sqlStr = \"SELECT 1\"\n\nif (lastInsertId) {\n    sqlStr = `\n    INSERT INTO cloudb_dev.api_user_social_mapping\n    (userId,\n    socialType,\n    socialId,\n    createTime,\n    createUser)\n    VALUES\n    (${lastInsertId},\n    '${actInfo.socialType}',\n    '${actInfo.socialId}',\n    CURRENT_TIME(),\n    ${lastInsertId});\n    `\n}\n\nnode.warn(sqlStr)\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nreturn msg\n\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":230,"wires":[["2fb13f83.50482"]]},{"id":"2fb13f83.50482","type":"subflow:42cc5e2a.1f178","z":"7a3748cb.a6fe98","name":"","x":980,"y":290,"wires":[["11330413.e3b63c"]]},{"id":"5b8e89eb.6b2cc8","type":"function","z":"7a3748cb.a6fe98","name":"","func":"let actInfo = msg[\"actInfo\"]\n\nmsg.payload = {\n    firebase: {\n        type: \"\",\n        query: actInfo.socialId\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1240,"y":160,"wires":[["c0082ffc.40948"]]},{"id":"c0082ffc.40948","type":"firebase-auth-get-user","z":"7a3748cb.a6fe98","name":"","queryType":"uid","queryValue":"","admin":"b6853919.862288","x":1420,"y":160,"wires":[["e7eda85d.467248","9ae32cd3.c4932"]]},{"id":"e7eda85d.467248","type":"switch","z":"7a3748cb.a6fe98","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":1390,"y":220,"wires":[["b264523.de3a1b"],["11330413.e3b63c"]]},{"id":"b264523.de3a1b","type":"function","z":"7a3748cb.a6fe98","name":"Prepare SQL","func":"let socialUid      = msg.payload.providerData[0].uid\nlet socialProvider = msg.payload.providerData[0].providerId\n\nlet insertUserResult = msg[\"insertUserResult\"]\nlet lastInsertId = insertUserResult[1][0].last_insert_id\n\nvar sqlStr = \"SELECT 1\"\n\nif (lastInsertId) {\n    sqlStr = `\n    INSERT INTO cloudb_dev.api_user_social_mapping\n    (userId,\n    socialType,\n    socialId,\n    createTime,\n    createUser)\n    VALUES\n    (${lastInsertId},\n    '${socialProvider}',\n    '${socialUid}',\n    CURRENT_TIME(),\n    ${lastInsertId});\n    `\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\n\nreturn msg\n\nfunction getRandomNumber(quantity_of_nums) {\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":1410,"y":290,"wires":[["2fb13f83.50482"]]},{"id":"52b9f0ed.c10f6","type":"http in","z":"bfabdc2e.53fdf","name":"","url":"/socialList","method":"post","upload":false,"swaggerDoc":"","x":140,"y":620,"wires":[["a8846814.d955c8","fc7035b.2f87fc8"]]},{"id":"6ae0da1.6ec6d24","type":"function","z":"bfabdc2e.53fdf","name":"check login history","func":"let actInfo = msg.payload\nlet sqlStr = ' SELECT * FROM api_login_history WHERE  history_logout_time IS NULL AND usertoken = \"' + actInfo.token+ '\" '\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\nmsg['actInfo'] = actInfo\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg","outputs":1,"noerr":0,"x":140,"y":400,"wires":[["da662dff.db874"]]},{"id":"a46ad9e1.55b268","type":"switch","z":"bfabdc2e.53fdf","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":105,"y":293,"wires":[["e98a9de9.8f582"],["733f463d.d3add8"]]},{"id":"a8846814.d955c8","type":"switch","z":"bfabdc2e.53fdf","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":130.5,"y":552,"wires":[["6ae0da1.6ec6d24"],["a5423353.b3c7c"]]},{"id":"a5423353.b3c7c","type":"function","z":"bfabdc2e.53fdf","name":"set missing para","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'missing parameters'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":417,"y":557,"wires":[["b874d16b.aca4f"]]},{"id":"b874d16b.aca4f","type":"http response","z":"bfabdc2e.53fdf","name":"","statusCode":"","headers":{},"x":800,"y":410,"wires":[]},{"id":"e98a9de9.8f582","type":"function","z":"bfabdc2e.53fdf","name":"set token to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.token)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":156.5,"y":238,"wires":[["8689c8f9.3b2918"]]},{"id":"84169bac.4de938","type":"switch","z":"bfabdc2e.53fdf","name":"check token expired","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":153.5,"y":118,"wires":[["372e6a2e.bcd826","728523b6.ae912c"],["f4f6c007.c9d57"]]},{"id":"733f463d.d3add8","type":"function","z":"bfabdc2e.53fdf","name":"set logout","func":"let newPayload = {}\nnewPayload['responseCode'] = 404\nnewPayload['responseMsg'] = 'User already logout'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":405,"y":303,"wires":[["b874d16b.aca4f"]]},{"id":"f4f6c007.c9d57","type":"function","z":"bfabdc2e.53fdf","name":"set token expired","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Token expired'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":434.5,"y":124,"wires":[["b874d16b.aca4f"]]},{"id":"fc7035b.2f87fc8","type":"debug","z":"bfabdc2e.53fdf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":389,"y":619,"wires":[]},{"id":"7d14336c.31681c","type":"function","z":"bfabdc2e.53fdf","name":"set update successfully","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'get social account list successfully'\nnewPayload['socialInfo'] = msg.payload\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":850,"y":170,"wires":[["b874d16b.aca4f"]]},{"id":"b93264b9.c73db8","type":"debug","z":"bfabdc2e.53fdf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"existingUserId","targetType":"msg","x":830,"y":70,"wires":[]},{"id":"372e6a2e.bcd826","type":"debug","z":"bfabdc2e.53fdf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"actInfo","x":125,"y":53,"wires":[]},{"id":"da662dff.db874","type":"subflow:42cc5e2a.1f178","z":"bfabdc2e.53fdf","name":"","x":120,"y":350,"wires":[["a46ad9e1.55b268"]]},{"id":"8689c8f9.3b2918","type":"subflow:47f0f2eb.a3493c","z":"bfabdc2e.53fdf","name":"","x":130,"y":180,"wires":[["84169bac.4de938"]]},{"id":"4f990f81.b25f8","type":"subflow:42cc5e2a.1f178","z":"bfabdc2e.53fdf","name":"","x":810,"y":120,"wires":[["7d14336c.31681c"]]},{"id":"728523b6.ae912c","type":"function","z":"bfabdc2e.53fdf","name":"prepare SQL for social list","func":"let actInfo = msg['actInfo']\n\nlet result = msg.payload.split(':')\nif (result && result.length > 2) {\n    msg[\"existingUserId\"] = result[2]\n}\n\nlet existingUserId = msg['existingUserId']\n\nlet sqlStr = `SELECT socialType,\n    socialId\nFROM api_user_social_mapping\nWHERE userId = ${existingUserId};`\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\n\nreturn msg;\n\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\n\n\n\n\nreturn msg","outputs":1,"noerr":0,"x":450,"y":70,"wires":[["4f990f81.b25f8","b93264b9.c73db8"]]},{"id":"ad73e062.d50c5","type":"function","z":"84c55f2c.56d0e","name":"update social account","func":"let actInfo = msg['actInfo']\n\nlet result = msg.payload.split(':')\nif (result && result.length > 2) {\n    msg[\"existingUserId\"] = result[2]\n}\n\nlet socialUid      = actInfo.socialId\nlet socialProvider = actInfo.socialType\nlet existingUserId = msg['existingUserId']\n\nlet sqlStr = `INSERT INTO cloudb_dev.api_user_social_mapping (userId, socialType, socialId, createTime, createUser)\nSELECT * FROM (SELECT ${existingUserId} AS userId, '${socialProvider}', '${socialUid}', current_time(), ${existingUserId} AS createUser) AS tmp\nWHERE  NOT EXISTS (SELECT mappingId \n                   FROM   cloudb_dev.api_user_social_mapping\n                   WHERE  socialType = '${socialProvider}' AND socialId = '${socialUid}')`\n                   \nif (msg.req.method === 'DELETE') {\n    sqlStr = `DELETE FROM cloudb_dev.api_user_social_mapping WHERE userId = ${existingUserId} AND socialType = '${socialProvider}' AND socialId = '${socialUid}'`\n}\n\nmsg['flow'] = getRandomNumber(10)\nmsg['topic'] = sqlStr\n\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":120,"wires":[["e9b3512a.d0f8d"]]}]
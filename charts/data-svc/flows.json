[{"id":"202da31a.94aadc","type":"tab","label":"Raw Data Flow","disabled":false,"info":""},{"id":"68e5277d.892928","type":"tab","label":"Track Flow","disabled":false,"info":""},{"id":"3873e5c5.abbcfa","type":"tab","label":"Event Flow","disabled":false,"info":""},{"id":"3ef324cd.c7c25c","type":"tab","label":"Rule Flow","disabled":false,"info":""},{"id":"5ba94578.282c1c","type":"tab","label":"Report Data Flow","disabled":false,"info":""},{"id":"b6dc1740.a5a938","type":"tab","label":"ShowField Flow","disabled":false,"info":""},{"id":"efffc1d0.4735d8","type":"subflow","name":"Redis get flow","info":"","in":[{"x":65,"y":79,"wires":[{"id":"5fa5d27.3f2d6ac"}]}],"out":[{"x":567,"y":86,"wires":[{"id":"6bea8938.88bad","port":0},{"id":"f92ff476.a92b88","port":0},{"id":"cc1a031d.d3e27","port":0}]}]},{"id":"8db62750.88d568","type":"subflow","name":"Tag flow","info":"","in":[{"x":90.9999885559082,"y":368.6666946411133,"wires":[{"id":"7945a941.39ce78"}]}],"out":[{"x":1080.9999656677246,"y":162.00002670288086,"wires":[{"id":"def38df7.b3798","port":0},{"id":"7bac07b1.2b1648","port":0}]}]},{"id":"7bc1586f.fd2988","type":"subflow","name":"mes-svc update Flow","info":"","in":[{"x":102,"y":169,"wires":[{"id":"3c9dd98f.45c906"}]}],"out":[{"x":667,"y":169,"wires":[{"id":"26b8d337.ff2f0c","port":0}]}]},{"id":"3a7f9ba4.31ba74","type":"subflow","name":"mes check flow","info":"","category":"","in":[{"x":120,"y":120,"wires":[{"id":"7c95a86d.0bc3d8"}]}],"out":[{"x":1360,"y":120,"wires":[{"id":"97112fd5.eadf2","port":0},{"id":"421c636a.3ee44c","port":0}]}],"env":[]},{"id":"610f0de2.4586f4","type":"subflow","name":"Downlink flow","info":"","category":"","in":[{"x":140,"y":220,"wires":[{"id":"3e1d3107.ee979e"}]}],"out":[],"env":[]},{"id":"1cdbd27a.5a97ee","type":"redis-config","z":"efffc1d0.4735d8","host":"redis-svr","port":"6379","dbase":"0","pass":"gemtek123"},{"id":"b697289e.173a9","type":"redis-config","z":"efffc1d0.4735d8","host":"redis-svr","port":"6379","dbase":"0","pass":"gemtek123"},{"id":"f9ed3ab1.0debf8","type":"mongodb","z":"","hostname":"mongodb","port":"27017","db":"argi_dev","name":""},{"id":"faa8fb6d.20bf28","type":"mqtt-broker","z":"","name":"","broker":"mqtt-svc","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"19a90d83.2e7202","type":"http in","z":"202da31a.94aadc","name":"","url":"/:db/event","method":"post","upload":false,"swaggerDoc":"","x":118.5,"y":381,"wires":[["dc10cae7.85e4c8","52fb82b9.7d461c"]]},{"id":"f2b3ad09.d7f988","type":"function","z":"202da31a.94aadc","name":"set db type","func":"msg.payload['db'] = msg.req.params.db\nmsg['db'] = msg.req.params.db\nmsg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":119.5,"y":294,"wires":[["c510da3a.1e48f"]]},{"id":"dc10cae7.85e4c8","type":"switch","z":"202da31a.94aadc","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":119.5,"y":337.00000381469727,"wires":[["f2b3ad09.d7f988"],["ba5107b3.ae8fd"]]},{"id":"ba5107b3.ae8fd","type":"function","z":"202da31a.94aadc","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'missing data'\nnewPayload['responseCode'] = '404'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":421.5,"y":346,"wires":[["c1be0257.68ff4"]]},{"id":"c1be0257.68ff4","type":"http response","z":"202da31a.94aadc","name":"","statusCode":"","headers":{},"x":1117.5,"y":240,"wires":[]},{"id":"5fa5d27.3f2d6ac","type":"switch","z":"efffc1d0.4735d8","name":"lbs","property":"flow","propertyType":"msg","rules":[{"t":"gte","v":"5","vt":"str"},{"t":"lt","v":"5","vt":"str"}],"checkall":"true","outputs":2,"x":270.5,"y":77,"wires":[["6bea8938.88bad"],["f92ff476.a92b88"]]},{"id":"6bea8938.88bad","type":"redis-command","z":"efffc1d0.4735d8","server":"1cdbd27a.5a97ee","command":"get","name":"redis_23","topic":"","x":412.5,"y":51,"wires":[[]]},{"id":"f92ff476.a92b88","type":"redis-command","z":"efffc1d0.4735d8","server":"b697289e.173a9","command":"get","name":"redis_22","topic":"","x":422,"y":104,"wires":[[]]},{"id":"e0e9f.d08f5161","type":"catch","z":"efffc1d0.4735d8","name":"","scope":["f92ff476.a92b88","6bea8938.88bad"],"x":99.5,"y":242,"wires":[["cc1a031d.d3e27"]]},{"id":"cc1a031d.d3e27","type":"function","z":"efffc1d0.4735d8","name":"set null to payload","func":"msg.payload = null\nreturn msg","outputs":1,"noerr":0,"x":317.5,"y":240,"wires":[[]]},{"id":"c510da3a.1e48f","type":"function","z":"202da31a.94aadc","name":"set macAddr to payload","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet newPayload = []\nlet mac = actInfo.data.macAddr\nif(mac.indexOf('_') !== -1){\n  let macArray = mac.split('_')\n  mac = macArray[0]\n}\nnewPayload.push(mac)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":147.5,"y":254,"wires":[["cd94f4df.0e644"]]},{"id":"cd94f4df.0e644","type":"subflow:efffc1d0.4735d8","z":"202da31a.94aadc","x":143.5,"y":212,"wires":[["6442bc4b.ddbe24"]]},{"id":"6442bc4b.ddbe24","type":"switch","z":"202da31a.94aadc","name":"check macAddr exist","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":155.5,"y":163,"wires":[["704b21f8.7eea08"],["8e09f8e.6afdf88"]]},{"id":"8e09f8e.6afdf88","type":"function","z":"202da31a.94aadc","name":"set expired result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'MacAddr not exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":443.5,"y":254,"wires":[["c1be0257.68ff4"]]},{"id":"704b21f8.7eea08","type":"switch","z":"202da31a.94aadc","name":"check db type","property":"db","propertyType":"msg","rules":[{"t":"eq","v":"cloudant","vt":"str"},{"t":"eq","v":"mongo","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":155.5,"y":102,"wires":[["d51931b.65a3bd"],["be123e80.24c038"]]},{"id":"bb55a066.ebc66","type":"mongodb out","z":"202da31a.94aadc","mongodb":"f9ed3ab1.0debf8","name":"save to mongo","collection":"devices","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1080,"y":80,"wires":[]},{"id":"be123e80.24c038","type":"function","z":"202da31a.94aadc","name":"set data to save","func":"let obj = msg['actInfo']\nlet newPayload = {}\nlet id = obj.data.extra.fport+'_'+obj.data.extra.frameCnt+'_'+obj.data.macAddr+'_'+obj.data.timestamp\nobj.data['recv'] = new Date(obj.data['recv'])\nnewPayload = obj['data']\nnewPayload['_id'] = id\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":780,"y":100,"wires":[["bb55a066.ebc66","bf52ce15.16282","c25d0cad.0e84"]]},{"id":"bf52ce15.16282","type":"function","z":"202da31a.94aadc","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'Insert success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1024,"y":132,"wires":[["c1be0257.68ff4"]]},{"id":"d51931b.65a3bd","type":"function","z":"202da31a.94aadc","name":"set expired result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Developing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":440,"y":52.00000190734863,"wires":[["d4405d38.20fe1"]]},{"id":"d4405d38.20fe1","type":"http response","z":"202da31a.94aadc","name":"","statusCode":"","headers":{},"x":715,"y":38,"wires":[]},{"id":"e0d22642.b2d6d8","type":"http in","z":"68e5277d.892928","name":"","url":"/track","method":"post","upload":false,"swaggerDoc":"","x":178.4286003112793,"y":1250.095314025879,"wires":[["15c3a4e0.35b30b","b2089db1.0f7f3"]]},{"id":"f8d107fb.f9e908","type":"switch","z":"68e5277d.892928","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":178.42860412597656,"y":1169.0952777862549,"wires":[["16f3efb4.ac8eb"],["32d4b7c7.1b87e8"]]},{"id":"16f3efb4.ac8eb","type":"function","z":"68e5277d.892928","name":"set data to flow","func":"msg['actInfo'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":182.42860412597656,"y":1126.0952777862549,"wires":[["d0e6b7cc.b5b8c8"]]},{"id":"32d4b7c7.1b87e8","type":"function","z":"68e5277d.892928","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'missing data'\nnewPayload['responseCode'] = '404'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":493.80953216552734,"y":1195.2855577468872,"wires":[["bfdcbb42.b91d48"]]},{"id":"bfdcbb42.b91d48","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1142.333251953125,"y":1159.9998779296875,"wires":[]},{"id":"683d4b50.d13194","type":"function","z":"68e5277d.892928","name":"set expired result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'MacAddr not exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":766.2856750488281,"y":1010.1428833007812,"wires":[["bfdcbb42.b91d48"]]},{"id":"fcd99ca6.99746","type":"function","z":"68e5277d.892928","name":"set macAddr to payload","func":"let actInfo = msg['actInfo']\nlet newPayload = []\nnewPayload.push(actInfo.data.macAddr)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":515.4285888671875,"y":1035.0953369140625,"wires":[["78a00444.deff0c"]]},{"id":"78a00444.deff0c","type":"subflow:efffc1d0.4735d8","z":"68e5277d.892928","x":507.4285888671875,"y":995.0953369140625,"wires":[["84af0013.5d6bd"]]},{"id":"84af0013.5d6bd","type":"switch","z":"68e5277d.892928","name":"check macAddr exist","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":497.4285888671875,"y":958.0952758789062,"wires":[[],["683d4b50.d13194"]]},{"id":"92941f07.b3ccc","type":"function","z":"68e5277d.892928","name":"check tag and loc","func":"let actInfo = msg['actInfo']\nlet tagInfo = msg['tagInfo']\nlet newPayload = {}\nlet tagId = eval('/'+tagInfo.type+'_'+tagInfo.val+'/i')\nnewPayload['loc.macAddr'] = actInfo.data.macAddr\nnewPayload['tagId'] = tagId\nnewPayload['out'] = 'NA'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":180.99998474121094,"y":195.33332443237305,"wires":[["51294ebe.db913"]]},{"id":"51294ebe.db913","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find track","collection":"track","operation":"find","x":162,"y":131.99998474121094,"wires":[["bd4993c2.c5291"]]},{"id":"bd4993c2.c5291","type":"switch","z":"68e5277d.892928","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":159,"y":79,"wires":[["1232c05f.451ba"],["4fa35674.26c878"]]},{"id":"26fafb8b.91aab4","type":"function","z":"68e5277d.892928","name":"set data to insert","func":"let actInfo = msg['actInfo']\nlet tagInfo = msg['tagInfo']\nlet extraArray = msg['extra']\nlet newPayload = {}\nlet tags = {}\nlet loc = {}\nloc['macAddr'] = actInfo.data.macAddr\nloc['name'] = msg['macName']\nloc['meta'] = msg['meta']\nnewPayload['loc'] = loc\nlet tag_id = tagInfo.type+'_'+tagInfo.val+'_'+actInfo.data['timestamp']\nnewPayload['_id'] = tag_id\nnewPayload['tagId'] = tag_id\nnewPayload['in'] = actInfo.data['date']\nnewPayload['in_ts'] = new Date(actInfo.data['recv'])\nnewPayload['out'] = 'NA'\nnewPayload['showFlg'] = msg['showFlg']\nif(extraArray !== undefined){\n  let exObj = {}\n  for(let i = 0 ; i < extraArray.length ; i++){\n    let ex = extraArray[i]\n    let key = ex['field']\n    let dep = ex['depend']\n    if(dep.indexOf(tagInfo.type+'') != -1){\n      ex['append'].forEach(function(element) {\n        if(ex[element] !== undefined)\n          exObj[element] = ex[element]\n      })\n      exObj[key] = ex.val\n    }\n  }\n  newPayload['extra'] = exObj\n}\nif(msg['extraObj'] !== undefined){\n  let extraObj = msg['extraObj']\n  let newExtra = newPayload['extra']\n  for (var key in extraObj) {\n    newExtra[key] = extraObj[key]\n  }\n  newPayload['extra'] = newExtra\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":880,"y":204,"wires":[["bb0920be.ef1f1","87a03165.019ce","1af7039e.91840c"]]},{"id":"bb0920be.ef1f1","type":"mongodb out","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"insert track","collection":"track","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1324,"y":60.666656494140625,"wires":[]},{"id":"1232c05f.451ba","type":"function","z":"68e5277d.892928","name":"set data duplicate","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'duplicate track'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":510,"y":40,"wires":[["988600d6.81416","80fce923.19d238"]]},{"id":"1af7039e.91840c","type":"function","z":"68e5277d.892928","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'Insert success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1359,"y":175,"wires":[["988600d6.81416","80fce923.19d238"]]},{"id":"ae1c30d2.babcf","type":"function","z":"68e5277d.892928","name":"set tag current loc search","func":"let actInfo = msg['actInfo']\nlet tagInfo = msg['tagInfo']\nlet newPayload = {}\nlet mac = {}\nlet tagId = eval('/'+tagInfo.type+'_'+tagInfo.val+'/i')\nmac['$ne'] = actInfo.data.macAddr\nnewPayload['loc.macAddr'] = mac\nnewPayload['tagId'] = tagId\nnewPayload['out'] = 'NA'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":194.0476531982422,"y":430.23812770843506,"wires":[["1b0b26d5.ea6b19"]]},{"id":"1b0b26d5.ea6b19","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find track current loc","collection":"track","operation":"find","x":188.23809814453125,"y":372.52386474609375,"wires":[["f101ed68.3511e"]]},{"id":"f101ed68.3511e","type":"function","z":"68e5277d.892928","name":"set out_ts to update","func":"let queryTsFlg = false\nif(msg.payload.length > 0){\n  let updateObj = msg.payload[0]\n  let actInfo = msg['actInfo']\n  updateObj['out'] = actInfo.data.date\n  updateObj['out_ts'] = new Date(actInfo.data.recv)\n  msg.payload = updateObj\n  queryTsFlg = true\n  msg['scaleSt'] = updateObj['in_ts']\n}\nmsg['queryTsFlg'] = queryTsFlg\nreturn msg","outputs":1,"noerr":0,"x":431.6665954589844,"y":366.0000305175781,"wires":[["e4650f9f.19e62","e0753f52.6cc8a"]]},{"id":"e4650f9f.19e62","type":"mongodb out","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"upadte out time","collection":"track","payonly":true,"upsert":false,"multi":true,"operation":"store","x":810,"y":308.3332824707031,"wires":[]},{"id":"2536d01e.6283c","type":"http in","z":"68e5277d.892928","name":"","url":"/:type/:id/track","method":"get","upload":false,"swaggerDoc":"","x":194.09521484375,"y":1776.7618408203125,"wires":[["7730944c.2f37ac"]]},{"id":"7730944c.2f37ac","type":"switch","z":"68e5277d.892928","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":189.0952262878418,"y":1738.7618408203125,"wires":[["c905477f.706df8"],["8f33d376.66d2c"]]},{"id":"8f33d376.66d2c","type":"function","z":"68e5277d.892928","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":490.0952339172363,"y":1717.4285373687744,"wires":[["e8c1251e.d52b18"]]},{"id":"e8c1251e.d52b18","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":787.09521484375,"y":1612.7618598937988,"wires":[]},{"id":"c905477f.706df8","type":"function","z":"68e5277d.892928","name":"set para to obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg.payload['tagId'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['tagType'] = msg.req.params.type\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":194.0952262878418,"y":1683.7618408203125,"wires":[["fcebccea.d5591"]]},{"id":"be475d14.1a3de","type":"switch","z":"68e5277d.892928","name":"check isTag","property":"isTag","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":194.09523010253906,"y":1333.4285888671875,"wires":[["747bac73.ba3fd4"],["64ee88ef.1c15a8"]]},{"id":"fed15311.82234","type":"http in","z":"68e5277d.892928","name":"","url":"/:type/:id/trackCnt","method":"get","upload":false,"swaggerDoc":"","x":200.1905059814453,"y":2486.666259765625,"wires":[["5fef3237.b7413c"]]},{"id":"5fef3237.b7413c","type":"switch","z":"68e5277d.892928","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":204.1905059814453,"y":2434.666259765625,"wires":[["d96fdcae.6fde"],["c47402ac.b6eb1"]]},{"id":"c47402ac.b6eb1","type":"function","z":"68e5277d.892928","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":468.19049072265625,"y":2422.666259765625,"wires":[["254dc77c.732028"]]},{"id":"254dc77c.732028","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":738.8571739196777,"y":2264.000005722046,"wires":[]},{"id":"d96fdcae.6fde","type":"function","z":"68e5277d.892928","name":"set para to obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg.payload['tagId'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['tagType'] = msg.req.params.type\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":202.1905059814453,"y":2388.666259765625,"wires":[["ca6a2843.e401c8"]]},{"id":"1633a5da.e4f61a","type":"switch","z":"68e5277d.892928","name":"check isTag","property":"isTag","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":164.85717010498047,"y":1997.9999561309814,"wires":[["adca62c8.b2dce"],["4d0bed14.77dce4"]]},{"id":"adca62c8.b2dce","type":"function","z":"68e5277d.892928","name":"set loc cnt","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet matchType = {}\nlet matchArray = []\nlet loc = 'loc.'\nif(obj.tagType != 'macAddr'){\n  loc += 'meta.'\n  matchType[loc+obj.tagType+'.val'] = obj.tagId\n}else{\n  matchType[loc+obj.tagType] = obj.tagId\n}\nmatchArray.push(matchType)\nif(obj.showFlg !== undefined){\n  let matchShow = {}\n  matchShow['showFlg'] = parseInt(obj.showFlg)\n  matchArray.push(matchShow)\n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  let outCond = {}\n  let inCond = {}\n  let orCond = {}\n  let orArray = []\n  dateCond['$gte'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  inCond['in_ts'] = dateCond\n  outCond['out_ts'] = dateCond\n  orArray.push(inCond)\n  orArray.push(outCond)\n  orCond['$or'] = orArray\n  matchArray.push(orCond)\n}else{\n  let matchOut = {}  \n  matchOut['out'] = 'NA'    \n  matchArray.push(matchOut)\n}\nnewPayload['$and'] = matchArray\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":454.85717010498047,"y":1954.9999551773071,"wires":[["785bcfd6.f31","9a34d99.674ea28"]]},{"id":"785bcfd6.f31","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find grid","collection":"track","operation":"count","x":734.8571739196777,"y":1974.9999561309814,"wires":[["2ecfb8c1.1fcf48"]]},{"id":"2ecfb8c1.1fcf48","type":"function","z":"68e5277d.892928","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = msg.payload\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":910.8572044372559,"y":1974.0000038146973,"wires":[["c876d1ba.a0a35"]]},{"id":"c876d1ba.a0a35","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1086.7143363952637,"y":1970.8572311401367,"wires":[]},{"id":"4d0bed14.77dce4","type":"function","z":"68e5277d.892928","name":"set tag cnt","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet newPayload = {}\nlet tagId = eval('/'+actInfo.tagType+'_'+actInfo.tagId+'/i')\nlet matchId = {}\nlet matchArray = []\nmatchId['tagId'] = tagId\nmatchArray.push(matchId)\nif(actInfo.showFlg !== undefined){\n  let matchShow = {}\n  matchShow['showFlg'] = parseInt(actInfo.showFlg)\n  matchArray.push(matchShow)\n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  let outCond = {}\n  let inCond = {}\n  let orCond = {}\n  let orArray = []\n  dateCond['$gte'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  inCond['in_ts'] = dateCond\n  outCond['out_ts'] = dateCond\n  orArray.push(inCond)\n  orArray.push(outCond)\n  orCond['$or'] = orArray\n  matchArray.push(orCond)\n}\nnewPayload['$and'] = matchArray\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":462.85717010498047,"y":2007.9999561309814,"wires":[["785bcfd6.f31","8cf868b7.ac8438"]]},{"id":"8cf868b7.ac8438","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":723.8572235107422,"y":2038.000005722046,"wires":[]},{"id":"9a34d99.674ea28","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":718.8571491241455,"y":1933.4762058258057,"wires":[]},{"id":"747bac73.ba3fd4","type":"function","z":"68e5277d.892928","name":"set loc search","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet paginate = true\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet matchType = {}\nlet matchArray = []\nlet loc = 'loc.'\nif(obj.tagType != 'macAddr'){\n  loc += 'meta.'\n  matchType[loc+obj.tagType+'.val'] = obj.tagId\n}else{\n  matchType[loc+obj.tagType] = obj.tagId\n}\nmatchArray.push(matchType)\nif(obj.showFlg !== undefined){\n  let matchShow = {}\n  matchShow['showFlg'] = parseInt(obj.showFlg)\n  matchArray.push(matchShow)\n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  let outCond = {}\n  let inCond = {}\n  let orCond = {}\n  let orArray = []\n  dateCond['$gte'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  inCond['in_ts'] = dateCond\n  outCond['out_ts'] = dateCond\n  orArray.push(inCond)\n  orArray.push(outCond)\n  orCond['$or'] = orArray\n  matchArray.push(orCond)\n}else{\n  let matchOut = {}  \n  matchOut['out'] = 'NA'    \n  matchArray.push(matchOut)\n}\nlet sort = {}\nsort['in_ts'] = -1\nif(obj.sort && obj.sort == 'asc'){\n  sort['in_ts'] = 1\n}\nmsg['sort'] = sort\nnewPayload['$and'] = matchArray\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":441.09527587890625,"y":1317.2857666015625,"wires":[["11ec8008.e06da"]]},{"id":"64ee88ef.1c15a8","type":"function","z":"68e5277d.892928","name":"set tag search","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet tagId = eval('/' + obj.tagType + '_' + obj.tagId + '/i')\nlet paginate = true\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['in_ts'] = -1\nif(obj.sort && obj.sort == 'asc'){\n  sort['in_ts'] = 1\n}\nmsg['sort'] = sort\nlet matchId = {}\nlet matchArray = []\nmatchId['tagId'] = tagId\nmatchArray.push(matchId)\nif(obj.showFlg !== undefined){\n  let matchShow = {}\n  matchShow['showFlg'] = parseInt(obj.showFlg)\n  matchArray.push(matchShow)\n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  let outCond = {}\n  let inCond = {}\n  let orCond = {}\n  let orArray = []\n  dateCond['$gte'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  inCond['in_ts'] = dateCond\n  outCond['out_ts'] = dateCond\n  orArray.push(inCond)\n  orArray.push(outCond)\n  orCond['$or'] = orArray\n  matchArray.push(orCond)\n}\nnewPayload['$and'] = matchArray\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":455.0951843261719,"y":1414.4285888671875,"wires":[["11ec8008.e06da","92ae86be.6de948"]]},{"id":"11ec8008.e06da","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find grid","collection":"track","operation":"find","x":676.09521484375,"y":1361.761962890625,"wires":[["a14885e0.121ab8","92ae86be.6de948"]]},{"id":"a14885e0.121ab8","type":"switch","z":"68e5277d.892928","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":867.09521484375,"y":1362.761962890625,"wires":[["4840b8e1.404828"],["926208b5.883528"]]},{"id":"926208b5.883528","type":"function","z":"68e5277d.892928","name":"set no data result","func":"let newPayload = {}\nlet tagArray = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = tagArray.length\nnewPayload['trackList'] = tagArray\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1132.0953216552734,"y":1498.619080543518,"wires":[["cd37bdd3.748ec"]]},{"id":"cd37bdd3.748ec","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1365.524127960205,"y":1382.0475816726685,"wires":[]},{"id":"4840b8e1.404828","type":"function","z":"68e5277d.892928","name":"set track result","func":"let newPayload = {}\nlet tagArray = []\nfor(let i = 0 ; i < msg.payload.length ; i++){\n    let d = msg.payload[i]\n    let tagId = d['tagId']\n    splitTag = tagId.split('_')\n    d['type'] = splitTag[0]\n    d['id'] = splitTag[1]\n    if(msg.payload[i].out != 'NA' && msg['tagType'] == 1){\n      let processTime = ''\n      let startDate = new Date(msg.payload[i].in_ts)\n      let endDate = new Date(msg.payload[i].out_ts)\n      let diffMs = endDate-startDate\n      let diffHour = (diffMs/3600000).toFixed(3)\n      if(diffHour > 0){\n        processTime = processTime + diffHour + ' hours '\n      }\n      /*\n      let diffDay = Math.floor(diffMs / 86400000)\n      let diffHour = Math.floor(diffMs % 86400000 / 3600000)\n      let diffMin = Math.floor(diffMs % 86400000  % 3600000 / 60000)\n      let diffSec = Math.floor(diffMs % 86400000  % 3600000 % 60000 / 1000)\n      if(diffDay > 0){\n        processTime = processTime + diffDay + ' days '\n      }\n      if(diffHour > 0){\n        processTime = processTime + diffHour + ' hours '\n      }\n      if(diffMin > 0){\n        processTime = processTime + diffMin + ' minutes '\n      }\n      if(diffSec > 0){\n        processTime = processTime + diffSec + ' seconds'\n      }\n      */\n      d['processTime'] = processTime\n    }\n    delete d['_id']\n    tagArray.push(d)\n}\nif(tagArray.length > 0){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'query success'\n  newPayload['size'] = tagArray.length\n  newPayload['trackList'] = tagArray\n}else{\n  newPayload['responseCode'] = '404'\n  newPayload['responseMsg'] = 'No Data'\n}\nmsg['payload'] = newPayload  \nreturn msg;","outputs":1,"noerr":0,"x":1126.809455871582,"y":1298.8094835281372,"wires":[["cd37bdd3.748ec"]]},{"id":"e02139c9.b71f38","type":"http in","z":"3873e5c5.abbcfa","name":"","url":"/event","method":"get","upload":false,"swaggerDoc":"","x":166.1666717529297,"y":816.3334197998047,"wires":[["a2a91ee5.7d657","ad1ac04d.8b4eb"]]},{"id":"e0753f52.6cc8a","type":"function","z":"68e5277d.892928","name":"set tag to search","func":"let tagInfo = msg['tagInfo']\nlet newPayload = {}\nnewPayload['information.type'] = tagInfo.type\nnewPayload['information.id'] = tagInfo.val\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":173.3333282470703,"y":305.66668701171875,"wires":[["995c0005.be787"]]},{"id":"995c0005.be787","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find tag","collection":"tags","operation":"find","x":175,"y":246.9999885559082,"wires":[["48d76b1f.c51344","92941f07.b3ccc"]]},{"id":"48d76b1f.c51344","type":"switch","z":"68e5277d.892928","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":339.3333435058594,"y":249.66665840148926,"wires":[["b6c1fb21.14f0f8"]]},{"id":"b6c1fb21.14f0f8","type":"function","z":"68e5277d.892928","name":"set macAddr update tag loc and updateTime","func":"let actInfo = msg['actInfo']\nlet macName = msg['macName']\nlet newPayload = {}\nlet loc = {}\nnewPayload = msg.payload[0]\nloc['macAddr'] = actInfo.data.macAddr\nloc['name'] = macName\nnewPayload['loc'] = loc\nnewPayload['updateTime'] = actInfo.data.date\nnewPayload['updateDt'] = new Date(actInfo.data.recv)\nlet q = {}\nq['information.type'] = msg.payload[0].information.type\nq['information.id'] = msg.payload[0].information.id\n\nmsg['query'] = q\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":590,"y":240,"wires":[["40c585a9.b5198c"]]},{"id":"40c585a9.b5198c","type":"mongodb out","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"update tag loc","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"update","x":900,"y":240,"wires":[]},{"id":"7e77ce2d.aa66f","type":"switch","z":"3873e5c5.abbcfa","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":171.00001525878906,"y":726.7499589920044,"wires":[["307414a5.ed976c"],["b028db00.04eb78"]]},{"id":"307414a5.ed976c","type":"function","z":"3873e5c5.abbcfa","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":166.5,"y":673.9999856948853,"wires":[["872b8d88.e1b2"]]},{"id":"722966b2.ed0a18","type":"http response","z":"3873e5c5.abbcfa","name":"","statusCode":"","headers":{},"x":1040.1113014221191,"y":376.33338928222656,"wires":[]},{"id":"b028db00.04eb78","type":"function","z":"3873e5c5.abbcfa","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":500.75000762939453,"y":764.9999694824219,"wires":[["722966b2.ed0a18"]]},{"id":"bd52f3c2.cf406","type":"function","z":"3873e5c5.abbcfa","name":"set search cond to get cnt","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.macAddr !== undefined ){\n  newPayload['macAddr'] = obj.macAddr    \n}else{\n  if(msg['cond'] !== undefined){\n    newPayload['macAddr'] = msg['cond']\n  }    \n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  newPayload['recv'] = dateCond\n}\nif(msg['search'] != undefined && msg['search'].indexOf(':') !== -1){\n  let arr = msg['search'].split(':')\n  if(arr.length === 3){\n    let fieldName = arr[0]\n    if(arr[2].indexOf('\"') !== -1){\n      arr[2] = arr[2].replace(/\"/g,'')\n    }else{\n      if (!isNaN(arr[2])) {\n        arr[2] = parseFloat(arr[2])\n      }\n    }\n    let opCond = {}\n    switch(arr[1]){\n      case '=':\n        newPayload[fieldName] = arr[2]\n        break\n      case '>':\n        opCond['$gt'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '<':\n        opCond['$lt'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '>=':\n        opCond['$gte'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '<=':\n        opCond['$lte'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '!=':\n        opCond['$ne'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      default:\n    }\n  }\n}\nif(obj.fport != undefined){\n  if (isNaN(obj.fport)) {\n    newPayload['extra.fport'] = obj.fport\n  } else {\n    newPayload['extra.fport'] = Number(obj.fport)\n  }\n}\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":544.1111145019531,"y":37.55556678771973,"wires":[["a1df7314.364c8","c3d34812.407d28"]]},{"id":"a1df7314.364c8","type":"mongodb in","z":"3873e5c5.abbcfa","mongodb":"f9ed3ab1.0debf8","name":"find raw data Cnt","collection":"devices","operation":"count","x":788.5556335449219,"y":54.222232818603516,"wires":[["f349b90c.47da88","ee3ef238.99b64"]]},{"id":"f349b90c.47da88","type":"switch","z":"3873e5c5.abbcfa","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":962.2221984863281,"y":59.77778625488281,"wires":[["1423781f.c3d458"],["56d338c9.a99248"]]},{"id":"56d338c9.a99248","type":"function","z":"3873e5c5.abbcfa","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = 0\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1003.222297668457,"y":159.33334732055664,"wires":[["722966b2.ed0a18"]]},{"id":"1423781f.c3d458","type":"function","z":"3873e5c5.abbcfa","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.macAddr !== undefined ){\n  newPayload['macAddr'] = obj.macAddr    \n}else{\n  if(msg['cond'] !== undefined){\n    newPayload['macAddr'] = msg['cond']\n  }    \n}\nif(obj.fport != undefined){\n  if (isNaN(obj.fport)) {\n    newPayload['extra.fport'] = obj.fport\n  } else {\n    newPayload['extra.fport'] = Number(obj.fport)\n  }\n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  newPayload['recv'] = dateCond\n}\nif(msg['search'] != undefined && msg['search'].indexOf(':') !== -1){\n  let arr = msg['search'].split(':')\n  if(arr.length === 3){\n    let fieldName = arr[0]\n    let opCond = {}\n    if(arr[2].indexOf('\"') !== -1){\n      arr[2] = arr[2].replace(/\"/g,'')\n    }else{\n      if (!isNaN(arr[2])) {\n        arr[2] = parseFloat(arr[2])\n      }\n    }\n    switch(arr[1]){\n      case '=':\n        // newPayload[fieldName] = parseInt(arr[2])\n        newPayload[fieldName] = arr[2]\n        break\n      case '>':\n        opCond['$gt'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '<':\n        opCond['$lt'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '>=':\n        opCond['$gte'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '<=':\n        opCond['$lte'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      default:\n    }\n  }\n}\n\nlet paginate = true\n\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['recv'] = -1\nif(obj.sort && obj.sort == 'asc'){\n  sort['recv'] = 1\n}\nmsg['sort'] = sort\nobj['next'] = nextPage\nobj['previous'] = previous\nobj['page_limit'] = page_limit\nobj['total'] = msg.payload\n// flow.set('actInfo', obj)\nmsg['actInfo'] = obj\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1229.4444580078125,"y":124.33333778381348,"wires":[["8b139e42.1954b"]]},{"id":"8b139e42.1954b","type":"mongodb in","z":"3873e5c5.abbcfa","mongodb":"f9ed3ab1.0debf8","name":"find raw data","collection":"devices","operation":"find","x":1211.444408416748,"y":190.77778673171997,"wires":[["f6855440.9e3b08"]]},{"id":"f6855440.9e3b08","type":"function","z":"3873e5c5.abbcfa","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet pageInfo = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = Number(obj['total'])\npageInfo['next'] = obj['next']\npageInfo['previous'] = obj['previous']\npageInfo['limit'] = obj['page_limit']\nnewPayload['pages'] = pageInfo\nnewPayload['data'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1219.444580078125,"y":251.44445037841797,"wires":[["722966b2.ed0a18"]]},{"id":"c3d34812.407d28","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":746.888858795166,"y":20,"wires":[]},{"id":"3cd66763.2705d8","type":"function","z":"68e5277d.892928","name":"check track duplicate","func":"let actInfo = msg['actInfo']\nlet tagInfo = msg['tagInfo']\nlet newPayload = {}\nlet tagId = eval('/'+tagInfo.type+'_'+tagInfo.val+'/i')\nnewPayload['loc.macAddr'] = actInfo.data.macAddr\nnewPayload['tagId'] = tagId\nnewPayload['out'] = 'NA'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":200,"y":680,"wires":[["7daffbd2.fe1194"]]},{"id":"7daffbd2.fe1194","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find duplicate track","collection":"track","operation":"find","x":210,"y":640,"wires":[["2cf1b9f3.f2abe6"]]},{"id":"2cf1b9f3.f2abe6","type":"switch","z":"68e5277d.892928","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":210,"y":580,"wires":[["31e89325.cb943c"],["c52495ce.dc9d68"]]},{"id":"c52495ce.dc9d68","type":"function","z":"68e5277d.892928","name":"set duplicate track result","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Track no change'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":610,"y":560,"wires":[["988600d6.81416","80fce923.19d238"]]},{"id":"52fb82b9.7d461c","type":"debug","z":"202da31a.94aadc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":299.50000381469727,"y":403.39996910095215,"wires":[]},{"id":"94d94764.b32808","type":"http in","z":"3873e5c5.abbcfa","name":"","url":"/eventType","method":"get","upload":false,"swaggerDoc":"","x":193.99993896484375,"y":1579.29984664917,"wires":[["c12f59f3.58d698"]]},{"id":"c12f59f3.58d698","type":"switch","z":"3873e5c5.abbcfa","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":190.99993896484375,"y":1532.2999267578125,"wires":[["488c82c4.c1ee5c"],["12358004.834a8"]]},{"id":"488c82c4.c1ee5c","type":"function","z":"3873e5c5.abbcfa","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":183.99993896484375,"y":1480.2999267578125,"wires":[["7d767fef.86b5e"]]},{"id":"95c61386.937f8","type":"http response","z":"3873e5c5.abbcfa","name":"","statusCode":"","headers":{},"x":1140.9999351501465,"y":1398.2999544143677,"wires":[]},{"id":"12358004.834a8","type":"function","z":"3873e5c5.abbcfa","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":475.99993896484375,"y":1482.2999267578125,"wires":[["95c61386.937f8"]]},{"id":"d61a2bbd.1e2928","type":"function","z":"3873e5c5.abbcfa","name":"set search cond to get type","func":"let obj = msg['actInfo']\nlet newPayload = []\nlet cnt = {}\nlet grp = {}\nlet cond = {}\nlet sort = {}\nlet sortField = {}\ncnt['$sum'] = 1\ngrp['_id'] = '$extra.fport'\ngrp['count'] = cnt\ncond['$group'] = grp\nsortField['_id'] = 1\nsort['$sort'] = sortField\nnewPayload.push(cond)\nnewPayload.push(sort)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":216.99993515014648,"y":1180.2999544143677,"wires":[["9cfeb9f2.405638","cba323bd.0e6f4"]]},{"id":"9cfeb9f2.405638","type":"mongodb in","z":"3873e5c5.abbcfa","mongodb":"f9ed3ab1.0debf8","name":"get raw data type","collection":"devices","operation":"aggregate","x":196.99993515014648,"y":1120.2999544143677,"wires":[["43d1a101.16af6","ba6f067c.fda128"]]},{"id":"43d1a101.16af6","type":"switch","z":"3873e5c5.abbcfa","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":386.999942779541,"y":1119.2999420166016,"wires":[["ec597e46.2914c"],["49c02e93.63b41"]]},{"id":"49c02e93.63b41","type":"function","z":"3873e5c5.abbcfa","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = 0\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":647.999942779541,"y":1169.2999429702759,"wires":[["95c61386.937f8"]]},{"id":"160a96a8.edc5e9","type":"function","z":"3873e5c5.abbcfa","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['data'] = msg['types']\nnewPayload['size'] = msg['types'].length\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1641.9998779296875,"y":1098.300048828125,"wires":[["95c61386.937f8"]]},{"id":"ba6f067c.fda128","type":"debug","z":"3873e5c5.abbcfa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":367.00000762939453,"y":1053.7999858856201,"wires":[]},{"id":"cba323bd.0e6f4","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":431.9999351501465,"y":1182.2999544143677,"wires":[]},{"id":"19c279a0.1c9086","type":"split","z":"3873e5c5.abbcfa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":766.1000633239746,"y":1003.3999900817871,"wires":[["52add3c8.a2e52c"]]},{"id":"52add3c8.a2e52c","type":"function","z":"3873e5c5.abbcfa","name":"get showField info","func":"let newPayload = {}\nnewPayload['deviceType'] = msg.payload._id+''\nmsg.payload = newPayload\nreturn msg;","outputs":1,"noerr":0,"x":887.0999450683594,"y":1089.6998929977417,"wires":[["42e1da5f.23b1b4"]]},{"id":"42e1da5f.23b1b4","type":"mongodb in","z":"3873e5c5.abbcfa","mongodb":"f9ed3ab1.0debf8","name":"get showField info","collection":"show_field","operation":"find","x":1117.5999755859375,"y":1088.89990234375,"wires":[["368778b8.f62958"]]},{"id":"368778b8.f62958","type":"join","z":"3873e5c5.abbcfa","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1292.0999755859375,"y":1095.300048828125,"wires":[["aafc695b.e6ebc8","d28a056d.d76af8"]]},{"id":"ec597e46.2914c","type":"function","z":"3873e5c5.abbcfa","name":"set obj to parameter","func":"msg['types'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":645.499942779541,"y":1088.6998925209045,"wires":[["19c279a0.1c9086"]]},{"id":"aafc695b.e6ebc8","type":"function","z":"3873e5c5.abbcfa","name":"combine result","func":"let types = msg['types']\nlet actInfo = msg['actInfo']\nif(actInfo.locale == undefined){\n  actInfo.locale = 'zh-Hans'\n}\nlet typeArray = []\nfor(let i = 0 ; i < types.length ; i++){\n  let typeObj = types[i]\n  if(msg.payload[i].length > 0){\n    typeObj['icon'] = msg.payload[i][0].icon\n    typeObj['keepalive'] = msg.payload[i][0].keepalive\n    typeObj['showTitle'] = msg.payload[i][0].showTitle\n    typeObj['showField'] = getShowField(msg.payload[i][0].showField, actInfo.locale)\n    typeObj['searchField'] = getSearchField(msg.payload[i][0].searchField, actInfo.locale)\n    typeObj['tab'] = getTabName(msg.payload[i][0].tab, actInfo.locale)\n    typeArray.push(typeObj)    \n  }\n}\nmsg['types'] = typeArray\nreturn msg\nfunction getShowField(showField, locale){\n  let f = {}\n  if (showField !== undefined) {\n    let s = {}\n    s = showField\n    f = s['event']\n    if (f !== undefined) {\n      if(locale !== 'all'){\n        for(let j = 0; j < f.length; j++){\n          if(actInfo.locale !== 'all')\n            f[j].name = f[j].name[actInfo.locale]\n        }  \n      }\n    }\n  }\n  return f\n}\nfunction getTabName(tab, locale){\n  let f = {}\n  if (tab !== undefined) {\n    if(locale !== 'all'){\n      f['name']= tab.name[actInfo.locale]\n    } else {\n      f = tab\n    }\n  }\n  return f\n}\nfunction getSearchField(searchField, locale){\n  let f = {}\n  if (searchField !== undefined) {\n    let s = {}\n    f = searchField\n    if (f !== undefined) {\n      if(locale !== 'all'){\n        for(let j = 0; j < f.length; j++){\n          if(actInfo.locale !== 'all')\n            f[j].name = f[j].name[actInfo.locale]\n        }  \n      }\n    }\n  }\n  return f\n}","outputs":1,"noerr":0,"x":1449.699951171875,"y":1097.699951171875,"wires":[["160a96a8.edc5e9","d28a056d.d76af8"]]},{"id":"65b7423b.efa0ac","type":"switch","z":"3873e5c5.abbcfa","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":181.50003051757812,"y":549.2000122070312,"wires":[["ba8a147.822a7e8"],["a1366f04.0ff04"]]},{"id":"ba8a147.822a7e8","type":"switch","z":"3873e5c5.abbcfa","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":185.00001525878906,"y":486,"wires":[["82c5ee4b.69677"],["e5112693.d89898"]]},{"id":"a1366f04.0ff04","type":"moment","z":"3873e5c5.abbcfa","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":422.50000762939453,"y":558.7999839782715,"wires":[["ba8a147.822a7e8"]]},{"id":"e5112693.d89898","type":"moment","z":"3873e5c5.abbcfa","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":416,"y":495.6000061035156,"wires":[["82c5ee4b.69677"]]},{"id":"179046df.09b0d9","type":"http in","z":"3ef324cd.c7c25c","name":"","url":"/rule","method":"get","upload":false,"swaggerDoc":"","x":195.5,"y":401.000018119812,"wires":[["bb6a2888.28cae8"]]},{"id":"bb6a2888.28cae8","type":"switch","z":"3ef324cd.c7c25c","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":199,"y":349.9999704360962,"wires":[["2f670098.19297"],["f293f2af.cdd49"]]},{"id":"2f670098.19297","type":"function","z":"3ef324cd.c7c25c","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":188.99999237060547,"y":308.9999694824219,"wires":[["94fb5ce9.df308"]]},{"id":"db5304c.df8d7f8","type":"function","z":"3ef324cd.c7c25c","name":"set search cond to get cnt","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport !== undefined){\n  newPayload['deviceType'] = obj.fport\n}\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":193.99999237060547,"y":104,"wires":[["7b96f533.0b11dc"]]},{"id":"7b96f533.0b11dc","type":"mongodb in","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"find maps data Cnt","collection":"maps","operation":"count","x":194.99999237060547,"y":51,"wires":[["35d0054e.b7beda"]]},{"id":"f293f2af.cdd49","type":"function","z":"3ef324cd.c7c25c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":501.00000762939453,"y":373.0000057220459,"wires":[["79759b5e.0b6054"]]},{"id":"79759b5e.0b6054","type":"http response","z":"3ef324cd.c7c25c","name":"","statusCode":"","headers":{},"x":1012.5,"y":291,"wires":[]},{"id":"35d0054e.b7beda","type":"switch","z":"3ef324cd.c7c25c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":387.00000381469727,"y":53.000000953674316,"wires":[["f5512b59.5ca168"],["f669517c.5d1c2"]]},{"id":"f669517c.5d1c2","type":"function","z":"3ef324cd.c7c25c","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = 0\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":557.0000076293945,"y":110.00000190734863,"wires":[["79759b5e.0b6054"]]},{"id":"f5512b59.5ca168","type":"function","z":"3ef324cd.c7c25c","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport){\n  newPayload['deviceType'] = obj.fport\n}\nlet paginate = true\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['deviceType'] = 1\nif(obj.sort && obj.sort == 'desc'){\n  sort['deviceType'] = -1\n}\nmsg['sort'] = sort\nobj['next'] = nextPage\nobj['previous'] = previous\nobj['page_limit'] = page_limit\nobj['total'] = msg.payload\n// flow.set('actInfo', obj)\nmsg['actInfo'] = obj\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":588,"y":28,"wires":[["23e4fea7.bdcb32"]]},{"id":"23e4fea7.bdcb32","type":"mongodb in","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"find maps data","collection":"maps","operation":"find","x":828.0000114440918,"y":25,"wires":[["fa2c1569.0c3a48"]]},{"id":"fa2c1569.0c3a48","type":"function","z":"3ef324cd.c7c25c","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet pageInfo = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = Number(obj['total'])\npageInfo['next'] = obj['next']\npageInfo['previous'] = obj['previous']\npageInfo['limit'] = obj['page_limit']\nnewPayload['pages'] = pageInfo\nnewPayload['data'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1120,"y":100,"wires":[["79759b5e.0b6054"]]},{"id":"3ad712ec.f6867e","type":"http in","z":"3ef324cd.c7c25c","name":"","url":"/rule","method":"post","upload":false,"swaggerDoc":"","x":171.5,"y":995.4000625610352,"wires":[["eaa30482.d76c38"]]},{"id":"eaa30482.d76c38","type":"switch","z":"3ef324cd.c7c25c","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":179,"y":947.800012588501,"wires":[["8f6929a4.e2cac8"],["34f223bd.55392c"]]},{"id":"a23cc63a.d54598","type":"function","z":"3ef324cd.c7c25c","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":168.99999237060547,"y":861.7999877929688,"wires":[["7a5fc7fa.251d88"]]},{"id":"34f223bd.55392c","type":"function","z":"3ef324cd.c7c25c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":486.00000762939453,"y":960.8000259399414,"wires":[["ffb384b9.adb658"]]},{"id":"ffb384b9.adb658","type":"http response","z":"3ef324cd.c7c25c","name":"","statusCode":"","headers":{},"x":1576.4999885559082,"y":922.0000133514404,"wires":[]},{"id":"8f6929a4.e2cac8","type":"switch","z":"3ef324cd.c7c25c","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":178,"y":905.2000131607056,"wires":[["a23cc63a.d54598"],["34f223bd.55392c"]]},{"id":"451eef12.d28ed","type":"function","z":"3ef324cd.c7c25c","name":"set fport to parameter","func":"let actInfo = msg['actInfo']\nif(actInfo.data.deviceType !== undefined){\n  msg['fport'] = actInfo.data.deviceType  \n}else{\n  msg['fport'] = 'NA'\n}\nreturn msg","outputs":1,"noerr":0,"x":185.5,"y":646.4000205993652,"wires":[["40dd2cd5.2af794"]]},{"id":"40dd2cd5.2af794","type":"switch","z":"3ef324cd.c7c25c","name":"","property":"fport","propertyType":"msg","rules":[{"t":"neq","v":"NA","vt":"str"},{"t":"eq","v":"NA","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":382.50000381469727,"y":638.8000707626343,"wires":[["57f65f28.d9267"],["9dc1f69.9dc8208"]]},{"id":"9dc1f69.9dc8208","type":"function","z":"3ef324cd.c7c25c","name":"set deviceType error","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'DeviceType not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":553.0000076293945,"y":683.1999855041504,"wires":[["ffb384b9.adb658"]]},{"id":"57f65f28.d9267","type":"function","z":"3ef324cd.c7c25c","name":"set search cond to get cnt","func":"let newPayload = {}\nnewPayload['deviceType'] = msg['fport']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":561.0000076293945,"y":596.5999841690063,"wires":[["f21b0fb0.4342d"]]},{"id":"f21b0fb0.4342d","type":"mongodb in","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"find maps by deviceType","collection":"maps","operation":"find","x":780,"y":546.0000085830688,"wires":[["5a2d91f8.8d2ef"]]},{"id":"5a2d91f8.8d2ef","type":"switch","z":"3ef324cd.c7c25c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":920,"y":600.0000095367432,"wires":[["cc421fcc.b976f"],["d69be971.2cfb78"]]},{"id":"27a84b96.d6dad4","type":"http in","z":"3ef324cd.c7c25c","name":"","url":"/rule/:fport","method":"delete","upload":false,"swaggerDoc":"","x":189,"y":1597.800048828125,"wires":[["bf280d55.d1b93"]]},{"id":"bf280d55.d1b93","type":"switch","z":"3ef324cd.c7c25c","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":179.5,"y":1539.800048828125,"wires":[["f0739154.e0d37"],["aecbd26e.5b71e"]]},{"id":"f0739154.e0d37","type":"function","z":"3ef324cd.c7c25c","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":174.5,"y":1492.800048828125,"wires":[["cf01eed5.d9aca"]]},{"id":"9c20cc60.22c0c","type":"function","z":"3ef324cd.c7c25c","name":"set search cond to get cnt","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['deviceType'] = obj.fport\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":191.49999237060547,"y":1270.8000421524048,"wires":[["7ff59353.9d9f3c"]]},{"id":"7ff59353.9d9f3c","type":"mongodb in","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"find maps data Cnt","collection":"maps","operation":"count","x":192.49999237060547,"y":1217.8000421524048,"wires":[["bcd259c3.1033f8"]]},{"id":"aecbd26e.5b71e","type":"function","z":"3ef324cd.c7c25c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":498.50000762939453,"y":1539.8000478744507,"wires":[["80e7e0df.12a2d"]]},{"id":"bcd259c3.1033f8","type":"switch","z":"3ef324cd.c7c25c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":384.50000381469727,"y":1219.800043106079,"wires":[["97bff000.3e273"],["52a7708a.9c522"]]},{"id":"52a7708a.9c522","type":"function","z":"3ef324cd.c7c25c","name":"set empty result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'no maps to delete'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":554.5000076293945,"y":1276.8000440597534,"wires":[["80e7e0df.12a2d"]]},{"id":"97bff000.3e273","type":"function","z":"3ef324cd.c7c25c","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport){\n  newPayload['deviceType'] = obj.fport\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":585.5,"y":1194.8000421524048,"wires":[["7781f21d.270b7c","40adc1cc.1cdf9"]]},{"id":"40adc1cc.1cdf9","type":"function","z":"3ef324cd.c7c25c","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'delete success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":833.5,"y":1302.8000440597534,"wires":[["80e7e0df.12a2d"]]},{"id":"80e7e0df.12a2d","type":"http response","z":"3ef324cd.c7c25c","name":"","statusCode":"","headers":{},"x":933.5000123977661,"y":1451.4000701904297,"wires":[]},{"id":"7781f21d.270b7c","type":"mongodb out","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"","collection":"maps","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":880.5000114440918,"y":1183.0000667572021,"wires":[]},{"id":"d69be971.2cfb78","type":"function","z":"3ef324cd.c7c25c","name":"set info to insert","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nobj.data['createTime'] = new Date()\nnewPayload = obj['data']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1045,"y":640.7999877929688,"wires":[["f13b1152.85231","42f1165b.98a068"]]},{"id":"f13b1152.85231","type":"mongodb out","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"insert maps info","collection":"maps","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1304,"y":640.7999877929688,"wires":[]},{"id":"42f1165b.98a068","type":"function","z":"3ef324cd.c7c25c","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'insert success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1118.999984741211,"y":732.0000095367432,"wires":[["ffb384b9.adb658"]]},{"id":"1add50f0.cc32ff","type":"mongodb out","z":"3ef324cd.c7c25c","mongodb":"f9ed3ab1.0debf8","name":"upadte maps info","collection":"maps","payonly":true,"upsert":false,"multi":true,"operation":"store","x":1342.5999946594238,"y":512.0000081062317,"wires":[]},{"id":"cc421fcc.b976f","type":"function","z":"3ef324cd.c7c25c","name":"set info to update","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nobj.data['updateTime'] = new Date()\nnewPayload = obj['data']\nnewPayload['_id'] = msg.payload[0]._id\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1116.6000671386719,"y":562.0000076293945,"wires":[["1add50f0.cc32ff","da4cf246.1c202"]]},{"id":"da4cf246.1c202","type":"function","z":"3ef324cd.c7c25c","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1329.5999908447266,"y":583.0000085830688,"wires":[["ffb384b9.adb658"]]},{"id":"7f924b52.d56c64","type":"function","z":"3873e5c5.abbcfa","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":182.77779388427734,"y":200.2221965789795,"wires":[["b66ae012.df692"]]},{"id":"b66ae012.df692","type":"switch","z":"3873e5c5.abbcfa","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":179.99999237060547,"y":154.44444370269775,"wires":[["6358adf8.bd5414"],["8d4b149c.da50a8"]]},{"id":"8d4b149c.da50a8","type":"function","z":"3873e5c5.abbcfa","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":457.8888626098633,"y":256.777795791626,"wires":[["722966b2.ed0a18"]]},{"id":"a2a91ee5.7d657","type":"switch","z":"3873e5c5.abbcfa","name":"check fport","property":"payload.fport","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":170.27777862548828,"y":773.0554447174072,"wires":[["7e77ce2d.aa66f"],["b028db00.04eb78"]]},{"id":"6358adf8.bd5414","type":"switch","z":"3873e5c5.abbcfa","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","outputs":4,"x":202.66664123535156,"y":91.11111831665039,"wires":[["bd52f3c2.cf406"],["fb380764.5072b8"],["fb380764.5072b8"],["87f73997.f30738"]]},{"id":"87f73997.f30738","type":"function","z":"3873e5c5.abbcfa","name":"set dataset fail","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Dataset missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":451,"y":184.6666660308838,"wires":[["722966b2.ed0a18"]]},{"id":"1260e910.4892e7","type":"http request","z":"3873e5c5.abbcfa","name":"get device","method":"GET","ret":"obj","url":"","tls":"","x":551.6667022705078,"y":140.22222709655762,"wires":[["57f8645c.4b4b8c"]]},{"id":"fb380764.5072b8","type":"function","z":"3873e5c5.abbcfa","name":"set url","func":"let actInfo = msg['actInfo']\nlet urlTemplate = 'http://device-svc:1880/sensor/3?token={token}&fport={fport}'\nlet url = ''\nurl = urlTemplate.replace('{token}', encodeURIComponent(actInfo.token)).replace('{fport}', actInfo.fport)\nmsg.payload = url\nmsg.url = url\nreturn msg","outputs":1,"noerr":0,"x":416.1111602783203,"y":101.33334159851074,"wires":[["1260e910.4892e7"]]},{"id":"57f8645c.4b4b8c","type":"switch","z":"3873e5c5.abbcfa","name":"check response code","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":767.2222290039062,"y":179.7777886390686,"wires":[["7875dbea.bd14e4"],["722966b2.ed0a18"]]},{"id":"7875dbea.bd14e4","type":"function","z":"3873e5c5.abbcfa","name":"set data level control","func":"let macAddr = {}\nlet macs = []\nif(msg.payload.size !== undefined && msg.payload.size > 0){\n  for (let i = 0 ; i < msg.payload.mList.length ; i++){\n    macs.push(msg.payload.mList[i].device_mac)\n  }\n  macAddr['$in'] = macs\n  msg['cond'] = macAddr\n}\nreturn msg","outputs":1,"noerr":0,"x":769.4444580078125,"y":127.55554866790771,"wires":[["bd52f3c2.cf406"]]},{"id":"872b8d88.e1b2","type":"switch","z":"3873e5c5.abbcfa","name":"check search","property":"payload.search","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":169.2500228881836,"y":632.5,"wires":[["65b7423b.efa0ac"],["24f835a2.c64c4a"]]},{"id":"24f835a2.c64c4a","type":"function","z":"3873e5c5.abbcfa","name":"set search text","func":"msg.payload = msg.payload.search\nreturn msg","outputs":1,"noerr":0,"x":378.25000381469727,"y":641.9999742507935,"wires":[["9361e3dc.75cb8"]]},{"id":"9361e3dc.75cb8","type":"decrypt","z":"3873e5c5.abbcfa","name":"","algorithm":"TripleDES","key":"gemtek","x":590.750057220459,"y":641.9999732971191,"wires":[["94105f67.59505"]]},{"id":"94105f67.59505","type":"function","z":"3873e5c5.abbcfa","name":"set search to parameter","func":"msg['search'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":436.75008392333984,"y":600.9999933242798,"wires":[["65b7423b.efa0ac"]]},{"id":"ad1ac04d.8b4eb","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":362.11645126342773,"y":816.0404300689697,"wires":[]},{"id":"341102fb.e3447e","type":"subflow:8db62750.88d568","z":"68e5277d.892928","name":"","x":200,"y":720,"wires":[["4646fb92.df0064"]]},{"id":"4646fb92.df0064","type":"switch","z":"68e5277d.892928","name":"","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":700,"wires":[["3cd66763.2705d8"],["988600d6.81416","80fce923.19d238"]]},{"id":"7945a941.39ce78","type":"function","z":"8db62750.88d568","name":"search tag","func":"let newPayload = {}\nnewPayload['information.type'] = msg.payload['type']\nnewPayload['information.id'] = msg.payload['val']\nmsg['tagInfo'] = msg.payload\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":101.70172119140625,"y":281.7670383453369,"wires":[["be1b218e.fbf58"]]},{"id":"be1b218e.fbf58","type":"mongodb in","z":"8db62750.88d568","mongodb":"f9ed3ab1.0debf8","name":"find tags","collection":"tags","operation":"find","x":91.01419067382812,"y":216.0056915283203,"wires":[["6cec8240.3d928c"]]},{"id":"6cec8240.3d928c","type":"switch","z":"8db62750.88d568","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":244.01418685913086,"y":143.0057020187378,"wires":[["def38df7.b3798"],["40356a16.5092b4"]]},{"id":"40356a16.5092b4","type":"function","z":"8db62750.88d568","name":"set tag info to insert","func":"let actInfo = msg['actInfo'].data\nlet tagInfo = msg['tagInfo']\nlet newPayload = {}\nlet info = {}\ninfo['id'] = tagInfo.val\ninfo['type'] = tagInfo.type\nnewPayload['_id'] = tagInfo.val\nnewPayload['information'] = info\nnewPayload['createTs'] = actInfo.timestamp\nnewPayload['createDt'] = new Date(actInfo.recv)\nnewPayload['createTime'] = actInfo.date\nnewPayload['macAddr'] = actInfo.macAddr\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":410.7016830444336,"y":188.4337100982666,"wires":[["65afeed6.5bfda","def38df7.b3798"]]},{"id":"def38df7.b3798","type":"function","z":"8db62750.88d568","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":845.6960525512695,"y":125.76133918762207,"wires":[[]]},{"id":"65afeed6.5bfda","type":"mongodb out","z":"8db62750.88d568","mongodb":"f9ed3ab1.0debf8","name":"insert tags","collection":"tags","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":686.0236892700195,"y":202.63636016845703,"wires":[]},{"id":"15c3a4e0.35b30b","type":"switch","z":"68e5277d.892928","name":"check map","property":"payload.map","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":184.01421737670898,"y":1207.2178554534912,"wires":[["f8d107fb.f9e908"],["32d4b7c7.1b87e8"]]},{"id":"9f2a8e74.3b88c","type":"catch","z":"8db62750.88d568","name":"catch error","scope":["be1b218e.fbf58","65afeed6.5bfda","7945a941.39ce78","7bac07b1.2b1648","def38df7.b3798","40356a16.5092b4","6cec8240.3d928c"],"x":453.02649307250977,"y":384.67419815063477,"wires":[["7bac07b1.2b1648"]]},{"id":"7bac07b1.2b1648","type":"function","z":"8db62750.88d568","name":"set fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'check tag error'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":758.0142211914062,"y":347.00567626953125,"wires":[[]]},{"id":"c523a02e.81a4e","type":"function","z":"68e5277d.892928","name":"set tag array","func":"let actInfo = msg['actInfo'].data\nlet infoObj = msg['actInfo'].data.information\nlet mapInfo = msg['actInfo'].map\nlet tagArray = []\nlet extraArray = []\nlet typeName = ''\nlet key = ''\nfor(let i = 1 ; i <= mapInfo.typeSize ; i++){\n  typeName = 'type'+i\n  let typeInfo = mapInfo[typeName]\n  if(typeInfo !== undefined){\n    key = typeInfo['valName']\n    if(infoObj[key] !== undefined){\n      let o = {}\n      o['type'] = i\n      o['val'] = infoObj[key]\n      o['macAddr'] = actInfo.macAddr\n      o['recv'] = new Date(actInfo.recv)\n      o['date'] = actInfo.date\n      o['ts'] = actInfo.timestamp\n      if(typeInfo['tags'] == 1){\n        tagArray.push(o)\n      }else{\n        typeInfo['append'].forEach(function(element) {\n          if(infoObj[element] !== undefined)\n            o[element] = infoObj[element]\n        });\n        o['field'] = key\n        o[key] = infoObj[key]\n        o['depend'] = typeInfo.depend\n        o['append'] = typeInfo.append\n        extraArray.push(o)\n      }\n    }\n  }\n}\nmsg.payload = tagArray\nmsg['extra'] = extraArray\nmsg['tagCnt'] = tagArray.length\nreturn msg","outputs":1,"noerr":0,"x":190,"y":880,"wires":[["fb4ea36f.a333e"]]},{"id":"19b5a5d0.fce86a","type":"split","z":"68e5277d.892928","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":190,"y":760,"wires":[["341102fb.e3447e"]]},{"id":"988600d6.81416","type":"join","z":"68e5277d.892928","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1550,"y":260,"wires":[["443c1e92.0de9"]]},{"id":"443c1e92.0de9","type":"function","z":"68e5277d.892928","name":"check tag result","func":"let newPayload = {}\nlet tagCnt = msg['tagCnt']\nlet resSuccessCnt = 0\nlet resErrorCnt = 0\nfor(let  i = 0 ; i < msg.payload.length ; i++){\n  res = msg.payload[i]\n  if(res['responseCode'] == '000'){\n    resSuccessCnt++\n  }else{\n    resErrorCnt++\n  }\n}\nif(tagCnt == resSuccessCnt){\n  newPayload['responseCode'] = '000'\n  newPayload['responseMsg'] = 'track success'\n}else{\n  newPayload['responseCode'] = '999'\n  newPayload['responseMsg'] = 'track fail'\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1720,"y":220,"wires":[["7b153768.20d758"]]},{"id":"7b153768.20d758","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1906.48388671875,"y":220.71685791015625,"wires":[]},{"id":"d0e6b7cc.b5b8c8","type":"function","z":"68e5277d.892928","name":"search mac name by mac","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\n//newPayload['fport'] = parseInt(actInfo.data.extra.fport)\nnewPayload['macAddr'] = actInfo.data.macAddr\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":190,"y":1060,"wires":[["deaf9cd8.5d45b"]]},{"id":"b3c90c37.53b6","type":"function","z":"68e5277d.892928","name":"set mac name","func":"let macName = 'NA'\nlet meta = {}\nlet showFlg = 1\nif(msg.payload.length > 0){\n  macName = msg.payload[0].name\n  meta = msg.payload[0].meta\n  showFlg = msg.payload[0].showFlg\n}\nmsg['macName'] = macName\nmsg['meta'] = meta\nmsg['showFlg'] = showFlg\nreturn msg","outputs":1,"noerr":0,"x":200,"y":940,"wires":[["c523a02e.81a4e"]]},{"id":"65d102f3.4b2ebc","type":"function","z":"68e5277d.892928","name":"check tag type","func":"let isTag = true\nlet parsed = Number.parseInt(msg['tagType']);\nif (Number.isNaN(parsed)) {\n    isTag = false\n}\nmsg['isTag'] = isTag\nreturn msg","outputs":1,"noerr":0,"x":182.69032287597656,"y":2052.3891835212708,"wires":[["1633a5da.e4f61a"]]},{"id":"cdcfdd6b.a7a6b","type":"function","z":"68e5277d.892928","name":"check tag type","func":"let isTag = true\nlet parsed = Number.parseInt(msg['tagType']);\nif (Number.isNaN(parsed)) {\n    isTag = false\n}\nmsg['isTag'] = isTag\nreturn msg","outputs":1,"noerr":0,"x":188.01419067382812,"y":1384.763243675232,"wires":[["be475d14.1a3de"]]},{"id":"deaf9cd8.5d45b","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find mac name","collection":"metadata","operation":"find","x":200,"y":1000,"wires":[["b3c90c37.53b6"]]},{"id":"54f2374a.3dcc88","type":"http in","z":"68e5277d.892928","name":"","url":"/:meta/:val/:target/:type/:id/track","method":"get","upload":false,"swaggerDoc":"","x":204.02841186523438,"y":2989.375,"wires":[["2c303435.67ea4c"]]},{"id":"2c303435.67ea4c","type":"switch","z":"68e5277d.892928","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":194.02841186523438,"y":2931.375,"wires":[["febb57a1.e382c8"],["495810d9.b2555"]]},{"id":"495810d9.b2555","type":"function","z":"68e5277d.892928","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":553.0284118652344,"y":2914.375,"wires":[["9d914b06.ce43c8"]]},{"id":"9d914b06.ce43c8","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1228.028419494629,"y":2908.3750143051147,"wires":[]},{"id":"febb57a1.e382c8","type":"function","z":"68e5277d.892928","name":"set para to obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg.payload['tagId'] = msg.req.params.id\nmsg.payload['meta'] = msg.req.params.meta\nmsg.payload['val'] = msg.req.params.val\nmsg.payload['target'] = msg.req.params.target\nmsg['actInfo'] = msg.payload\nmsg['tagType'] = msg.req.params.type\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":185.02841186523438,"y":2879.375,"wires":[["11b9cb.d745d635"]]},{"id":"ed169f1d.47ec","type":"switch","z":"68e5277d.892928","name":"check isTag","property":"isTag","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":190.0284423828125,"y":2643.3751006126404,"wires":[["3dbb9505.0a42fa"],["482f3b1.ffd8ac4"]]},{"id":"9d3c8ad5.87a448","type":"http in","z":"68e5277d.892928","name":"","url":"/:meta/:type/:id/track","method":"get","upload":false,"swaggerDoc":"","x":173.79037475585938,"y":3598.613037109375,"wires":[["336834f3.c4a48c"]]},{"id":"336834f3.c4a48c","type":"switch","z":"68e5277d.892928","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":171.7903823852539,"y":3537.613037109375,"wires":[["88c10e5a.45495"],["7a97b3c8.5e0d8c"]]},{"id":"7a97b3c8.5e0d8c","type":"function","z":"68e5277d.892928","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":508.7903747558594,"y":3527.613037109375,"wires":[["d06ff4f1.fca798"]]},{"id":"d06ff4f1.fca798","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1198.7903575897217,"y":3619.7241926193237,"wires":[]},{"id":"88c10e5a.45495","type":"function","z":"68e5277d.892928","name":"set para to obj","func":"msg.payload['tagType'] = msg.req.params.type\nmsg.payload['tagId'] = msg.req.params.id\nmsg.payload['meta'] = msg.req.params.meta\nmsg['actInfo'] = msg.payload\nmsg['tagType'] = msg.req.params.type\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":161.7903823852539,"y":3489.613037109375,"wires":[["166e754e.2770db"]]},{"id":"779ea021.5de92","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"aggregate by tagId","collection":"track","operation":"aggregate","x":684.7903366088867,"y":3224.0575275421143,"wires":[["d1af3983.f39358"]]},{"id":"7b5221ec.b6736","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1746.6474800109863,"y":3218.8036613464355,"wires":[]},{"id":"d8f36838.86d118","type":"function","z":"68e5277d.892928","name":"check tag type","func":"let isTag = true\nlet parsed = Number.parseInt(msg['tagType']);\nif (Number.isNaN(parsed)) {\n    isTag = false\n}\nmsg['isTag'] = isTag\nreturn msg","outputs":1,"noerr":0,"x":142.62351989746094,"y":3304.00244140625,"wires":[["101b53f.03e31ac"]]},{"id":"4724fb67.acfaa4","type":"function","z":"68e5277d.892928","name":"check tag type","func":"let isTag = true\nlet parsed = Number.parseInt(msg['tagType']);\nif (Number.isNaN(parsed)) {\n    isTag = false\n}\nmsg['isTag'] = isTag\nreturn msg","outputs":1,"noerr":0,"x":168.94740295410156,"y":2695.709716796875,"wires":[["ed169f1d.47ec"]]},{"id":"101b53f.03e31ac","type":"switch","z":"68e5277d.892928","name":"check isTag","property":"isTag","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":144.79036712646484,"y":3242.6131172180176,"wires":[["29a0e894.6abf28"],["9aa1b3ee.373d8"]]},{"id":"9aa1b3ee.373d8","type":"function","z":"68e5277d.892928","name":"set type error","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'type error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":429.45703125,"y":3272.613133430481,"wires":[["d06ff4f1.fca798"]]},{"id":"482f3b1.ffd8ac4","type":"function","z":"68e5277d.892928","name":"set type error","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'type error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":446.6824264526367,"y":2650.4099225997925,"wires":[["9d914b06.ce43c8"]]},{"id":"29a0e894.6abf28","type":"function","z":"68e5277d.892928","name":"set tag cnt","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet newPayload = []\nlet tagId = eval('/'+actInfo.tagType+'_'+actInfo.tagId+'/ig')\nlet inTs = {}\nlet outTs = {}\nlet grp = {}\nlet match = {}\nlet matchAnd = {}\nlet matchType = {}\nlet matchFport = {}\nlet matchArray = []\nlet cond = {}\n// let sort = {}\n// let sortField = {}\nlet loc = '$loc.'\nlet grpObj = {}\nlet exObj = {}\nmatchType['tagId'] = tagId\nmatchArray.push(matchType)\nif(actInfo.showFlg !== undefined){\n  let matchShow = {}\n  matchShow['showFlg'] = parseInt(actInfo.showFlg)\n  matchArray.push(matchShow)\n}\nmatchAnd['$and'] = matchArray\nmatch['$match'] = matchAnd\ninTs['$min'] = '$in_ts'\noutTs['$max'] = '$out_ts'\nif(actInfo.meta !== 'macAddr'){\n  loc+='meta.'\n  grpObj['val'] = loc+actInfo.meta+'.val'\n  grpObj['name'] = loc+actInfo.meta+'.name'\n}else{\n  grpObj['val'] = loc+actInfo.meta\n  grpObj['name'] = loc+'name'\n  \n}\nif(actInfo.extra !== undefined && actInfo.extra != 0){\n  exObj['$addToSet'] = '$extra.'+actInfo.extra\n  grp['extra'] = exObj  \n}\ngrp['_id'] = grpObj\ngrp['inTs'] = inTs\ngrp['outTs'] = outTs\ncond['$group'] = grp\n// sortField['in_ts'] = -1\n// sort['$sort'] = sortField\nnewPayload.push(match)\nnewPayload.push(cond)\n// newPayload.push(sort)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":421.1268997192383,"y":3192.935227394104,"wires":[["779ea021.5de92","a62c7d2a.c842b"]]},{"id":"becd88d5.ea9548","type":"function","z":"68e5277d.892928","name":"set result","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nif(actInfo.sort == 'desc'){\n  newPayload['track'] = orderByDateDesc(msg.payload, 'inTs')  \n}else{\n  newPayload['track'] = orderByDateAsc(msg.payload, 'inTs')\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = msg.payload.length\n\n/*\nmsg.payload.sort( function compare(a, b){\n  return a['inTs'] - b['inTs']\n})\n*/\nmsg['payload'] = newPayload\nreturn msg\nfunction orderByDateAsc(arr, dateProp){\n  return arr.slice().sort(function (a, b){\n    return a[dateProp] < b[dateProp] ? -1:1\n  })\n}\nfunction orderByDateDesc(arr, dateProp){\n  return arr.slice().sort(function (a, b){\n    return a[dateProp] < b[dateProp] ? 1:-1\n  })\n}","outputs":1,"noerr":0,"x":1398.9046249389648,"y":3212.6324462890625,"wires":[["7b5221ec.b6736"]]},{"id":"d1af3983.f39358","type":"switch","z":"68e5277d.892928","name":"check result","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":874.1129856109619,"y":3224.0591564178467,"wires":[["8f6781c8.a2917"],["12131530.55d07b"]]},{"id":"12131530.55d07b","type":"function","z":"68e5277d.892928","name":"set result","func":"let newPayload = {}\nlet trackArray = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = trackArray.length\nnewPayload['track'] = trackArray\nmsg['payload'] = newPayload  \nreturn msg","outputs":1,"noerr":0,"x":1021.1268310546875,"y":3297.076904296875,"wires":[["d06ff4f1.fca798"]]},{"id":"8f6781c8.a2917","type":"split","z":"68e5277d.892928","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":875.2242202758789,"y":3169.3747713565826,"wires":[["34bf9a86.81ec26"]]},{"id":"34bf9a86.81ec26","type":"function","z":"68e5277d.892928","name":"check NA with meta","func":"let actInfo = msg['actInfo']\nmsg['metaObj'] = msg.payload\nlet newPayload = {}\nlet tagId = eval('/'+actInfo.tagType+'_'+actInfo.tagId+'/i')\nlet loc = 'loc.'\nif(actInfo.meta != 'macAddr'){\n  loc += 'meta.'\n  newPayload[loc+actInfo.meta+'.val'] = msg.payload['_id'].val\n}else{\n  newPayload[loc+actInfo.meta] = msg.payload['_id'].val\n}\n\nnewPayload['tagId'] = tagId\nnewPayload['out'] = 'NA'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1085.2208967208862,"y":3132.569372177124,"wires":[["21341ae.1a517e6"]]},{"id":"21341ae.1a517e6","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find NA by tagId and meta","collection":"track","operation":"find","x":1342.4399337768555,"y":3130.0062103271484,"wires":[["b860b2e.fb7c15"]]},{"id":"b860b2e.fb7c15","type":"function","z":"68e5277d.892928","name":"set isNA","func":"let isNA = false\nlet processTime = ''\nlet metaObj = msg['metaObj']\nif(msg.payload.length > 0){\n  isNA = true  \n  metaObj['outTs'] = null\n  let utcDt = new Date(metaObj.inTs)\n  let localDt = new Date(utcDt.getTime()+8*60*60*1000)\n  metaObj['inTs'] = localDt\n}else{\n  let startDate = new Date(metaObj.inTs)\n  let endDate = new Date(metaObj.outTs)\n  let diffMs = endDate-startDate\n  let diffHour = (diffMs/3600000).toFixed(3)\n  if(diffHour > 0){\n    processTime = processTime + diffHour + ' hours '\n  }\n  /*\n  let diffDay = Math.floor(diffMs / 86400000)\n  let diffHour = Math.floor(diffMs % 86400000 / 3600000)\n  let diffMin = Math.floor(diffMs % 86400000  % 3600000 / 60000)\n  let diffSec = Math.floor(diffMs % 86400000  % 3600000 % 60000 / 1000)\n  if(diffDay > 0){\n    processTime = processTime + diffDay + ' days '\n  }\n  if(diffHour > 0){\n    processTime = processTime + diffHour + ' hours '\n  }\n  if(diffMin > 0){\n    processTime = processTime + diffMin + ' minutes '\n  }\n  if(diffSec > 0){\n    processTime = processTime + diffSec + ' seconds'\n  } \n  */\n}\nmetaObj['processTime'] = processTime\nmetaObj['isNA'] = isNA \nmsg.payload = metaObj\nreturn msg","outputs":1,"noerr":0,"x":1547.7493934631348,"y":3129.3339500427246,"wires":[["59744208.091e8c"]]},{"id":"59744208.091e8c","type":"join","z":"68e5277d.892928","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1140.6691818237305,"y":3201.168125152588,"wires":[["becd88d5.ea9548"]]},{"id":"3dbb9505.0a42fa","type":"function","z":"68e5277d.892928","name":"set tag cnt","func":"// let actInfo = flow.get('actInfo')\nlet actInfo = msg['actInfo']\nlet newPayload = []\nlet tagId = eval('/'+actInfo.tagType+'_'+actInfo.tagId+'/i')\nlet inTs = {}\nlet outTs = {}\nlet grp = {}\nlet match = {}\nlet matchAnd = {}\nlet matchType = {}\nlet matchMeta = {}\nlet matchFport = {}\nlet matchArray = []\nlet cond = {}\nlet loc = '$loc.'\nlet grpObj = {}\nlet exObj = {}\nmatchType['tagId'] = tagId\nmatchMeta['loc.meta.'+actInfo.meta+'.val'] = actInfo.val\nmatchArray.push(matchType)\nmatchArray.push(matchMeta)\nif(actInfo.showFlg !== undefined){\n  let matchShow = {}\n  matchShow['showFlg'] = parseInt(actInfo.showFlg)\n  matchArray.push(matchShow)\n}\nmatchAnd['$and'] = matchArray\nmatch['$match'] = matchAnd\ninTs['$min'] = '$in_ts'\noutTs['$max'] = '$out_ts'\nif(actInfo.target !== 'macAddr'){\n  loc+='meta.'\n  grpObj['val'] = loc+actInfo.target+'.val'\n  grpObj['name'] = loc+actInfo.target+'.name'\n}else{\n  grpObj['val'] = loc+actInfo.target\n  grpObj['name'] = loc+'name'\n}\nif(actInfo.extra != 0){\n  exObj['$addToSet'] = '$extra.'+actInfo.extra\n  grp['extra'] = exObj  \n}\ngrp['_id'] = grpObj\ngrp['inTs'] = inTs\ngrp['outTs'] = outTs\ncond['$group'] = grp\nnewPayload.push(match)\nnewPayload.push(cond)\nlet sort = {}\nsort['inTs'] = -1\nif(actInfo.sort && actInfo.sort == 'asc'){\n  sort['inTs'] = 1\n}\nmsg['sort'] = sort\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":451.0142364501953,"y":2558.9149322509766,"wires":[["7e44165.5ca56e8"]]},{"id":"7e44165.5ca56e8","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"aggregate by tagId","collection":"track","operation":"aggregate","x":681.0142211914062,"y":2572.914794921875,"wires":[["c53aa817.eaaaf8"]]},{"id":"c53aa817.eaaaf8","type":"switch","z":"68e5277d.892928","name":"check result","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":874.6505737304688,"y":2569.914794921875,"wires":[["d00fdfdb.aef19"],["9a510f1c.5aada"]]},{"id":"d00fdfdb.aef19","type":"split","z":"68e5277d.892928","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":875.7618083953857,"y":2515.230409860611,"wires":[["87441a83.4881a8"]]},{"id":"9a510f1c.5aada","type":"function","z":"68e5277d.892928","name":"set result","func":"let newPayload = {}\nlet trackArray = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = trackArray.length\nnewPayload['track'] = trackArray\nmsg['payload'] = newPayload  \nreturn msg","outputs":1,"noerr":0,"x":1021.6644191741943,"y":2642.9325428009033,"wires":[["9d914b06.ce43c8"]]},{"id":"87441a83.4881a8","type":"function","z":"68e5277d.892928","name":"check NA with meta","func":"let actInfo = msg['actInfo']\nmsg['metaObj'] = msg.payload\nlet newPayload = {}\nlet tagId = eval('/'+actInfo.tagType+'_'+actInfo.tagId+'/i')\nlet loc = 'loc.'\nif(actInfo.target != 'macAddr'){\n  loc += 'meta.'\n  newPayload[loc+actInfo.target+'.val'] = msg.payload['_id'].val\n}else{\n  newPayload[loc+actInfo.target] = msg.payload['_id'].val\n}\nnewPayload['tagId'] = tagId\nnewPayload['out'] = 'NA'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1085.758484840393,"y":2478.4250106811523,"wires":[["cad5a29.29cc86"]]},{"id":"7948550d.d215fc","type":"join","z":"68e5277d.892928","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1141.2067699432373,"y":2547.023763656616,"wires":[["7ff995a3.7543dc"]]},{"id":"cad5a29.29cc86","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find NA by tagId and meta","collection":"track","operation":"find","x":1342.9775218963623,"y":2475.8618488311768,"wires":[["b7feb3d5.de468"]]},{"id":"b7feb3d5.de468","type":"function","z":"68e5277d.892928","name":"set isNA","func":"let isNA = false\nlet processTime = ''\nlet metaObj = msg['metaObj']\nif(msg.payload.length > 0){\n  isNA = true  \n  metaObj['outTs'] = null\n  let utcDt = new Date(metaObj.inTs)\n  let localDt = new Date(utcDt.getTime()+8*60*60*1000)\n  metaObj['inTs'] = localDt\n}else{\n  let startDate = new Date(metaObj.inTs)\n  let endDate = new Date(metaObj.outTs)\n  let diffMs = endDate-startDate\n  let diffHour = (diffMs/3600000).toFixed(3)\n  if(diffHour > 0){\n    processTime = processTime + diffHour + ' hours '\n  }\n  /*\n  let diffDay = Math.floor(diffMs / 86400000)\n  let diffHour = Math.floor(diffMs % 86400000 / 3600000)\n  let diffMin = Math.floor(diffMs % 86400000  % 3600000 / 60000)\n  let diffSec = Math.floor(diffMs % 86400000  % 3600000 % 60000 / 1000)\n  if(diffDay > 0){\n    processTime = processTime + diffDay + ' days '\n  }\n  if(diffHour > 0){\n    processTime = processTime + diffHour + ' hours '\n  }\n  if(diffMin > 0){\n    processTime = processTime + diffMin + ' minutes '\n  }\n  if(diffSec > 0){\n    processTime = processTime + diffSec + ' seconds'\n  }  \n  */\n}\nmetaObj['processTime'] = processTime\nmetaObj['isNA'] = isNA \n\nmsg.payload = metaObj\nreturn msg","outputs":1,"noerr":0,"x":1548.2869815826416,"y":2475.189588546753,"wires":[["7948550d.d215fc"]]},{"id":"7ff995a3.7543dc","type":"function","z":"68e5277d.892928","name":"set result","func":"let newPayload = {}\nlet actInfo = msg['actInfo']\nif(actInfo.sort == 'desc'){\n  newPayload['track'] = orderByDateDesc(msg.payload, 'inTs')  \n}else{\n  newPayload['track'] = orderByDateAsc(msg.payload, 'inTs')\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = msg.payload.length\n\n/*\nmsg.payload.sort( function compare(a, b){\n  return a['inTs'] - b['inTs']\n})\n*/\nmsg['payload'] = newPayload\nreturn msg\nfunction orderByDateAsc(arr, dateProp){\n  return arr.slice().sort(function (a, b){\n    return a[dateProp] < b[dateProp] ? -1:1\n  })\n}\nfunction orderByDateDesc(arr, dateProp){\n  return arr.slice().sort(function (a, b){\n    return a[dateProp] < b[dateProp] ? 1:-1\n  })\n}","outputs":1,"noerr":0,"x":1399.4422130584717,"y":2558.488084793091,"wires":[["3817831e.f8183c"]]},{"id":"3817831e.f8183c","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":1747.1850681304932,"y":2564.659299850464,"wires":[]},{"id":"fb4ea36f.a333e","type":"switch","z":"68e5277d.892928","name":"check tag array","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":200,"y":820,"wires":[["19b5a5d0.fce86a"],["3c95b5b.154a14a"]]},{"id":"7c9b6661.249158","type":"function","z":"68e5277d.892928","name":"check macAddr with NA","func":"let newPayload = {}\nnewPayload['loc.macAddr'] = msg.payload[0].belong\nnewPayload['out'] = 'NA'    \nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":911,"y":745,"wires":[["f6916509.4acfb8"]]},{"id":"f6916509.4acfb8","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find NA tag","collection":"track","operation":"find","x":1119,"y":750,"wires":[["3f97fab1.243196"]]},{"id":"3f97fab1.243196","type":"switch","z":"68e5277d.892928","name":"check track by macAddr","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1158,"y":703,"wires":[["ebcda812.515918"],["3a7d4236.8ad55e"]]},{"id":"3a7d4236.8ad55e","type":"function","z":"68e5277d.892928","name":"set tag not exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'No tag exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1406,"y":730,"wires":[["bfdcbb42.b91d48"]]},{"id":"a11c525a.bb3f","type":"split","z":"68e5277d.892928","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1412,"y":636,"wires":[["177267dc.4dbad8"]]},{"id":"177267dc.4dbad8","type":"function","z":"68e5277d.892928","name":"set data to update","func":"let actInfo = msg['actInfo']\nlet tagInfo = msg.payload\nlet extraArray = msg['extra']\nlet tags = {}\nlet loc = {}\nlet tagExtra = tagInfo['extra']\nloc['macAddr'] = actInfo.data.macAddr\nlet tagIds = tagInfo['tagId'].split('_')\nif(extraArray !== undefined){\n  let exObj = tagExtra\n  for(let i = 0 ; i < extraArray.length ; i++){\n    let ex = extraArray[i]\n    let key = ex['field']\n    let dep = ex['depend']\n    if(dep.indexOf(tagIds[0]+'') != -1){\n      ex['append'].forEach(function(element) {\n        if(ex[element] !== undefined && tagExtra[element] === undefined)\n          exObj[element] = ex[element]\n      })\n      if(tagExtra[key] === undefined)\n        exObj[key] = ex.val\n    }\n  }\n  tagInfo['extra'] = exObj\n}\nmsg.payload = tagInfo\nreturn msg","outputs":1,"noerr":0,"x":1434,"y":584,"wires":[["2b8ce952.3ef9d6"]]},{"id":"2b8ce952.3ef9d6","type":"mongodb out","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"upadte tag extra","collection":"track","payonly":true,"upsert":false,"multi":true,"operation":"store","x":1671,"y":586,"wires":[]},{"id":"ebcda812.515918","type":"function","z":"68e5277d.892928","name":"set tag cnt","func":"msg['tagCnt'] = msg.payload.length\nreturn msg","outputs":1,"noerr":0,"x":1393,"y":681,"wires":[["a11c525a.bb3f"]]},{"id":"ca6a2843.e401c8","type":"switch","z":"68e5277d.892928","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":194.33333587646484,"y":2343.66650390625,"wires":[["fbae4543.1a9ca8"],["3219de07.80eec2"]]},{"id":"fbae4543.1a9ca8","type":"switch","z":"68e5277d.892928","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":184.1666488647461,"y":2281.466552734375,"wires":[["5fd49a2b.463d94"],["764aa97c.db1868"]]},{"id":"3219de07.80eec2","type":"moment","z":"68e5277d.892928","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":459.9999694824219,"y":2335.933349609375,"wires":[["fbae4543.1a9ca8"]]},{"id":"764aa97c.db1868","type":"moment","z":"68e5277d.892928","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":442.4999694824219,"y":2265.733154296875,"wires":[["5fd49a2b.463d94"]]},{"id":"fcebccea.d5591","type":"switch","z":"68e5277d.892928","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":199.3333396911621,"y":1633.6666278839111,"wires":[["95eaaa1a.706078"],["d7344386.35767"]]},{"id":"95eaaa1a.706078","type":"switch","z":"68e5277d.892928","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":206.8333282470703,"y":1590.4666576385498,"wires":[["ce538d6d.2348d"],["c1a54703.b1ac38"]]},{"id":"d7344386.35767","type":"moment","z":"68e5277d.892928","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":454.3333206176758,"y":1647.2666282653809,"wires":[["95eaaa1a.706078"]]},{"id":"c1a54703.b1ac38","type":"moment","z":"68e5277d.892928","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":447.83331298828125,"y":1584.066650390625,"wires":[["ce538d6d.2348d"]]},{"id":"a62c7d2a.c842b","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":651,"y":3150,"wires":[]},{"id":"6bfe33ff.d1db1c","type":"function","z":"68e5277d.892928","name":"search belong by mac","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['fport'] = parseInt(actInfo.data.extra.fport)\nnewPayload['macAddr'] =actInfo.data.macAddr\nmsg.payload = newPayload\nreturn msg\n","outputs":1,"noerr":0,"x":704,"y":690,"wires":[["30f5731c.3dd03c"]]},{"id":"30f5731c.3dd03c","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find metadata","collection":"metadata","operation":"find","x":713,"y":794,"wires":[["97ef77c4.df3618"]]},{"id":"97ef77c4.df3618","type":"switch","z":"68e5277d.892928","name":"check belong","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":917,"y":799,"wires":[["7c9b6661.249158"],["3c95b5b.154a14a"]]},{"id":"3c95b5b.154a14a","type":"function","z":"68e5277d.892928","name":"set tag not exist result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'No belong exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":915,"y":884,"wires":[["bfdcbb42.b91d48"]]},{"id":"f4e932b3.f3477","type":"catch","z":"68e5277d.892928","name":"","scope":null,"x":1475,"y":333,"wires":[["ba94b8ce.463298","21683658.09b18a"]]},{"id":"ba94b8ce.463298","type":"function","z":"68e5277d.892928","name":"set duplicate track result","func":"let newPayload = {}\nnewPayload['responseCode'] = '500'\nnewPayload['responseMsg'] = 'Track error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1694,"y":331,"wires":[["a5531dcd.8042b","7b153768.20d758"]]},{"id":"21683658.09b18a","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1651,"y":379,"wires":[]},{"id":"4fa35674.26c878","type":"function","z":"68e5277d.892928","name":"find scale mac","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nnewPayload['belong'] = actInfo.data.macAddr\n//newPayload['fport'] = parseInt(actInfo.data.extra.fport)\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":374,"y":88,"wires":[["31d5f9f8.820fd6"]]},{"id":"31d5f9f8.820fd6","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"get scale mac","collection":"metadata","operation":"find","x":367,"y":149,"wires":[["74e35e90.a72a8"]]},{"id":"74e35e90.a72a8","type":"switch","z":"68e5277d.892928","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":520,"y":168,"wires":[["d05e1a2.80df2e8"],["26fafb8b.91aab4"]]},{"id":"4d59bc94.b76534","type":"function","z":"68e5277d.892928","name":"get scale info by time","func":"//query by time period and find max value\nif(msg['queryTsFlg']){\n  let newPayload = []\n  let match = {}\n  let matchAnd = {}\n  let matchArray = []\n  let matchMac = {}\n  let matchRecv = {}\n  let cond = {}\n  let maxNW = {}\n  let grp = {}\n  \n  matchMac['macAddr']=msg.payload[0].macAddr\n  matchArray.push(matchMac)\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['scaleSt'])\n  dateCond['$lte'] = new Date()\n  matchRecv['recv'] = dateCond\n  \n  matchArray.push(matchRecv)\n  matchAnd['$and'] = matchArray\n  match['$match'] = matchAnd\n  \n  maxNW['$max'] = '$information.NW'\n  grp['_id'] = null\n  grp['maxNW'] = maxNW\n  cond['$group'] = grp\n  \n  newPayload.push(match)\n  newPayload.push(cond)\n  msg.payload = newPayload\n} else {\n  let newPayload = {}\n  newPayload['macAddr'] = msg.payload[0].macAddr\n  let sort = {}\n  sort['recv'] = -1\n  msg['limit'] = 1\n  msg['sort'] = sort\n  msg.payload = newPayload\n}\nreturn msg","outputs":1,"noerr":0,"x":795,"y":55,"wires":[["ff3d5d5e.2ce31","9ff097c0.1c97e8"]]},{"id":"9ff097c0.1c97e8","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find raw data","collection":"devices","operation":"aggregate","x":1003,"y":75,"wires":[["1eb08056.0bb48"]]},{"id":"1eb08056.0bb48","type":"function","z":"68e5277d.892928","name":"set info to msg","func":"if(msg.payload.length > 0){\n  if(msg['queryTsFlg']){\n    let newInfo = {}\n    newInfo['NW'] = msg.payload[0].maxNW\n    msg['extraObj'] = newInfo\n  } else {\n    msg['extraObj'] = msg.payload[0].information    \n  }\n  \n}\nreturn msg","outputs":1,"noerr":0,"x":1027,"y":121,"wires":[["26fafb8b.91aab4"]]},{"id":"ee3ef238.99b64","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":980,"y":21,"wires":[]},{"id":"3c9dd98f.45c906","type":"function","z":"7bc1586f.fd2988","name":"set mes-svc update","func":"let newPayload = {}\nnewPayload['tagId'] = msg.payload['tagId']\nnewPayload['out_ts'] = msg.payload['out']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":274,"y":173,"wires":[["26b8d337.ff2f0c"]]},{"id":"ff0496c2.f29658","type":"subflow:7bc1586f.fd2988","z":"68e5277d.892928","x":759,"y":373,"wires":[["e4346328.33d58"]]},{"id":"26b8d337.ff2f0c","type":"http request","z":"7bc1586f.fd2988","name":"","method":"PUT","ret":"obj","url":"http://10.70.51.54:5000/orcl/CIM/CIM100ROLA01","tls":"","x":500,"y":171,"wires":[[]]},{"id":"e4346328.33d58","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":974,"y":347,"wires":[]},{"id":"42e9377f.3abe08","type":"function","z":"68e5277d.892928","name":"set mes-svc insert Flow","func":"let newPayload = {}\nnewPayload['tagId'] = msg.payload['tagId']\nnewPayload['macAddr'] = msg.payload.loc.macAddr\nnewPayload['macAddr_name'] = msg.payload.loc.name\nnewPayload['factory_val'] = msg.payload.loc.meta.factory.val\nnewPayload['factory_name'] = msg.payload.loc.meta.factory.name\nnewPayload['zone_val'] = msg.payload.loc.meta.zone.val\nnewPayload['zone_name'] = msg.payload.loc.meta.zone.name\nnewPayload['station_val'] = msg.payload.loc.meta.station.val\nnewPayload['station_name'] = msg.payload.loc.meta.station.name\nnewPayload['in_ts'] = msg.payload['in']\nnewPayload['out_ts'] = msg.payload.out == 'NA' ? null:msg.payload.out\nlet extra = msg.payload.extra\nif(extra['NW'] !== undefined)\n  newPayload['weight'] = extra['NW']\nelse if(extra['GW'] !== undefined)\n  newPayload['weight'] = extra['GW']\nelse\n  newPayload['weight'] = null\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1030,"y":280,"wires":[["bfdef89b.3e3368"]]},{"id":"bfdef89b.3e3368","type":"http request","z":"68e5277d.892928","name":"","method":"POST","ret":"obj","url":"http://10.70.51.54:5000/orcl/CIM/CIM100ROLA01","tls":"","x":1130,"y":220,"wires":[["1af7039e.91840c","87a03165.019ce"]]},{"id":"87a03165.019ce","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1295,"y":122,"wires":[]},{"id":"166e754e.2770db","type":"http request","z":"68e5277d.892928","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":158,"y":3437,"wires":[["b085bc1f.d3084"]]},{"id":"b085bc1f.d3084","type":"function","z":"68e5277d.892928","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":150,"y":3393,"wires":[["931d61d3.16d91"]]},{"id":"931d61d3.16d91","type":"switch","z":"68e5277d.892928","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":150,"y":3350,"wires":[["d8f36838.86d118"],["a128318f.3e2a8"]]},{"id":"a128318f.3e2a8","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":356.5,"y":3411,"wires":[]},{"id":"11b9cb.d745d635","type":"http request","z":"68e5277d.892928","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":173,"y":2833,"wires":[["e2c86d47.3f5b2"]]},{"id":"e2c86d47.3f5b2","type":"function","z":"68e5277d.892928","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":165,"y":2789,"wires":[["5480c69f.ab1328"]]},{"id":"5480c69f.ab1328","type":"switch","z":"68e5277d.892928","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":165,"y":2746,"wires":[["4724fb67.acfaa4"],["b48ae45b.482a18"]]},{"id":"b48ae45b.482a18","type":"http response","z":"68e5277d.892928","name":"","statusCode":"","headers":{},"x":391.5,"y":2751,"wires":[]},{"id":"72c36730.1ded78","type":"switch","z":"68e5277d.892928","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":178,"y":2112,"wires":[["65d102f3.4b2ebc"],["254dc77c.732028"]]},{"id":"e49cb654.59f3f8","type":"function","z":"68e5277d.892928","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":180,"y":2154,"wires":[["72c36730.1ded78"]]},{"id":"5fd49a2b.463d94","type":"http request","z":"68e5277d.892928","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":190,"y":2200,"wires":[["e49cb654.59f3f8"]]},{"id":"76d0f38c.e0ee1c","type":"switch","z":"68e5277d.892928","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":189,"y":1436,"wires":[["cdcfdd6b.a7a6b"],["e8c1251e.d52b18"]]},{"id":"9a181ddf.4d65","type":"function","z":"68e5277d.892928","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":191,"y":1478,"wires":[["76d0f38c.e0ee1c"]]},{"id":"ce538d6d.2348d","type":"http request","z":"68e5277d.892928","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":201,"y":1524,"wires":[["9a181ddf.4d65"]]},{"id":"ddc8f5e9.2f2f78","type":"http request","z":"3873e5c5.abbcfa","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":203,"y":368,"wires":[["c61f9e9.d60b96"]]},{"id":"c61f9e9.d60b96","type":"function","z":"3873e5c5.abbcfa","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":192,"y":323,"wires":[["d5e4b067.33473"]]},{"id":"d5e4b067.33473","type":"switch","z":"3873e5c5.abbcfa","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":189,"y":278,"wires":[["7f924b52.d56c64"],["722966b2.ed0a18"]]},{"id":"2a5fc9d7.02c916","type":"http request","z":"3873e5c5.abbcfa","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":185,"y":1361,"wires":[["a8945fc0.d6a21"]]},{"id":"a8945fc0.d6a21","type":"function","z":"3873e5c5.abbcfa","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":180,"y":1304,"wires":[["1062d5a5.667eea"]]},{"id":"1062d5a5.667eea","type":"switch","z":"3873e5c5.abbcfa","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":179,"y":1255,"wires":[["d61a2bbd.1e2928"],["95c61386.937f8"]]},{"id":"cf01eed5.d9aca","type":"http request","z":"3ef324cd.c7c25c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":171,"y":1444,"wires":[["2201bfb5.f1639"]]},{"id":"2201bfb5.f1639","type":"function","z":"3ef324cd.c7c25c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":166,"y":1387,"wires":[["680badc7.2cfb14"]]},{"id":"680badc7.2cfb14","type":"switch","z":"3ef324cd.c7c25c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":165,"y":1338,"wires":[["9c20cc60.22c0c"],["80e7e0df.12a2d"]]},{"id":"7a5fc7fa.251d88","type":"http request","z":"3ef324cd.c7c25c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":171,"y":816,"wires":[["6052e4f5.5cb8ec"]]},{"id":"6052e4f5.5cb8ec","type":"function","z":"3ef324cd.c7c25c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":166,"y":759,"wires":[["c59ae9bc.a8a5d8"]]},{"id":"c59ae9bc.a8a5d8","type":"switch","z":"3ef324cd.c7c25c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":165,"y":710,"wires":[["451eef12.d28ed"],["ba3a9e78.c386a"]]},{"id":"ba3a9e78.c386a","type":"http response","z":"3ef324cd.c7c25c","name":"","statusCode":"","headers":{},"x":370.5,"y":708,"wires":[]},{"id":"94fb5ce9.df308","type":"http request","z":"3ef324cd.c7c25c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":185,"y":259,"wires":[["188b0ca9.7134b3"]]},{"id":"188b0ca9.7134b3","type":"function","z":"3ef324cd.c7c25c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":180,"y":202,"wires":[["1cc26954.73df77"]]},{"id":"1cc26954.73df77","type":"switch","z":"3ef324cd.c7c25c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":179,"y":153,"wires":[["db5304c.df8d7f8"],["79759b5e.0b6054"]]},{"id":"3b3dd44c.4c905c","type":"http in","z":"202da31a.94aadc","name":"","url":"/packet","method":"post","upload":false,"swaggerDoc":"","x":116,"y":909,"wires":[["66898dd3.f4f734","e9d766c0.cc0b58"]]},{"id":"ab932076.dbc67","type":"function","z":"202da31a.94aadc","name":"set to parameter","func":"let actInfo = msg['actInfo']\nmsg['testData'] = actInfo.data\nlet newPayload = []\nnewPayload.push(msg['testData'][0].macAddr)\nmsg.payload = newPayload\nmsg['flow'] = getRandomNumber(10)\nreturn msg\nfunction getRandomNumber(quantity_of_nums){\n   var milliseconds = new Date().getMilliseconds()\n   return Math.floor(milliseconds * quantity_of_nums / 1000)\n}","outputs":1,"noerr":0,"x":518,"y":509,"wires":[["3f6c05d7.42814a"]]},{"id":"80a6e248.ff1bb","type":"function","z":"202da31a.94aadc","name":"set frameCnt","func":"let testData = msg['testData']\nif(msg.payload != null){\n  testData[0].frameCnt = parseInt(msg.payload)+1\n}else{\n  testData[0].frameCnt = 1\n}\ntestData[0].channel = 999999999\ntestData[0].sf = 9\ntestData[0].time = new Date()\ntestData[0].gwip = '127.0.0.1'\ntestData[0].gwid = '0000000000000000'\ntestData[0].repeater = '00000000ffffffff'\ntestData[0].systype = 0\ntestData[0].rssi = -1\ntestData[0].snr = -1\ntestData[0].snr_max = 0\ntestData[0].snr_min = -2\nmsg.payload = testData\nreturn msg","outputs":1,"noerr":0,"x":766,"y":653,"wires":[["26d66316.db80ec","28fb3291.6b5bfe"]]},{"id":"26d66316.db80ec","type":"mqtt out","z":"202da31a.94aadc","name":"","topic":"GIOT-GW/UL/123456789","qos":"0","retain":"","broker":"faa8fb6d.20bf28","x":977.5,"y":631.199951171875,"wires":[]},{"id":"3f6c05d7.42814a","type":"subflow:efffc1d0.4735d8","z":"202da31a.94aadc","x":708.5,"y":573,"wires":[["80a6e248.ff1bb"]]},{"id":"66898dd3.f4f734","type":"switch","z":"202da31a.94aadc","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":111,"y":856,"wires":[["59707f42.0b33d"],["ff40e2e5.71fc2"]]},{"id":"59707f42.0b33d","type":"switch","z":"202da31a.94aadc","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":114,"y":809,"wires":[["e3b0edfa.89116"],["ff40e2e5.71fc2"]]},{"id":"e3b0edfa.89116","type":"function","z":"202da31a.94aadc","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":117,"y":745,"wires":[["d8227f16.a74af"]]},{"id":"d8227f16.a74af","type":"http request","z":"202da31a.94aadc","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":109,"y":688,"wires":[["50412851.214b08"]]},{"id":"50412851.214b08","type":"function","z":"202da31a.94aadc","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":104,"y":631,"wires":[["75d3f3f6.a3292c"]]},{"id":"75d3f3f6.a3292c","type":"switch","z":"202da31a.94aadc","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":118,"y":582,"wires":[["d3bce93c.4b9b18"],["73aff8fc.d29448"]]},{"id":"ff40e2e5.71fc2","type":"function","z":"202da31a.94aadc","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":362,"y":847,"wires":[["73aff8fc.d29448"]]},{"id":"73aff8fc.d29448","type":"http response","z":"202da31a.94aadc","name":"","statusCode":"","headers":{},"x":970.5,"y":832,"wires":[]},{"id":"d3bce93c.4b9b18","type":"function","z":"202da31a.94aadc","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":118,"y":531,"wires":[["28e25569.bd45aa"]]},{"id":"88d2a845.2014c8","type":"function","z":"202da31a.94aadc","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":427,"y":617,"wires":[["73aff8fc.d29448"]]},{"id":"28e25569.bd45aa","type":"switch","z":"202da31a.94aadc","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":121,"y":481,"wires":[["ab932076.dbc67"],["88d2a845.2014c8"]]},{"id":"28fb3291.6b5bfe","type":"function","z":"202da31a.94aadc","name":"set success result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'publish success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":906,"y":722,"wires":[["73aff8fc.d29448"]]},{"id":"528bd36.305202c","type":"comment","z":"68e5277d.892928","name":"mes-svc","info":"","x":1280,"y":260,"wires":[]},{"id":"f4d0a2d8.5e3e8","type":"comment","z":"68e5277d.892928","name":"mes-svc","info":"","x":721,"y":410,"wires":[]},{"id":"46150ae2.a1a2c4","type":"function","z":"202da31a.94aadc","name":"check db data","func":"let actInfo = msg['actInfo']\nlet newPayload = {}\nlet tagId = eval('/'+actInfo.data.extra.fport+'_'+actInfo.data.extra.frameCnt+'_'+actInfo.data.macAddr+'_'+'/i')\nnewPayload['_id'] = tagId\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":387,"y":127,"wires":[["40610483.1f1a5c"]]},{"id":"40610483.1f1a5c","type":"mongodb in","z":"202da31a.94aadc","mongodb":"f9ed3ab1.0debf8","name":"find devices","collection":"devices","operation":"find","x":494,"y":177,"wires":[["93550ace.89ba58"]]},{"id":"93550ace.89ba58","type":"switch","z":"202da31a.94aadc","name":"check data exist","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":581,"y":120,"wires":[["be123e80.24c038"],["e0ef691d.91a318"]]},{"id":"e0ef691d.91a318","type":"function","z":"202da31a.94aadc","name":"set duplicate data","func":"let newPayload = {}\nnewPayload['responseMsg'] = 'duplicate frameCnt'\nnewPayload['responseCode'] = '404'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":784,"y":161,"wires":[["c1be0257.68ff4"]]},{"id":"7d767fef.86b5e","type":"switch","z":"3873e5c5.abbcfa","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":191,"y":1420,"wires":[["2a5fc9d7.02c916"],["d61a2bbd.1e2928"]]},{"id":"82c5ee4b.69677","type":"switch","z":"3873e5c5.abbcfa","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":204,"y":429,"wires":[["ddc8f5e9.2f2f78"],["bd52f3c2.cf406"]]},{"id":"c2695be8.259358","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":410,"y":520,"wires":[]},{"id":"e9d766c0.cc0b58","type":"debug","z":"202da31a.94aadc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":354.5,"y":889,"wires":[]},{"id":"92ae86be.6de948","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":777.5,"y":1425,"wires":[]},{"id":"ff3d5d5e.2ce31","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1003.5,"y":26,"wires":[]},{"id":"a5531dcd.8042b","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1858.5,"y":375,"wires":[]},{"id":"d05e1a2.80df2e8","type":"switch","z":"68e5277d.892928","name":"check queryTsFlg","property":"queryTsFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":582.5,"y":119,"wires":[["4d59bc94.b76534"],["f296ab30.845948"]]},{"id":"f296ab30.845948","type":"function","z":"68e5277d.892928","name":"get scale info last 1","func":"//query by time period and find max value\nif(msg['queryTsFlg']){\n  let newPayload = []\n  let match = {}\n  let matchAnd = {}\n  let matchArray = []\n  let matchMac = {}\n  let matchRecv = {}\n  let cond = {}\n  let maxNW = {}\n  let grp = {}\n  \n  matchMac['macAddr']=msg.payload[0].macAddr\n  matchArray.push(matchMac)\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['scaleSt'])\n  dateCond['$lte'] = new Date()\n  matchRecv['recv'] = dateCond\n  \n  matchArray.push(matchRecv)\n  matchAnd['$and'] = matchArray\n  match['$match'] = matchAnd\n  \n  maxNW['$max'] = '$information.NW'\n  grp['_id'] = null\n  grp['maxNW'] = maxNW\n  cond['$group'] = grp\n  \n  newPayload.push(match)\n  newPayload.push(cond)\n  msg.payload = newPayload\n} else {\n  let newPayload = {}\n  newPayload['macAddr'] = msg.payload[0].macAddr\n  let sort = {}\n  sort['recv'] = -1\n  msg['limit'] = 1\n  msg['sort'] = sort\n  msg.payload = newPayload\n}\nreturn msg","outputs":1,"noerr":0,"x":717.5,"y":153,"wires":[["e49242ae.de8bf"]]},{"id":"e49242ae.de8bf","type":"mongodb in","z":"68e5277d.892928","mongodb":"f9ed3ab1.0debf8","name":"find raw data","collection":"devices","operation":"find","x":816,"y":115,"wires":[["1eb08056.0bb48"]]},{"id":"35cb8d49.83b282","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rptCnt","method":"get","upload":false,"swaggerDoc":"","x":209.5,"y":650,"wires":[["587b282d.a38208"]]},{"id":"51b19b5e.3e7574","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":196,"y":393,"wires":[["8f7fa6e6.72a2a8"],["a37e26e1.4a7a78"]]},{"id":"8f7fa6e6.72a2a8","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":198,"y":341,"wires":[["71fc1b5e.f29724"]]},{"id":"71fc1b5e.f29724","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":187,"y":294,"wires":[["c29a2078.712b1"]]},{"id":"c29a2078.712b1","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":184,"y":240,"wires":[["c07124e6.6e1b58"],["ab1ef86e.8e0418"]]},{"id":"c07124e6.6e1b58","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":186.77779388427734,"y":189.22219848632812,"wires":[["be273379.da461"]]},{"id":"be273379.da461","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":178.99999237060547,"y":129.44444370269775,"wires":[["a37e26e1.4a7a78"],["11ccd8e0.2413a7"]]},{"id":"11ccd8e0.2413a7","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":488.88885498046875,"y":237.77780151367188,"wires":[["ab1ef86e.8e0418"]]},{"id":"a37e26e1.4a7a78","type":"function","z":"5ba94578.282c1c","name":"set search cond to get cnt","func":"let obj = msg['actInfo']\nlet newPayload = {}\nif(obj.periodType !== undefined ){\n  newPayload['periodType'] = obj.periodType    \n}\nif(obj.reportType !== undefined ){\n  newPayload['reportType'] = obj.reportType    \n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = Math.floor(new Date(msg['from']).getTime()/1000)\n  dateCond['$lte'] = Math.floor(new Date(msg['to']).getTime()/1000)\n  newPayload['createTs'] = dateCond\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":485,"y":123,"wires":[["2890ce81.d2da12"]]},{"id":"ab1ef86e.8e0418","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1295.5,"y":316,"wires":[]},{"id":"587b282d.a38208","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":205,"y":595,"wires":[["c94518b3.a34858"],["79899c6c.00ae74"]]},{"id":"79899c6c.00ae74","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":678,"y":560,"wires":[["ab1ef86e.8e0418"]]},{"id":"45bf9c97.933214","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rpt","method":"get","upload":false,"swaggerDoc":"","x":237,"y":1346,"wires":[["414bbef5.3b886"]]},{"id":"d3c0ed8e.dc382","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":240.5,"y":1044,"wires":[["e63a731.2ad699"],["42f6b194.a4f3e"]]},{"id":"e63a731.2ad699","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":242.5,"y":980,"wires":[["dc98ea02.9b03e8"]]},{"id":"dc98ea02.9b03e8","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":231.5,"y":935,"wires":[["f711744b.dd8ee8"]]},{"id":"f711744b.dd8ee8","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":228.5,"y":890,"wires":[["8dd0574d.25e998"],["798378d0.e38f98"]]},{"id":"8dd0574d.25e998","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":227.27779388427734,"y":826.2221984863281,"wires":[["d85e4945.664fb8"]]},{"id":"d85e4945.664fb8","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":219.49999237060547,"y":766.4444437026978,"wires":[["42f6b194.a4f3e"],["535b480e.579e98"]]},{"id":"535b480e.579e98","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":529.3888549804688,"y":874.7778015136719,"wires":[["798378d0.e38f98"]]},{"id":"42f6b194.a4f3e","type":"function","z":"5ba94578.282c1c","name":"set search cond to get data","func":"let obj = msg['actInfo']\nlet newPayload = {}\nif(obj.periodType !== undefined ){\n  newPayload['periodType'] = obj.periodType    \n}\nif(obj.reportType !== undefined ){\n  newPayload['reportType'] = obj.reportType    \n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = Math.floor(new Date(msg['from']).getTime()/1000)\n  dateCond['$lte'] = Math.floor(new Date(msg['to']).getTime()/1000)\n  newPayload['createTs'] = dateCond\n}\nlet paginate = true\n\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['createTs'] = -1\nif(obj.sort && obj.sort == 'asc'){\n  sort['createTs'] = 1\n}\nmsg['sort'] = sort\nobj['next'] = nextPage\nobj['previous'] = previous\nobj['page_limit'] = Number(page_limit)\nmsg['actInfo'] = obj\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":535.5,"y":760,"wires":[["6a975697.7bd608"]]},{"id":"798378d0.e38f98","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1403,"y":965,"wires":[]},{"id":"414bbef5.3b886","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":244.5,"y":1284,"wires":[["1f46b662.d135ba"],["31ccda12.d633a6"]]},{"id":"31ccda12.d633a6","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":601.5,"y":1244,"wires":[["798378d0.e38f98"]]},{"id":"2890ce81.d2da12","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report Cnt","collection":"report_config","operation":"count","x":752,"y":122,"wires":[["e2804630.a90a68"]]},{"id":"76b674df.f27f0c","type":"switch","z":"5ba94578.282c1c","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":197,"y":498,"wires":[["45535da9.f05cf4"],["e77fb987.c6a998"]]},{"id":"e77fb987.c6a998","type":"moment","z":"5ba94578.282c1c","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":446,"y":474.5999755859375,"wires":[["45535da9.f05cf4"]]},{"id":"45535da9.f05cf4","type":"switch","z":"5ba94578.282c1c","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":196.5,"y":446.79998779296875,"wires":[["51b19b5e.3e7574"],["9cf9587e.0ee148"]]},{"id":"9cf9587e.0ee148","type":"moment","z":"5ba94578.282c1c","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":430.5,"y":400.3999938964844,"wires":[["51b19b5e.3e7574"]]},{"id":"e2804630.a90a68","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['size'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1104.222412109375,"y":121.66665649414062,"wires":[["ab1ef86e.8e0418"]]},{"id":"7dabe599.f9f65c","type":"switch","z":"5ba94578.282c1c","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":251,"y":1160,"wires":[["cec636ff.c6e568"],["5b158263.e94dfc"]]},{"id":"cec636ff.c6e568","type":"switch","z":"5ba94578.282c1c","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":243.5,"y":1104.7999267578125,"wires":[["d3c0ed8e.dc382"],["a471b02e.9403e"]]},{"id":"a471b02e.9403e","type":"moment","z":"5ba94578.282c1c","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":490.5,"y":1074.4000244140625,"wires":[["d3c0ed8e.dc382"]]},{"id":"5b158263.e94dfc","type":"moment","z":"5ba94578.282c1c","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":499,"y":1150.5999755859375,"wires":[["cec636ff.c6e568"]]},{"id":"6a975697.7bd608","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report config","collection":"report_config","operation":"find","x":789,"y":758,"wires":[["c7e1a54c.9dcea8"]]},{"id":"c7e1a54c.9dcea8","type":"switch","z":"5ba94578.282c1c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":994,"y":777,"wires":[["ae8d69c5.1c5148"],["8b098583.61ba18"]]},{"id":"8b098583.61ba18","type":"function","z":"5ba94578.282c1c","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1035.000099182129,"y":876.5555610656738,"wires":[["798378d0.e38f98"]]},{"id":"ae8d69c5.1c5148","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let obj = msg['actInfo']\nlet newPayload = {}\nlet pageInfo = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\npageInfo['next'] = obj['next']\npageInfo['previous'] = obj['previous']\npageInfo['limit'] = obj['page_limit']\nnewPayload['pages'] = pageInfo\nnewPayload['data'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1167.222412109375,"y":750.6666564941406,"wires":[["798378d0.e38f98"]]},{"id":"c94518b3.a34858","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":200,"y":550,"wires":[["76b674df.f27f0c"]]},{"id":"1f46b662.d135ba","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":267,"y":1221,"wires":[["7dabe599.f9f65c"]]},{"id":"861637d2.34e408","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rpt/:id","method":"get","upload":false,"swaggerDoc":"","x":266.6666564941406,"y":1906.6666259765625,"wires":[["1647a4bc.f348cb"]]},{"id":"8cca1bde.94bc58","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":275.1666564941406,"y":1734.6666259765625,"wires":[["4f11c48c.4cc9cc"],["d775498e.222238"]]},{"id":"4f11c48c.4cc9cc","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":277.1666564941406,"y":1670.6666259765625,"wires":[["d3c04220.6438d"]]},{"id":"d3c04220.6438d","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":266.1666564941406,"y":1625.6666259765625,"wires":[["935fac1f.896a2"]]},{"id":"935fac1f.896a2","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":263.1666564941406,"y":1580.6666259765625,"wires":[["1984f6b3.1cecc9"],["9f360109.9290e"]]},{"id":"1984f6b3.1cecc9","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":261.94445037841797,"y":1516.8888244628906,"wires":[["dd522caf.3514a"]]},{"id":"dd522caf.3514a","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":254.1666488647461,"y":1457.1110696792603,"wires":[["d775498e.222238"],["ccdba610.4d60f8"]]},{"id":"ccdba610.4d60f8","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":564.0555114746094,"y":1565.4444274902344,"wires":[["9f360109.9290e"]]},{"id":"d775498e.222238","type":"function","z":"5ba94578.282c1c","name":"set search cond to get data","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['_id'] = obj['reportId']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":550.1666564941406,"y":1450.6666259765625,"wires":[["50be3143.5da9f"]]},{"id":"9f360109.9290e","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1437.6666564941406,"y":1655.6666259765625,"wires":[]},{"id":"1647a4bc.f348cb","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":264.1666564941406,"y":1844.6666259765625,"wires":[["56fcf0f6.d007c"],["e9d8bcc1.68e2d"]]},{"id":"e9d8bcc1.68e2d","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":627.1666259765625,"y":1754.6666259765625,"wires":[["9f360109.9290e"]]},{"id":"2e5fe56e.48bbba","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report config","collection":"report_config","operation":"find","x":916.6666870117188,"y":1441.6666259765625,"wires":[["4749a03d.d3c6c"]]},{"id":"4749a03d.d3c6c","type":"switch","z":"5ba94578.282c1c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1083.6666870117188,"y":1446.6666259765625,"wires":[["3b8d6d6.4a28e92"],["2e57b28f.552ece"]]},{"id":"2e57b28f.552ece","type":"function","z":"5ba94578.282c1c","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1181.666748046875,"y":1508.22216796875,"wires":[["9f360109.9290e"]]},{"id":"3b8d6d6.4a28e92","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let obj = msg['actInfo']\nlet dataObj = msg.payload[0]\nlet newPayload = {}\nif(obj.locale == undefined){\n  obj.locale = 'zh-Hans'\n}\nif(obj.locale !== 'all'){\n  let title = dataObj['reportTitle']\n  let headers = dataObj['reportHeader']\n  let newHeaders = []\n  dataObj['reportTitle'] = title[obj.locale]\n  for(let i = 0 ; i < headers.length ; i++){\n    let headObj = headers[i]\n    headObj.name = headers[i].name[obj.locale]\n    newHeaders.push(headObj)\n  }\n  dataObj['reportHeader'] = newHeaders\n}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['data'] = dataObj\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1280.8890380859375,"y":1457.333251953125,"wires":[["9f360109.9290e"]]},{"id":"56fcf0f6.d007c","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg.payload['reportId'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":286.6666564941406,"y":1781.6666259765625,"wires":[["8cca1bde.94bc58"]]},{"id":"50be3143.5da9f","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"_id","x":740.5,"y":1449,"wires":[["2e5fe56e.48bbba"]]},{"id":"58680e6e.fbf4d","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rptData/:id","method":"get","upload":false,"swaggerDoc":"","x":298.33331298828125,"y":2495.66650390625,"wires":[["27b94f1.22b02b"]]},{"id":"78741fb1.39a52","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":296.83331298828125,"y":2289.66650390625,"wires":[["8bb6d357.c9ee6"],["105e4f0b.9767c1"]]},{"id":"8bb6d357.c9ee6","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":298.83331298828125,"y":2225.66650390625,"wires":[["c260b863.81b9c8"]]},{"id":"c260b863.81b9c8","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":287.83331298828125,"y":2180.66650390625,"wires":[["22a4bcd7.c341b4"]]},{"id":"22a4bcd7.c341b4","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":284.83331298828125,"y":2135.66650390625,"wires":[["9b4b6af7.82f0e8"],["1fb662c3.424ebd"]]},{"id":"9b4b6af7.82f0e8","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":283.6111068725586,"y":2071.888702392578,"wires":[["fbd4f684.7b23e8"]]},{"id":"fbd4f684.7b23e8","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":275.8333053588867,"y":2012.1109476089478,"wires":[["105e4f0b.9767c1"],["6ed9101d.1e9f2"]]},{"id":"6ed9101d.1e9f2","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":585.72216796875,"y":2120.444305419922,"wires":[["1fb662c3.424ebd"]]},{"id":"105e4f0b.9767c1","type":"function","z":"5ba94578.282c1c","name":"set search config_id to get data","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['config_id'] = obj['reportId']\nnewPayload['period'] = obj['period']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":581.8333129882812,"y":2005.66650390625,"wires":[["55568380.1cabdc"]]},{"id":"1fb662c3.424ebd","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1459.3333129882812,"y":2210.66650390625,"wires":[]},{"id":"9791c931.5c3448","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":285.83331298828125,"y":2399.66650390625,"wires":[["2974e19f.01fa1e"],["a533465a.841fe8"]]},{"id":"a533465a.841fe8","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":648.8332824707031,"y":2309.66650390625,"wires":[["1fb662c3.424ebd"]]},{"id":"4f75f0fc.5f57e","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report data","collection":"report_data","operation":"find","x":992.3333740234375,"y":1917.66650390625,"wires":[["b1e896b7.aac1a8","f2a802d.2f8cd"]]},{"id":"b1e896b7.aac1a8","type":"switch","z":"5ba94578.282c1c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1105.3333435058594,"y":2001.66650390625,"wires":[["c39b16af.505838"],["25fa33b7.a85afc"]]},{"id":"25fa33b7.a85afc","type":"function","z":"5ba94578.282c1c","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1203.3334045410156,"y":2063.2220458984375,"wires":[["1fb662c3.424ebd"]]},{"id":"c39b16af.505838","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let obj = msg['actInfo']\nlet newPayload = {}\nlet pageInfo = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['rpt'] = msg.payload[0]\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1302.5556945800781,"y":2012.3331298828125,"wires":[["1fb662c3.424ebd"]]},{"id":"2974e19f.01fa1e","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg.payload['reportId'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":308.33331298828125,"y":2336.66650390625,"wires":[["78741fb1.39a52"]]},{"id":"55568380.1cabdc","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"config_id","x":800.1666259765625,"y":2005.9998779296875,"wires":[["4f75f0fc.5f57e","f2a802d.2f8cd"]]},{"id":"27b94f1.22b02b","type":"switch","z":"5ba94578.282c1c","name":"check period exists","property":"payload.period","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":294,"y":2447,"wires":[["9791c931.5c3448"],["a533465a.841fe8"]]},{"id":"f2a802d.2f8cd","type":"debug","z":"5ba94578.282c1c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":994.5,"y":2092,"wires":[]},{"id":"731f77c0.09cbc8","type":"catch","z":"5ba94578.282c1c","name":"","scope":["50be3143.5da9f","684e29ad.9c30a8","7aec24bd.0fa42c","55568380.1cabdc","6c534ae5.fe0234","22f15432.ce2ddc","cbebfb5a.016938"],"x":980.5,"y":2339,"wires":[["82075b83.0e5418"]]},{"id":"82075b83.0e5418","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'ObjId invalid'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1231,"y":2283,"wires":[["1fb662c3.424ebd"]]},{"id":"21386676.b8c20a","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rpt","method":"post","upload":false,"swaggerDoc":"","x":291.6666717529297,"y":3118.6664638519287,"wires":[["b66eef53.e8b5f"]]},{"id":"cefe2994.118cb8","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":315.1666564941406,"y":2924.66650390625,"wires":[["98f708ee.c96aa8"],["40c2c107.9aeff"]]},{"id":"98f708ee.c96aa8","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":317.1666564941406,"y":2860.66650390625,"wires":[["c6ca4921.bfbca8"]]},{"id":"c6ca4921.bfbca8","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":306.1666564941406,"y":2815.66650390625,"wires":[["73572c5b.612e44"]]},{"id":"73572c5b.612e44","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":303.1666564941406,"y":2770.66650390625,"wires":[["65fb71a1.66a0a"],["c45ea99c.6ec538"]]},{"id":"65fb71a1.66a0a","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":301.94445037841797,"y":2706.888702392578,"wires":[["a6451962.2c5a88"]]},{"id":"a6451962.2c5a88","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":294.1666488647461,"y":2647.1109476089478,"wires":[["40c2c107.9aeff"],["d1b8e624.3c2538"]]},{"id":"d1b8e624.3c2538","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":604.0555114746094,"y":2755.444305419922,"wires":[["c45ea99c.6ec538"]]},{"id":"c45ea99c.6ec538","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1477.6666564941406,"y":2845.66650390625,"wires":[]},{"id":"b66eef53.e8b5f","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":299.1666717529297,"y":3056.6664638519287,"wires":[["4e09d2b0.d697cc"],["faa99f11.39183"]]},{"id":"faa99f11.39183","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":679.4999465942383,"y":3004.666627496481,"wires":[["c45ea99c.6ec538"]]},{"id":"fb06d979.d21328","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report config","collection":"report_config","operation":"find","x":863.6666564941406,"y":2638.66650390625,"wires":[["c2d12bdb.ff8fd8"]]},{"id":"c2d12bdb.ff8fd8","type":"switch","z":"5ba94578.282c1c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1053.6667289733887,"y":2642.666527748108,"wires":[["725d5c0b.aab704"],["50aea8d3.a1dea8"]]},{"id":"50aea8d3.a1dea8","type":"function","z":"5ba94578.282c1c","name":"set binding result","func":"let newPayload = {}\nnewPayload['responseCode'] = '500'\nnewPayload['responseMsg'] = 'worker already bind'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1119.6667556762695,"y":2757.222064971924,"wires":[["c45ea99c.6ec538"]]},{"id":"46b521aa.4f21f","type":"function","z":"5ba94578.282c1c","name":"set insert obj","func":"let obj = msg['actInfo']\nobj['createTs'] = Math.floor(msg['nowTs'] / 1000)\nobj['createTime'] = msg['dateStr']\ndelete obj['token']\nmsg['payload'] = obj\nreturn msg","outputs":1,"noerr":0,"x":1496.8890075683594,"y":2617.99986076355,"wires":[["8e3ddfa9.91855","db768e3d.33b27"]]},{"id":"4e09d2b0.d697cc","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":321.6666717529297,"y":2993.6664638519287,"wires":[["cefe2994.118cb8"]]},{"id":"aeade34c.737a5","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rpt/:id","method":"put","upload":false,"swaggerDoc":"","x":311.6666793823242,"y":3749.9997425079346,"wires":[["14e20a2c.291116"]]},{"id":"c0a41840.400f68","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":326.8333435058594,"y":3572.9998989105225,"wires":[["53c8cd7.6545434"],["8fa78b47.7082d8"]]},{"id":"53c8cd7.6545434","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":325.5,"y":3525.66650390625,"wires":[["db13a83d.3ba918"]]},{"id":"db13a83d.3ba918","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":314.5,"y":3480.66650390625,"wires":[["bf3112c2.7d81"]]},{"id":"bf3112c2.7d81","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":311.5,"y":3435.66650390625,"wires":[["aba19d9f.5a891"],["a15912a.0f88af"]]},{"id":"aba19d9f.5a891","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":310.27779388427734,"y":3371.888702392578,"wires":[["8be6353f.6179c8"]]},{"id":"8be6353f.6179c8","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":302.49999237060547,"y":3312.1109476089478,"wires":[["8fa78b47.7082d8"],["95f0736b.d9a72"]]},{"id":"95f0736b.d9a72","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":612.3888549804688,"y":3420.444305419922,"wires":[["a15912a.0f88af"]]},{"id":"a15912a.0f88af","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1486,"y":3510.66650390625,"wires":[]},{"id":"14e20a2c.291116","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":309.1666793823242,"y":3687.9997425079346,"wires":[["5285cbc5.6e3634"],["4198fcbf.9d3884"]]},{"id":"4198fcbf.9d3884","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":689.5000305175781,"y":3626.333240509033,"wires":[["a15912a.0f88af"]]},{"id":"eaafc3b0.4e4dd","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report config","collection":"report_config","operation":"find","x":1038.666618347168,"y":3263.6663904190063,"wires":[["41768514.f89c2c"]]},{"id":"41768514.f89c2c","type":"switch","z":"5ba94578.282c1c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1077,"y":3322.66650390625,"wires":[["31934846.a8ee58"],["8552625d.918fa"]]},{"id":"8552625d.918fa","type":"function","z":"5ba94578.282c1c","name":"set empty result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'update obj not exist'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1268.0001678466797,"y":3388.888807296753,"wires":[["a15912a.0f88af"]]},{"id":"35b7afe3.f09d8","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1640.2223091125488,"y":3289.6666383743286,"wires":[["a15912a.0f88af"]]},{"id":"5285cbc5.6e3634","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg.payload['reportId'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":331.6666793823242,"y":3624.9997425079346,"wires":[["c0a41840.400f68"]]},{"id":"e5e8cb75.2cd6d8","type":"http in","z":"5ba94578.282c1c","name":"","url":"/rpt/:id","method":"delete","upload":false,"swaggerDoc":"","x":329.99998474121094,"y":4460.000177383423,"wires":[["6c9a280.37f9dd8"]]},{"id":"30eb49b2.9e2106","type":"switch","z":"5ba94578.282c1c","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":330.1666564941406,"y":4278,"wires":[["ec8abb3a.954b48"],["38fd15de.5eb65a"]]},{"id":"ec8abb3a.954b48","type":"http request","z":"5ba94578.282c1c","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":332.1666564941406,"y":4214,"wires":[["2e8bb69a.fbecea"]]},{"id":"2e8bb69a.fbecea","type":"function","z":"5ba94578.282c1c","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":321.1666564941406,"y":4169,"wires":[["219667c8.0c8068"]]},{"id":"219667c8.0c8068","type":"switch","z":"5ba94578.282c1c","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":318.1666564941406,"y":4124,"wires":[["f08a9bff.3e0fa8"],["d0651ae4.152f28"]]},{"id":"f08a9bff.3e0fa8","type":"function","z":"5ba94578.282c1c","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":316.94445037841797,"y":4060.222198486328,"wires":[["42cd2328.60a22c"]]},{"id":"42cd2328.60a22c","type":"switch","z":"5ba94578.282c1c","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":309.1666488647461,"y":4000.4444437026978,"wires":[["38fd15de.5eb65a"],["48a445f6.7ea3ec"]]},{"id":"48a445f6.7ea3ec","type":"function","z":"5ba94578.282c1c","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":619.0555114746094,"y":4108.777801513672,"wires":[["d0651ae4.152f28"]]},{"id":"d0651ae4.152f28","type":"http response","z":"5ba94578.282c1c","name":"","statusCode":"","headers":{},"x":1492.6666564941406,"y":4199,"wires":[]},{"id":"6c9a280.37f9dd8","type":"switch","z":"5ba94578.282c1c","name":"check token exists","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":317.49998474121094,"y":4398.000177383423,"wires":[["380e4a0b.e49b26"],["86d6fea1.6d83d"]]},{"id":"86d6fea1.6d83d","type":"function","z":"5ba94578.282c1c","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":681.166633605957,"y":4351.333185195923,"wires":[["d0651ae4.152f28"]]},{"id":"c9a52cea.3c607","type":"mongodb in","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"find report config","collection":"report_config","operation":"find","x":865.3333511352539,"y":4013.6666622161865,"wires":[["597421a9.71dc8"]]},{"id":"597421a9.71dc8","type":"switch","z":"5ba94578.282c1c","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1057.0000038146973,"y":4010.9999961853027,"wires":[["e0342ed3.5b18b"],["d3cfe486.697388"]]},{"id":"d3cfe486.697388","type":"function","z":"5ba94578.282c1c","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'delete config not exist'\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1124.6667556762695,"y":4110.555561065674,"wires":[["d0651ae4.152f28"]]},{"id":"380e4a0b.e49b26","type":"function","z":"5ba94578.282c1c","name":"set para to obj","func":"msg.payload['reportId'] = msg.req.params.id\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":339.99998474121094,"y":4335.000177383423,"wires":[["30eb49b2.9e2106"]]},{"id":"8fa78b47.7082d8","type":"function","z":"5ba94578.282c1c","name":"set search _id to get config","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['_id'] = obj['reportId']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":600,"y":3258.333251953125,"wires":[["684e29ad.9c30a8"]]},{"id":"684e29ad.9c30a8","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"_id","x":818.3333129882812,"y":3258.6666259765625,"wires":[["eaafc3b0.4e4dd"]]},{"id":"38fd15de.5eb65a","type":"function","z":"5ba94578.282c1c","name":"set search _id to get config","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['_id'] = obj['reportId']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":593.3333206176758,"y":3968.333002090454,"wires":[["7aec24bd.0fa42c"]]},{"id":"7aec24bd.0fa42c","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"_id","x":861.6666259765625,"y":3940.3331298828125,"wires":[["c9a52cea.3c607"]]},{"id":"7b051249.f6e0fc","type":"mongodb out","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"","collection":"report_config","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":1390.833333333333,"y":3953.3333333333326,"wires":[]},{"id":"ab9517d5.7df178","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'delete success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1406.6666793823242,"y":4056.6664209365845,"wires":[["d0651ae4.152f28"]]},{"id":"c630a558.11ca68","type":"mongodb out","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"update config","collection":"report_config","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1979.9999084472656,"y":3083.3331356048584,"wires":[]},{"id":"40c2c107.9aeff","type":"function","z":"5ba94578.282c1c","name":"set search worker_id to get data","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['worker_id'] = obj['worker_id']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":618.3333129882812,"y":2586.66650390625,"wires":[["6c534ae5.fe0234"]]},{"id":"6c534ae5.fe0234","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"worker_id","x":836.6666259765625,"y":2586.9998779296875,"wires":[["fb06d979.d21328"]]},{"id":"8e3ddfa9.91855","type":"mongodb out","z":"5ba94578.282c1c","mongodb":"f9ed3ab1.0debf8","name":"insert config","collection":"report_config","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1693.333351135254,"y":2598.333110809326,"wires":[]},{"id":"db768e3d.33b27","type":"function","z":"5ba94578.282c1c","name":"set final result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'insert success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1576.6666412353516,"y":2708.3331155776978,"wires":[["c45ea99c.6ec538"]]},{"id":"22f15432.ce2ddc","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"worker_id","x":1263.3331451416016,"y":3158.333215713501,"wires":[["68c17607.5c2258"]]},{"id":"31934846.a8ee58","type":"function","z":"5ba94578.282c1c","name":"set worker_id","func":"let obj = msg['actInfo']\nlet newPayload = {}\nobj['_id'] = msg.payload[0]._id\nobj['createTs'] = msg.payload[0].createTs\nobj['createTime'] = msg.payload[0].createTime\nmsg['actInfo'] = obj\nnewPayload['worker_id'] = obj['worker_id']\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1278.3333129882812,"y":3231.6666259765625,"wires":[["22f15432.ce2ddc"]]},{"id":"68c17607.5c2258","type":"function","z":"5ba94578.282c1c","name":"set update obj and nowTs","func":"let obj = msg['actInfo']\nobj['worker_id'] = msg.payload['worker_id']\ndelete obj['reportId']\nmsg['actInfo'] = obj\nmsg['payload'] = Date.now()\nmsg['nowTs'] = msg['payload']\nreturn msg","outputs":1,"noerr":0,"x":1476.666603088379,"y":3131.6664657592773,"wires":[["d63dd797.b2bab8"]]},{"id":"6e58833b.23cd9c","type":"moment","z":"5ba94578.282c1c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Etc/UTC","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"dateStr","outputType":"msg","outTz":"Asia/Taipei","x":1288.333251953125,"y":2505,"wires":[["46b521aa.4f21f"]]},{"id":"9cb52dc1.2f97c","type":"function","z":"5ba94578.282c1c","name":"set nowTime","func":"let obj = msg['actInfo']\nobj['worker_id'] = msg.payload['worker_id']\ndelete obj['reportId']\nmsg['actInfo'] = obj\nlet nowTs = Date.now()\nmsg.payload = nowTs\nmsg['nowTs'] = nowTs\nreturn msg","outputs":1,"noerr":0,"x":1094.166648864746,"y":2506.666766166687,"wires":[["6e58833b.23cd9c"]]},{"id":"d63dd797.b2bab8","type":"moment","z":"5ba94578.282c1c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Etc/UTC","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD HH:mm:ss","locale":"en_US","output":"dateStr","outputType":"msg","outTz":"Asia/Taipei","x":1728.333251953125,"y":3041.66650390625,"wires":[["e1eb709b.02927"]]},{"id":"e1eb709b.02927","type":"function","z":"5ba94578.282c1c","name":"set update obj","func":"let obj = msg['actInfo']\nobj['updateTs'] = Math.floor(msg['nowTs'] / 1000)\nobj['updateTime'] = msg['dateStr']\ndelete obj['token']\nmsg['payload'] = obj\nreturn msg","outputs":1,"noerr":0,"x":1776.6666259765625,"y":3116.66650390625,"wires":[["c630a558.11ca68","35b7afe3.f09d8"]]},{"id":"725d5c0b.aab704","type":"function","z":"5ba94578.282c1c","name":"set worker_id","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['worker_id'] = obj['worker_id']\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1086.6666793823242,"y":2589.99986076355,"wires":[["cbebfb5a.016938"]]},{"id":"cbebfb5a.016938","type":"objectid","z":"5ba94578.282c1c","name":"","selectedProperty":"worker_id","x":1081.6665534973145,"y":2549.9999389648438,"wires":[["9cb52dc1.2f97c"]]},{"id":"e0342ed3.5b18b","type":"function","z":"5ba94578.282c1c","name":"set delete obj","func":"msg['payload'] = msg.payload[0]\nreturn msg","outputs":1,"noerr":0,"x":1116.6666259765625,"y":3889.999755859375,"wires":[["7b051249.f6e0fc","ab9517d5.7df178"]]},{"id":"d28a056d.d76af8","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1460.5,"y":1025,"wires":[]},{"id":"410a89cd.d03088","type":"http in","z":"b6dc1740.a5a938","name":"","url":"/showField","method":"get","upload":false,"swaggerDoc":"","x":180,"y":420,"wires":[["f1d9bb.1e439648"]]},{"id":"f1d9bb.1e439648","type":"switch","z":"b6dc1740.a5a938","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":163.5,"y":368.9999523162842,"wires":[["549bae2b.6d219"],["ace6a213.9923d"]]},{"id":"549bae2b.6d219","type":"function","z":"b6dc1740.a5a938","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":153.49999237060547,"y":327.99995136260986,"wires":[["377689a8.bd61f6"]]},{"id":"7937005b.4184d","type":"function","z":"b6dc1740.a5a938","name":"set search cond to get cnt","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport !== undefined){\n  newPayload['deviceType'] = obj.fport\n}\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":158.49999237060547,"y":122.99998188018799,"wires":[["dc72f5e3.e027b8"]]},{"id":"dc72f5e3.e027b8","type":"mongodb in","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"find show_field data Cnt","collection":"show_field","operation":"count","x":179.49999237060547,"y":69.99998188018799,"wires":[["3426101b.1cccb"]]},{"id":"ace6a213.9923d","type":"function","z":"b6dc1740.a5a938","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":465.50000762939453,"y":391.9999876022339,"wires":[["95e8d7cb.6387d8"]]},{"id":"95e8d7cb.6387d8","type":"http response","z":"b6dc1740.a5a938","name":"","statusCode":"","headers":{},"x":977,"y":309.999981880188,"wires":[]},{"id":"3426101b.1cccb","type":"switch","z":"b6dc1740.a5a938","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":351.50000381469727,"y":71.9999828338623,"wires":[["56b4b53f.fc819c"],["fd3b5ab9.ee5fa8"]]},{"id":"fd3b5ab9.ee5fa8","type":"function","z":"b6dc1740.a5a938","name":"set empty result","func":"let newPayload = {}\nlet dataList = []\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = 0\nnewPayload['data'] = dataList\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":521.5000076293945,"y":128.99998378753662,"wires":[["95e8d7cb.6387d8"]]},{"id":"56b4b53f.fc819c","type":"function","z":"b6dc1740.a5a938","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport){\n  newPayload['deviceType'] = obj.fport\n}\nlet paginate = true\nif(obj.paginate){\n  paginate = (obj.paginate === 'true')\n}\nlet page_limit = 10\nif(obj.limit){\n  page_limit = obj.limit\n}\nlet page = 1\nif(obj.page){\n  page = obj.page\n}\nlet offset = (page-1) * page_limit\nlet nextPage = Number(page) + 1\nlet previous = 1\nif(page != 1)\n  previous = Number(page)-1\nelse\n  previous = Number(page)\nif(paginate){\n  msg['limit'] = page_limit\n  msg['skip'] = offset\n}\nlet sort = {}\nsort['deviceType'] = 1\nif(obj.sort && obj.sort == 'desc'){\n  sort['deviceType'] = -1\n}\nmsg['sort'] = sort\nobj['next'] = nextPage\nobj['previous'] = previous\nobj['page_limit'] = page_limit\nobj['total'] = msg.payload\n// flow.set('actInfo', obj)\nmsg['actInfo'] = obj\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":552.5,"y":46.99998188018799,"wires":[["1c136f70.1d9701"]]},{"id":"1c136f70.1d9701","type":"mongodb in","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"find show_field data","collection":"show_field","operation":"find","x":812.5000114440918,"y":43.99998188018799,"wires":[["a7445ddc.20015"]]},{"id":"a7445ddc.20015","type":"function","z":"b6dc1740.a5a938","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nlet pageInfo = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = Number(obj['total'])\npageInfo['next'] = obj['next']\npageInfo['previous'] = obj['previous']\npageInfo['limit'] = obj['page_limit']\nnewPayload['pages'] = pageInfo\nnewPayload['data'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1084.5,"y":118.99998188018799,"wires":[["95e8d7cb.6387d8"]]},{"id":"dcf89ecf.82eb5","type":"http in","z":"b6dc1740.a5a938","name":"","url":"/showField","method":"post","upload":false,"swaggerDoc":"","x":156,"y":1014.4000444412231,"wires":[["c1d28175.1b2c9"]]},{"id":"c1d28175.1b2c9","type":"switch","z":"b6dc1740.a5a938","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":143.5,"y":966.799994468689,"wires":[["6464c8a1.65bb68"],["b9ad1a36.0756e8"]]},{"id":"629f4900.081478","type":"function","z":"b6dc1740.a5a938","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":133.49999237060547,"y":880.7999696731567,"wires":[["d75e87e8.784318"]]},{"id":"b9ad1a36.0756e8","type":"function","z":"b6dc1740.a5a938","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":450.50000762939453,"y":979.8000078201294,"wires":[["8dacd8ad.b022c8"]]},{"id":"8dacd8ad.b022c8","type":"http response","z":"b6dc1740.a5a938","name":"","statusCode":"","headers":{},"x":1540.9999885559082,"y":940.9999952316284,"wires":[]},{"id":"6464c8a1.65bb68","type":"switch","z":"b6dc1740.a5a938","name":"check data","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":142.5,"y":924.1999950408936,"wires":[["629f4900.081478"],["b9ad1a36.0756e8"]]},{"id":"e597b618.da0e18","type":"function","z":"b6dc1740.a5a938","name":"set fport to parameter","func":"let actInfo = msg['actInfo']\nif(actInfo.data.deviceType !== undefined){\n  msg['fport'] = actInfo.data.deviceType  \n}else{\n  msg['fport'] = 'NA'\n}\nreturn msg","outputs":1,"noerr":0,"x":150,"y":665.4000024795532,"wires":[["b43c946b.eb1788"]]},{"id":"b43c946b.eb1788","type":"switch","z":"b6dc1740.a5a938","name":"","property":"fport","propertyType":"msg","rules":[{"t":"neq","v":"NA","vt":"str"},{"t":"eq","v":"NA","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":347.00000381469727,"y":657.8000526428223,"wires":[["74d19b36.0e2304"],["5a2c0217.b3e52c"]]},{"id":"5a2c0217.b3e52c","type":"function","z":"b6dc1740.a5a938","name":"set deviceType error","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'DeviceType not exists'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":517.5000076293945,"y":702.1999673843384,"wires":[["8dacd8ad.b022c8"]]},{"id":"74d19b36.0e2304","type":"function","z":"b6dc1740.a5a938","name":"set search cond to get cnt","func":"let newPayload = {}\nnewPayload['deviceType'] = msg['fport']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":525.5000076293945,"y":615.5999660491943,"wires":[["f7485fb3.745b8"]]},{"id":"f7485fb3.745b8","type":"mongodb in","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"find show_field by deviceType","collection":"show_field","operation":"find","x":764.5,"y":564.9999904632568,"wires":[["ee92b8da.27e898"]]},{"id":"ee92b8da.27e898","type":"switch","z":"b6dc1740.a5a938","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":884.5,"y":618.9999914169312,"wires":[["dbd66a2a.d40b98"],["9a7ef20d.03d1a"]]},{"id":"91c53f10.ade41","type":"http in","z":"b6dc1740.a5a938","name":"","url":"/showField/:fport","method":"delete","upload":false,"swaggerDoc":"","x":173.5,"y":1616.800030708313,"wires":[["9d3fa7c5.32ff58"]]},{"id":"9d3fa7c5.32ff58","type":"switch","z":"b6dc1740.a5a938","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":144,"y":1558.800030708313,"wires":[["7d44c2e3.ff740c"],["6ebe1d85.4b7104"]]},{"id":"7d44c2e3.ff740c","type":"function","z":"b6dc1740.a5a938","name":"set para to obj","func":"msg.payload['fport'] = msg.req.params.fport\nmsg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg","outputs":1,"noerr":0,"x":139,"y":1511.800030708313,"wires":[["fb08a804.e84b88"]]},{"id":"14724fe8.fe438","type":"function","z":"b6dc1740.a5a938","name":"set search cond to get cnt","func":"let obj = msg['actInfo']\nlet newPayload = {}\nnewPayload['deviceType'] = obj.fport\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":155.99999237060547,"y":1289.8000240325928,"wires":[["b89113a3.96c35"]]},{"id":"b89113a3.96c35","type":"mongodb in","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"find show_field data Cnt","collection":"show_field","operation":"count","x":176.99999237060547,"y":1236.8000240325928,"wires":[["358e11c8.0d5bbe"]]},{"id":"6ebe1d85.4b7104","type":"function","z":"b6dc1740.a5a938","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":463.00000762939453,"y":1558.8000297546387,"wires":[["36ab2c8c.659404"]]},{"id":"358e11c8.0d5bbe","type":"switch","z":"b6dc1740.a5a938","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":349.00000381469727,"y":1238.800024986267,"wires":[["557b0148.99c28"],["c302f530.a2a6c8"]]},{"id":"c302f530.a2a6c8","type":"function","z":"b6dc1740.a5a938","name":"set empty result","func":"let newPayload = {}\nnewPayload['responseCode'] = '404'\nnewPayload['responseMsg'] = 'no maps to delete'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":519.0000076293945,"y":1295.8000259399414,"wires":[["36ab2c8c.659404"]]},{"id":"557b0148.99c28","type":"function","z":"b6dc1740.a5a938","name":"set search cond to get data","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.fport){\n  newPayload['deviceType'] = obj.fport\n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":550,"y":1213.8000240325928,"wires":[["aa9ab900.29c7d8","fc2942d4.a5d1d"]]},{"id":"fc2942d4.a5d1d","type":"function","z":"b6dc1740.a5a938","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'delete success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":798,"y":1321.8000259399414,"wires":[["36ab2c8c.659404"]]},{"id":"36ab2c8c.659404","type":"http response","z":"b6dc1740.a5a938","name":"","statusCode":"","headers":{},"x":898.0000123977661,"y":1470.4000520706177,"wires":[]},{"id":"aa9ab900.29c7d8","type":"mongodb out","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"remove show_field by fport","collection":"show_field","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":835.0000114440918,"y":1202.0000486373901,"wires":[]},{"id":"9a7ef20d.03d1a","type":"function","z":"b6dc1740.a5a938","name":"set info to insert","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nobj.data['createTime'] = new Date()\nnewPayload = obj['data']\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1009.5,"y":659.7999696731567,"wires":[["3d857c1b.84d7f4","759b8da5.4b04f4"]]},{"id":"3d857c1b.84d7f4","type":"mongodb out","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"insert show_field info","collection":"show_field","payonly":true,"upsert":false,"multi":false,"operation":"insert","x":1288.5,"y":659.7999696731567,"wires":[]},{"id":"759b8da5.4b04f4","type":"function","z":"b6dc1740.a5a938","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'insert success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1083.499984741211,"y":750.9999914169312,"wires":[["8dacd8ad.b022c8"]]},{"id":"bb1a71e6.4e2e2","type":"mongodb out","z":"b6dc1740.a5a938","mongodb":"f9ed3ab1.0debf8","name":"upadte show_field info","collection":"show_field","payonly":true,"upsert":false,"multi":true,"operation":"store","x":1317.0999946594238,"y":530.9999899864197,"wires":[]},{"id":"dbd66a2a.d40b98","type":"function","z":"b6dc1740.a5a938","name":"set info to update","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nobj.data['updateTime'] = new Date()\nnewPayload = obj['data']\nnewPayload['_id'] = msg.payload[0]._id\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1081.1000671386719,"y":580.9999895095825,"wires":[["bb1a71e6.4e2e2","22af1485.a3cf1c"]]},{"id":"22af1485.a3cf1c","type":"function","z":"b6dc1740.a5a938","name":"set final result","func":"// let obj = flow.get('actInfo')\nlet newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'update success'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1294.0999908447266,"y":601.9999904632568,"wires":[["8dacd8ad.b022c8"]]},{"id":"fb08a804.e84b88","type":"http request","z":"b6dc1740.a5a938","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":135.5,"y":1462.999981880188,"wires":[["4d98cb29.309db4"]]},{"id":"4d98cb29.309db4","type":"function","z":"b6dc1740.a5a938","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":130.5,"y":1405.999981880188,"wires":[["6ee18db1.7489f4"]]},{"id":"6ee18db1.7489f4","type":"switch","z":"b6dc1740.a5a938","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":129.5,"y":1356.999981880188,"wires":[["14724fe8.fe438"],["36ab2c8c.659404"]]},{"id":"d75e87e8.784318","type":"http request","z":"b6dc1740.a5a938","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":135.5,"y":834.999981880188,"wires":[["4c374feb.c3fb6"]]},{"id":"4c374feb.c3fb6","type":"function","z":"b6dc1740.a5a938","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":130.5,"y":777.999981880188,"wires":[["e2820cf3.f4909"]]},{"id":"e2820cf3.f4909","type":"switch","z":"b6dc1740.a5a938","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":129.5,"y":728.999981880188,"wires":[["e597b618.da0e18"],["60e9b52.710fb4c"]]},{"id":"60e9b52.710fb4c","type":"http response","z":"b6dc1740.a5a938","name":"","statusCode":"","headers":{},"x":335,"y":726.999981880188,"wires":[]},{"id":"377689a8.bd61f6","type":"http request","z":"b6dc1740.a5a938","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":149.5,"y":277.999981880188,"wires":[["d75da9cc.73e968"]]},{"id":"d75da9cc.73e968","type":"function","z":"b6dc1740.a5a938","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":144.5,"y":220.999981880188,"wires":[["c5cf784c.028088"]]},{"id":"c5cf784c.028088","type":"switch","z":"b6dc1740.a5a938","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":143.5,"y":171.999981880188,"wires":[["7937005b.4184d"],["95e8d7cb.6387d8"]]},{"id":"31e89325.cb943c","type":"subflow:3a7f9ba4.31ba74","z":"68e5277d.892928","name":"","x":200,"y":540,"wires":[["3cbb7175.ef0f6e","c2695be8.259358"]]},{"id":"3cbb7175.ef0f6e","type":"switch","z":"68e5277d.892928","name":"","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":480,"wires":[["ae1c30d2.babcf"],["b488013a.e28a5"]]},{"id":"b488013a.e28a5","type":"function","z":"68e5277d.892928","name":"set error position result","func":"let newPayload = {}\nnewPayload['responseCode'] = '500'\nnewPayload['responseMsg'] = 'tag check error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":590,"y":480,"wires":[["988600d6.81416","80fce923.19d238"]]},{"id":"7c95a86d.0bc3d8","type":"function","z":"3a7f9ba4.31ba74","name":"set check data","func":"let actInfo = msg['actInfo']\nlet tagInfo = msg['tagInfo']\nlet newPayload = {}\nnewPayload['loc_code'] = actInfo.data.macAddr\nnewPayload['order'] = tagInfo.val\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":270,"y":120,"wires":[["9d9fe993.98dd88"]]},{"id":"9d9fe993.98dd88","type":"mongodb in","z":"3a7f9ba4.31ba74","mongodb":"f9ed3ab1.0debf8","name":"find track current loc","collection":"checkTagInfo","operation":"find","x":500,"y":120,"wires":[["b68708cf.65db28"]]},{"id":"b68708cf.65db28","type":"switch","z":"3a7f9ba4.31ba74","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"lte","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":120,"wires":[["97112fd5.eadf2"],["421c636a.3ee44c"]]},{"id":"97112fd5.eadf2","type":"function","z":"3a7f9ba4.31ba74","name":"set check fail or success when meta.type == 'mac'","func":"let newPayload = {}\nlet meta = msg['meta']\nif (meta.type == 'mac') {\n  newPayload['responseCode'] = '000'  \n} else {\n  newPayload['responseCode'] = '404'    \n}\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1030,"y":80,"wires":[[]]},{"id":"421c636a.3ee44c","type":"function","z":"3a7f9ba4.31ba74","name":"set check success","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1030,"y":160,"wires":[[]]},{"id":"3e1d3107.ee979e","type":"function","z":"610f0de2.4586f4","name":"set payload to mqtt server","func":"let newPayloads = []\nlet newPayload = {}\nlet extraInfo = {}\nlet actInfo = msg['actInfo']\nlet tagInfo = msg['tagInfo']\nlet checkResult = msg.payload.responseCode == '500'? 'AA008E':'AA018E'\nlet receiveTime = actInfo.data.timestamp\nlet publishTime = Date.now()\nlet delayFlg = true\nif(publishTime - receiveTime > 1000)\n  delayFlg = false\nnewPayload['macAddr'] = actInfo.data.information.moduleMac\nnewPayload['data'] = checkResult\nnewPayload['id'] = 'aaa'\nextraInfo['port'] = 170\nextraInfo['txpara'] = '22'\nnewPayload['extra'] = extraInfo\nnewPayloads.push(newPayload)\nmsg.payload = newPayloads\nmsg['topic'] = 'GIOT-GW/DL/' + actInfo.data.extra.gwid\nmsg['delayFlg'] = delayFlg\nreturn msg","outputs":1,"noerr":0,"x":340,"y":220,"wires":[["5872e7d5.4b5b18"]]},{"id":"80fce923.19d238","type":"subflow:610f0de2.4586f4","z":"68e5277d.892928","name":"","x":1410,"y":400,"wires":[]},{"id":"f7188441.cf6f28","type":"mqtt out","z":"610f0de2.4586f4","name":"","topic":"","qos":"1","retain":"true","broker":"faa8fb6d.20bf28","x":970,"y":220,"wires":[]},{"id":"b2089db1.0f7f3","type":"debug","z":"68e5277d.892928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":400,"y":1260,"wires":[]},{"id":"5872e7d5.4b5b18","type":"switch","z":"610f0de2.4586f4","name":"check delayFlg","property":"delayFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":600,"y":220,"wires":[["27b4743b.8bb81c"],["f7188441.cf6f28"]]},{"id":"27b4743b.8bb81c","type":"delay","z":"610f0de2.4586f4","name":"","pauseType":"delay","timeout":"1500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":800,"y":180,"wires":[["f7188441.cf6f28"]]},{"id":"dab2e715.f34208","type":"http in","z":"3873e5c5.abbcfa","name":"","url":"/eventCnt","method":"get","upload":false,"swaggerDoc":"","x":200,"y":2540,"wires":[["1d7deb7c.a2bce5","187ed78e.fe1e08"]]},{"id":"4e4d8bbd.0b0fe4","type":"switch","z":"3873e5c5.abbcfa","name":"check token","property":"payload.token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":184.83334350585938,"y":2450.4165391921997,"wires":[["67e7f983.036bf8"],["37da623d.a82f2e"]]},{"id":"67e7f983.036bf8","type":"function","z":"3873e5c5.abbcfa","name":"set para to obj","func":"msg['actInfo'] = msg.payload\nmsg['token'] = encodeURIComponent(msg.payload['token'])\nreturn msg\n","outputs":1,"noerr":0,"x":180.3333282470703,"y":2397.6665658950806,"wires":[["f81080d7.5e94c"]]},{"id":"37da623d.a82f2e","type":"function","z":"3873e5c5.abbcfa","name":"set missing result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Missing parameter'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":514.5833358764648,"y":2488.666549682617,"wires":[["cc8fa099.4608d"]]},{"id":"8a70b9b5.0fa378","type":"function","z":"3873e5c5.abbcfa","name":"set search cond to get cnt","func":"// let obj = flow.get('actInfo')\nlet obj = msg['actInfo']\nlet newPayload = {}\nif(obj.macAddr !== undefined ){\n  newPayload['macAddr'] = obj.macAddr    \n}else{\n  if(msg['cond'] !== undefined){\n    newPayload['macAddr'] = msg['cond']\n  }    \n}\nif(msg['from'] !== undefined && msg['to'] !== undefined ){\n  let dateCond = {}\n  dateCond['$gt'] = new Date(msg['from'])\n  dateCond['$lte'] = new Date(msg['to'])\n  newPayload['recv'] = dateCond\n}\nif(msg['search'] != undefined && msg['search'].indexOf(':') !== -1){\n  let arr = msg['search'].split(':')\n  if(arr.length === 3){\n    let fieldName = arr[0]\n    if(arr[2].indexOf('\"') !== -1){\n      arr[2] = arr[2].replace(/\"/g,'')\n    }else{\n      arr[2] = parseFloat(arr[2])\n    }\n    let opCond = {}\n    switch(arr[1]){\n      case '=':\n        newPayload[fieldName] = arr[2]\n        break\n      case '>':\n        opCond['$gt'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '<':\n        opCond['$lt'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '>=':\n        opCond['$gte'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '<=':\n        opCond['$lte'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      case '!=':\n        opCond['$ne'] = arr[2]\n        newPayload[fieldName] = opCond\n        break\n      default:\n    }\n  }\n}\nif(obj.fport != undefined){\n  if (isNaN(obj.fport)) {\n    newPayload['extra.fport'] = obj.fport\n  } else {\n    newPayload['extra.fport'] = Number(obj.fport)\n  }\n}\n\nmsg.payload = newPayload\nreturn msg","outputs":1,"noerr":0,"x":557.9444427490234,"y":1761.222146987915,"wires":[["6338378.2bd88c8","b178787a.c490b8"]]},{"id":"6338378.2bd88c8","type":"mongodb in","z":"3873e5c5.abbcfa","mongodb":"f9ed3ab1.0debf8","name":"find raw data Cnt","collection":"devices","operation":"count","x":802.3889617919922,"y":1777.8888130187988,"wires":[["7bdf3fd3.94f03"]]},{"id":"b178787a.c490b8","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":760.7221870422363,"y":1743.6665802001953,"wires":[]},{"id":"a37fcc28.c5598","type":"switch","z":"3873e5c5.abbcfa","name":"check from","property":"payload.from","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":195.33335876464844,"y":2272.8665924072266,"wires":[["555a328f.65c5ac"],["8b1d88fa.e4fd28"]]},{"id":"555a328f.65c5ac","type":"switch","z":"3873e5c5.abbcfa","name":"check to","property":"payload.to","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":198.83334350585938,"y":2209.6665802001953,"wires":[["248ad355.ca462c"],["181bbc0.8b5bd44"]]},{"id":"8b1d88fa.e4fd28","type":"moment","z":"3873e5c5.abbcfa","name":"","topic":"","input":"payload.from","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"from","outputType":"msg","outTz":"Etc/UTC","x":436.33333587646484,"y":2282.466564178467,"wires":[["555a328f.65c5ac"]]},{"id":"181bbc0.8b5bd44","type":"moment","z":"3873e5c5.abbcfa","name":"","topic":"","input":"payload.to","inputType":"msg","inTz":"Asia/Taipei","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"POSIX","output":"to","outputType":"msg","outTz":"Etc/UTC","x":429.8333282470703,"y":2219.266586303711,"wires":[["248ad355.ca462c"]]},{"id":"88ec2005.57bff","type":"function","z":"3873e5c5.abbcfa","name":"set token len","func":"let actInfo = msg['actInfo']\nlet token = msg.payload\nlet ar = token.split(':')\nif(ar.length !== 6){\n    msg['check'] = 0\n}else{\n    msg['check'] = 1\n    actInfo['grp'] = ar[0]\n    actInfo['ts'] = ar[1]\n    actInfo['userId'] = ar[2]\n    actInfo['cpId'] = ar[3]\n    actInfo['roleId'] = ar[4]\n    actInfo['dataset'] = ar[5]\n    msg['actInfo'] = actInfo\n}\nmsg['dataset'] = actInfo.dataset\nreturn msg","outputs":1,"noerr":0,"x":196.61112213134766,"y":1923.8887767791748,"wires":[["8b74e804.a6f968"]]},{"id":"8b74e804.a6f968","type":"switch","z":"3873e5c5.abbcfa","name":"check token len","property":"check","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"str"}],"checkall":"true","outputs":2,"x":193.83332061767578,"y":1878.111023902893,"wires":[["1c9a8054.ffe1e"],["2be94e51.b72622"]]},{"id":"2be94e51.b72622","type":"function","z":"3873e5c5.abbcfa","name":"set token fail result","func":"let newPayload = {}\nnewPayload['responseCode'] = '999'\nnewPayload['responseMsg'] = 'Token error'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":471.7221908569336,"y":1980.4443759918213,"wires":[["cc8fa099.4608d"]]},{"id":"1d7deb7c.a2bce5","type":"switch","z":"3873e5c5.abbcfa","name":"check fport","property":"payload.fport","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":184.1111068725586,"y":2496.7220249176025,"wires":[["4e4d8bbd.0b0fe4"],["37da623d.a82f2e"]]},{"id":"1c9a8054.ffe1e","type":"switch","z":"3873e5c5.abbcfa","name":"check dataset","property":"dataset","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","outputs":4,"x":216.49996948242188,"y":1814.7776985168457,"wires":[["8a70b9b5.0fa378"],["9e58d1a9.2913e"],["9e58d1a9.2913e"],["2c77ee5b.f49312"]]},{"id":"2c77ee5b.f49312","type":"function","z":"3873e5c5.abbcfa","name":"set dataset fail","func":"let newPayload = {}\nnewPayload['responseCode'] = '401'\nnewPayload['responseMsg'] = 'Dataset missing'\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":464.8333282470703,"y":1908.333246231079,"wires":[["cc8fa099.4608d"]]},{"id":"664cacad.dd6904","type":"http request","z":"3873e5c5.abbcfa","name":"get device","method":"GET","ret":"obj","url":"","tls":"","x":565.5000305175781,"y":1863.888807296753,"wires":[["3670fd9d.938862"]]},{"id":"9e58d1a9.2913e","type":"function","z":"3873e5c5.abbcfa","name":"set url","func":"let actInfo = msg['actInfo']\nlet urlTemplate = 'http://device-svc:1880/sensor/3?token={token}&fport={fport}'\nlet url = ''\nurl = urlTemplate.replace('{token}', encodeURIComponent(actInfo.token)).replace('{fport}', actInfo.fport)\nmsg.payload = url\nmsg.url = url\nreturn msg","outputs":1,"noerr":0,"x":429.9444885253906,"y":1824.999921798706,"wires":[["664cacad.dd6904"]]},{"id":"3670fd9d.938862","type":"switch","z":"3873e5c5.abbcfa","name":"check response code","property":"payload.responseCode","propertyType":"msg","rules":[{"t":"eq","v":"000","vt":"str"},{"t":"neq","v":"000","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":781.0555572509766,"y":1903.444368839264,"wires":[["a5cb661c.2070f8"],["cc8fa099.4608d"]]},{"id":"a5cb661c.2070f8","type":"function","z":"3873e5c5.abbcfa","name":"set data level control","func":"let macAddr = {}\nlet macs = []\nif(msg.payload.size !== undefined && msg.payload.size > 0){\n  for (let i = 0 ; i < msg.payload.mList.length ; i++){\n    macs.push(msg.payload.mList[i].device_mac)\n  }\n  macAddr['$in'] = macs\n  msg['cond'] = macAddr\n}\nreturn msg","outputs":1,"noerr":0,"x":783.2777862548828,"y":1851.222128868103,"wires":[["8a70b9b5.0fa378"]]},{"id":"f81080d7.5e94c","type":"switch","z":"3873e5c5.abbcfa","name":"check search","property":"payload.search","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":183.0833511352539,"y":2356.1665802001953,"wires":[["a37fcc28.c5598"],["f855134b.25619"]]},{"id":"f855134b.25619","type":"function","z":"3873e5c5.abbcfa","name":"set search text","func":"msg.payload = msg.payload.search\nreturn msg","outputs":1,"noerr":0,"x":392.0833320617676,"y":2365.6665544509888,"wires":[["1e1a983d.9ffcd8"]]},{"id":"1e1a983d.9ffcd8","type":"decrypt","z":"3873e5c5.abbcfa","name":"","algorithm":"TripleDES","key":"gemtek","x":604.5833854675293,"y":2365.6665534973145,"wires":[["c16f6e4e.7fbcc"]]},{"id":"c16f6e4e.7fbcc","type":"function","z":"3873e5c5.abbcfa","name":"set search to parameter","func":"msg['search'] = msg.payload\nreturn msg","outputs":1,"noerr":0,"x":450.58341217041016,"y":2324.666573524475,"wires":[["a37fcc28.c5598"]]},{"id":"187ed78e.fe1e08","type":"debug","z":"3873e5c5.abbcfa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":375.94977951049805,"y":2539.707010269165,"wires":[]},{"id":"e506c478.491b98","type":"http request","z":"3873e5c5.abbcfa","name":"","method":"GET","ret":"obj","url":"http://am-svc:1880/chkToken?token={{token}}","tls":"","x":216.8333282470703,"y":2091.6665802001953,"wires":[["cad2b66f.8ae378"]]},{"id":"cad2b66f.8ae378","type":"function","z":"3873e5c5.abbcfa","name":"check token result","func":"let checkFlg = false\nif(msg.payload['responseCode'] == '000'){\n  checkFlg = true\n  msg.payload = msg.payload['data']\n}\nmsg['checkFlg'] = checkFlg\nreturn msg","outputs":1,"noerr":0,"x":205.8333282470703,"y":2046.6665802001953,"wires":[["442f4ad8.b22ee4"]]},{"id":"442f4ad8.b22ee4","type":"switch","z":"3873e5c5.abbcfa","name":"check checkFlg","property":"checkFlg","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":202.8333282470703,"y":2001.6665802001953,"wires":[["88ec2005.57bff"],[]]},{"id":"248ad355.ca462c","type":"switch","z":"3873e5c5.abbcfa","name":"check token","property":"token","propertyType":"msg","rules":[{"t":"neq","v":"system_trigger","vt":"str"},{"t":"eq","v":"system_trigger","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":217.8333282470703,"y":2152.6665802001953,"wires":[["e506c478.491b98"],["8a70b9b5.0fa378"]]},{"id":"7bdf3fd3.94f03","type":"function","z":"3873e5c5.abbcfa","name":"set result","func":"let newPayload = {}\nnewPayload['responseCode'] = '000'\nnewPayload['responseMsg'] = 'query success'\nnewPayload['total'] = msg.payload\nmsg['payload'] = newPayload\nreturn msg","outputs":1,"noerr":0,"x":1040,"y":1780,"wires":[["cc8fa099.4608d"]]},{"id":"cc8fa099.4608d","type":"http response","z":"3873e5c5.abbcfa","name":"","statusCode":"","headers":{},"x":1290,"y":2140,"wires":[]},{"id":"c25d0cad.0e84","type":"http request","z":"202da31a.94aadc","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"http://socketio-with-restify:8000/socket?api_key=gemtek123","tls":"","proxy":"","authType":"","x":1020,"y":40,"wires":[["7fd55013.2d11"]]},{"id":"7fd55013.2d11","type":"debug","z":"202da31a.94aadc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1200,"y":40,"wires":[]}]
